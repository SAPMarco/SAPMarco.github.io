/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/library","sap/ui/core/Core","sap/ui/core/Item","sap/ui/core/Renderer","sap/ui/core/IconPool","sap/ui/core/InvisibleText","sap/ui/core/Control","sap/ui/Device","./AccButton","sap/m/Button","sap/m/ResponsivePopover","sap/m/IconTabBarSelectList"],function(e,t,i,s,o,a,n,r,l,p,c,g,u){"use strict";var d=t.TextAlign;var h=t.TextDirection;var f=e.ButtonType;var I=e.PlacementType;var _=e.ImageHelper;var T=e.IconTabFilterDesign;var v=t.IconColor;var b=s.extend("sap.m.IconTabFilter",{metadata:{interfaces:["sap.m.IconTab","sap.ui.core.PopupInterface"],library:"sap.m",designtime:"sap/m/designtime/IconTabFilter.designtime",properties:{count:{type:"string",group:"Data",defaultValue:""},showAll:{type:"boolean",group:"Misc",defaultValue:false},icon:{type:"sap.ui.core.URI",group:"Misc",defaultValue:""},iconColor:{type:"sap.ui.core.IconColor",group:"Appearance",defaultValue:v.Default},iconDensityAware:{type:"boolean",group:"Appearance",defaultValue:true},visible:{type:"boolean",group:"Behavior",defaultValue:true},design:{type:"sap.m.IconTabFilterDesign",group:"Appearance",defaultValue:T.Vertical}},defaultAggregation:"content",aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"},items:{type:"sap.m.IconTabFilter",multiple:true,singularName:"item"},_expandButton:{type:"sap.m.Button",multiple:false,visibility:"hidden"}}}});var m=i.getLibraryResourceBundle("sap.m");b._aAllIconColors=["sapMITBFilterCritical","sapMITBFilterPositive","sapMITBFilterNegative","sapMITBFilterDefault","sapMITBFilterNeutral"];b.prototype._getImageControl=function(e,t,i){var s={src:this.getIcon(),densityAware:this.getIconDensityAware(),useIconTooltip:false};if(s.src){this._oImageControl=_.getImageControl(this.getId()+"-icon",this._oImageControl,t,s,e,i)}else if(this._oImageControl){this._oImageControl.destroy();this._oImageControl=null}return this._oImageControl};b.prototype.exit=function(e){if(this._oImageControl){this._oImageControl.destroy()}if(s.prototype.exit){s.prototype.exit.call(this,e)}if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null}if(this._oPopover){this._oPopover.destroy();this._oPopover=null}};b.prototype.invalidate=function(){var e=this.getParent(),t,i;if(!e){return}t=e.getParent();if(!(t instanceof sap.m.IconTabBar)){e.invalidate();return}i=t.getParent();if(i instanceof sap.m.ObjectHeader){i.invalidate()}else{t.invalidate()}};b.prototype.setProperty=function(e,t,i){switch(e){case"enabled":case"textDirection":case"text":case"count":case"showAll":case"icon":case"iconColor":case"iconDensityAware":case"design":if(this.getProperty(e)===t){return this}r.prototype.setProperty.call(this,e,t,true);if(!i){var s=this.getParent();if(s instanceof sap.m.IconTabHeader){s.invalidate()}}break;default:r.prototype.setProperty.apply(this,arguments);break}return this};b.prototype._getNonEmptyKey=function(){var e=this.getKey();if(e){return e}return this.getId()};b.prototype._getRealTab=function(){return this._oTabFilter||this};b.prototype._getRootTab=function(){var e=this._getRealTab(),t=e.getParent();while(t&&t.isA("sap.m.IconTabFilter")){e=t;t=t.getParent()}return e};b.prototype._getNestedLevel=function(){var e=this._getRealTab().getParent(),t;for(t=1;e&&e.isA("sap.m.IconTabFilter");t++){e=e.getParent()}return t};b.prototype.render=function(e,t,s){if(!this.getVisible()){return}var o=this.getParent(),a=o.getParent(),n=o._isInsideIconTabBar(),r=i.getLibraryResourceBundle("sap.m"),l={role:"tab"},p=this.getId(),c=this.getCount(),g=this.getText(),u=this.getIcon(),d=this.getIconColor(),h=d==="Positive"||d==="Critical"||d==="Negative",f=this.getDesign()===T.Horizontal,I=o._bTextOnly,_=o._bInLine||o.isInlineMode();if(n){l.controls=a.getId()+"-content"}if(this._getAllSubFilters().length){l.roledescription=r.getText("ICONTABFILTER_SPLIT_TAB")}if(g.length||c!==""||u){var v=[];if(c!==""){v.push(p+"-count")}if(g.length){v.push(p+"-text")}if(u){v.push(p+"-icon")}if(h){v.push(p+"-iconColor")}l.labelledby=v.join(" ")}if(t!==undefined&&s!==undefined){Object.assign(l,{posinset:t+1,setsize:s})}e.openStart("div",this).accessibilityState(l).class("sapMITBItem");if(!c){e.class("sapMITBItemNoCount")}if(f){e.class("sapMITBHorizontal")}else{e.class("sapMITBVertical")}if(this.getShowAll()){e.class("sapMITBAll")}else{e.class("sapMITBFilter").class("sapMITBFilter"+d)}if(o._isUnselectable(this)){e.class("sapMITHUnselectable")}if(!this.getEnabled()){e.class("sapMITBDisabled").attr("aria-disabled",true)}e.attr("aria-selected",false);var m=this.getTooltip_AsString();if(m){e.attr("title",m)}if(this._bIsOverflow||this.getItems().length){e.attr("aria-haspopup","menu")}e.openEnd();e.openStart("div").class("sapMITBFilterWrapper").openEnd();if(!_){e.openStart("div",p+"-tab").class("sapMITBTab").openEnd();if(!this.getShowAll()||!u){if(h){e.openStart("div",p+"-iconColor").style("display","none").openEnd().text(r.getText("ICONTABBAR_ICONCOLOR_"+d.toUpperCase())).close("div")}e.renderControl(this._getImageControl(["sapMITBFilterIcon","sapMITBFilter"+d],o,b._aAllIconColors))}if(!this.getShowAll()&&!u&&!I){e.openStart("span").class("sapMITBFilterNoIcon").openEnd().close("span")}if(f&&!this.getShowAll()){e.close("div");e.openStart("div").class("sapMITBHorizontalWrapper").openEnd()}e.openStart("span",p+"-count").class("sapMITBCount").openEnd();if(c===""&&f){e.unsafeHtml("&nbsp;")}else{e.text(c)}e.close("span");if(!f){e.close("div")}}if(g.length){e.openStart("div",p+"-text").class("sapMITBText");if(n&&a.getUpperCase()){e.class("sapMITBTextUpperCase")}if(_){e.attr("dir","ltr")}e.openEnd().text(o._getDisplayText(this)).close("div")}if(!_&&f){e.close("div")}e.openStart("div").class("sapMITBContentArrow").openEnd().close("div");e.close("div");if(this._bIsOverflow||this.getItems().length>0){e.openStart("span").accessibilityState({role:"separator"}).openEnd().close("span");e.renderControl(this._getExpandButton())}e.close("div")};b.prototype.renderInSelectList=function(e,t,s,o,a){if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null}if(!this.getVisible()){return}var r=true,l=t._bIconOnly,p=t._oIconTabHeader,c=i.getLibraryResourceBundle("sap.m");if(p){r=p._bTextOnly}e.openStart("li",this).attr("tabindex","-1").attr("role","menuitem");if(a){e.style("padding-left",a+"rem")}if(s!==undefined&&o!==undefined){e.attr("aria-posinset",s+1);e.attr("aria-setsize",o);e.attr("aria-level",this._getNestedLevel())}var g=this.getTooltip_AsString();if(g){e.attr("title",g)}if(p._isUnselectable(this)){e.class("sapMITHUnselectable")}if(!this.getEnabled()){e.class("sapMITBDisabled").attr("aria-disabled",true)}e.class("sapMITBSelectItem");if(t.getSelectedItem()==this){e.class("sapMITBSelectItemSelected");e.attr("aria-selected",true)}var u=this.getIconColor();e.class("sapMITBFilter"+u);var d=this.getId(),h=u=="Positive"||u=="Critical"||u=="Negative",f=[];if(!l){f.push(d+"-text")}if(!r&&this.getIcon()){f.push(d+"-icon")}if(h){this._invisibleText=new n({text:c.getText("ICONTABBAR_ICONCOLOR_"+u.toUpperCase())});f.push(this._invisibleText.getId())}e.accessibilityState({labelledby:f.join(" ")}).openEnd();if(this._invisibleText){e.renderControl(this._invisibleText)}if(!r){this._renderIcon(e)}if(!l){this._renderText(e)}e.close("li")};b.prototype._renderIcon=function(e){var t=this.getIcon();if(t){var i=a.getIconInfo(t),s=["sapMITBSelectItemIcon"];if(i&&!i.suppressMirroring){s.push("sapUiIconMirrorInRTL")}e.icon(t,s,{id:this.getId()+"-icon","aria-hidden":true})}else{e.openStart("span").class("sapUiIcon").openEnd().close("span")}};b.prototype._renderText=function(e){var t=this.getText(),s=this.getCount(),a=i.getConfiguration().getRTL(),n=this.getTextDirection();e.openStart("span",this.getId()+"-text").attr("dir","ltr").class("sapMText").class("sapMTextNoWrap").class("sapMITBText");if(n!==h.Inherit){e.attr("dir",n.toLowerCase())}var r=o.getTextAlign(d.Begin,n);if(r){e.style("text-align",r)}if(s){if(a){t="("+s+") "+t}else{t+=" ("+s+")"}}e.openEnd().text(t).close("span")};b.prototype._getSelectList=function(){if(!this._oSelectList){this._oSelectList=new u({selectionChange:function(e){var t=e.getParameter("selectedItem");this._oIconTabHeader.setSelectedItem(t._getRealTab());this._oTabFilter._closeOverflow()}});this._oSelectList._oIconTabHeader=this.getParent();this._oSelectList._oTabFilter=this}return this._oSelectList};b.prototype._getExpandButton=function(){var e=this.getAggregation("_expandButton");if(!e){e=new p(this.getId()+"-expandButton",{type:f.Transparent,icon:a.getIconURI("slim-arrow-down"),tooltip:i.getLibraryResourceBundle("sap.m").getText("ICONTABHEADER_OVERFLOW_MORE"),tabIndex:"-1",press:this._expandButtonPress.bind(this)}).addStyleClass("sapMITBFilterExpandBtn");this.setAggregation("_expandButton",e)}return e};b.prototype._expandButtonPress=function(){this.$().focus();if(!this._oPopover){this._oPopover=new g({showArrow:false,showHeader:false,offsetY:0,offsetX:0,placement:I.VerticalPreferredBottom}).addStyleClass("sapMITBFilterPopover");this._oPopover.attachBeforeClose(function(){this._getSelectList().destroyItems()},this);if(l.system.phone){this._oPopover._oControl.addButton(this._createPopoverCloseButton())}this.addDependent(this._oPopover);this._oPopover._oControl._adaptPositionParams=function(){var e=this.$().parents().hasClass("sapUiSizeCompact");this._arrowOffset=0;if(e){this._offsets=["0 0","0 0","0 4","0 0"]}else{this._offsets=["0 0","0 0","0 5","0 0"]}this._atPositions=["end top","end top","end bottom","begin top"];this._myPositions=["end bottom","begin top","end top","end top"]}}var e=this._setSelectListItems();var t=this._getSelectList();this._oPopover.removeAllContent();this._oPopover.addContent(t).setInitialFocus(e?t.getSelectedItem():t.getItems()[0]).openBy(this._getExpandButton())};b.prototype._getAllSubFilters=function(){var e=[];this._getRealTab().getItems().forEach(function(t){e=e.concat(t,t._getAllSubFilters())});return e};b.prototype._getAllSubFiltersDomRefs=function(){return this._getAllSubFilters().filter(function(e){return Boolean(e._getRealTab().getDomRef())}).map(function(e){return e._getRealTab().getDomRef()})};b.prototype._getFirstAvailableSubFilter=function(){var e=this._getAllSubFilters();for(var t=0;t<e.length;t++){var i=e[t];if(i.getContent().length&&i.getVisible()){return i}}return this};b.prototype._isParentOf=function(e){var t=this._getAllSubFilters();for(var i=0;i<t.length;i++){if(t[i]._getRealTab()===e){return true}}return false};b.prototype._createPopoverCloseButton=function(){return new c({text:m.getText("SELECT_CANCEL_BUTTON"),press:this._closeOverflow.bind(this)})};b.prototype._closeOverflow=function(){if(this._oPopover){this._oPopover.close();this._oPopover.removeAllContent()}if(this._bIsOverflow&&this.getParent().oSelectedItem){(this.getParent()._oSelectedRootItem||this.getParent().oSelectedItem).$().focus()}};b.prototype._setSelectListItems=function(){var e=this.getParent(),t=this._getSelectList(),i=this.getItems(),s=e.oSelectedItem,o=false,a;if(this._bIsOverflow){i=e.getTabFilters();a=e._getItemsInStrip()}t.destroyItems();t.setSelectedItem(null);for(var n=0;n<i.length;n++){var r=i[n];if(this._bIsOverflow&&!l.system.phone&&a.indexOf(r)>-1){continue}var p=r.clone(undefined,undefined,{cloneChildren:false,cloneBindings:true});p._oTabFilter=r;t.addItem(p);if(p._getRealTab()===s){t.setSelectedItem(p);o=true;continue}if(p._getRealTab()._isParentOf(s)){t.setSelectedItem(s._getRealTab());o=true}}return o};b.prototype.onsapdown=function(e){if(this._bIsOverflow||this._getNestedLevel()===1&&this._getRealTab()===this&&this._getRealTab().getItems().length!==0){e.stopImmediatePropagation();this._expandButtonPress()}};return b});