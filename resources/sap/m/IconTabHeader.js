/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/Core","sap/ui/core/Control","sap/ui/core/EnabledPropagator","sap/ui/core/delegate/ItemNavigation","sap/ui/core/InvisibleText","sap/ui/core/ResizeHandler","sap/m/Button","sap/m/IconTabFilter","sap/m/IconTabSeparator","sap/m/IconTabBarDragAndDropUtil","sap/m/IconTabHeaderRenderer","sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/events/KeyCodes"],function(e,t,i,o,s,a,n,r,l,d,h,p,c,g,f){"use strict";var u=e.BackgroundDesign;var m=e.IconTabHeaderMode;var I=e.IconTabDensityMode;var v=i.extend("sap.m.IconTabHeader",{metadata:{library:"sap.m",properties:{showSelection:{type:"boolean",group:"Misc",defaultValue:true,deprecated:true},selectedKey:{type:"string",group:"Data",defaultValue:null},visible:{type:"boolean",group:"Behavior",defaultValue:true},mode:{type:"sap.m.IconTabHeaderMode",group:"Appearance",defaultValue:m.Standard},showOverflowSelectList:{type:"boolean",group:"Appearance",defaultValue:false,deprecated:true},backgroundDesign:{type:"sap.m.BackgroundDesign",group:"Appearance",defaultValue:u.Solid},enableTabReordering:{type:"boolean",group:"Behavior",defaultValue:false},tabDensityMode:{type:"sap.m.IconTabDensityMode",group:"Appearance",defaultValue:I.Cozy}},aggregations:{items:{type:"sap.m.IconTab",multiple:true,singularName:"item",dnd:{draggable:true,droppable:true,layout:"Horizontal"}},_overflow:{type:"sap.m.IconTabFilter",multiple:false,visibility:"hidden"}},events:{select:{parameters:{item:{type:"sap.m.IconTabFilter"},key:{type:"string"}}}}}});var _=t.getLibraryResourceBundle("sap.m");o.apply(v.prototype,[true]);v.prototype.init=function(){this._aTabKeys=[];this._oAriaHeadText=new a({id:this.getId()+"-ariaHeadText"})};v.prototype.exit=function(){if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();delete this._oItemNavigation}if(this._sResizeListenerId){n.deregister(this._sResizeListenerId);this._sResizeListenerId=null}if(this._aTabKeys){this._aTabKeys=null}if(this._oPopover){this._oPopover.destroy();this._oPopover=null}if(this.getAggregation("_overflow")){this._getOverflow().removeEventDelegate(this._oOverflowEventDelegate);this._oOverflowEventDelegate=null}this._oAriaHeadText.destroy();this._oAriaHeadText=null;this._bRtl=null};v.prototype.onBeforeRendering=function(){this._bRtl=t.getConfiguration().getRTL();if(this._sResizeListenerId){n.deregister(this._sResizeListenerId);this._sResizeListenerId=null}this._updateSelection();this._setsDragAndDropConfigurations()};v.prototype.onAfterRendering=function(){this._applyTabDensityMode();var e=this.getParent();var i=this._isInsideIconTabBar();if(this.oSelectedItem&&(!i||i&&e.getExpanded())){this.oSelectedItem.$().addClass("sapMITBSelected").attr({"aria-selected":true});if(this._oSelectedRootItem){this._oSelectedRootItem.$().addClass("sapMITBSelected");this._oSelectedRootItem.$().attr({"aria-selected":true})}}if(t.isThemeApplied()){this._setItemsForStrip()}else{t.attachThemeChanged(this._handleThemeLoad,this)}this._initItemNavigation();this._sResizeListenerId=n.register(this.getDomRef(),c.proxy(this._fnResize,this))};v.prototype._getSelectList=function(){return this._getOverflow()._getSelectList()};v.prototype._getOverflow=function(){var e=this.getAggregation("_overflow");if(!e){e=new l({id:this.getId()+"-overflow",text:_.getText("ICONTABHEADER_OVERFLOW_MORE")});e._bIsOverflow=true;this._oOverflowEventDelegate={onlongdragover:this._handleOnLongDragOver,ondragover:this._handleOnDragOver,ondragleave:this._handleOnDragLeave,ondrop:this._handleOnDrop};e.addEventDelegate(this._oOverflowEventDelegate,this);e.addEventDelegate({onsapnext:e.onsapdown},e);this.setAggregation("_overflow",e)}return e};v.prototype._onItemNavigationFocusLeave=function(){if(!this.oSelectedItem){return}var e=this.getItems();var t=-1;var i;for(var o=0;o<e.length;o++){i=e[o];if(i instanceof l==false){continue}t++;if((this._oSelectedRootItem||this.oSelectedItem)==i){break}}this._oItemNavigation.setFocusedIndex(t)};v.prototype.getTabFilters=function(){var e=[];this.getItems().forEach(function(t){if(t instanceof l){e.push(t)}});return e};v.prototype._handleOnLongDragOver=function(){var e=this._getOverflow();if(!e._oPopover||!e._oPopover.isOpen()){e._expandButtonPress()}};v.prototype._handleOnDragOver=function(e){this._getOverflow()._getExpandButton().addStyleClass("sapMBtnDragOver");e.preventDefault()};v.prototype._handleOnDrop=function(){this._getOverflow()._getExpandButton().removeStyleClass("sapMBtnDragOver")};v.prototype._handleOnDragLeave=function(){this._getOverflow()._getExpandButton().removeStyleClass("sapMBtnDragOver")};v.prototype._setsDragAndDropConfigurations=function(){if(!this.getEnableTabReordering()&&this.getDragDropConfig().length){this.destroyDragDropConfig()}else if(this.getEnableTabReordering()&&!this.getDragDropConfig().length){h.setDragDropAggregations(this,"Horizontal")}};v.prototype.setSelectedKey=function(e){var t=this.getTabFilters(),i=this._isInsideIconTabBar(),o;if(t.length>0){e=e||t[0]._getNonEmptyKey()}if(this.$().length){for(var s=0;s<t.length;s++){if(t[s]._getNonEmptyKey()===e){this.setSelectedItem(t[s],true);o=true;break}}if(!o&&!i&&e){this.setSelectedItem(null)}}this.setProperty("selectedKey",e,true);return this};v.prototype.setSelectedItem=function(e,t){if(!e){if(this.oSelectedItem){this.oSelectedItem.$().removeClass("sapMITBSelected");this.oSelectedItem=null;if(this._oSelectedRootItem){this._oSelectedRootItem.getDomRef().classList.remove("sapMITBSelected");this._oSelectedRootItem=null}}return this}if(this._isUnselectable(e)){return this}var i=this.getParent();var o=this._isInsideIconTabBar();var s=false;if(e.getContent().length===0&&this.oSelectedItem&&this.oSelectedItem.getContent().length===0){s=true}if(this.oSelectedItem&&this.oSelectedItem.getVisible()&&(!t&&o&&i.getExpandable()||this.oSelectedItem!==e)){this.oSelectedItem.$().removeClass("sapMITBSelected").attr("aria-selected",false).removeAttr("aria-expanded");if(this._oSelectedRootItem){this._oSelectedRootItem.$().removeClass("sapMITBSelected").attr("aria-selected",false).removeAttr("aria-expanded")}}if(e.getVisible()){if(this.oSelectedItem===e){if(!t&&o&&i.getExpandable()){i._toggleExpandCollapse()}}else{if(o){i.$("content").attr("aria-labelledby",e.sId)}this.oSelectedItem=e;if(this.oSelectedItem._getNestedLevel()!==1){this._oSelectedRootItem=this.oSelectedItem._getRootTab();this._oSelectedRootItem.$().addClass("sapMITBSelected").attr({"aria-selected":true})}else{this._oSelectedRootItem=null}this.setProperty("selectedKey",this.oSelectedItem._getNonEmptyKey(),true);if(!o){this.oSelectedItem.$().addClass("sapMITBSelected").attr({"aria-selected":true})}if(o&&(i.getExpandable()||i.getExpanded())){this.oSelectedItem.$().addClass("sapMITBSelected").attr({"aria-selected":true});var a=this.oSelectedItem.getContent();if(a.length>0){i._rerenderContent(a)}else{if(!s){i._rerenderContent(i.getContent())}}if(!t&&i.getExpandable()&&!i.getExpanded()){i._toggleExpandCollapse(true)}}}}this.oSelectedItem=e;var n=this.oSelectedItem._getNonEmptyKey();this.setProperty("selectedKey",n,true);if(o){i.setProperty("selectedKey",n,true)}if(!t){if(o){i.fireSelect({selectedItem:this.oSelectedItem,selectedKey:n,item:this.oSelectedItem,key:n})}else{this.fireSelect({selectedItem:this.oSelectedItem,selectedKey:n,item:this.oSelectedItem,key:n})}}this._setItemsForStrip();return this};v.prototype.getVisibleTabFilters=function(){return this.getTabFilters().filter(function(e){return e.getVisible()})};v.prototype._initItemNavigation=function(){var e=this,t=this.getItems(),i=[],o=-1;t.forEach(function(t){if(t.isA("sap.m.IconTabFilter")){var s=e.getFocusDomRef(t);if(!s){return}s.setAttribute("tabindex","-1");i.push(s);if(t===e.oSelectedItem||t===e._oSelectedRootItem){o=i.indexOf(s)}}});if(this.$().hasClass("sapMITHOverflowList")){var a=this._getOverflow().getFocusDomRef();a.setAttribute("tabindex","-1");i.push(a)}if(!this._oItemNavigation){this._oItemNavigation=(new s).setCycling(false).attachEvent(s.Events.FocusLeave,this._onItemNavigationFocusLeave,this).setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"]});this.addDelegate(this._oItemNavigation)}this._oItemNavigation.setRootDomRef(this.getDomRef()).setItemDomRefs(i).setPageSize(i.length).setSelectedIndex(o)};v.prototype.onThemeChanged=function(){this._applyTabDensityMode()};v.prototype._applyTabDensityMode=function(){var e=this.getTabDensityMode();this.$().removeClass("sapUiSizeCompact");switch(e){case I.Compact:this.$().addClass("sapUiSizeCompact");break;case I.Inherit:if(this.$().closest(".sapUiSizeCompact").length){this.$().addClass("sapUiSizeCompact")}break}};v.prototype._handleThemeLoad=function(){setTimeout(this._setItemsForStrip.bind(this),350);t.detachThemeChanged(this._handleThemeLoad,this)};v.prototype.destroyItems=function(){this.oSelectedItem=null;this._aTabKeys=[];this.destroyAggregation("items");return this};v.prototype.addItem=function(e){if(!(e instanceof d)){var t=e.getKey();if(this._aTabKeys.indexOf(t)!==-1){g.warning("sap.m.IconTabHeader: duplicate key '"+t+"' inside the IconTabFilter. Please use unique keys.")}this._aTabKeys.push(t)}this.addAggregation("items",e);this._invalidateParentIconTabBar()};v.prototype.insertItem=function(e,t){if(!(e instanceof d)){var i=e.getKey();if(this._aTabKeys.indexOf(i)!==-1){g.warning("sap.m.IconTabHeader: duplicate key '"+i+"' inside the IconTabFilter. Please use unique keys.")}this._aTabKeys.push(i)}this.insertAggregation("items",e,t);this._invalidateParentIconTabBar()};v.prototype.removeAllItems=function(){var e=this.removeAllAggregation("items");this._aTabKeys=[];this.oSelectedItem=null;this._invalidateParentIconTabBar();return e};v.prototype.removeItem=function(e){e=this.removeAggregation("items",e);if(e&&!(e instanceof d)){var t=e.getKey();this._aTabKeys.splice(this._aTabKeys.indexOf(t),1)}if(this.oSelectedItem===e){this.oSelectedItem=null}this._invalidateParentIconTabBar();return e};v.prototype.updateAggregation=function(){this.oSelectedItem=null;i.prototype.updateAggregation.apply(this,arguments);this.invalidate()};v.prototype.removeAggregation=function(e,t,o){var s=this.getTabFilters();var a=i.prototype.removeAggregation.apply(this,arguments);if(o){return a}if(a&&a==this.oSelectedItem&&e=="items"){var n=s?Array.prototype.indexOf.call(s,a):-1;s=this.getTabFilters();n=Math.max(0,Math.min(n,s.length-1));var r=s[n];if(r){this.setSelectedItem(r,true)}else{var l=this.getParent();if(this._isInsideIconTabBar()&&l.getExpanded()){l.$("content").children().remove()}}}return a};v.prototype.removeAllAggregation=function(e,t){if(e=="items"){var o=this.getParent();if(this._isInsideIconTabBar()&&o.getExpanded()){o.$("content").children().remove()}}return i.prototype.removeAllAggregation.apply(this,arguments)};v.prototype._getDisplayText=function(e){var t=e.getText();if(this.isInlineMode()){var i=e.getCount();if(i){if(this._bRtl){t="("+i+") "+t}else{t+=" ("+i+")"}}}return t};v.prototype.isInlineMode=function(){return this._bTextOnly&&this.getMode()==m.Inline};v.prototype._checkTextOnly=function(){this._bTextOnly=this.getItems().every(function(e){return e instanceof d||!e.getIcon()});return this._bTextOnly};v.prototype._checkNoText=function(e){if(e.length>0){for(var t=0;t<e.length;t++){if(!(e[t]instanceof d)){if(e[t].getText().length>0){return false}}}}return true};v.prototype._checkInLine=function(e){var t;if(e.length>0){for(var i=0;i<e.length;i++){t=e[i];if(!(t instanceof d)){if(t.getIcon()||t.getCount()){this._bInLine=false;return false}}}}this._bInLine=true;return true};v.prototype._getItemsInStrip=function(){return this.getItems().filter(function(e){var t=e.getDomRef();return t&&!t.classList.contains("sapMITBFilterHidden")})};v.prototype._setItemsForStrip=function(){var e=this.getVisibleTabFilters();if(!t.isThemeApplied()||!e.length){return}var i=this.getDomRef("head"),o=this.oSelectedItem&&this.oSelectedItem.getVisible()?this.oSelectedItem:e[0];if(!i){return}if(this._oPopover){this._oPopover.close()}var s=i.offsetWidth,a,n,r=(this._oSelectedRootItem||o).getDomRef(),l=this.getItems().filter(function(e){return e.getDomRef()}).map(function(e){return e.getDomRef()});if(!l.length||!r){return}l.forEach(function(e){e.style.width="";e.classList.remove("sapMITBFilterHidden")});r.classList.remove("sapMITBFilterTruncated");var d=window.getComputedStyle(r);var h=r.offsetWidth+Number.parseInt(d.marginLeft)+Number.parseInt(d.marginRight);l.splice(l.indexOf(r),1);if(s<h){r.style.width=s-20+"px";r.classList.add("sapMITBFilterTruncated");for(n=0;n<l.length;n++){a=l[n];if(a){a.classList.add("sapMITBFilterHidden")}}return}var p=-1;for(n=0;n<l.length;n++){a=l[n];var c=window.getComputedStyle(a);var g=a.offsetWidth+Number.parseInt(c.marginLeft)+Number.parseInt(c.marginRight);if(s>h+g){h+=g;p=n}else{break}}for(n=p+1;n<l.length;n++){a=l[n];a.classList.add("sapMITBFilterHidden")}this.$().toggleClass("sapMITHOverflowList",p+1!==l.length)};v.prototype._handleActivation=function(e){var i=e.target.id,o=e.srcControl,s,a=c(e.target);if(o instanceof r){return}var n=c(document.getElementById(i));if(n.parents()&&Array.prototype.indexOf.call(n.parents(),this.$("content")[0])>-1){}else{if(i){e.preventDefault();if(a.hasClass("sapMITBFilterIcon")||a.hasClass("sapMITBCount")||a.hasClass("sapMITBText")||a.hasClass("sapMITBTab")||a.hasClass("sapMITBContentArrow")||a.hasClass("sapMITBSep")||a.hasClass("sapMITBSepIcon")){s=e.srcControl.getId().replace(/-icon$/,"");o=t.byId(s);if(o.getMetadata().isInstanceOf("sap.m.IconTab")&&!(o instanceof d)){if(this._isUnselectable(o)){if(o.getItems().length){o._expandButtonPress()}return}if(o===this._getOverflow()){o._expandButtonPress();return}this.setSelectedItem(o)}}else if(o.getMetadata().isInstanceOf("sap.m.IconTab")&&!(o instanceof d)){if(this._isUnselectable(o)){if(o.getItems().length){o._expandButtonPress()}return}if(o===this._getOverflow()){o._expandButtonPress();return}this.setSelectedItem(o)}}else{if(o.getMetadata().isInstanceOf("sap.m.IconTab")&&!(o instanceof d)){if(this._isUnselectable(o)){if(o.getItems().length){o._expandButtonPress()}return}if(o===this._getOverflow()){o._expandButtonPress();return}this.setSelectedItem(o)}}}};v.prototype._fnResize=function(){if(this._getOverflow()._oPopover){this._getOverflow()._oPopover.close()}this._setItemsForStrip();this._initItemNavigation()};v.prototype._isUnselectable=function(e){var t=e._getRealTab();return!t.getEnabled()||this._isInsideIconTabBar()&&!this.getParent().getContent().length&&t._getNestedLevel()===1&&t.getItems().length&&!t.getContent().length};v.prototype._isInsideIconTabBar=function(){var e=this.getParent();return e instanceof i&&e.isA("sap.m.IconTabBar")};v.prototype._invalidateParentIconTabBar=function(){if(this._isInsideIconTabBar()){this.getParent().invalidate()}};v.prototype.getFocusDomRef=function(e){var t=e||this.oSelectedItem;if(!t){return null}return t.getDomRef()};v.prototype.applyFocusInfo=function(e){if(e.focusDomRef){c(e.focusDomRef).focus()}};v.prototype._updateSelection=function(){var e=this.getItems(),t=this.getSelectedKey(),i=0,o=this.getParent(),s=this._isInsideIconTabBar(),a=o&&o.isA("sap.tnt.ToolHeader");if(e.length>0){if(!this.oSelectedItem||t&&t!==this.oSelectedItem._getNonEmptyKey()){if(t){for(;i<e.length;i++){if(!(e[i]instanceof d)&&e[i]._getNonEmptyKey()===t){this.oSelectedItem=e[i];break}}}if(!this.oSelectedItem&&(s||!t)){for(i=0;i<e.length;i++){if(!(e[i]instanceof d)&&e[i].getVisible()){this.oSelectedItem=e[i];break}}}}if(!a&&this.oSelectedItem&&!this.oSelectedItem.getVisible()){for(i=0;i<e.length;i++){if(!(e[i]instanceof d)&&e[i].getVisible()){this.oSelectedItem=e[i];break}}}if(!this.oSelectedItem){return}if(this._isUnselectable(this.oSelectedItem)){this.setSelectedItem(this.oSelectedItem._getFirstAvailableSubFilter(),true);return}this.setProperty("selectedKey",this.oSelectedItem._getNonEmptyKey(),true)}};v.prototype.ontouchstart=function(e){var t=e.targetTouches[0];this._iActiveTouch=t.identifier};v.prototype.ontouchend=function(e){if(this._iActiveTouch===undefined){return}var t=0;var i=1;var o;if(e.which===o||e.which===t||e.which===i){this._handleActivation(e)}this._iActiveTouch=undefined};v.prototype.ontouchcancel=v.prototype.ontouchend;v.prototype.onkeydown=function(e){switch(e.which){case f.ENTER:this._handleActivation(e);e.preventDefault();break;case f.SPACE:this._handleActivation(e);e.preventDefault();break}};v.prototype._handleDragAndDrop=function(e){var t=e.getParameter("dropPosition"),i=e.getParameter("draggedControl"),o=e.getParameter("droppedControl");h.handleDrop(this,t,i._getRealTab(),o,false);this._setItemsForStrip();this._initItemNavigation();this._getSelectList()._initItemNavigation();i._getRealTab().$().focus()};v.prototype._moveTab=function(e,t){h.moveItem.call(this,e,t);this._setItemsForStrip();this._initItemNavigation()};v.prototype.ondragrearranging=function(e){if(!this.getEnableTabReordering()){return}var t=e.srcControl;this._moveTab(t,e.keyCode);t.$().focus()};v.prototype.onsaphomemodifiers=v.prototype.ondragrearranging;v.prototype.onsapendmodifiers=v.prototype.ondragrearranging;v.prototype.onsapincreasemodifiers=v.prototype.ondragrearranging;v.prototype.onsapdecreasemodifiers=v.prototype.ondragrearranging;return v});