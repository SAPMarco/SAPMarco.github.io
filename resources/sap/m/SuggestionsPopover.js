/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/Device","sap/ui/base/EventProvider","sap/ui/core/InvisibleText","sap/ui/core/ValueStateSupport","sap/m/library","sap/ui/core/library","sap/m/Button","sap/m/ColumnListItem","sap/m/GroupHeaderListItem","sap/ui/core/SeparatorItem","sap/m/List","sap/m/Popover","sap/m/Table","sap/ui/events/KeyCodes","sap/m/ValueStateHeader","sap/m/inputUtils/highlightDOMElements","sap/m/inputUtils/scrollToItem","sap/m/inputUtils/ListHelpers","sap/m/inputUtils/SuggestionsPopoverDialogMixin","sap/m/inputUtils/SuggestionsPopoverPopoverMixin"],function(e,t,s,o,i,a,n,u,r,l,p,h,d,g,_,c,f,S,I,m){"use strict";var y=i.ListMode;var v=i.ListType;var V=i.ListSeparators;var b="sapMSuggestionsPopover",P="sapUiNoContentPadding";var L=a.ValueState;var T=t.extend("sap.m.SuggestionsPopover",{constructor:function(s){t.apply(this,arguments);this._oInput=s;this._bHasTabularSuggestions=false;this._bUseDialog=e.system.phone;this._iPopupListSelectedIndex=-1;this._sPopoverContentWidth=null;this._bEnableHighlighting=true;this._bIsInputIncrementalType=false;this._bAutocompleteEnabled=false;this._sTypedInValue="";this._sOldValueState=L.None;this._oInput.addEventDelegate({onsapup:function(e){if(!this._oInput.isComposingCharacter()){this._onsaparrowkey(e,"up",1)}},onsapdown:function(e){if(!this._oInput.isComposingCharacter()){this._onsaparrowkey(e,"down",1)}},onsappageup:function(e){this._onsaparrowkey(e,"up",5)},onsappagedown:function(e){this._onsaparrowkey(e,"down",5)},onsaphome:function(e){var t;if(this._oList){t=this._oList.getItems().length?this._oList.getItems().length-1:0;this._onsaparrowkey(e,"up",t)}},onsapend:function(e){if(this._oList){this._onsaparrowkey(e,"down",this._oList.getItems().length)}},onsapright:this._onsapright,onsaptabnext:this._handleValueStateLinkNav,onsaptabprevious:this._handleValueStateLinkNav},this);if(e.system.phone){I.apply(T.prototype)}else{m.apply(T.prototype)}},destroy:function(){this.destroyPopover();if(this._oList){this._oList.destroy();this._oList=null}this._oProposedItem=null;this._oInputDelegate=null;this._oValueStateHeader=null;if(this._oPickerValueStateText){this._oPickerValueStateText.destroy();this._oPickerValueStateText=null}}});T.M_EVENTS={SELECTION_CHANGE:"selectionChange"};T.prototype.isOpen=function(){var e=this.getPopover();return e&&e.isOpen()};T.prototype.setPopover=function(e){this._oPopover=e};T.prototype.getPopover=function(){return this._oPopover};T.prototype.destroyPopover=function(){if(this._oPopover){this._oPopover.destroy()}this._oPopover=null};T.prototype.setInputLabels=function(e){this._fnInputLabels=e};T.prototype._createSuggestionPopup=function(e){var t,o=this._oInput;e=e||[];t=this.createPopover(o,this._oPopupInput,e);this.setPopover(t);this._registerAutocomplete();t.addStyleClass(b);t.addStyleClass(P);t.addAriaLabelledBy(s.getStaticId("sap.m","INPUT_AVALIABLE_VALUES"));if(this._oList){this.addContent(this._oList)}};T.prototype._createSuggestionPopupContent=function(e){var t=this._oInput,s=this.getPopover();this._bHasTabularSuggestions=e;if(!e){this._oList=new p(t.getId()+"-popup-list",{showNoData:false,mode:y.SingleSelectMaster,rememberSelections:false,width:"100%",showSeparators:V.None,busyIndicatorDelay:0});this._oList.addEventDelegate({onAfterRendering:function(){var e,t;if(!this._bEnableHighlighting){return}e=this._oList.$().find(".sapMSLIInfo, .sapMSLITitleOnly");t=(this._sTypedInValue||this._oInput.getValue()).toLowerCase();c(e,t)}.bind(this)})}else{this._oList=this._oInput._getSuggestionsTable()}if(s){if(this._bUseDialog){s.addAggregation("content",this._oList,true);var o=s.$("scrollCont")[0];if(o){var i=sap.ui.getCore().createRenderManager();i.renderControl(this._oList);i.flush(o);i.destroy()}}else{this.addContent(this._oList)}}};T.prototype._getValueStateHeader=function(){var e;if(!this._oValueStateHeader){this._oValueStateHeader=new _;e=this.getPopover();if(e.isA("sap.m.Popover")){e.setCustomHeader(this._oValueStateHeader)}else{e.insertContent(this._oValueStateHeader,0)}this._oValueStateHeader.setPopup(e)}return this._oValueStateHeader};T.prototype._destroySuggestionPopup=function(){if(this.getPopover()&&this._oList instanceof d){this.getPopover().removeAllContent()}this.destroyPopover();if(this._oList instanceof p){this._oList.destroy();this._oList=null}if(this._oPickerValueStateText){this._oPickerValueStateText.destroy();this._oPickerValueStateText=null}if(this._oValueStateHeader){this._oValueStateHeader.destroy();this._oValueStateHeader=null}this._getInput().removeEventDelegate(this._oInputDelegate,this)};T.prototype._handleValueStateLinkNav=function(e){this.bMessageValueStateActive=this._oInput.getFormattedTextFocused?this._oInput.getFormattedTextFocused():this.bMessageValueStateActive;if(!this.bMessageValueStateActive||!this.getValueStateLinks().length||this.bMessageValueStateActive&&document.activeElement.tagName==="A"){return}var t=this.getValueStateLinks(),s=t[t.length-1];e.preventDefault();this._iPopupListSelectedIndex=-1;t[0].focus();this._getValueStateHeader().removeStyleClass("sapMPseudoFocus");t.forEach(function(e){e.addDelegate({onsapup:function(e){this._oInput.getFocusDomRef().focus();this._onsaparrowkey(e,"up",1)},onsapdown:function(e){this._oInput.getFocusDomRef().focus();this._onsaparrowkey(e,"down",1)}},this)},this);s.addDelegate({onsaptabnext:function(e){this.bMessageValueStateActive=false;this._oInput.onsapfocusleave(e);this.getPopover().close();setTimeout(function(){this._oInput.closeValueStateMessage()}.bind(this),0)}},this);t[0].addDelegate({onsaptabprevious:function(e){e.preventDefault();this._oInput.getFocusDomRef().focus();this._getValueStateHeader().addStyleClass("sapMPseudoFocus");this._oInput.removeStyleClass("sapMFocus")}},this)};T.prototype._onsaparrowkey=function(t,s,o){var i=this._oInput,a,n=this.getPopover(),r=i.$("inner");if(t.isMarked()){return}if(!i.getEnabled()||!i.getEditable()){return}if(s!=="up"&&s!=="down"){return}if(this._bIsInputIncrementalType){t.setMarked()}if(!n||!n.isOpen()){return}t.preventDefault();t.stopPropagation();var l=false,p=this._oList,h=p.getItems(),d=p.getSelectedItem(),g=this._iPopupListSelectedIndex,_,c=this._getValueStateHeader(),S=c.getFormattedText(),I=e.browser.msie?S:c,m=g;if(s=="down"&&g===h.length-1){return}if(this.getValueStateLinks().length&&this.bMessageValueStateActive&&t.type==="sapend"){I.removeStyleClass("sapMPseudoFocus");this._oList.addStyleClass("sapMListFocus");m=0;g=h.length-1;h[g].addStyleClass("sapMLIBFocused");this.bMessageValueStateActive=false}var y;if(o>1){if(s=="down"&&g+o>=h.length){s="up";o=1;h[g].setSelected(false);h[g].removeStyleClass("sapMLIBFocused");y=g;g=h.length-1;l=true}else if(s=="up"&&g-o<0&&g>=0){s="down";o=1;h[g].setSelected(false);h[g].removeStyleClass("sapMLIBFocused");y=g;g=0;l=true}}i.removeStyleClass("sapMFocus");this._oList.addStyleClass("sapMListFocus");if(g===-1){g=0;if(this._isSuggestionItemSelectable(h[g])){m=g;l=true}else{s="down"}}if(s==="down"){while(g<h.length-1&&(!l||!this._isSuggestionItemSelectable(h[g]))){h[g].setSelected(false);h[g].removeStyleClass("sapMLIBFocused");g=g+o;l=true;o=1;if(y===g){break}}}else{while(g>0&&(!l||!h[g].getVisible()||!this._isSuggestionItemSelectable(h[g]))){h[g].setSelected(false);h[g].removeStyleClass("sapMLIBFocused");g=g-o;l=true;o=1;if(y===g){break}}}if(this.getValueStateLinks().length&&!this.bMessageValueStateActive&&t.type!=="sapend"&&(s==="up"&&(!this._isSuggestionItemSelectable(h[g])||m===0)||t.type==="saphome")){I.addStyleClass("sapMPseudoFocus");this._oList.removeStyleClass("sapMListFocus");r.attr("aria-activedescendant",S.getId());this.bMessageValueStateActive=true;this._iPopupListSelectedIndex=-1;f(h[0],this.getPopover());return}if(this.getValueStateLinks().length&&this.bMessageValueStateActive&&(s==="up"&&g===0||s==="down")){I.removeStyleClass("sapMPseudoFocus");this._oList.addStyleClass("sapMListFocus");this.bMessageValueStateActive=false}if(!this._isSuggestionItemSelectable(h[g])){if(m>=0){h[m].setSelected(true).updateAccessibilityState();r.attr("aria-activedescendant",h[m].getId());h[m].addStyleClass("sapMLIBFocused")}return}else{a=h[g];a.setSelected(true).updateAccessibilityState();a.addStyleClass("sapMLIBFocused");r.attr("aria-activedescendant",h[g].getId())}if(e.system.desktop){f(h[g],this.getPopover())}this._oLastSelectedHeader&&this._oLastSelectedHeader.removeStyleClass("sapMInputFocusedHeaderGroup");if(u&&h[g]instanceof u){_=i._getInputValue(i._fnRowResultFilter(h[g]))}else{if(h[g].isA("sap.m.GroupHeaderListItem")){_="";h[g].addStyleClass("sapMInputFocusedHeaderGroup");d&&d.setSelected(false);this._oLastSelectedHeader=h[g]}else{_=i._getInputValue(h[g].getTitle())}}this._iPopupListSelectedIndex=g;this._bSuggestionItemChanged=true;this.fireEvent(T.M_EVENTS.SELECTION_CHANGE,{newValue:_})};T.prototype.getValueStateLinks=function(){var e=this._getValueStateHeader(),t=e&&typeof e.getFormattedText==="function"&&e.getFormattedText(),s=t&&typeof t.getControls==="function"&&t.getControls();return s||[]};T.prototype._isSuggestionItemSelectable=function(e){var t=this._bHasTabularSuggestions||e.getType()!==v.Inactive||e.isA("sap.m.GroupHeaderListItem");return e.getVisible()&&t};T.prototype._registerAutocomplete=function(){var t=this.getPopover(),s=this._getInput(),o=this._bUseDialog;if(o){t.addEventDelegate({ontap:function(){if(!this._bSuggestionItemTapped&&this._sProposedItemText){s.setValue(this._sProposedItemText);this._sProposedItemText=null}}},this)}else{t.attachAfterOpen(this._handleTypeAhead,this)}t.attachAfterOpen(this._setSelectedSuggestionItem,this);t.attachAfterClose(this._finalizeAutocomplete,this);this._oInputDelegate={onkeydown:function(t){this._bDoTypeAhead=!e.os.android&&this._bAutocompleteEnabled&&t.which!==g.BACKSPACE&&t.which!==g.DELETE},oninput:this._handleTypeAhead};s.addEventDelegate(this._oInputDelegate,this)};T.prototype._handleTypeAhead=function(){var t=this._getInput(),s=t.getValue();this._oProposedItem=null;this._sProposedItemText=null;this._sTypedInValue=s;if(!this._bDoTypeAhead||s===""){return}if(!this.getPopover().isOpen()||s.length<this._oInput.getStartSuggestion()){return}if(document.activeElement!==t.getFocusDomRef()){return}var o=s.toLowerCase(),i=this._bHasTabularSuggestions?this._oInput.getSuggestionRows():S.getEnabledItems(this._oInput.getSuggestionItems()),a,n,u,r;i=i.filter(function(e){return!(e.isA("sap.ui.core.SeparatorItem")||e.isA("sap.m.GroupHeaderListItem"))});a=i.length;for(r=0;r<a;r++){u=this._bHasTabularSuggestions?this._oInput._fnRowResultFilter(i[r]):i[r].getText();if(u.toLowerCase().indexOf(o)===0){this._oProposedItem=i[r];n=u;break}}this._sProposedItemText=n;if(n){n=this._formatTypedAheadValue(n);if(!t.isComposingCharacter()){t.updateDomValue(n)}if(e.system.desktop){t.selectText(s.length,n.length)}else{setTimeout(function(){t.selectText(s.length,n.length)},0)}}};T.prototype._setSelectedSuggestionItem=function(){var e=this._oInput.getItems?this._oInput.getItems():this._oInput.getSuggestionItems(),t,s;if(!this._oList){return}t=this._oList.getItems();for(var o=0;o<t.length;o++){s=S.getItemByListItem(e,t[o])||t[o];if(s===this._oProposedItem){t[o].setSelected(true);break}}};T.prototype._getInput=function(){return this._bUseDialog?this._oPopupInput:this._oInput};T.prototype._finalizeAutocomplete=function(){if(this._oInput.isComposingCharacter()){return}if(!this._bAutocompleteEnabled){return}if(!this._bSuggestionItemTapped&&!this._bSuggestionItemChanged&&this._oProposedItem){if(this._bHasTabularSuggestions){this._oInput.setSelectionRow(this._oProposedItem,true)}else{this._oInput.setSelectionItem(this._oProposedItem,true)}}if(this._oProposedItem&&document.activeElement===this._oInput.getFocusDomRef()){var e=this._oInput.getValue().length;this._oInput.selectText(e,e)}this._resetTypeAhead()};T.prototype._resetTypeAhead=function(){this._oProposedItem=null;this._sProposedItemText=null;this._sTypedInValue="";this._bSuggestionItemTapped=false;this._bSuggestionItemChanged=false};T.prototype._formatTypedAheadValue=function(e){return this._sTypedInValue.concat(e.substring(this._sTypedInValue.length,e.length))};T.prototype._onsapright=function(){var e=this._oInput,t=e.getValue();if(!this._bAutocompleteEnabled){return}if(this._sTypedInValue!==t){this._sTypedInValue=t;e.fireLiveChange({value:t,newValue:t})}};T.prototype.updateValueState=function(e,t,s){var i=s&&e!==L.None;t=t||o.getAdditionalText(e);if(!this.getPopover()){return this}if(this._oPopupInput){this._oPopupInput.setValueState(e)}this._getValueStateHeader().setValueState(e);if(this._oValueStateHeader&&typeof t==="string"){this._oValueStateHeader.setText(t)}else if(this._oValueStateHeader&&typeof t==="object"){this._oValueStateHeader.setFormattedText(t)}if(this._oValueStateHeader){this._oValueStateHeader.setVisible(i)}this._alignValueStateStyles(e);return this};T.prototype._alignValueStateStyles=function(e){var t=b+"ValueState",s=b+this._sOldValueState+"State",o=b+e+"State",i=this.getPopover();i.addStyleClass(t);i.removeStyleClass(s);i.addStyleClass(o);this._sOldValueState=e};T.prototype.addContent=function(e){this.getPopover().addContent(e)};T.prototype.getPickerTitle=function(){return null};T.prototype.getOkButton=function(){return null};T.prototype.getCancelButton=function(){return null};T.prototype.getFilterSelectedButton=function(){return null};T.prototype.setOkPressHandler=function(){return null};T.prototype.setCancelPressHandler=function(){return null};T.prototype.setShowSelectedPressHandler=function(){return null};T.prototype.resizePopup=function(){};return T});