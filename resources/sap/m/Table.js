/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Core","sap/ui/Device","./library","./ListBase","./ListItemBase","./CheckBox","./TableRenderer","sap/base/Log","sap/ui/core/ResizeHandler","sap/ui/core/util/PasteHelper","sap/ui/events/KeyCodes","sap/ui/thirdparty/jquery","sap/m/ListBaseRenderer","sap/ui/dom/jquery/Selectors"],function(e,t,i,o,s,n,r,a,l,h,u,p,d){"use strict";var f=i.ListKeyboardMode;var c=i.ListGrowingDirection;var g=i.BackgroundDesign;var y=i.PopinLayout;var m=i.ScreenSizes;var C=o.extend("sap.m.Table",{metadata:{library:"sap.m",properties:{backgroundDesign:{type:"sap.m.BackgroundDesign",group:"Appearance",defaultValue:g.Translucent},fixedLayout:{type:"any",group:"Behavior",defaultValue:true},showOverlay:{type:"boolean",group:"Appearance",defaultValue:false},alternateRowColors:{type:"boolean",group:"Appearance",defaultValue:false},popinLayout:{type:"sap.m.PopinLayout",group:"Appearance",defaultValue:y.Block},contextualWidth:{type:"string",group:"Behavior",defaultValue:"Inherit"},autoPopinMode:{type:"boolean",group:"Behavior",defaultValue:false},hiddenInPopin:{type:"sap.ui.core.Priority[]",group:"Behavior"}},aggregations:{columns:{type:"sap.m.Column",multiple:true,singularName:"column",dnd:{draggable:true,droppable:true,layout:"Horizontal"}}},events:{beforeOpenContextMenu:{allowPreventDefault:true,parameters:{listItem:{type:"sap.m.ColumnListItem"},column:{type:"sap.m.Column"}}},paste:{allowPreventDefault:true,parameters:{data:{type:"string[][]"}}},popinChanged:{parameters:{hasPopin:{type:"boolean"},hiddenInPopin:{type:"sap.m.Column[]"}}}},designtime:"sap/m/designtime/Table.designtime"}});C.prototype.sNavItemClass="sapMListTblRow";C.prototype.init=function(){this._iItemNeedsColumn=0;o.prototype.init.call(this)};C.prototype.setContextualWidth=function(e){var t=this.getContextualWidth();if(e==t){return this}if(typeof e==="number"){this._sContextualWidth=e+"px";this._sContextualWidth=this._sContextualWidth.toLowerCase()}else{var i=e.toLowerCase(),o=m[i];if(o){this._sContextualWidth=o+"px"}else{this._sContextualWidth=e}}var s=this._validateContextualWidth(this._sContextualWidth);this._iLastContextualWidth=t;if(s){this.setProperty("contextualWidth",e,true)}else{return this}if(this._iLastContextualWidth.toLowerCase()==="auto"){this._deregisterResizeHandler()}if(this._sContextualWidth.toLowerCase()==="auto"){this._registerResizeHandler();this._applyContextualWidth(this.$().width())}else{this._applyContextualWidth(this._sContextualWidth)}return this};C.prototype._validateContextualWidth=function(e){if(!e){return}if(typeof e!="string"){throw new Error('expected string for property "contextualWidth" of '+this)}if(e.toLowerCase()==="auto"||e.toLowerCase()==="inherit"){return true}if(!/^\d+(\.\d+)?(px)$/i.test(e)){throw new Error('invalid CSS size("px", "Auto", "auto", Inherit", "inherit" required) or sap.m.ScreenSize enumeration for property "contextualWidth" of '+this)}return true};C.prototype._applyContextualWidth=function(e){e=parseFloat(e)||0;if(e){this._applyContextualSettings({contextualWidth:e})}};C.prototype._onResize=function(e){this._applyContextualWidth(e.size.width)};C.prototype._registerResizeHandler=function(){if(!this._iResizeHandlerId){var e=this;window.requestAnimationFrame(function(){e._iResizeHandlerId=l.register(e,e._onResize.bind(e))})}};C.prototype._deregisterResizeHandler=function(){if(this._iResizeHandlerId){l.deregister(this._iResizeHandlerId);this._iResizeHandlerId=null}};C.prototype.onBeforeRendering=function(){o.prototype.onBeforeRendering.call(this);this._bHasDynamicWidthCol=this._hasDynamicWidthColumn();if(this.getAutoPopinMode()){this._configureAutoPopin();this._bAutoPopinMode=true}else{this._bAutoPopinMode=false}this._applyContextualWidth(this._sContextualWidth);this._ensureColumnsMedia();this._notifyColumns("ItemsRemoved")};C.prototype._hasDynamicWidthColumn=function(e,t){if(this.getFixedLayout()!="Strict"){return true}return this.getColumns().some(function(i){if(i.getVisible()){var o=e&&e==i?t:i.getWidth();return!o||o=="auto"}})};C.prototype._ensureColumnsMedia=function(){this.getColumns().forEach(function(e){if(e._bShouldAddMedia){e._addMedia()}})};C.prototype.onAfterRendering=function(){o.prototype.onAfterRendering.call(this);this.updateSelectAllCheckbox();if(this.getFixedLayout()){this._forceStyleChange()}this._renderOverlay();if(this._bPopinChanged){this._firePopinChangedEvent();this._bPopinChanged=false}};C.prototype._renderOverlay=function(){var e=this.$(),t=e.find(".sapMTableOverlay"),i=this.getShowOverlay();if(i&&t.length===0){t=p("<div>").addClass("sapUiOverlay sapMTableOverlay").css("z-index","1");e.append(t)}else if(!i){t.remove()}};C.prototype.setShowOverlay=function(e){this.setProperty("showOverlay",e,true);this._renderOverlay();return this};C.prototype.exit=function(){o.prototype.exit.call(this);if(this._selectAllCheckBox){this._selectAllCheckBox.destroy();this._selectAllCheckBox=null}};C.prototype.destroyItems=function(){this._notifyColumns("ItemsRemoved");return o.prototype.destroyItems.apply(this,arguments)};C.prototype.removeAllItems=function(){this._notifyColumns("ItemsRemoved");return o.prototype.removeAllItems.apply(this,arguments)};C.prototype.removeSelections=function(){o.prototype.removeSelections.apply(this,arguments);this.updateSelectAllCheckbox();return this};C.prototype.selectAll=function(){o.prototype.selectAll.apply(this,arguments);this.updateSelectAllCheckbox();return this};C.prototype.getColumns=function(e){var t=this.getAggregation("columns",[]);if(e){t.sort(function(e,t){return e.getOrder()-t.getOrder()})}return t};C.prototype.setFixedLayout=function(e){if(e==undefined||e=="true"){e=true}else if(e=="false"){e=false}if(typeof e=="boolean"||e=="Strict"){return this.setProperty("fixedLayout",e)}throw new Error('"'+e+'" is an invalid value, expected false, true or "Strict" for the property fixedLayout of '+this)};C.prototype.onBeforePageLoaded=function(){if(this.getAlternateRowColors()){this._sAlternateRowColorsClass=this._getAlternateRowColorsClass()}o.prototype.onBeforePageLoaded.apply(this,arguments)};C.prototype.onAfterPageLoaded=function(){this.updateSelectAllCheckbox();if(this.getAlternateRowColors()&&this._sAlternateRowColorsClass!=this._getAlternateRowColorsClass()){var e=this.$("tblBody").removeClass(this._sAlternateRowColorsClass);e.addClass(this._getAlternateRowColorsClass())}o.prototype.onAfterPageLoaded.apply(this,arguments)};C.prototype.shouldRenderItems=function(){return this.getColumns().some(function(e){return e.getVisible()})};C.prototype.onItemTypeColumnChange=function(e,t){this._iItemNeedsColumn+=t?1:-1;if(this._iItemNeedsColumn==1&&t){this._setTypeColumnVisibility(true)}else if(this._iItemNeedsColumn==0){this._setTypeColumnVisibility(false)}};C.prototype.onItemSelectedChange=function(e,t){o.prototype.onItemSelectedChange.apply(this,arguments);setTimeout(function(){this.updateSelectAllCheckbox()}.bind(this),0)};C.prototype.getTableDomRef=function(){return this.getDomRef("listUl")};C.prototype.getItemsContainerDomRef=function(){return this.getDomRef("tblBody")};C.prototype.setNavigationItems=function(e){var t=this.$("tblHeader");var i=this.$("tblFooter");var o=this.$("tblBody").children(".sapMLIB");var s=t.add(o).add(i).get();e.setItemDomRefs(s);if(e.getFocusedIndex()==-1){if(this.getGrowing()&&this.getGrowingDirection()==c.Upwards){e.setFocusedIndex(s.length-1)}else{e.setFocusedIndex(t[0]?1:0)}}};C.prototype.checkGrowingFromScratch=function(){if(this.hasPopin()){return false}return this.getColumns().some(function(e){return e.getVisible()&&e.getMergeDuplicates()})};C.prototype.onColumnPress=function(e){this.bActiveHeaders&&this.fireEvent("columnPress",{column:e})};C.prototype.onColumnResize=function(e){if(!this.hasPopin()&&!this._mutex){var t=this.getColumns().some(function(e){return e.isPopin()});if(!t){e.setDisplay(this.getTableDomRef(),!e.isHidden());setTimeout(function(){var e=this.getHiddenInPopin()||[];var t=e.some(function(e){return!!e});if(t){this._firePopinChangedEvent()}}.bind(this),100);return}}this._dirty=this._getMediaContainerWidth()||window.innerWidth;if(!this._mutex){var i=this._getMediaContainerWidth()||window.innerWidth;this._mutex=true;this.rerender();setTimeout(function(){if(this._dirty!=i){this._dirty=0;this.rerender()}this._mutex=false}.bind(this),200)}};C.prototype.setTableHeaderVisibility=function(e){if(!this.getDomRef()){return}if(!this.shouldRenderItems()){return this.invalidate()}var t=this.$("tblHeader"),i=!t.hasClass("sapMListTblHeaderNone"),o=t.find(".sapMListTblCell:visible"),s=o.eq(0);if(o.length==1){s.width("")}else{o.each(function(){this.style.width=this.getAttribute("data-sap-width")||""})}this._colCount=o.length+3+!!d.ModeOrder[this.getMode()];this.$("tblBody").find(".sapMGHLICell").attr("colspan",this.getColSpan());this.$("nodata-text").attr("colspan",this.getColCount());if(this.hasPopin()){this.$("tblBody").find(".sapMListTblSubRowCell").attr("colspan",this.getColSpan())}if(this.getFixedLayout()){this._forceStyleChange()}if(!e&&i){t[0].className="sapMListTblRow sapMLIBFocusable sapMListTblHeader";this._headerHidden=false}else if(e&&!i&&!o.length){t[0].className="sapMListTblHeaderNone";this._headerHidden=true}};C.prototype._forceStyleChange=function(){if(t.browser.msie||t.browser.edge){var e=this.getTableDomRef().style;e.listStyleType="circle";window.setTimeout(function(){e.listStyleType="none"},0)}};C.prototype._setTypeColumnVisibility=function(e){p(this.getTableDomRef()).toggleClass("sapMListTblHasNav",e);if(this.getAutoPopinMode()){this._configureAutoPopin(true)}};C.prototype._notifyColumns=function(e,t,i){this.getColumns().forEach(function(o){o["on"+e](t,i)})};C.prototype._getSelectAllCheckbox=function(){if(this.bPreventMassSelection){return}if(!this._selectAllCheckBox){this._selectAllCheckBox=new n({id:this.getId("sa"),activeHandling:false}).addStyleClass("sapMLIBSelectM").setParent(this,null,true).attachSelect(function(){if(this._selectAllCheckBox.getSelected()){this.selectAll(true)}else{this.removeSelections(false,true)}},this).setTabIndex(-1)}this._selectAllCheckBox.getEnabled=function(){return this._selectAllCheckBox.getProperty("enabled")}.bind(this);return this._selectAllCheckBox};C.prototype.updateSelectAllCheckbox=function(){if(this._selectAllCheckBox&&this.getMode()==="MultiSelect"){var e=this.getItems(),t=this.getSelectedItems().length,i=e.filter(function(e){return e.isSelectable()}).length;this._selectAllCheckBox.setSelected(e.length>0&&t==i)}};C.prototype.enhanceAccessibilityState=function(t,i){if(t==this._selectAllCheckBox){var o=e.getLibraryResourceBundle("sap.m");i.label=o.getText("TABLE_CHECKBOX_SELECT_ALL")}};C.prototype.getColSpan=function(){var e=this.shouldRenderDummyColumn()?3:2;return(this._colCount||1)-e};C.prototype.getColCount=function(){return this._colCount||0};C.prototype.shouldRenderDummyColumn=function(){return!this._bHasDynamicWidthCol&&this.shouldRenderItems()};C.prototype.hasPopin=function(){return!!this._hasPopin};C.prototype.isHeaderRowEvent=function(e){var t=this.$("tblHeader");return!!p(e.target).closest(t,this.getTableDomRef()).length};C.prototype.isFooterRowEvent=function(e){var t=this.$("tblFooter");return!!p(e.target).closest(t,this.getTableDomRef()).length};C.prototype.getAccessibilityType=function(){return e.getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_TABLE")};C.prototype._setHeaderAnnouncement=function(){var t=e.getLibraryResourceBundle("sap.m"),i=t.getText("ACC_CTR_TYPE_HEADER_ROW")+" ";if(this.isAllSelectableSelected()){i+=t.getText("LIST_ALL_SELECTED")}this.getColumns(true).forEach(function(e,t){if(!e.getVisible()){return}var o=e.getHeader();if(o&&o.getVisible()){i+=s.getAccessibilityText(o)+" "}});this.updateInvisibleText(i)};C.prototype._setFooterAnnouncement=function(){var t=e.getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_FOOTER_ROW")+" ";this.getColumns(true).forEach(function(e,i){if(!e.getVisible()){return}var o=e.getFooter();if(o&&o.getVisible()){var n=e.getHeader();if(n&&n.getVisible()){t+=s.getAccessibilityText(n)+" "}t+=s.getAccessibilityText(o)+" "}});this.updateInvisibleText(t)};C.prototype.onsapspace=function(e){if(e.isMarked()){return}if(e.target.id==this.getId("tblHeader")){e.preventDefault();if(this._selectAllCheckBox){this._selectAllCheckBox.setSelected(!this._selectAllCheckBox.getSelected()).fireSelect();e.setMarked()}}};C.prototype.onsaptabnext=function(e){if(e.isMarked()||this.getKeyboardMode()==f.Edit){return}var t=p();if(e.target.id==this.getId("nodata")){t=this.$("nodata")}else if(this.isHeaderRowEvent(e)){t=this.$("tblHeader")}else if(this.isFooterRowEvent(e)){t=this.$("tblFooter")}var i=t.find(":sapTabbable").get(-1)||t[0];if(e.target===i){this.forwardTab(true);e.setMarked()}};C.prototype.onsaptabprevious=function(e){if(e.isMarked()||this.getKeyboardMode()==f.Edit){return}var t=e.target.id;if(t==this.getId("nodata")||t==this.getId("tblHeader")||t==this.getId("tblFooter")){this.forwardTab(false)}else if(t==this.getId("trigger")){this.focusPrevious();e.preventDefault()}};C.prototype.onfocusin=function(e){var t=e.target;if(t.id==this.getId("tblHeader")){this._setHeaderAnnouncement();this._setFirstLastVisibleCells(t)}else if(t.id==this.getId("tblFooter")){this._setFooterAnnouncement();this._setFirstLastVisibleCells(t)}else if(t.id==this.getId("nodata")){this._setFirstLastVisibleCells(t)}if(this._bThemeChanged){this._bThemeChanged=false;this._forceStyleChange()}o.prototype.onfocusin.call(this,e)};C.prototype.onThemeChanged=function(){o.prototype.onThemeChanged.call(this);this._bThemeChanged=true};C.prototype._getAlternateRowColorsClass=function(){if(this.isGrouped()){return"sapMListTblAlternateRowColorsGrouped"}if(this.hasPopin()){return"sapMListTblAlternateRowColorsPopin"}return"sapMListTblAlternateRowColors"};C.prototype.onpaste=function(e){if(e.isMarked()||/^(input|textarea)$/i.test(e.target.tagName)){return}var t=h.getPastedDataAs2DArray(e.originalEvent);if(!t||t.length===0||t[0].length===0){return}this.firePaste({data:t})};C.prototype.onkeydown=function(e){o.prototype.onkeydown.apply(this,arguments);if(t.browser.msie&&e.ctrlKey&&e.which===u.V){this.onpaste(e)}};C.prototype.ondragenter=function(e){var t=e.dragSession;if(!t||!t.getDropControl()||!t.getDropControl().isA("sap.m.Column")){return}t.setIndicatorConfig({height:this.getTableDomRef().clientHeight})};C.prototype.onColumnWidthChanged=function(e,t){this._bHasDynamicWidthCol=this._hasDynamicWidthColumn(e,t)};C.prototype.onColumnRecalculateAutoPopin=function(e,t){if(this.getAutoPopinMode()){this._configureAutoPopin(t)}};C.prototype._requireAutoPopinRecalculation=function(e){var t=this.getAutoPopinMode();if(this._bAutoPopinMode!==t){this._bAutoPopinMode=t;return true}if(e.length!==this._aVisibleColumns.length){return true}for(var i=0;i<e.length;i++){if(e[i]!==this._aVisibleColumns[i]){return true}}return this.shouldRenderDummyColumn()};C.prototype._configureAutoPopin=function(e){var t=this.getColumns(true).filter(function(e){return e.getVisible()});if(!t.length){return}if(!this._aVisibleColumns||!e&&this._requireAutoPopinRecalculation(t)){this._aVisibleColumns=t;if(!e){e=true}}if(e){var i=this.getItems();var o=[];var s=[];var n=[];for(var r=0;r<t.length;r++){var a=t[r].getImportance();if(a==="Medium"||a==="None"){s.push(t[r])}else if(a==="High"){o.push(t[r])}else{n.push(t[r])}}var l=this._getInitialAccumulatedWidth(i)||6.5;l+=this.shouldRenderDummyColumn()?1:0;l=C._updateAccumulatedWidth(o,o.length>0,l);l=C._updateAccumulatedWidth(s,o.length===0&&s.length>0,l);C._updateAccumulatedWidth(n,o.length===0&&s.length===0&&n.length>0,l)}};C.prototype._getInitialAccumulatedWidth=function(e){var t=e.find(function(e){return e.getHighlight()!=="None"});var i=t?.375:0;var o=this.getMode(),s=o==="MultiSelect"||o==="Delete"||o==="SingleSelect"||o==="SingleSelectLeft"?3:0;var n=e.find(function(e){var t=e.getType();return t==="Detail"||t==="DetailAndActive"||e.getType()==="Navigation"});var r=n?3:0;var a=e.find(function(e){return e.getNavigated()});var l=a?.1875:0;return i+s+r+l};C._updateAccumulatedWidth=function(e,t,o){var s=o;for(var n=0;n<e.length;n++){e[n].setDemandPopin(!(t&&n===0));var r=e[n].getWidth();var a=r.replace(/[^a-z]/gi,"");var l=parseFloat(i.BaseFontSize)||16;if(a===""||a==="auto"){s=s+e[n].getAutoPopinWidth()}else if(a==="px"){s=s+parseFloat((parseFloat(r).toFixed(2)/l).toFixed(2))}else if(a==="em"||a==="rem"){s=s+parseFloat(r)}if(e[n].getDemandPopin()){e[n].setMinScreenWidth(s+"rem")}else{e[n].setMinScreenWidth()}}return s};C.prototype._getHiddenInPopin=function(){var e=this.getColumns().filter(function(e){return e.getVisible()&&e.getDemandPopin()});var t=e.filter(function(e){return e._media&&!e._media.matches&&!e.isPopin()});this._iHiddenPopinColumns=t.length;return t};C.prototype._firePopinChangedEvent=function(){this.fireEvent("popinChanged",{hasPopin:this.hasPopin(),hiddenInPopin:this._getHiddenInPopin()})};C.prototype._fireUpdateFinished=function(e){o.prototype._fireUpdateFinished.apply(this,arguments);if(this._bPopinChanged==null){this._iVisibleItemsLength=this.getVisibleItems().length;return}var t=this.getVisibleItems().length;if(!this._iVisibleItemsLength&&t>0){this._iVisibleItemsLength=t;this._firePopinChangedEvent()}else if(this._iVisibleItemsLength>0&&!t){this._iVisibleItemsLength=t;this._firePopinChangedEvent()}};C.prototype.onItemFocusIn=function(t,i){o.prototype.onItemFocusIn.apply(this,arguments);if(t!=i||!e.getConfiguration().getAccessibility()){return}this._setFirstLastVisibleCells(t.getDomRef())};C.prototype._setFirstLastVisibleCells=function(e){if(this.hasPopin()||!this.shouldRenderDummyColumn()){return}var t=p(e);t.find(".sapMTblLastVisibleCell").removeClass("sapMTblLastVisibleCell");t.find(".sapMTblFirstVisibleCell").removeClass("sapMTblFirstVisibleCell");for(var i=e.firstChild;i&&!i.clientWidth;i=i.nextSibling){}for(var o=e.lastChild.previousSibling;o&&!o.clientWidth;o=o.previousSibling){}p(i).addClass("sapMTblFirstVisibleCell");p(o).addClass("sapMTblLastVisibleCell")};return C});