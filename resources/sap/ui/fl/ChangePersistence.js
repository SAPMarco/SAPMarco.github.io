/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/StorageUtils","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/Variant","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Cache","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/write/_internal/Storage","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ui/thirdparty/jquery","sap/base/util/includes","sap/base/util/merge","sap/base/Log","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState"],function(e,t,n,a,r,i,s,o,h,p,g,c,f,l,u,d,C,m,y){"use strict";var _=function(t){this._mComponent=t;this._mChanges=e.createEmptyDependencyMap();this._bChangesMapCreated=false;this._mChangesInitial=C({},this._mChanges);this._mVariantsChanges={};if(!this._mComponent||!this._mComponent.name){m.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.")}this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist"};function v(e,t){return e.controlChanges.some(function(n,a){if(n.fileName===t.getDefinition().fileName){e.controlChanges.splice(a,1,t);return true}})}function D(e,t){var a;if(t instanceof n){a=t;this._mChangesEntries[a.getFileName()]=a}else{if(!this._mChangesEntries[t.fileName]){this._mChangesEntries[t.fileName]=new n(t)}a=this._mChangesEntries[t.fileName];a.setState(n.states.PERSISTED);var r=a.getVariantReference();if(r){var i=y.getVariant({vReference:r,reference:this._mComponent.name});if(i){v(i,a)}}}return a}_.prototype.getComponentName=function(){return this._mComponent.name};_.prototype.getCacheKey=function(e){return o.getCacheKey(this._mComponent,e)};_.prototype._preconditionsFulfilled=function(e,t){var a=t instanceof n?t.getDefinition():t;if(!a.fileName){m.warning("A change without fileName is detected and excluded from component: "+this._mComponent.name);return false}function r(){if(e){return a.fileType==="change"||a.fileType==="variant"}return a.fileType==="change"&&a.changeType!=="defaultVariant"}function i(){if(e){if(a.fileType==="variant"||a.changeType==="defaultVariant"){return a.selector&&a.selector.persistencyKey}}return true}function s(){if(a.fileType==="ctrl_variant"||a.fileType==="ctrl_variant_change"||a.fileType==="ctrl_variant_management_change"){return a.variantManagementReference||a.variantReference||a.selector&&a.selector.id}}if(r()&&i()||s()){return true}return false};_.prototype.getChangesForComponent=function(e,n){return o.getChangesFillingCache(this._mComponent,e,n).then(function(e,n){var r=C({},n);var o=e&&e.component&&i.getAppComponentForControl(e.component);var h=t.isStorageResponseFilled(r.changes);if(!h){return[]}var p=r.changes.changes;if(!this._oMessagebundle&&r.messagebundle&&o){if(!o.getModel("i18nFlexVendor")){if(p.some(function(e){return e.layer===a.VENDOR})){this._oMessagebundle=r.messagebundle;var g=new f(this._oMessagebundle);o.setModel(g,"i18nFlexVendor")}}}var c=e&&e.currentLayer;var l=!(e&&e.ignoreMaxLayerParameter);var u=function(){return true};if(c){u=this._filterChangeForCurrentLayer.bind(this,c);p=p.filter(u)}else if(s.isLayerFilteringRequired()&&l){u=this._filterChangeForMaxLayer.bind(this);p=p.filter(u)}else if(this._bHasChangesOverMaxLayer&&!l){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST}var d=r.changes&&e&&e.includeCtrlVariants;var m=this._getAllCtrlVariantChanges(r,d,u);p=p.concat(m);var y=e&&e.includeVariants;return this._checkAndGetChangeInstances(p,y,r)}.bind(this,e))};_.prototype._checkAndGetChangeInstances=function(e,t,n){return e.filter(this._preconditionsFulfilled.bind(this,t)).map(D.bind(this,n))};_.prototype._filterChangeForMaxLayer=function(e){if(s.isOverMaxLayer(this._getLayerFromChangeOrChangeContent(e))){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true}return false}return true};_.prototype._filterChangeForCurrentLayer=function(e,t){return e===this._getLayerFromChangeOrChangeContent(t)};_.prototype._getLayerFromChangeOrChangeContent=function(e){var t;if(e instanceof r||e instanceof n){t=e.getLayer()}else{t=e.layer}return t};_.prototype._getAllCtrlVariantChanges=function(e,t,n){if(!t){return y.getInitialChanges({reference:this._mComponent.name})}return["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"].reduce(function(t,n){if(e.changes[n]){return t.concat(e.changes[n])}return t},[]).filter(n)};_.prototype.getSmartVariantManagementChangeMap=function(){return this._mVariantsChanges};_.prototype.getChangesForVariant=function(e,t,n){if(this._mVariantsChanges[t]){return Promise.resolve(this._mVariantsChanges[t])}var a=function(n){var a=false;var r=n._oDefinition.selector;u.each(r,function(n,r){if(n===e&&r===t){a=true}});return a};var r=function(e,t){m.error("key : "+e+" and text : "+t.value)};return this.getChangesForComponent(n).then(function(e){return e.filter(a)}).then(function(e){if(!this._mVariantsChanges[t]){this._mVariantsChanges[t]={}}var n;e.forEach(function(e){n=e.getId();if(e.isValid()){if(this._mVariantsChanges[t][n]&&e.isVariant()){m.error("Id collision - two or more variant files having the same id detected: "+n);u.each(e.getDefinition().texts,r);m.error("already exists in variant : ");u.each(this._mVariantsChanges[t][n].getDefinition().texts,r)}this._mVariantsChanges[t][n]=e}}.bind(this));return this._mVariantsChanges[t]}.bind(this))};_.prototype.addChangeForVariant=function(e,t,a){var r;var i;var s;var o;var h;if(!a){return undefined}if(!a.type){m.error("sap.ui.fl.Persistence.addChange : type is not defined")}var p=u.type(a.content);if(p!=="object"&&p!=="array"){m.error("mParameters.content is not of expected type object or array, but is: "+p,"sap.ui.fl.Persistence#addChange")}s={};if(typeof a.texts==="object"){u.each(a.texts,function(e,t){s[e]={value:t,type:"XFLD"}})}var g={creation:this._mComponent.appVersion,from:this._mComponent.appVersion};if(this._mComponent.appVersion&&a.developerMode){g.to=this._mComponent.appVersion}i={changeType:a.type,service:a.ODataService,texts:s,content:a.content,reference:this._mComponent.name,isVariant:a.isVariant,packageName:a.packageName,isUserDependent:a.isUserDependent,validAppVersions:g};i.selector={};i.selector[e]=t;r=n.createInitialFileContent(i);if(a.id){r.fileName=a.id}o=new n(r);h=o.getId();if(!this._mVariantsChanges[t]){this._mVariantsChanges[t]={}}this._mVariantsChanges[t][h]=o;return o.getId()};_.prototype.saveAllChangesForVariant=function(e){var t=[];u.each(this._mVariantsChanges[e],function(a,r){var i=r.getId();switch(r.getPendingAction()){case"NEW":var s=p.write({flexObjects:[r.getDefinition()],layer:r.getLayer(),transport:r.getRequest(),isLegacyVariant:r.isVariant()}).then(function(e){if(e&&e.response&&e.response[0]){r.setResponse(e.response[0])}else{r.setState(n.states.PERSISTED)}o.addChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},r.getDefinition());return e}.bind(this));t.push(s);break;case"UPDATE":var h=p.update({flexObject:r.getDefinition(),layer:r.getLayer(),transport:r.getRequest()}).then(function(e){if(e&&e.response){r.setResponse(e.response)}else{r.setState(n.states.PERSISTED)}o.updateChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},r.getDefinition());return e}.bind(this));t.push(h);break;case"DELETE":var g=p.remove({flexObject:r.getDefinition(),layer:r.getLayer(),transport:r.getRequest()}).then(function(t){var n=this._mVariantsChanges[e][i];if(n.getPendingAction()==="DELETE"){delete this._mVariantsChanges[e][i]}o.deleteChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},n.getDefinition());return t}.bind(this));t.push(g);break;default:break}}.bind(this));return Promise.all(t)};_.prototype.loadChangesMapForComponent=function(t){return this.getChangesForComponent({component:t}).then(n.bind(this));function n(n){l.start("fl.createDependencyMap","Measurement of creating initial dependency map");this._mChanges=e.createEmptyDependencyMap();n.forEach(this._addChangeAndUpdateDependencies.bind(this,t));this._mChangesInitial=C({},this._mChanges);l.end("fl.createDependencyMap","Measurement of creating initial dependency map");this._bChangesMapCreated=true;return this.getChangesMapForComponent.bind(this)}};_.prototype.checkForOpenDependenciesForControl=function(t,n){return e.checkForOpenDependenciesForControl(this._mChanges,g.getControlIdBySelector(t,n),n)};_.prototype.copyDependenciesFromInitialChangesMap=function(e,t,n){var a=C({},this._mChangesInitial.mDependencies);var r=a[e.getId()];if(r){var i=[];r.dependencies.forEach(function(n){if(t(n)){this._mChanges.mDependentChangesOnMe[n]=this._mChanges.mDependentChangesOnMe[n]||[];this._mChanges.mDependentChangesOnMe[n].push(e.getId());i.push(n)}}.bind(this));var s;var o=[];r.controlsDependencies.forEach(function(t){if(!g.bySelector(t,n)){s=g.getControlIdBySelector(t,n);o.push(t);this._mChanges.mControlsWithDependencies[s]=this._mChanges.mControlsWithDependencies[s]||[];if(!d(this._mChanges.mControlsWithDependencies[s],e.getId())){this._mChanges.mControlsWithDependencies[s].push(e.getId())}}}.bind(this));r.dependencies=i;r.controlsDependencies=o;if(i.length||o.length){this._mChanges.mDependencies[e.getId()]=r}}return this._mChanges};_.prototype._addChangeAndUpdateDependencies=function(t,n){n.setInitialApplyState();e.addChangeAndUpdateDependencies(n,t,this._mChanges)};_.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(t,n){e.addRuntimeChangeAndUpdateDependencies(n,t,this._mChanges,this._mChangesInitial)};_.prototype.getChangesMapForComponent=function(){return this._mChanges};_.prototype.isChangeMapCreated=function(){return this._bChangesMapCreated};_.prototype.changesHavingCorrectViewPrefix=function(e,t){var n=e.modifier;var a=e.appComponent;var r=t.getSelector();if(!r||!e){return false}if(r.viewSelector){var i=n.getControlIdBySelector(r.viewSelector,a);return i===e.viewId}var s=r.id;if(s){var o;if(t.getSelector().idIsLocal){if(a){o=a.getLocalId(e.viewId)}}else{o=e.viewId}var h=0;var p;do{h=s.indexOf("--",h);p=s.slice(0,h);h++}while(p!==o&&h>0);return p===o}return false};_.prototype.getChangesForView=function(e){return this.getChangesForComponent(e).then(function(t){return t.filter(this.changesHavingCorrectViewPrefix.bind(this,e))}.bind(this))};_.prototype.addChange=function(e,t){var n=this.addDirtyChange(e);this._addRunTimeCreatedChangeAndUpdateDependencies(t,n);this._addPropagationListener(t);return n};_.prototype.addDirtyChange=function(e){var t;if(e instanceof n||e instanceof r){t=e}else{t=new n(e)}if(this._aDirtyChanges.indexOf(t)===-1){this._aDirtyChanges.push(t)}return t};_.prototype._addPropagationListener=function(e){var t=i.getAppComponentForControl(e);if(t instanceof c){var n=function(e){return!e._bIsSapUiFlFlexControllerApplyChangesOnControl};var a=t.getPropagationListeners().every(n);if(a){var r=t.getManifestObject();var s=i.getAppVersionFromManifest(r);var o=sap.ui.require("sap/ui/fl/FlexControllerFactory");var p=o.create(this.getComponentName(),s);var g=h.applyAllChangesForControl.bind(h,this.getChangesMapForComponent.bind(this),t,p);g._bIsSapUiFlFlexControllerApplyChangesOnControl=true;t.addPropagationListener(g)}}};_.prototype.saveDirtyChanges=function(e,t,n){var a=t||this._aDirtyChanges;var r=a.slice(0);var i=this._getRequests(a);var s=this._getPendingActions(a);if(s.length===1&&i.length===1&&s[0]==="NEW"){var o=i[0];var h=this._prepareDirtyChanges(a);return p.write({layer:h[0].layer,flexObjects:h,transport:o,isLegacyVariant:false,draft:n}).then(function(t){this._massUpdateCacheAndDirtyState(r,e);return t}.bind(this))}return this.saveSequenceOfDirtyChanges(r,e,n)};_.prototype.saveSequenceOfDirtyChanges=function(e,t,n){return e.reduce(function(e,a){return e.then(this._performSingleSaveAction(a,n)).then(this._updateCacheAndDirtyState.bind(this,a,t))}.bind(this),Promise.resolve())};_.prototype._performSingleSaveAction=function(e,t){return function(){if(e.getPendingAction()==="NEW"){return p.write({layer:e.getLayer(),flexObjects:[e.getDefinition()],transport:e.getRequest(),isLegacyVariant:e.isVariant(),draft:t})}if(e.getPendingAction()==="DELETE"){return p.remove({flexObject:e.getDefinition(),layer:e.getLayer(),transport:e.getRequest()})}}};_.prototype._updateCacheAndDirtyState=function(e,t){if(!t){if(i.isChangeRelatedToVariants(e)){y.updateVariantsState({reference:this._mComponent.name,changeToBeAddedOrDeleted:e})}else if(e.getPendingAction()==="NEW"){o.addChange(this._mComponent,e.getDefinition())}else if(e.getPendingAction()==="DELETE"){o.deleteChange(this._mComponent,e.getDefinition())}}this._aDirtyChanges=this._aDirtyChanges.filter(function(t){return e.getId()!==t.getId()})};_.prototype._massUpdateCacheAndDirtyState=function(e,t){e.forEach(function(e){this._updateCacheAndDirtyState(e,t)},this)};_.prototype._getRequests=function(e){var t=[];e.forEach(function(e){var n=e.getRequest();if(t.indexOf(n)===-1){t.push(n)}});return t};_.prototype._getPendingActions=function(e){var t=[];e.forEach(function(e){var n=e.getPendingAction();if(t.indexOf(n)===-1){t.push(n)}});return t};_.prototype._prepareDirtyChanges=function(e){var t=[];e.forEach(function(e){t.push(e.getDefinition())});return t};_.prototype.getDirtyChanges=function(){return this._aDirtyChanges};_.prototype.deleteChange=function(e,t){var n=this._aDirtyChanges.indexOf(e);if(n>-1){if(e.getPendingAction()==="DELETE"){return}this._aDirtyChanges.splice(n,1);this._deleteChangeInMap(e,t);return}e.markForDeletion();this.addDirtyChange(e);this._deleteChangeInMap(e,t)};_.prototype._deleteChangeInMap=function(t,n){var a=t.getId();e.removeChangeFromMap(this._mChanges,a);e.removeChangeFromDependencies(n?this._mChangesInitial:this._mChanges,a)};_.prototype.transportAllUIChanges=function(e,t,n,a){return this.getChangesForComponent({currentLayer:n,includeCtrlVariants:true}).then(function(r){return p.publish({transportDialogSettings:{rootControl:e,styleClass:t},layer:n,reference:this.getComponentName(),appVersion:this._mComponent.appVersion,localChanges:r,appVariantDescriptors:a})}.bind(this))};_.prototype._getChangesFromMapByNames=function(e){return this._mChanges.aChanges.filter(function(t){return e.indexOf(t.getFileName())!==-1})};_.prototype.resetChanges=function(e,t,n,a){var r=n&&n.length>0;var i=a&&a.length>0;if(!t&&!r&&!i){m.error("Of the generator, selector IDs and change types parameters at least one has to filled");return Promise.reject("Of the generator, selector IDs and change types parameters at least one has to filled")}return this.getChangesForComponent({currentLayer:e,includeCtrlVariants:true}).then(function(s){var o={reference:this.getComponentName(),appVersion:this._mComponent.appVersion,layer:e,changes:s};if(t){o.generator=t}if(r){o.selectorIds=n}if(i){o.changeTypes=a}return p.reset(o)}.bind(this)).then(function(e){var t=[];if(n||a){var r=[];if(e&&e.response&&e.response.length>0){e.response.forEach(function(e){r.push(e.name)})}o.removeChanges(this._mComponent,r);t=this._getChangesFromMapByNames(r)}return t}.bind(this))};_.prototype.getResetAndPublishInfo=function(e){return p.getFlexInfo(e)};return _},true);