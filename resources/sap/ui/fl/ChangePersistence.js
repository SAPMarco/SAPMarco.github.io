/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/Variant","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Cache","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/write/_internal/Storage","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ui/thirdparty/jquery","sap/base/util/includes","sap/base/util/merge","sap/base/util/UriParameters","sap/base/Log","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/write/_internal/condenser/Condenser"],function(e,t,n,r,a,i,s,o,h,p,g,c,f,l,u,d,C,m,y,_,v){"use strict";var D=function(t){this._mComponent=t;this._mChanges=e.createEmptyDependencyMap();this._bChangesMapCreated=false;this._mChangesInitial=C({},this._mChanges);this._mVariantsChanges={};if(!this._mComponent||!this._mComponent.name){y.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.")}this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist"};function b(e,t){return e.controlChanges.some(function(n,r){if(n.fileName===t.getDefinition().fileName){e.controlChanges.splice(r,1,t);return true}})}function V(e,t){var r;if(t instanceof n){r=t;this._mChangesEntries[r.getFileName()]=r}else{if(!this._mChangesEntries[t.fileName]){this._mChangesEntries[t.fileName]=new n(t)}r=this._mChangesEntries[t.fileName];r.setState(n.states.PERSISTED);var a=r.getVariantReference();if(a){var i=_.getVariant({vReference:a,reference:this._mComponent.name});if(i){b(i,r)}}}return r}D.prototype.getComponentName=function(){return this._mComponent.name};D.prototype.getCacheKey=function(e){return o.getCacheKey(this._mComponent,e)};D.prototype._preconditionsFulfilled=function(e,t){var r=t instanceof n?t.getDefinition():t;if(!r.fileName){y.warning("A change without fileName is detected and excluded from component: "+this._mComponent.name);return false}function a(){if(e){return r.fileType==="change"||r.fileType==="variant"}return r.fileType==="change"&&r.changeType!=="defaultVariant"}function i(){if(e){if(r.fileType==="variant"||r.changeType==="defaultVariant"){return r.selector&&r.selector.persistencyKey}}return true}function s(){if(r.fileType==="ctrl_variant"||r.fileType==="ctrl_variant_change"||r.fileType==="ctrl_variant_management_change"){return r.variantManagementReference||r.variantReference||r.selector&&r.selector.id}}if(a()&&i()||s()){return true}return false};D.prototype.getChangesForComponent=function(e,n){return o.getChangesFillingCache(this._mComponent,e,n).then(function(e,n){var a=C({},n);var o=e&&e.component&&i.getAppComponentForControl(e.component);var h=t.isStorageResponseFilled(a.changes);if(!h){return[]}var p=a.changes.changes;if(!this._oMessagebundle&&a.messagebundle&&o){if(!o.getModel("i18nFlexVendor")){if(p.some(function(e){return e.layer===r.VENDOR})){this._oMessagebundle=a.messagebundle;var g=new f(this._oMessagebundle);o.setModel(g,"i18nFlexVendor")}}}var c=e&&e.currentLayer;var l=!(e&&e.ignoreMaxLayerParameter);var u=function(){return true};if(c){u=this._filterChangeForCurrentLayer.bind(this,c);p=p.filter(u)}else if(s.isLayerFilteringRequired()&&l){u=this._filterChangeForMaxLayer.bind(this);p=p.filter(u)}else if(this._bHasChangesOverMaxLayer&&!l){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST}var d=a.changes&&e&&e.includeCtrlVariants;var m=this._getAllCtrlVariantChanges(a,d,u);p=p.concat(m);var y=e&&e.includeVariants;return this._checkAndGetChangeInstances(p,y,a)}.bind(this,e))};D.prototype._checkAndGetChangeInstances=function(e,t,n){return e.filter(this._preconditionsFulfilled.bind(this,t)).map(V.bind(this,n))};D.prototype._filterChangeForMaxLayer=function(e){if(s.isOverMaxLayer(this._getLayerFromChangeOrChangeContent(e))){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true}return false}return true};D.prototype._filterChangeForCurrentLayer=function(e,t){return e===this._getLayerFromChangeOrChangeContent(t)};D.prototype._getLayerFromChangeOrChangeContent=function(e){var t;if(e instanceof a||e instanceof n){t=e.getLayer()}else{t=e.layer}return t};D.prototype._getAllCtrlVariantChanges=function(e,t,n){if(!t){return _.getInitialChanges({reference:this._mComponent.name})}return["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"].reduce(function(t,n){if(e.changes[n]){return t.concat(e.changes[n])}return t},[]).filter(n)};D.prototype.getSmartVariantManagementChangeMap=function(){return this._mVariantsChanges};D.prototype.getControlChangesForVariant=function(e,t,n){if(this._mVariantsChanges[t]){return Promise.resolve(this._mVariantsChanges[t])}var r=function(n){var r=false;var a=n._oDefinition.selector;u.each(a,function(n,a){if(n===e&&a===t){r=true}});return r};var a=function(e,t){y.error("key : "+e+" and text : "+t.value)};return this.getChangesForComponent(n).then(function(e){return e.filter(r)}).then(function(e){if(!this._mVariantsChanges[t]){this._mVariantsChanges[t]={}}var n;e.forEach(function(e){n=e.getId();if(e.isValid()){if(this._mVariantsChanges[t][n]&&e.isVariant()){y.error("Id collision - two or more variant files having the same id detected: "+n);u.each(e.getDefinition().texts,a);y.error("already exists in variant : ");u.each(this._mVariantsChanges[t][n].getDefinition().texts,a)}this._mVariantsChanges[t][n]=e}}.bind(this));return this._mVariantsChanges[t]}.bind(this))};D.prototype.addChangeForVariant=function(e,t,r){var a;var i;var s;var o;var h;if(!r){return undefined}if(!r.type){y.error("sap.ui.fl.Persistence.addChange : type is not defined")}var p=typeof r.content;if(!r.content||p!=="object"&&!Array.isArray(r.content)){y.error("mParameters.content is not of expected type object or array, but is: "+p,"sap.ui.fl.Persistence#addChange")}s={};if(typeof r.texts==="object"){u.each(r.texts,function(e,t){s[e]={value:t,type:"XFLD"}})}var g={creation:this._mComponent.appVersion,from:this._mComponent.appVersion};if(this._mComponent.appVersion&&r.developerMode){g.to=this._mComponent.appVersion}i={changeType:r.type,service:r.ODataService,texts:s,content:r.content,reference:this._mComponent.name,isVariant:r.isVariant,packageName:r.packageName,isUserDependent:r.isUserDependent,validAppVersions:g};i.selector={};i.selector[e]=t;a=n.createInitialFileContent(i);if(r.id){a.fileName=r.id}o=new n(a);h=o.getId();if(!this._mVariantsChanges[t]){this._mVariantsChanges[t]={}}this._mVariantsChanges[t][h]=o;return o.getId()};D.prototype.saveAllChangesForVariant=function(e){var t=[];u.each(this._mVariantsChanges[e],function(r,a){var i=a.getId();switch(a.getPendingAction()){case"NEW":var s=p.write({flexObjects:[a.getDefinition()],layer:a.getLayer(),transport:a.getRequest(),isLegacyVariant:a.isVariant()}).then(function(e){if(e&&e.response&&e.response[0]){a.setResponse(e.response[0])}else{a.setState(n.states.PERSISTED)}o.addChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},a.getDefinition());return e}.bind(this));t.push(s);break;case"UPDATE":var h=p.update({flexObject:a.getDefinition(),layer:a.getLayer(),transport:a.getRequest()}).then(function(e){if(e&&e.response){a.setResponse(e.response)}else{a.setState(n.states.PERSISTED)}o.updateChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},a.getDefinition());return e}.bind(this));t.push(h);break;case"DELETE":var g=p.remove({flexObject:a.getDefinition(),layer:a.getLayer(),transport:a.getRequest()}).then(function(t){var n=this._mVariantsChanges[e][i];if(n.getPendingAction()==="DELETE"){delete this._mVariantsChanges[e][i]}o.deleteChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},n.getDefinition());return t}.bind(this));t.push(g);break;default:break}}.bind(this));return Promise.all(t)};D.prototype.loadChangesMapForComponent=function(t){return this.getChangesForComponent({component:t}).then(n.bind(this));function n(n){l.start("fl.createDependencyMap","Measurement of creating initial dependency map");this._mChanges=e.createEmptyDependencyMap();n.forEach(this._addChangeAndUpdateDependencies.bind(this,t));this._mChangesInitial=C({},this._mChanges);l.end("fl.createDependencyMap","Measurement of creating initial dependency map");this._bChangesMapCreated=true;return this.getChangesMapForComponent.bind(this)}};D.prototype.checkForOpenDependenciesForControl=function(t,n){return e.checkForOpenDependenciesForControl(this._mChanges,g.getControlIdBySelector(t,n),n)};D.prototype.copyDependenciesFromInitialChangesMap=function(e,t,n){var r=C({},this._mChangesInitial.mDependencies);var a=r[e.getId()];if(a){var i=[];a.dependencies.forEach(function(n){if(t(n)){this._mChanges.mDependentChangesOnMe[n]=this._mChanges.mDependentChangesOnMe[n]||[];this._mChanges.mDependentChangesOnMe[n].push(e.getId());i.push(n)}}.bind(this));var s;var o=[];a.controlsDependencies.forEach(function(t){if(!g.bySelector(t,n)){s=g.getControlIdBySelector(t,n);o.push(t);this._mChanges.mControlsWithDependencies[s]=this._mChanges.mControlsWithDependencies[s]||[];if(!d(this._mChanges.mControlsWithDependencies[s],e.getId())){this._mChanges.mControlsWithDependencies[s].push(e.getId())}}}.bind(this));a.dependencies=i;a.controlsDependencies=o;if(i.length||o.length){this._mChanges.mDependencies[e.getId()]=a}}return this._mChanges};D.prototype._addChangeAndUpdateDependencies=function(t,n){n.setInitialApplyState();e.addChangeAndUpdateDependencies(n,t,this._mChanges)};D.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(t,n){e.addRuntimeChangeAndUpdateDependencies(n,t,this._mChanges,this._mChangesInitial)};D.prototype.getChangesMapForComponent=function(){return this._mChanges};D.prototype.isChangeMapCreated=function(){return this._bChangesMapCreated};D.prototype.changesHavingCorrectViewPrefix=function(e,t){var n=e.modifier;var r=e.appComponent;var a=t.getSelector();if(!a||!e){return false}if(a.viewSelector){var i=n.getControlIdBySelector(a.viewSelector,r);return i===e.viewId}var s=a.id;if(s){var o;if(t.getSelector().idIsLocal){if(r){o=r.getLocalId(e.viewId)}}else{o=e.viewId}var h=0;var p;do{h=s.indexOf("--",h);p=s.slice(0,h);h++}while(p!==o&&h>0);return p===o}return false};D.prototype.getChangesForView=function(e){return this.getChangesForComponent(e).then(function(t){return t.filter(this.changesHavingCorrectViewPrefix.bind(this,e))}.bind(this))};D.prototype.addChange=function(e,t){var n=this.addDirtyChange(e);this._addRunTimeCreatedChangeAndUpdateDependencies(t,n);this._addPropagationListener(t);return n};D.prototype.addDirtyChange=function(e){var t;if(e instanceof n||e instanceof a){t=e}else{t=new n(e)}if(this._aDirtyChanges.indexOf(t)===-1){this._aDirtyChanges.push(t)}return t};D.prototype._addPropagationListener=function(e){var t=i.getAppComponentForControl(e);if(t instanceof c){var n=function(e){return!e._bIsSapUiFlFlexControllerApplyChangesOnControl};var r=t.getPropagationListeners().every(n);if(r){var a=t.getManifestObject();var s=i.getAppVersionFromManifest(a);var o=sap.ui.require("sap/ui/fl/FlexControllerFactory");var p=o.create(this.getComponentName(),s);var g=h.applyAllChangesForControl.bind(h,this.getChangesMapForComponent.bind(this),t,p);g._bIsSapUiFlFlexControllerApplyChangesOnControl=true;t.addPropagationListener(g)}}};D.prototype._deleteNotSavedChanges=function(e,t){e.filter(function(e){return!t.some(function(t){return e.getId()===t.getId()})}).forEach(function(e){this.deleteChange(e,true)}.bind(this))};function E(e,t){var n=false;if(!e||t.length<2){return false}var r=t.map(function(e){return e.getLayer()});var a=r.filter(function(e,t,n){return n.indexOf(e)===t});if(a.length>1){return false}if(a[0]==="CUSTOMER"||a[0]==="USER"){n=true}var i=m.fromURL(window.location.href);if(i.has("sap-ui-xx-condense-changes")){n=i.get("sap-ui-xx-condense-changes")==="true"}return n}D.prototype.saveDirtyChanges=function(e,t,n,r){n=n||this._aDirtyChanges;var a=n.slice(0);var i=this._getRequests(n);var s=this._getPendingActions(n);if(s.length===1&&i.length===1&&s[0]==="NEW"){var o=Promise.resolve(a);if(E(e,a)){o=v.condense(e,a)}return o.then(function(e){if(e.length){var a=i[0];var s=this._prepareDirtyChanges(e);return p.write({layer:s[0].layer,flexObjects:s,transport:a,isLegacyVariant:false,draft:r}).then(function(r){this._massUpdateCacheAndDirtyState(e,t);this._deleteNotSavedChanges(n,e);return r}.bind(this))}this._deleteNotSavedChanges(n,e)}.bind(this))}return this.saveSequenceOfDirtyChanges(a,t,r)};D.prototype.saveSequenceOfDirtyChanges=function(e,t,n){return e.reduce(function(e,r){return e.then(this._performSingleSaveAction(r,n)).then(this._updateCacheAndDirtyState.bind(this,r,t))}.bind(this),Promise.resolve())};D.prototype._performSingleSaveAction=function(e,t){return function(){if(e.getPendingAction()==="NEW"){return p.write({layer:e.getLayer(),flexObjects:[e.getDefinition()],transport:e.getRequest(),isLegacyVariant:e.isVariant(),draft:t})}if(e.getPendingAction()==="DELETE"){return p.remove({flexObject:e.getDefinition(),layer:e.getLayer(),transport:e.getRequest()})}}};D.prototype._updateCacheAndDirtyState=function(e,t){if(!t){if(i.isChangeRelatedToVariants(e)){_.updateVariantsState({reference:this._mComponent.name,changeToBeAddedOrDeleted:e})}else if(e.getPendingAction()==="NEW"){o.addChange(this._mComponent,e.getDefinition())}else if(e.getPendingAction()==="DELETE"){o.deleteChange(this._mComponent,e.getDefinition())}}this._aDirtyChanges=this._aDirtyChanges.filter(function(t){return e.getId()!==t.getId()})};D.prototype._massUpdateCacheAndDirtyState=function(e,t){e.forEach(function(e){this._updateCacheAndDirtyState(e,t)},this)};D.prototype._getRequests=function(e){var t=[];e.forEach(function(e){var n=e.getRequest();if(t.indexOf(n)===-1){t.push(n)}});return t};D.prototype._getPendingActions=function(e){var t=[];e.forEach(function(e){var n=e.getPendingAction();if(t.indexOf(n)===-1){t.push(n)}});return t};D.prototype._prepareDirtyChanges=function(e){var t=[];e.forEach(function(e){t.push(e.getDefinition())});return t};D.prototype.getDirtyChanges=function(){return this._aDirtyChanges};D.prototype.deleteChange=function(e,t){var n=this._aDirtyChanges.indexOf(e);if(n>-1){if(e.getPendingAction()==="DELETE"){return}this._aDirtyChanges.splice(n,1);this._deleteChangeInMap(e,t);return}e.markForDeletion();this.addDirtyChange(e);this._deleteChangeInMap(e,t)};D.prototype._deleteChangeInMap=function(t,n){var r=t.getId();e.removeChangeFromMap(this._mChanges,r);e.removeChangeFromDependencies(n?this._mChangesInitial:this._mChanges,r)};D.prototype.transportAllUIChanges=function(e,t,n,r){return this.getChangesForComponent({currentLayer:n,includeCtrlVariants:true}).then(function(a){return p.publish({transportDialogSettings:{rootControl:e,styleClass:t},layer:n,reference:this.getComponentName(),appVersion:this._mComponent.appVersion,localChanges:a,appVariantDescriptors:r})}.bind(this))};D.prototype._getChangesFromMapByNames=function(e){return this._mChanges.aChanges.filter(function(t){return e.indexOf(t.getFileName())!==-1})};D.prototype.resetChanges=function(e,t,n,r){var a=n&&n.length>0;var i=r&&r.length>0;if(!t&&!a&&!i){y.error("Of the generator, selector IDs and change types parameters at least one has to filled");return Promise.reject("Of the generator, selector IDs and change types parameters at least one has to filled")}return this.getChangesForComponent({currentLayer:e,includeCtrlVariants:true}).then(function(s){var o={reference:this.getComponentName(),appVersion:this._mComponent.appVersion,layer:e,changes:s};if(t){o.generator=t}if(a){o.selectorIds=n}if(i){o.changeTypes=r}return p.reset(o)}.bind(this)).then(function(e){var t=[];if(n||r){var a=[];if(e&&e.response&&e.response.length>0){e.response.forEach(function(e){a.push(e.fileName)})}o.removeChanges(this._mComponent,a);t=this._getChangesFromMapByNames(a)}return t}.bind(this))};D.prototype.getResetAndPublishInfo=function(e){return p.getFlexInfo(e)};return D},true);