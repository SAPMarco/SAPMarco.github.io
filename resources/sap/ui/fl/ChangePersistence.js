/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/Variant","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Cache","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/write/_internal/Storage","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ui/thirdparty/jquery","sap/base/util/includes","sap/base/util/merge","sap/base/util/UriParameters","sap/base/Log","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantState","sap/ui/fl/write/_internal/condenser/Condenser"],function(e,t,n,r,i,a,s,o,h,p,g,f,c,l,u,d,C,m,y,_,v,D,b){"use strict";var S=function(t){this._mComponent=t;this._mChanges=e.createEmptyDependencyMap();this._bChangesMapCreated=false;this._mChangesInitial=C({},this._mChanges);if(!this._mComponent||!this._mComponent.name){y.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.")}this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist"};function I(e,t){return e.controlChanges.some(function(n,r){if(n.fileName===t.getDefinition().fileName){e.controlChanges.splice(r,1,t);return true}})}function M(e,t){var r;if(t instanceof n){r=t;this._mChangesEntries[r.getFileName()]=r}else{if(!this._mChangesEntries[t.fileName]){this._mChangesEntries[t.fileName]=new n(t)}r=this._mChangesEntries[t.fileName];r.setState(n.states.PERSISTED);var i=r.getVariantReference();if(i){var a=_.getVariant({vReference:i,reference:this._mComponent.name});if(a){I(a,r)}}}return r}S.prototype.getComponentName=function(){return this._mComponent.name};S.prototype.getCacheKey=function(e){return o.getCacheKey(this._mComponent,e)};S.prototype._preconditionsFulfilled=function(e){var t=e instanceof n?e.getDefinition():e;function r(){if(t.fileType==="ctrl_variant"||t.fileType==="ctrl_variant_change"||t.fileType==="ctrl_variant_management_change"){return t.variantManagementReference||t.variantReference||t.selector&&t.selector.id}}return t.fileType==="change"||r()};S.prototype.getChangesForComponent=function(e,n){return o.getChangesFillingCache(this._mComponent,e,n).then(function(e,n){var i=C({},n);var o=e&&e.component&&a.getAppComponentForControl(e.component);var h=t.isStorageResponseFilled(i.changes);if(!h){return[]}var p=i.changes.changes;if(!this._oMessagebundle&&i.messagebundle&&o){if(!o.getModel("i18nFlexVendor")){if(p.some(function(e){return e.layer===r.VENDOR})){this._oMessagebundle=i.messagebundle;var g=new c(this._oMessagebundle);o.setModel(g,"i18nFlexVendor")}}}var f=e&&e.currentLayer;var l=!(e&&e.ignoreMaxLayerParameter);var u=function(){return true};if(f){u=this._filterChangeForCurrentLayer.bind(this,f);p=p.filter(u)}else if(s.isLayerFilteringRequired()&&l){u=this._filterChangeForMaxLayer.bind(this);p=p.filter(u)}else if(this._bHasChangesOverMaxLayer&&!l){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST}var d=i.changes&&e&&e.includeCtrlVariants;var m=this._getAllCtrlVariantChanges(i,d,u);p=p.concat(m);return this._checkAndGetChangeInstances(p,i)}.bind(this,e))};S.prototype._checkAndGetChangeInstances=function(e,t){return e.filter(this._preconditionsFulfilled).map(M.bind(this,t))};S.prototype._filterChangeForMaxLayer=function(e){if(s.isOverMaxLayer(this._getLayerFromChangeOrChangeContent(e))){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true}return false}return true};S.prototype._filterChangeForCurrentLayer=function(e,t){return e===this._getLayerFromChangeOrChangeContent(t)};S.prototype._getLayerFromChangeOrChangeContent=function(e){var t;if(e instanceof i||e instanceof n){t=e.getLayer()}else{t=e.layer}return t};S.prototype._getAllCtrlVariantChanges=function(e,t,n){if(!t){return _.getInitialChanges({reference:this._mComponent.name})}return["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"].reduce(function(t,n){if(e.changes[n]){return t.concat(e.changes[n])}return t},[]).filter(n)};S.prototype.loadChangesMapForComponent=function(t){return this.getChangesForComponent({component:t}).then(n.bind(this));function n(n){l.start("fl.createDependencyMap","Measurement of creating initial dependency map");this._mChanges=e.createEmptyDependencyMap();n.forEach(this._addChangeAndUpdateDependencies.bind(this,t));this._mChangesInitial=C({},this._mChanges);l.end("fl.createDependencyMap","Measurement of creating initial dependency map");this._bChangesMapCreated=true;return this.getChangesMapForComponent.bind(this)}};S.prototype.checkForOpenDependenciesForControl=function(t,n){return e.checkForOpenDependenciesForControl(this._mChanges,g.getControlIdBySelector(t,n),n)};S.prototype.copyDependenciesFromInitialChangesMap=function(e,t,n){var r=C({},this._mChangesInitial.mDependencies);var i=r[e.getId()];if(i){var a=[];i.dependencies.forEach(function(n){if(t(n)){this._mChanges.mDependentChangesOnMe[n]=this._mChanges.mDependentChangesOnMe[n]||[];this._mChanges.mDependentChangesOnMe[n].push(e.getId());a.push(n)}}.bind(this));var s;var o=[];i.controlsDependencies.forEach(function(t){if(!g.bySelector(t,n)){s=g.getControlIdBySelector(t,n);o.push(t);this._mChanges.mControlsWithDependencies[s]=this._mChanges.mControlsWithDependencies[s]||[];if(!d(this._mChanges.mControlsWithDependencies[s],e.getId())){this._mChanges.mControlsWithDependencies[s].push(e.getId())}}}.bind(this));i.dependencies=a;i.controlsDependencies=o;if(a.length||o.length){this._mChanges.mDependencies[e.getId()]=i}}return this._mChanges};S.prototype._addChangeAndUpdateDependencies=function(t,n){n.setInitialApplyState();e.addChangeAndUpdateDependencies(n,t,this._mChanges)};S.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(t,n){e.addRuntimeChangeAndUpdateDependencies(n,t,this._mChanges,this._mChangesInitial)};S.prototype.getChangesMapForComponent=function(){return this._mChanges};S.prototype.isChangeMapCreated=function(){return this._bChangesMapCreated};S.prototype.changesHavingCorrectViewPrefix=function(e,t){var n=e.modifier;var r=e.appComponent;var i=t.getSelector();if(!i||!e){return false}if(i.viewSelector){var a=n.getControlIdBySelector(i.viewSelector,r);return a===e.viewId}var s=i.id;if(s){var o;if(t.getSelector().idIsLocal){if(r){o=r.getLocalId(e.viewId)}}else{o=e.viewId}var h=0;var p;do{h=s.indexOf("--",h);p=s.slice(0,h);h++}while(p!==o&&h>0);return p===o}return false};S.prototype.getChangesForView=function(e){return this.getChangesForComponent(e).then(function(t){return t.filter(this.changesHavingCorrectViewPrefix.bind(this,e))}.bind(this))};S.prototype.addChange=function(e,t){var n=this.addDirtyChange(e);this._addRunTimeCreatedChangeAndUpdateDependencies(t,n);this._addPropagationListener(t);return n};S.prototype.addDirtyChange=function(e){var t;if(e instanceof n||e instanceof i){t=e}else{t=new n(e)}if(this._aDirtyChanges.indexOf(t)===-1){this._aDirtyChanges.push(t)}return t};S.prototype._addPropagationListener=function(e){var t=a.getAppComponentForControl(e);if(t instanceof f){var n=function(e){return!e._bIsSapUiFlFlexControllerApplyChangesOnControl};var r=t.getPropagationListeners().every(n);if(r){var i=sap.ui.require("sap/ui/fl/FlexControllerFactory");var s=i.create(this.getComponentName());var o=h.applyAllChangesForControl.bind(h,this.getChangesMapForComponent.bind(this),t,s);o._bIsSapUiFlFlexControllerApplyChangesOnControl=true;t.addPropagationListener(o)}}};S.prototype._deleteNotSavedChanges=function(e,t){e.filter(function(e){return!t.some(function(t){return e.getId()===t.getId()})}).forEach(function(e){this.deleteChange(e,true)}.bind(this))};function F(e,t){var n=false;if(!e||t.length<2){return false}var r=t.map(function(e){return e.getLayer()});var i=r.filter(function(e,t,n){return n.indexOf(e)===t});if(i.length>1){return false}if(i[0]==="CUSTOMER"||i[0]==="USER"){n=true}var a=m.fromURL(window.location.href);if(a.has("sap-ui-xx-condense-changes")){n=a.get("sap-ui-xx-condense-changes")==="true"}return n}S.prototype.saveDirtyChanges=function(e,t,n,r){n=n||this._aDirtyChanges;var i=n.slice(0);var a=this._getRequests(n);var s=this._getPendingActions(n);if(s.length===1&&a.length===1&&s[0]==="NEW"){var o=Promise.resolve(i);if(F(e,i)){o=b.condense(e,i)}return o.then(function(e){if(e.length){var i=a[0];var s=this._prepareDirtyChanges(e);return p.write({layer:s[0].layer,flexObjects:s,transport:i,isLegacyVariant:false,parentVersion:r}).then(function(r){this._massUpdateCacheAndDirtyState(e,t);this._deleteNotSavedChanges(n,e);return r}.bind(this))}this._deleteNotSavedChanges(n,e)}.bind(this))}return this.saveSequenceOfDirtyChanges(i,t,r)};S.prototype.saveSequenceOfDirtyChanges=function(e,t,n){var r;if(n){var i=e.filter(function(e){return e.getPendingAction()==="NEW"});r=[].concat(i).shift()}return e.reduce(function(e,i){return e.then(this._performSingleSaveAction(i,r,n)).then(this._updateCacheAndDirtyState.bind(this,i,t))}.bind(this),Promise.resolve())};S.prototype._performSingleSaveAction=function(e,t,n){return function(){if(e.getPendingAction()==="NEW"){if(n!==undefined){n=e===t?n:sap.ui.fl.Versions.Draft}return p.write({layer:e.getLayer(),flexObjects:[e.getDefinition()],transport:e.getRequest(),parentVersion:n})}if(e.getPendingAction()==="DELETE"){return p.remove({flexObject:e.getDefinition(),layer:e.getLayer(),transport:e.getRequest()})}}};S.prototype._updateCacheAndDirtyState=function(e,t){if(!t){if(a.isChangeRelatedToVariants(e)){_.updateVariantsState({reference:this._mComponent.name,changeToBeAddedOrDeleted:e})}else if(a.isChangeRelatedToCompVariant(e)){D.updateState({reference:this._mComponent.name,changeToBeAddedOrDeleted:e})}else if(e.getPendingAction()==="NEW"){o.addChange(this._mComponent,e.getDefinition())}else if(e.getPendingAction()==="DELETE"){o.deleteChange(this._mComponent,e.getDefinition())}}this._aDirtyChanges=this._aDirtyChanges.filter(function(t){return e.getId()!==t.getId()})};S.prototype._massUpdateCacheAndDirtyState=function(e,t){e.forEach(function(e){this._updateCacheAndDirtyState(e,t)},this)};S.prototype._getRequests=function(e){var t=[];e.forEach(function(e){var n=e.getRequest();if(t.indexOf(n)===-1){t.push(n)}});return t};S.prototype._getPendingActions=function(e){var t=[];e.forEach(function(e){var n=e.getPendingAction();if(t.indexOf(n)===-1){t.push(n)}});return t};S.prototype._prepareDirtyChanges=function(e){var t=[];e.forEach(function(e){t.push(e.getDefinition())});return t};S.prototype.getDirtyChanges=function(){return this._aDirtyChanges};S.prototype.deleteChange=function(e,t){var n=this._aDirtyChanges.indexOf(e);if(n>-1){if(e.getPendingAction()==="DELETE"){return}this._aDirtyChanges.splice(n,1);this._deleteChangeInMap(e,t);return}e.markForDeletion();this.addDirtyChange(e);this._deleteChangeInMap(e,t)};S.prototype._deleteChangeInMap=function(t,n){var r=t.getId();e.removeChangeFromMap(this._mChanges,r);e.removeChangeFromDependencies(n?this._mChangesInitial:this._mChanges,r)};function E(e,t){return(t.getRequest()==="$TMP"||t.getRequest()==="")&&t.getLayer()===e}S.prototype.transportAllUIChanges=function(e,t,n,r){return Promise.all([this.getChangesForComponent({currentLayer:n,includeCtrlVariants:true}),v.getCompEntitiesByIdMap(this.getComponentName())]).then(function(i){var a=i[0];var s=i[1];var o=[];for(var h in s){o.push(s[h])}a=a.concat(o.filter(E.bind(this,n)));return p.publish({transportDialogSettings:{rootControl:e,styleClass:t},layer:n,reference:this.getComponentName(),localChanges:a,appVariantDescriptors:r})}.bind(this))};S.prototype._getChangesFromMapByNames=function(e){return this._mChanges.aChanges.filter(function(t){return e.indexOf(t.getFileName())!==-1})};S.prototype.removeDirtyChanges=function(e,t,n,r,i){if(!n){y.error("The selectorId must be provided");return Promise.reject("The selectorId must be provided")}var a=this._aDirtyChanges;var s=a.filter(function(a){var s=true;if(a.getLayer()!==e){return false}if(r&&a.getDefinition().support.generator!==r){return false}var o=a.getSelector();s=n.getId()===g.getControlIdBySelector(o,t);if(i){s=s&&i.indexOf(a.getChangeType())!==-1}return s});s.forEach(function(e){var t=a.indexOf(e);a.splice(t,1)});return Promise.resolve(s)};S.prototype.resetChanges=function(e,t,n,r){var i=n&&n.length>0;var a=r&&r.length>0;if(!t&&!i&&!a){y.error("Of the generator, selector IDs and change types parameters at least one has to filled");return Promise.reject("Of the generator, selector IDs and change types parameters at least one has to filled")}return this.getChangesForComponent({currentLayer:e,includeCtrlVariants:true}).then(function(s){var o={reference:this.getComponentName(),layer:e,changes:s};if(t){o.generator=t}if(i){o.selectorIds=n}if(a){o.changeTypes=r}return p.reset(o)}.bind(this)).then(function(e){var t=[];if(n||r){var i=[];if(e&&e.response&&e.response.length>0){e.response.forEach(function(e){i.push(e.fileName)})}o.removeChanges(this._mComponent,i);t=this._getChangesFromMapByNames(i)}return t}.bind(this))};S.prototype.getResetAndPublishInfo=function(e){return p.getFlexInfo(e)};return S},true);