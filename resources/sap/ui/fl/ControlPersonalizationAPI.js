/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/registry/ChangeRegistry","sap/ui/fl/FlexControllerFactory","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/base/ManagedObject","sap/base/util/includes","sap/ui/fl/variants/VariantManagement","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/core/Component","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,t,r,n,a,o,i,c,s,l,u,f,g,p,d){"use strict";var m={_determineParameters:function(e,t){var n=r.getAppComponentForControl(e);var a=o.createForControl(n);var i=n.getRootControl();var c={rootControl:i,flexController:a};if(!t){var s;var l;c.variantModel=n.getModel(r.VARIANT_MODEL_NAME);c.variantManagement={};d.makeArray(c.rootControl.$().find(".sapUiFlVarMngmt")).map(function(e){s=sap.ui.getCore().byId(e.id);if(s.getMetadata().getName()==="sap.ui.fl.variants.VariantManagement"){l=s.getFor();l.forEach(function(t){c.variantManagement[t]=c.variantModel.getLocalId(e.id,n)})}})}return c},_getVariantManagement:function(e,t){t=t||this._determineParameters(e);var r=function(e){if(!t.variantManagement[e.getId()]&&e.getParent()&&e.getId()!==t.rootControl.getId()){return r(e.getParent())}else if(!e.getParent()||e.getId()===t.rootControl.getId()){return t.variantManagement[e.getId()]||""}return t.variantManagement[e.getId()]};return r(e)},clearVariantParameterInURL:function(e){var t;var n=r.getAppComponentForControl(e);var a=n instanceof g?n.getModel(r.VARIANT_MODEL_NAME):undefined;if(!a){p.warning("Variant model could not be found on the provided control")}if(e instanceof u){var o=a.getLocalId(e.getId(),n);var i=f.removeURLParameterForVariantManagement({model:a,vmReference:o});t=i.parameters}f.update({parameters:t||[],updateURL:true,updateHashEntry:!!a,model:a||{},silent:!a})},activateVariant:function(e,t){return Promise.resolve().then(function(){var n;if(typeof e==="string"||e instanceof String){n=g.get(e);if(!(n instanceof g)){n=sap.ui.getCore().byId(e);if(!(n instanceof c)){throw new Error("No valid component or control found for the provided ID")}}}else if(e instanceof g||e instanceof c){n=e}var a=r.getAppComponentForControl(n);if(!a){throw new Error("A valid variant management control or component (instance or ID) should be passed as parameter")}var o=a.getModel(r.VARIANT_MODEL_NAME);if(!o){throw new Error("No variant management model found for the passed control or application component")}var i=o.getVariantManagementReference(t).variantManagementReference;if(!i){throw new Error("A valid control or component, and a valid variant/ID combination are required")}return o.waitForVMControlInit(i).then(function(){return o.updateCurrentVariant(i,t,a)})})["catch"](function(e){p.error(e);return Promise.reject(e)})},_checkChangeSpecificData:function(e,t){if(!e.changeSpecificData){return Promise.reject(new Error("No changeSpecificData available"))}if(!e.changeSpecificData.changeType){return Promise.reject(new Error("No valid changeType"))}if(!(e.selectorControl instanceof c)){return Promise.reject(new Error("No valid selectorControl"))}var r=e.selectorControl.getMetadata().getName();var n=a.getInstance();return n.getChangeHandler(e.changeSpecificData.changeType,r,e.selectorControl,i,t)},addPersonalizationChanges:function(e){var t=[];var a=n.getCurrentLayer(true);var o=[];e.controlChanges.forEach(function(r){var n={};Object.assign(n,{developerMode:false,layer:a});function i(){return this._checkChangeSpecificData(r,a).then(function(){var t=this._determineParameters(r.selectorControl,e.ignoreVariantManagement);if(!e.ignoreVariantManagement){if(!r.changeSpecificData.variantReference){var a=this._getVariantManagement(r.selectorControl,t);if(a){var o=t.variantModel.oData[a].currentVariant;r.changeSpecificData.variantReference=o}}}else{delete r.changeSpecificData.variantReference}return t.flexController.createAndApplyChange(Object.assign(n,r.changeSpecificData),r.selectorControl)}.bind(this)).then(function(e){t.push(e)}).catch(function(e){return Promise.reject({change:r,message:e.message})})}o.push(i.bind(this))}.bind(this));return r.execPromiseQueueSequentially(o).then(function(){return t})},isPersonalized:function(e,n){if(!e||e.length===0){return this._reject("At least one control ID has to be provided as a parameter")}var a=e[0].appComponent||r.getAppComponentForControl(e[0]);if(!a){return this._reject("App Component could not be determined")}var i=e.map(function(e){return e.id||e.getId()});var c=o.createForControl(a);return c.getComponentChanges({currentLayer:t.USER,includeCtrlVariants:true}).then(function(e){return e.filter(this._filterBySelectors.bind(this,a,i)).filter(this._filterByChangeType.bind(this,n)).some(this._ifValidFileType)}.bind(this))},_reject:function(e){p.error(e);return Promise.reject(e)},_filterBySelectors:function(e,t,r){var n=r.getSelector();var a=i.getControlIdBySelector(n,e);return l(t,a)},_filterByChangeType:function(e,t){return Array.isArray(e)&&e.length>0?l(e,t.getChangeType()):true},_ifValidFileType:function(e){return e.getFileType()==="change"},resetChanges:function(e,n){if(!e||e.length===0){return this._reject("At least one control ID has to be provided as a parameter")}var a=e[0].appComponent||r.getAppComponentForControl(e[0]);if(!a){return this._reject("App Component could not be determined")}var i=e.map(function(e){var t=e.id||e.getId();var r=a.getLocalId(t);return r||t});var c=o.createForControl(a);return c.resetChanges(t.USER,undefined,a,i,n)},saveChanges:function(e,t){if(!(t instanceof s)){var r="A valid sap.ui.base.ManagedObject instance is required as a parameter";p.error(r);return Promise.reject(r)}var n=m._determineParameters(t);var a=Object.keys(n.variantManagement).reduce(function(e,t){return e.concat([n.variantManagement[t]])},[]);return n.flexController.saveSequenceOfDirtyChanges(e).then(function(e){n.variantModel.checkDirtyStateForControlModels(a);return e})},hasVariantManagement:function(e){try{return!!this._getVariantManagement(e)}catch(e){p.error(e.message);return false}}};return m},true);