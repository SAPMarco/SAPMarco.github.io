/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/registry/ChangeRegistry","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Change","sap/ui/fl/Variant","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Versions","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/util/reflection/XmlTreeModifier","sap/ui/core/Component","sap/base/Log"],function(e,t,n,r,o,i,a,s,p,h,c,g,u,l){"use strict";var f=function(e,n){this._oChangePersistence=undefined;this._sComponentName=e||"";this._sAppVersion=n||t.DEFAULT_APP_VERSION;if(this._sComponentName&&this._sAppVersion){this._createChangePersistence()}};f.prototype.getComponentName=function(){return this._sComponentName};f.prototype.getAppVersion=function(){return this._sAppVersion};f.prototype.setVariantSwitchPromise=function(e){this._oVariantSwitchPromise=e};f.prototype.waitForVariantSwitch=function(){if(!this._oVariantSwitchPromise){this._oVariantSwitchPromise=Promise.resolve()}return this._oVariantSwitchPromise};f.prototype.createBaseChange=function(e,n){var o;var i;if(!n){throw new Error("No application component found. To offer flexibility a valid relation to its owning component must be present.")}e.reference=this.getComponentName();e.packageName="$TMP";e.validAppVersions=t.getValidAppVersions({appVersion:this.getAppVersion(),developerMode:e.developerMode,scenario:e.scenario});o=r.createInitialFileContent(e);i=new r(o);if(e.variantReference){i.setVariantReference(e.variantReference)}return i};f.prototype._createChange=function(e,n,r){var o=r&&(r.controlType||t.getControlType(r));var i=this.createBaseChange(e,n);return this._getChangeHandler(i,o,r,c).then(function(t){if(t){t.completeChangeContent(i,e,{modifier:c,appComponent:n})}else{throw new Error("Change handler could not be retrieved for change "+JSON.stringify(e)+".")}return i}).catch(function(e){return Promise.reject(e)})};f.prototype.createChangeWithExtensionPointSelector=function(e,n){return Promise.resolve().then(function(){if(!n){throw new Error("A flexibility change on extension point cannot be created without a valid extension point reference.")}var r=n.view;var o=t.getAppComponentForControl(r);e.selector={name:n.name,viewSelector:c.getSelector(r.getId(),o)};return o}).then(function(t){return this._createChange(e,t)}.bind(this))};f.prototype.createChangeWithControlSelector=function(e,n){var r;return(new t.FakePromise).then(function(){if(!n){throw new Error("A flexibility change cannot be created without a targeted control.")}var o=n.id||n.getId();if(!e.selector){e.selector={}}r=n.appComponent||t.getAppComponentForControl(n);if(!r){throw new Error("No application component found. To offer flexibility, the control with the ID '"+o+"' has to have a valid relation to its owning application component.")}Object.assign(e.selector,c.getSelector(o,r));return r}).then(function(t){return this._createChange(e,t,n)}.bind(this))};f.prototype.addChange=function(e,n){return this.createChangeWithControlSelector(e,n).then(function(e){var r=t.getAppComponentForControl(n);e._ignoreOnce=true;this.addPreparedChange(e,r);return e}.bind(this))};f.prototype.addPreparedChange=function(e,n){if(e.getVariantReference()){var r=n.getModel(t.VARIANT_MODEL_NAME);r.addChange(e)}this._oChangePersistence.addChange(e,n);return e};f.prototype.deleteChange=function(e,n){this._oChangePersistence.deleteChange(e);if(e.getVariantReference()){n.getModel(t.VARIANT_MODEL_NAME).removeChange(e)}};f.prototype.createAndApplyChange=function(e,n){var r;return this.addChange(e,n).then(function(e){r=e;var o={modifier:c,appComponent:t.getAppComponentForControl(n),view:t.getViewForControl(n)};r.setQueuedForApply();return s.applyChangeOnControl(r,n,o)}).then(function(e){if(!e.success){var t=e.error||new Error("The change could not be applied.");this._oChangePersistence.deleteChange(r,true);throw t}return r}.bind(this))};function C(e,n,r,o,i){var a=d(e,o);if(!a){return[]}i.push(e);var s=e.getId();var p=n[s]&&n[s].dependencies||[];for(var h=0,c=p.length;h<c;h++){var g=t.getChangeFromChangesMap(r,p[h]);a=C(g,n,r,o,i);if(a.length===0){i=[];break}delete n[s]}return i}function d(e,t){var n=e.getDependentControlSelectorList();n.push(e.getSelector());return!n.some(function(e){return!c.bySelector(e,t)})}f.prototype.waitForChangesToBeApplied=function(e){var t;if(Array.isArray(e)){t=e}else{t=[e]}var n=t.map(function(e){return this._waitForChangesToBeApplied(e)}.bind(this));return Promise.all(n).then(function(){return undefined})};f.prototype._waitForChangesToBeApplied=function(e){var n=e.id&&sap.ui.getCore().byId(e.id)||e;var r=this._oChangePersistence.getChangesMapForComponent();var o=[];var i=Object.assign({},r.mDependencies);var a=r.mChanges;var s=a[n.getId()]||[];var p=s.filter(function(e){return!e.isCurrentProcessFinished()},this);var h=e.appComponent||t.getAppComponentForControl(n);var c=[];p.forEach(function(e){var t=C(e,i,r.mChanges,h,[]);t.forEach(function(e){if(c.indexOf(e)===-1){c.push(e)}})});c.forEach(function(e){o=o.concat(e.addChangeProcessingPromises())},this);o.push(this.waitForVariantSwitch());return Promise.all(o)};f.prototype.saveAll=function(e,t,n){return this._oChangePersistence.saveDirtyChanges(e,t,undefined,n).then(function(e){if(n&&e&&e.response){var t=e.response;if(Array.isArray(t)){t=t[0]}a.ensureDraftVersionExists({reference:t.reference,layer:t.layer})}return e})};f.prototype.processXmlView=function(e,n){var r=u.get(n.componentId);var o=t.getAppComponentForControl(r);n.appComponent=o;n.modifier=g;n.view=e;return this._oChangePersistence.getChangesForView(n).then(s.applyAllChangesForXMLView.bind(s,n)).catch(this._handlePromiseChainError.bind(this,n.view))};f.prototype._handlePromiseChainError=function(e,t){l.error("Error processing view "+t+".");return e};f.prototype._getChangeHandler=function(e,t,n,r){var o=e.getChangeType();var i=e.getLayer();return this._getChangeRegistry().getChangeHandler(o,t,n,r,i)};f.prototype._getChangeRegistry=function(){var t=e.getInstance();t.initSettings();return t};f.prototype.getComponentChanges=function(e,t){return this._oChangePersistence.getChangesForComponent(e,t)};f.prototype.checkForOpenDependenciesForControl=function(e,t){return this._oChangePersistence.checkForOpenDependenciesForControl(e,t)};f.prototype.hasHigherLayerChanges=function(e){e=e||{};var t=e.upToLayer||n.getCurrentLayer(false);e.includeVariants=true;e.includeCtrlVariants=true;return this.getComponentChanges(e).then(function(e){var r=e===this._oChangePersistence.HIGHER_LAYER_CHANGES_EXIST||e.some(function(e){return n.compareAgainstCurrentLayer(e.getLayer(),t)>0});return!!r}.bind(this))};f.prototype._createChangePersistence=function(){this._oChangePersistence=i.getChangePersistenceForComponent(this.getComponentName(),this.getAppVersion());return this._oChangePersistence};f.prototype.resetChanges=function(e,n,r,o,i){return this._oChangePersistence.resetChanges(e,n,o,i).then(function(e){if(e.length!==0){return p.revertMultipleChanges(e,{appComponent:r,modifier:c,flexController:this})}}.bind(this)).then(function(){if(r){var e=r.getModel(t.VARIANT_MODEL_NAME);if(e){h.update({parameters:[],updateURL:true,updateHashEntry:true,model:e})}}})};f.prototype.discardChanges=function(e,t){var r=n.getCurrentLayer(!!t);var o=0;var i;var a;i=e.length;while(o<e.length){a=e[o];if(a&&a.getLayer&&a.getLayer()===r){this._oChangePersistence.deleteChange(a)}if(i===e.length){o++}else{i=e.length}}return this._oChangePersistence.saveDirtyChanges()};f.prototype.applyVariantChanges=function(e,n){var r;return e.reduce(function(e,t){return e.then(function(){var e={modifier:c,appComponent:n};this._oChangePersistence._addRunTimeCreatedChangeAndUpdateDependencies(n,t);r=e.modifier.bySelector(t.getSelector(),n);if(r){return s.applyChangeOnControl(t,r,e)}l.error("A flexibility change tries to change a nonexistent control.")}.bind(this))}.bind(this),new t.FakePromise)};f.prototype.saveSequenceOfDirtyChanges=function(e,t){return this._oChangePersistence.saveDirtyChanges(t,false,e)};f.prototype.getResetAndPublishInfo=function(e){e.reference=this._sComponentName;e.appVersion=this._sAppVersion;return this._oChangePersistence.getResetAndPublishInfo(e)};return f},true);