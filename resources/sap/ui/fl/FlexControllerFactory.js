/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/FlexController","sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/variants/VariantModel","sap/base/Log","sap/ui/performance/Measurement"],function(e,n,t,r,o,a,i,s){"use strict";var p={};p._instanceCache={};p._componentInstantiationPromises={};p.create=function(t,r){r=r||n.DEFAULT_APP_VERSION;if(!p._instanceCache[t]){p._instanceCache[t]={}}var o=p._instanceCache[t][r];if(!o){o=new e(t,r);p._instanceCache[t][r]=o}return o};p.createForControl=function(e,t){try{var r=n.getAppComponentForControl(e);var o=n.getComponentClassName(r||e);var a=n.getAppVersionFromManifest(r?r.getManifest():t);return p.create(o,a)}catch(e){i.error(e.message,undefined,"sap.ui.fl.FlexControllerFactory")}};function l(e,r){if(n.getUshellContainer()){return Promise.resolve(e)}var o=window.sessionStorage.getItem("sap.ui.rta.restart."+t.CUSTOMER);if(o){var a=n.getComponentClassName(r);if(o!==a&&o!=="true"){i.error("an application component was started "+"which does not match the component for which the restart was triggered:\n"+"Triggering component: "+o+"\n"+"Started component: "+a);return Promise.resolve(e)}window.sessionStorage.removeItem("sap.ui.rta.restart."+t.CUSTOMER);return new Promise(function(n){sap.ui.getCore().loadLibrary("sap.ui.rta",{async:true}).then(function(){sap.ui.require(["sap/ui/rta/api/startKeyUserAdaptation"],function(t){t({rootControl:r});n(e)})})})}return Promise.resolve(e)}p.getChangesAndPropagate=function(e,t){if(n.isApplicationComponent(e)){var r=e.getId();p._componentInstantiationPromises[r]=o.initialize({componentId:r,asyncHints:t.asyncHints}).then(c.bind(this,e));return p._componentInstantiationPromises[r]}else if(n.isEmbeddedComponent(e)){var a=n.getAppComponentForControl(e);if(a&&n.isApplicationComponent(a)){var i=Promise.resolve();if(p._componentInstantiationPromises[a.getId()]){i=p._componentInstantiationPromises[a.getId()]}return i.then(function(){var e=a.getModel(n.VARIANT_MODEL_NAME);if(!e){return c(a)}return e}).then(function(t){e.setModel(t,n.VARIANT_MODEL_NAME)})}return Promise.resolve()}};function c(e){var t=e.getManifestObject();var o;o=p.createForControl(e,t);return o._oChangePersistence.loadChangesMapForComponent(e).then(function(t){var i=r.applyAllChangesForControl.bind(r,t,e,o);i._bIsSapUiFlFlexControllerApplyChangesOnControl=true;e.addPropagationListener(i);var p=new a({},o,e);e.setModel(p,n.VARIANT_MODEL_NAME);s.end("flexProcessing");return p}).then(function(n){return l(n,e)})}return p},true);