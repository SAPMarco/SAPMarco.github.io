/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/security/encodeURLParameters","sap/base/Log","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/base/util/isEmptyObject"],function(e,n,t,r,a){"use strict";var i="sap/ui/fl/apply/_internal/connectors/";var o={connector:"StaticFileConnector"};function s(e,n){return e.filter(function(e){return n.indexOf(e)!==-1||n[0]==="ALL"})}function c(e){function n(e,n){return new Date(e.creation)-new Date(n.creation)}["changes","variantChanges","variants","variantDependentControlChanges","variantManagementChanges"].forEach(function(t){e[t]=e[t].sort(n)});return e}function u(e,n,t){return t.map(function(t){var r=t.connector;var a;if(!t.custom){a=e+r}else{a=n?t.applyConnector:t.writeConnector}return a})}function l(e,n,t){var r=u(e,n,t);return new Promise(function(e){sap.ui.require(r,function(){Array.from(arguments).forEach(function(e,r){if(!t[r].layers){t[r].layers=e.layers}else{t[r].layers=s(t[r].layers,e.layers)}if(n){t[r].applyConnectorModule=e}else{t[r].writeConnectorModule=e}});e(t)})})}return{getConnectors:function(e,n){var t=sap.ui.getCore().getConfiguration().getFlexibilityServices();var r=[];if(n){r=[o]}r=r.concat(t);return l(e,n,r)},getApplyConnectors:function(){return this.getConnectors(i,true)},getStaticFileConnector:function(){return l(i,true,[o])},logAndResolveDefault:function(e,t,r,a){n.error("Connector ("+t.connector+") failed call '"+r+"': "+a+"\nApplication startup continues without data from this storage.");return e},filterAndSortResponses:function(e){var n=[];Object.keys(e).forEach(function(t){n.push(e[t])});n=n.filter(function(e){return e.changes.length>0||e.variants.length>0||e.variantChanges.length>0||e.variantManagementChanges.length>0||e.variantDependentControlChanges.length>0});n.sort(function(e,n){return e.index-n.index});return n},getGroupedFlexObjects:function(e){var n={};Object.keys(t).forEach(function(e){n[e]=this.getEmptyFlexDataResponse();n[e].index=r.getLayerIndex(e)}.bind(this));e.forEach(function(e){var t=e.layer;if(e.fileType==="ctrl_variant"&&e.variantManagementReference){n[t].variants.push(e)}else if(e.fileType==="ctrl_variant_change"){n[t].variantChanges.push(e)}else if(e.fileType==="ctrl_variant_management_change"){n[t].variantManagementChanges.push(e)}else if(e.fileType==="change"||e.fileType==="variant"){if(e.variantReference){n[t].variantDependentControlChanges.push(e)}else{n[t].changes.push(e)}}});Object.keys(n).forEach(function(e){c(n[e])});return n},getEmptyFlexDataResponse:function(){return Object.assign({},{appDescriptorChanges:[],changes:[],variants:[],variantChanges:[],variantDependentControlChanges:[],variantManagementChanges:[],ui2personalization:{}})},isStorageResponseFilled:function(e){return Object.keys(e||{}).some(function(n){if(Array.isArray(e[n])){return e[n].length!==0}return!a(e[n])})}}});