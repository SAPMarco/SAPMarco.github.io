/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Element","sap/ui/core/StashedControlSupport","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/Utils"],function(e,n,r,t,i,a,o,s){"use strict";var l=new s.FakePromise;function c(e,n){var r=e.getSelector&&e.getSelector();if(!r||!r.id&&!r.name){throw Error("No selector in change found or no selector ID.")}var t=n.modifier.bySelector(r,n.appComponent,n.view);if(!t){throw Error("A flexibility change tries to change a nonexistent control.")}var i=e.getDependentControlSelectorList();i.forEach(function(e){var r=n.modifier.bySelector(e,n.appComponent,n.view);if(!r){throw Error("A dependent selector control of the flexibility change is not available.")}});return t}function p(e,n,r,t,o){var s=g(o);var l=a.getControlIfTemplateAffected(n,e,o);var c=i.hasChangeApplyFinishedCustomData(l.control,n,o.modifier);var p=n.isApplyProcessFinished();if(p&&!c){if(!s){var u=a.checkIfDependencyIsStillValid.bind(null,o.appComponent,o.modifier,r);r=t._oChangePersistence.copyDependenciesFromInitialChangesMap(n,u,o.appComponent)}n.setInitialApplyState()}else if(!p&&c){n.markFinished()}return r}function u(e,n){var r;if(g(n)&&e.getDefinition().jsOnly){r="Change cannot be applied in XML. Retrying in JS."}if(r){e.setInitialApplyState();throw Error(r)}}function f(e,r,t,a){if(t instanceof n){r.control=t}if(r.control){a.modifier.updateAggregation(r.originalControl,e.getContent().boundAggregation)}i.addAppliedCustomData(r.control,e,a,g(a));var o={success:true};e.markFinished(o);return o}function d(e,n,r,t){var a=g(t);var o={success:false,error:e};var l=n.getId();var c="Change ''{0}'' could not be applied.";var p=e instanceof Error;var u=i.getCustomDataIdentifier(false,p,a);switch(u){case i.notApplicableChangesCustomDataKey:s.formatAndLogMessage("info",[c,e.message],[l]);break;case i.failedChangesCustomDataKeyXml:s.formatAndLogMessage("warning",[c,"Merge error detected while processing the XML tree."],[l],e.stack);break;case i.failedChangesCustomDataKeyJs:s.formatAndLogMessage("error",[c,"Merge error detected while processing the JS control tree."],[l],e.stack);break}i.addFailedCustomData(r.control,n,t,u);if(a){n.setInitialApplyState()}else{n.markFinished(o)}return o}function g(e){return e.modifier.targets==="xmlTree"}function h(n,r){var t=r.getDefinition();var i=t.changeType;var a=t.selector.id;var o=t.namespace+t.fileName+"."+t.fileType;var s="A flexibility change could not be applied.";s+="\nThe displayed UI might not be displayed as intedend.";if(n.message){s+="\n   occurred error message: '"+n.message+"'"}s+="\n   type of change: '"+i+"'";s+="\n   LRep location of the change: "+o;s+="\n   id of targeted control: '"+a+"'.";e.warning(s,undefined,"sap.ui.fl.apply._internal.changes.Applier")}function v(e,n){var r=e.mChanges[n]||[];var t=true;var i;r.slice(0).reverse().some(function(e){i=e.getDefinition().changeType;if(i.indexOf("stash")>-1){t=true;return true}else if(i.indexOf("unstash")>-1){t=false;return true}});return t}function m(e,n,t){var i=false;var a=r.getStashedControlIds(n);a.forEach(function(r){if(v(e,r)){var a=o.removeOpenDependentChanges(e,t,r,n);a.forEach(function(e){e._ignoreOnce=true});i=a.length>0?true:i}});return i}var C={addPreConditionForInitialChangeApplying:function(e){l=l.then(function(){return e})},applyChangeOnControl:function(e,n,r){var t=a.getControlIfTemplateAffected(e,n,r);return a.getChangeHandler(e,t,r).then(function(n){u(e,r);return n}).then(function(n){if(e.hasApplyProcessStarted()){return e.addPromiseForApplyProcessing().then(function(n){e.markFinished();return n})}else if(!e.isApplyProcessFinished()){return(new s.FakePromise).then(function(){e.startApplying();return n.applyChange(e,t.control,r)}).then(function(n){return f(e,t,n,r)}).catch(function(n){return d(n,e,t,r)})}var i={success:true};e.markFinished(i);return i}).catch(function(e){return{success:false,error:e}})},applyAllChangesForControl:function(e,n,r,i){var a=e();var c=i.getId();var u=a.mChanges[c]||[];var f=m(a,c,n);u.forEach(function(e){if(!e.isApplyProcessFinished()&&!e._ignoreOnce){e.setQueuedForApply()}});l=l.then(function(e,i){var l=[];var c=e.getId();var u=a.mChanges[c]||[];var f={modifier:t,appComponent:n,view:s.getViewForControl(e)};var d;if(a.mControlsWithDependencies[c]){o.removeControlsDependencies(a,c);d=true}u.forEach(function(n){a=p(e,n,a,r,f);if(n._ignoreOnce){delete n._ignoreOnce}else if(n.isApplyProcessFinished()){o.resolveDependenciesForChange(a,n.getId(),c)}else if(!a.mDependencies[n.getId()]){l.push(function(){return C.applyChangeOnControl(n,e,f).then(function(){o.resolveDependenciesForChange(a,n.getId(),c)})})}else{var t=C.applyChangeOnControl.bind(C,n,e,f);o.addChangeApplyCallbackToDependency(a,n.getId(),t)}});if(u.length||d||i){return s.execPromiseQueueSequentially(l).then(function(){return o.processDependentQueue(a,n,c)})}}.bind(null,i,f));return l},applyAllChangesForXMLView:function(n,r){if(!Array.isArray(r)){var t="No list of changes was passed for processing the flexibility on view: "+n.view+".";e.error(t,undefined,"sap.ui.fl.apply._internal.changes.Applier");r=[]}return r.reduce(function(e,r){return e.then(function(){var e=c(r,n);r.setQueuedForApply();p(e,r,undefined,undefined,n);if(!r.isApplyProcessFinished()){return C.applyChangeOnControl(r,e,n)}return{success:true}}).then(function(e){if(!e.success){throw Error(e.error)}}).catch(function(e){h(e,r)})},new s.FakePromise).then(function(){return n.view})}};return C},true);