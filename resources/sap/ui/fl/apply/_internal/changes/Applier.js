/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Element","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/Utils"],function(e,n,r,t,i,a,o){"use strict";var s=new o.FakePromise;function l(e,n){var r=e.getSelector&&e.getSelector();if(!r||!r.id&&!r.name){throw Error("No selector in change found or no selector ID.")}var t=n.modifier.bySelector(r,n.appComponent,n.view);if(!t){throw Error("A flexibility change tries to change a nonexistent control.")}var i=e.getDependentControlSelectorList();i.forEach(function(e){var r=n.modifier.bySelector(e,n.appComponent,n.view);if(!r){throw Error("A dependent selector control of the flexibility change is not available.")}});return t}function c(e,n,r,a,o){var s=d(o);var l=i.getControlIfTemplateAffected(n,e,o);var c=t.hasChangeApplyFinishedCustomData(l.control,n,o.modifier);var p=n.isApplyProcessFinished();if(p&&!c){if(!s){var f=i.checkIfDependencyIsStillValid.bind(null,o.appComponent,o.modifier,r);r=a._oChangePersistence.copyDependenciesFromInitialChangesMap(n,f,o.appComponent)}n.setInitialApplyState()}else if(!p&&c){n.markFinished()}return r}function p(e,n){var r;if(d(n)&&e.getDefinition().jsOnly){r="Change cannot be applied in XML. Retrying in JS."}if(r){e.setInitialApplyState();throw Error(r)}}function f(e,r,i,a){if(i instanceof n){r.control=i}if(r.control){a.modifier.updateAggregation(r.originalControl,e.getContent().boundAggregation)}t.addAppliedCustomData(r.control,e,a,d(a));var o={success:true};e.markFinished(o);return o}function u(e,n,r,i){var a=d(i);var s={success:false,error:e};var l=n.getId();var c="Change ''{0}'' could not be applied.";var p=e instanceof Error;var f=t.getCustomDataIdentifier(false,p,a);switch(f){case t.notApplicableChangesCustomDataKey:o.formatAndLogMessage("info",[c,e.message],[l]);break;case t.failedChangesCustomDataKeyXml:o.formatAndLogMessage("warning",[c,"Merge error detected while processing the XML tree."],[l],e.stack);break;case t.failedChangesCustomDataKeyJs:o.formatAndLogMessage("error",[c,"Merge error detected while processing the JS control tree."],[l],e.stack);break}t.addFailedCustomData(r.control,n,i,f);if(a){n.setInitialApplyState()}else{n.markFinished(s)}return s}function d(e){return e.modifier.targets==="xmlTree"}function g(n,r){var t=r.getDefinition();var i=t.changeType;var a=t.selector.id;var o=t.namespace+t.fileName+"."+t.fileType;var s="A flexibility change could not be applied.";s+="\nThe displayed UI might not be displayed as intedend.";if(n.message){s+="\n   occurred error message: '"+n.message+"'"}s+="\n   type of change: '"+i+"'";s+="\n   LRep location of the change: "+o;s+="\n   id of targeted control: '"+a+"'.";e.warning(s,undefined,"sap.ui.fl.apply._internal.changes.Applier")}var h={addPreConditionForInitialChangeApplying:function(e){s=s.then(function(){return e})},applyChangeOnControl:function(e,n,r){var t=i.getControlIfTemplateAffected(e,n,r);return i.getChangeHandler(e,t,r).then(function(n){p(e,r);return n}).then(function(n){if(e.hasApplyProcessStarted()){return e.addPromiseForApplyProcessing().then(function(n){e.markFinished();return n})}else if(!e.isApplyProcessFinished()){return(new o.FakePromise).then(function(){e.startApplying();return n.applyChange(e,t.control,r)}).then(function(n){return f(e,t,n,r)}).catch(function(n){return u(n,e,t,r)})}var i={success:true};e.markFinished(i);return i}).catch(function(e){return{success:false,error:e}})},applyAllChangesForControl:function(e,n,t,i){var l=e();var p=i.getId();var f=l.mChanges[p]||[];f.forEach(function(e){if(!e.isApplyProcessFinished()&&!e._ignoreOnce){e.setQueuedForApply()}});s=s.then(function(e){var i=[];var s=e.getId();var p=l.mChanges[s]||[];var f={modifier:r,appComponent:n,view:o.getViewForControl(e)};var u;if(l.mControlsWithDependencies[s]){a.removeControlsDependencies(l,s);u=true}p.forEach(function(n){l=c(e,n,l,t,f);if(n._ignoreOnce){delete n._ignoreOnce}else if(n.isApplyProcessFinished()){a.resolveDependenciesForChange(l,n.getId(),s)}else if(!l.mDependencies[n.getId()]){i.push(function(){return h.applyChangeOnControl(n,e,f).then(function(){a.resolveDependenciesForChange(l,n.getId(),s)})})}else{var r=h.applyChangeOnControl.bind(h,n,e,f);a.addChangeApplyCallbackToDependency(l,n.getId(),r)}});if(p.length||u){return o.execPromiseQueueSequentially(i).then(function(){return a.processDependentQueue(l,n,s)})}}.bind(null,i));return s},applyAllChangesForXMLView:function(n,r){if(!Array.isArray(r)){var t="No list of changes was passed for processing the flexibility on view: "+n.view+".";e.error(t,undefined,"sap.ui.fl.apply._internal.changes.Applier");r=[]}return r.reduce(function(e,r){return e.then(function(){var e=l(r,n);r.setQueuedForApply();c(e,r,undefined,undefined,n);if(!r.isApplyProcessFinished()){return h.applyChangeOnControl(r,e,n)}return{success:true}}).then(function(e){if(!e.success){throw Error(e.error)}}).catch(function(e){g(e,r)})},new o.FakePromise).then(function(){return n.view})}};return h},true);