/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/Utils"],function(e,r,t,n){"use strict";function o(e,r,t,n){var o=false;var a=n.modifier.getControlType(r);if(e.getChangeType()==="stashControl"&&a==="sap.ui.core._StashedControl"){o=true;if(!e.hasRevertData()){t.setChangeRevertData(e,false)}}return o}function a(e){if(!e.isApplyProcessFinished()&&e.hasApplyProcessStarted()){return e.addPromiseForApplyProcessing().then(function(r){if(r&&r.error){e.markRevertFinished(r.error);throw Error(r.error)}})}}var i={revertChangeOnControl:function(n,i,s){var l=t.getControlIfTemplateAffected(n,i,s);var u;return t.getChangeHandler(n,l,s).then(function(e){u=e}).then(a.bind(null,n)).then(function(){var e=o(n,i,u,s);if(n.isApplyProcessFinished()||e){if(!n.hasRevertData()){n.setRevertData(r.getParsedRevertDataFromCustomData(i,n,s.modifier))}n.startReverting();return u.revertChange(n,l.control,s)}throw Error("Change was never applied")}).then(function(){l.control=s.modifier.bySelector(n.getSelector(),s.appComponent,s.view);if(l.bTemplateAffected){s.modifier.updateAggregation(l.control,n.getContent().boundAggregation)}n.markRevertFinished();return l.control}).catch(function(r){var t="Change could not be reverted: "+r.message;e.error(t);n.markRevertFinished(t);return false})},revertMultipleChanges:function(t,o){var a=[];t.forEach(function(t){t.setQueuedForRevert();a.push(function(){var a=t.getSelector&&t.getSelector();var s=o.modifier.bySelector(a,o.appComponent);if(!s){e.warning("A flexibility change tries to revert changes on a nonexistent control with id "+a.id);return new n.FakePromise}var l={modifier:o.modifier,appComponent:o.appComponent,view:n.getViewForControl(s)};return i.revertChangeOnControl(t,s,l).then(function(e){r.destroyAppliedCustomData(e||s,t,o.modifier);return!!e}).then(function(e){if(e){o.flexController._oChangePersistence._deleteChangeInMap(t)}})})});return n.execPromiseQueueSequentially(a)}};return i},true);