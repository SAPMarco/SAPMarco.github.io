/*!
* OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
*/
sap.ui.define(["sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/changes/ExtensionPointState","sap/ui/fl/Utils","sap/ui/core/util/reflection/JsControlTreeModifier","sap/base/util/merge"],function(e,n,t,i,o,r){"use strict";var a={oExtensionPointRegistry:undefined,oRegistryPromise:Promise.resolve(),registerExtensionPoint:function(e){a.oRegistryPromise=a.oRegistryPromise.then(function(){return new Promise(function(n,t){if(a.oExtensionPointRegistry){a.oExtensionPointRegistry.registerExtensionPoint(e);return n()}else if(sap.ui.getCore().getConfiguration().getDesignMode()){sap.ui.require(["sap/ui/fl/write/_internal/extensionPoint/Registry"],function(t){a.oExtensionPointRegistry=t;t.registerExtensionPoint(e);n()},function(e){t(e)})}else{n()}})});return a.oRegistryPromise},createDefaultContent:function(e,n){if(n.length===0){return e.createDefault().then(function(n){n.forEach(function(n,t){o.insertAggregation(e.targetControl,e.aggregationName,n,e.index+t,e.view)});e.ready(n);return n})}return Promise.resolve([])},addDefaultContentToExtensionPointInfo:function(e,n){e.defaultContent=e.defaultContent.concat(n.map(function(e){return e.getId()}))},applyExtensionPoint:function(s){var u=i.getAppComponentForControl(s.targetControl);var l={};var f=r({defaultContent:[]},s);l.appComponent=u;l.modifier=o;l.viewId=s.view.getId();l.componentId=u.getId();var g=a.registerExtensionPoint(f).then(n.initialize.bind(n,l)).then(t.enhanceExtensionPointChanges.bind(t,l,f)).then(a.createDefaultContent.bind(this,s)).then(a.addDefaultContentToExtensionPointInfo.bind(this,f));e.addPreConditionForInitialChangeApplying(g);return g}};return a});