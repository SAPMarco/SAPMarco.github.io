/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/base/util/ObjectPath","sap/ui/core/Component","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/apply/_internal/flexState/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/prepareVariantsMap","sap/ui/fl/apply/_internal/flexState/prepareCompVariantsMap","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/base/Log"],function(e,n,t,a,r,i,o,p,s,l,c,f,u){"use strict";var g={};var d={};var h={};var m={};var S={appDescriptorMap:o,changesMap:p,variantsMap:s,compVariantsMap:l};function v(e){var n=t.get(e.componentId);d[e.reference].componentData=n?n.getComponentData():e.componentData}function M(e){var n=t.get(e.componentId);e.componentData=e.componentData||n.getComponentData()||{};e.manifest=e.manifest||e.rawManifest||n.getManifestObject();e.reference=e.reference||i.getFlexReference(e)}function R(e,n){if(!d[e]){throw new Error("State is not yet initialized")}if(!d[e].preparedMaps[n]){var t={unfilteredStorageResponse:d[e].unfilteredStorageResponse,storageResponse:d[e].storageResponse,componentId:d[e].componentId,componentData:d[e].componentData};d[e].preparedMaps[n]=g._callPrepareFunction(n,t)}return d[e].preparedMaps[n]}function x(e){return R(e,"appDescriptorMap")}function F(e){return R(e,"changesMap")}function D(e){return R(e,"variantsMap")}function C(e){return R(e,"compVariantsMap")}function y(n){if(n.reference.endsWith(".Component")){var t=n.reference.split(".");t.pop();var r=t.join(".");d[r]=e({},{storageResponse:{changes:a.getEmptyFlexDataResponse()},unfilteredStorageResponse:{changes:a.getEmptyFlexDataResponse()},preparedMaps:{},componentId:n.componentId,partialFlexState:n.partialFlexState});m[r]=m[n.reference]}}function I(n){var t=e({},n);var a=t.changes;var r=["changes","variants","variantChanges","variantDependentControlChanges","variantManagementChanges"];if(c.isLayerFilteringRequired()){r.forEach(function(e){a[e]=c.filterChangeDefinitionsByMaxLayer(a[e])})}return t}function b(n){m[n.reference]=r.loadFlexData(n).then(function(t){d[n.reference]=e({},{unfilteredStorageResponse:t,preparedMaps:{},componentId:n.componentId,componentData:n.componentData,partialFlexState:n.partialFlexState});y(n);z(n.reference);return t});return m[n.reference]}function z(e){f.ifUShellContainerThen(function(n){h[e]=_.bind(null,e);n[0].registerNavigationFilter(h[e])},["ShellNavigation"])}function U(e){f.ifUShellContainerThen(function(n){if(h[e]){n[0].unregisterNavigationFilter(h[e]);delete h[e]}},["ShellNavigation"])}function _(e,n,t){return f.ifUShellContainerThen(function(a){try{var r=c.getMaxLayerTechnicalParameter(n);var i=c.getMaxLayerTechnicalParameter(t);if(r!==i){g.clearFilteredResponse(e)}}catch(e){u.error(e.message)}return a[0].NavigationFilterStatus.Continue},["ShellNavigation"])}function V(e){d[e].preparedMaps={}}function L(n){var t=d[n.reference];if(t.partialFlexState===true&&n.partialFlexState!==true){t.partialFlexState=false;n.partialFlexData=e({},t.unfilteredStorageResponse.changes);n.reInitialize=true}return n}function P(e){var n=d[e.reference].componentId;if(!e.reInitialize&&n!==e.componentId){e.reInitialize=true}return e}g.initialize=function(e){return Promise.resolve(e).then(function(e){M(e);var n=e.reference;if(m[n]){return m[n].then(L.bind(null,e)).then(P).then(function(e){return e.reInitialize?b(e):d[n].unfilteredStorageResponse})}return b(e)}).then(function(e,n){if(!d[e.reference].storageResponse){d[e.reference].storageResponse=I(n);v(e);g.getVariantsState(e.reference)}}.bind(null,e))};g.clearAndInitialize=function(e){M(e);var t=!!n.get(["preparedMaps","variantsMap"],d[e.reference]);g.clearState(e.reference);g.clearState(f.normalizeReference(e.reference));return g.initialize(e).then(function(e,n){if(e){return g.getVariantsState(n)}}.bind(null,t,e.reference))};g.clearState=function(e){if(e){U(e);delete d[e];delete m[e]}else{Object.keys(d).forEach(function(e){U(e)});d={};m={}}};g.clearFilteredResponse=function(e){if(d[e]){V(e);delete d[e].storageResponse}};g.getUIChanges=function(e){return F(e).changes};g.getAppDescriptorChanges=function(e){return x(e).appDescriptorChanges};g.getVariantsState=function(e){return D(e)};g.getUI2Personalization=function(e){return d[e].unfilteredStorageResponse.changes.ui2personalization};g.getCompVariantsMap=function(e){return C(e).map};g.getCompEntitiesByIdMap=function(e){return C(e).byId};g._callPrepareFunction=function(e,n){return S[e](n)};g.getStorageResponse=function(e){if(m[e]){return m[e].then(function(){return d[e].unfilteredStorageResponse})}};g.getFlexObjectsFromStorageResponse=function(e){return d[e]&&d[e].unfilteredStorageResponse.changes};return g},true);