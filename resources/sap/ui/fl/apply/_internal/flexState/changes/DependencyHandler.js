/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/includes","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/Utils"],function(e,n,t){"use strict";var d="sap.ui.fl:PendingChange";var c={};function i(e,t){return n.getControlIdBySelector(e,t)}function s(e){return{changeObject:e,dependencies:[],controlsDependencies:[],dependentIds:[]}}function o(e,n,t){a(t,n,e);r(t,n)}function r(n,t){if(!e(n.aChanges,t)){n.aChanges.push(t)}}function a(n,t,d){if(!n.mChanges[d]){n.mChanges[d]=[]}if(!e(n.mChanges[d],t)){n.mChanges[d].push(t)}}function p(e,n,t){var d=e.getSelector();if(d){if(d.id){o(i(d,n),e,t)}else{r(t,e)}}return t.aChanges}function u(e,n){return e.some(function(e){return e.id===n.id&&e.idIsLocal===n.idIsLocal})}function f(e,n,t,d,c,s,o){var r=t.getDependentSelectorList();n.some(function(n){if(u(r,n)){var a=i(n,c);var p=d&&s.indexOf(e)<s.indexOf(t);if(p){g(t,e,a,o,true)}else{g(e,t,a,o)}return true}})}function h(e,n,t,d){if(e.isValidForDependencyMap()){var c=e.getDependentSelectorList();m(e,c,n,d);var i=t.indexOf(e);var s=i<t.length-1;var o=t.slice();o.splice(i,1);o.reverse().forEach(function(i){if(i.isValidForDependencyMap()){f(e,c,i,s,n,t,d)}})}}function m(e,n,t,d){if(n.length){var c=n.map(function(e){return i(e,t)});if(!d.mDependencies[e.getId()]){d.mDependencies[e.getId()]=s(e)}d.mDependencies[e.getId()].controlsDependencies=c;c.forEach(function(n){d.mControlsWithDependencies[n]=d.mControlsWithDependencies[n]||[];d.mControlsWithDependencies[n].push(e.getId())})}}function g(n,t,d,c,i){if(l(n,t,d,c,i)){c.mDependencies[n.getId()].dependencies.push(t.getId());if(!e(c.mDependencies[n.getId()].dependentIds,d)){c.mDependencies[n.getId()].dependentIds.push(d)}if(!c.mDependentChangesOnMe[t.getId()]){c.mDependentChangesOnMe[t.getId()]=[]}c.mDependentChangesOnMe[t.getId()].push(n.getId())}}function l(n,t,d,c,i){var s=!i&&e(c.mDependencies[n.getId()].dependentIds,d);var o=false;if(c.mDependentChangesOnMe[t.getId()]){c.mDependentChangesOnMe[t.getId()].some(function(t){o=e(c.mDependencies[n.getId()].dependencies,t);return o})}return!s&&!o}function D(e,n){var i=[];var s=[];var o=[];if(e.dependencyRemovedInLastBatch[n]){e.dependencyRemovedInLastBatch[n].forEach(function(n){var t=e.mDependencies[n];if(t&&t.dependencies.length===0&&!(t.controlsDependencies&&t.controlsDependencies.length)){s.push(n);i.push(t.changeObject.getId());if(t[d]){o.push(function(){return t[d]()})}}})}return t.execPromiseQueueSequentially(o).then(function(n,t,d){delete e.dependencyRemovedInLastBatch[d];t.forEach(function(n){delete e.mDependencies[n]});n.forEach(function(n){c.resolveDependenciesForChange(e,n,d)});return!!n.length}.bind(undefined,i,s,n))}c.createEmptyDependencyMap=function(){return{aChanges:[],mChanges:{},mDependencies:{},mDependentChangesOnMe:{},mControlsWithDependencies:{},dependencyRemovedInLastBatch:{}}};c.addChangeAndUpdateDependencies=function(e,n,t){var d=p(e,n,t);h(e,n,d,t)};c.addRuntimeChangeAndUpdateDependencies=function(e,n,t,d){var c=p(e,n,t);h(e,n,c,d)};c.processDependentQueue=function(e,n,t){return D(e,t).then(function(t,d){if(d){return c.processDependentQueue(e,n,t)}}.bind(undefined,t))};c.addChangeApplyCallbackToDependency=function(e,n,t){e.mDependencies[n][d]=t};c.removeControlsDependencies=function(n,t){var d=n.mControlsWithDependencies[t];if(d){d.forEach(function(d){var c=n.mDependencies[d];if(c&&c.controlsDependencies&&c.controlsDependencies.length){var i=c.controlsDependencies.indexOf(t);if(i>-1){c.controlsDependencies.splice(i,1);delete n.mControlsWithDependencies[t];n.dependencyRemovedInLastBatch[t]=n.dependencyRemovedInLastBatch[t]||[];if(!e(n.dependencyRemovedInLastBatch[t],d)){n.dependencyRemovedInLastBatch[t].push(d)}}}});delete n.mControlsWithDependencies[t]}};c.resolveDependenciesForChange=function(n,t,d){var c=n.mDependentChangesOnMe[t];if(c){c.forEach(function(c){var i=n.mDependencies[c];var s=i?i.dependencies.indexOf(t):-1;if(s>-1){i.dependencies.splice(s,1);n.dependencyRemovedInLastBatch[d]=n.dependencyRemovedInLastBatch[d]||[];if(!e(n.dependencyRemovedInLastBatch[d],c)){n.dependencyRemovedInLastBatch[d].push(c)}}});delete n.mDependentChangesOnMe[t]}};c.removeChangeFromMap=function(e,n){Object.keys(e.mChanges).some(function(t){var d=e.mChanges[t];var c=d.map(function(e){return e.getId()}).indexOf(n);if(c!==-1){d.splice(c,1);return true}});var t=e.aChanges.map(function(e){return e.getId()}).indexOf(n);if(t!==-1){e.aChanges.splice(t,1)}};c.removeChangeFromDependencies=function(e,n,t){c.resolveDependenciesForChange(e,n,t);delete e.mDependencies[n]};c.checkForOpenDependenciesForControl=function(e,t,d){return Object.keys(e.mDependencies).some(function(c){return e.mDependencies[c].changeObject.getDependentSelectorList().some(function(e){return n.getControlIdBySelector(e,d)===t})})};c.getOpenDependenciesForControl=function(e,t,d){var c=[];Object.keys(e.mDependencies).forEach(function(i){e.mDependencies[i].changeObject.getDependentSelectorList().some(function(e){if(n.getControlIdBySelector(e,d)===t){c.push(i);return true}})});return c};c.removeOpenDependentChanges=function(e,n,t,d){var i=c.getOpenDependenciesForControl(e,t,n);var s=[];i.forEach(function(n){if(e.mDependencies[n].controlsDependencies.length){s.push(e.mDependencies[n].changeObject);c.removeChangeFromDependencies(e,n,d)}});return s};return c});