/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/base/util/merge","sap/base/util/ObjectPath"],function(e,t,r,n){"use strict";function o(e){return typeof e==="function"}function a(e){if(e.modelType){return e.modelType}else if(e.oDataServiceVersion){return"sap.ui.model.odata.v2.ODataModel"}}var i={createAddViaDelegateChangeHandler:function(i){function l(e){return e+i.fieldSuffix}function d(e){if(o(i.skipCreateLabel)){return!!i.skipCreateLabel({changeDefinition:e})}return!!i.skipCreateLabel}function u(e){if(o(i.skipCreateLayout)){return!!i.skipCreateLayout({changeDefinition:e})}return!!i.skipCreateLayout}function c(e,t,n){var o=r({},t);o.fieldSelector.id=l(o.fieldSelector.id);return n.createControlForProperty(o).then(function(r){if(d(e)){return r}var o=t.modifier.getId(r.control);t.labelFor=o;return n.createLabel(t).then(function(e){return{label:e,control:r.control,valueHelp:r.valueHelp}})})}function f(e,t,a){var l=r({aggregationName:i.aggregationName,payload:t.payload||{}},a);var d=t.instance;return Promise.resolve().then(function(){if(o(d.createLayout)&&!u(e)){return d.createLayout(l)}}).then(function(t){if(n.get("control",t)){t.layoutControl=true;return t}return c(e,l,d)})}return{applyChange:function(n,o,l){var d=n.getDefinition();var u=l.appComponent;var c=d.content;var p=c.newFieldSelector;var g={appComponent:l.appComponent,view:l.view,fieldSelector:p,bindingPath:c.bindingPath,modifier:l.modifier,element:o};if(l.modifier.bySelector(p,u)){return e.markAsNotApplicable("Control to be created already exists:"+(p.id||p),true)}var s={newFieldSelector:p};n.setRevertData(s);var v=a(c);return t.getDelegateForControl({control:o,modifier:l.modifier,modelType:v,supportsDefault:i.supportsDefault}).then(function(e){return f(d,e,g)}).then(function(e){var t=r({},{control:o,innerControls:e,change:n},l);i.addProperty(t);if(e.valueHelp){var a=l.modifier.getSelector(l.modifier.getId(e.valueHelp),u);s.valueHelpSelector=a}})},revertChange:function(e,t,n){var a=n.appComponent;var l=n.modifier;var d=e.getRevertData().newFieldSelector;var u=e.getRevertData().valueHelpSelector;var c=l.bySelector(d,a);var f=e.getDependentControl(i.parentAlias,n)||t;l.removeAggregation(f,i.aggregationName,c);l.destroy(c);if(u){var p=l.bySelector(u,a);l.removeAggregation(f,"dependents",p);l.destroy(p)}var g=r({},{control:t,change:e},n);if(o(i.revertAdditionalControls)){i.revertAdditionalControls(g)}e.resetRevertData();return true},completeChangeContent:function(e,t,r){var n=r.appComponent;var a=e.getDefinition();if(!a.content){a.content={}}if(t.parentId){if(o(i.mapParentIdIntoChange)){i.mapParentIdIntoChange(e,t,r)}else{e.addDependentControl(t.parentId,i.parentAlias,r)}}else{throw new Error("mSpecificChangeInfo.parentId attribute required")}if(t.bindingPath){a.content.bindingPath=t.bindingPath}else{throw new Error("mSpecificChangeInfo.bindingPath attribute required")}if(t.newControlId){a.content.newFieldSelector=r.modifier.getSelector(t.newControlId,n)}else{throw new Error("mSpecificChangeInfo.newControlId attribute required")}if(t.index===undefined){throw new Error("mSpecificChangeInfo.targetIndex attribute required")}else{a.content.newFieldIndex=t.index}if(t.oDataServiceVersion){a.content.oDataServiceVersion=t.oDataServiceVersion}if(t.modelType&&i.supportsDefault){a.content.modelType=t.modelType}}}}};return i});