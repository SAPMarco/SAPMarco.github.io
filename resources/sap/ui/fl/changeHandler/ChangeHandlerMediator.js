/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/strings/capitalize","sap/ui/fl/registry/ChangeHandlerRegistration"],function(e,n,t){"use strict";var i={};i._aChangeHandlerSettings=[];["addODataField","addODataFieldWithLabel"].forEach(function(e){["2.0","1.0"].forEach(function(n){i._aChangeHandlerSettings.push({key:{scenario:e,oDataServiceVersion:n},content:{requiredLibraries:{"sap.ui.comp":{minVersion:"1.48",lazy:false}}},scenarioInitialized:false})})});i.addChangeHandlerSettings=function(e,n){var t;if(!(e&&n)){throw new Error("New entry in ChangeHandlerMediator requires a key and settings")}t={key:e,content:n,scenarioInitialized:false};return this.getChangeHandlerSettings(e,true).then(function(e){var n=this._aChangeHandlerSettings.indexOf(e);if(n>-1){Object.assign(this._aChangeHandlerSettings[n].content,t.content);this._aChangeHandlerSettings[n].scenarioInitialized=false}else{this._aChangeHandlerSettings.push(t);return this._createChangeHandlerSettingsGetter(t)}}.bind(this))};i.getChangeHandlerSettings=function(e,n){var t=Object.keys(e);var i;if(t.length>0){i=this._aChangeHandlerSettings.filter(function(n){var i=Object.keys(n.key);if(i.length===t.length){var r=t.filter(function(t){if(n.key[t]===e[t]){return true}});if(r.length===t.length){return true}}})[0];if(!n&&i&&!i.scenarioInitialized){return this._initializeScenario(i).then(function(){return i}).catch(function(){return undefined})}}return Promise.resolve(i)};i._initializeScenario=function(n){var i=[];if(n.content.requiredLibraries){var r=Object.keys(n.content.requiredLibraries);r.forEach(function(r){var a=r;var s=sap.ui.getCore().loadLibrary(r,{async:true}).catch(function(){e.warning("Required library not available: "+a+" - "+n.key.scenario+" could not be initialized");return Promise.reject()}).then(function(){return t.waitForChangeHandlerRegistration(a)});i.push(s)});return Promise.all(i).then(function(){n.scenarioInitialized=true})}return Promise.resolve()};i._createChangeHandlerSettingsGetter=function(t){var r="get"+n(t.key.scenario)+"Settings";if(!i[r]){i[r]=function(n){var i;try{i=n.getModel().getMetaModel().getProperty("/dataServices/dataServiceVersion")}catch(n){e.warning("Data service version could not be retrieved")}return this.getChangeHandlerSettings({scenario:t.key.scenario,oDataServiceVersion:i}).then(function(e){if(e&&e.content&&e.content.createFunction){return e}})}}};i._aChangeHandlerSettings.forEach(function(e){i._createChangeHandlerSettingsGetter(e)});return i},true);