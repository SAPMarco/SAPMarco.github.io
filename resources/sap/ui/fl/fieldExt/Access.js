/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/util/Storage","sap/ui/fl/Utils","sap/base/security/encodeURLParameters","sap/ui/thirdparty/jquery"],function(e,t,r,i){"use strict";var s={};s._mServiceType={v2:"v2",v4:"v4"};s._sODataV4ResourcePathPrefix="sap/opu/odata4/";s._sStorageKey="sap.ui.fl.fieldExt.Access";s._iValidityPeriod=1*7*24*60*60*1e3;s.getBusinessContexts=function(e,t,r){var i=this._getEntityInfo(t,r);var s=this._parseServiceUri(e);var a=this._buildBusinessContextRetrievalUri(s,i);var n=this._executeAjaxCall(a,s,i);return n};s.isServiceOutdated=function(e){if(!this._isSystemInfoAvailable()){return false}var t=this._getServiceItem(this._createServiceItem(e));if(t){if(this._isServiceExpired(t)){this.setServiceValid(e);return false}return true}return false};s.setServiceValid=function(e){if(this._isSystemInfoAvailable()){var t=this._getDataFromLocalStorage();delete t[this._createServiceItem(e).serviceKey];this._setDataToLocalStorage(t)}};s.setServiceInvalid=function(e){if(this._isSystemInfoAvailable()){var t=this._getDataFromLocalStorage();var r=this._createServiceItem(e);t[r.serviceKey]=r;this._setDataToLocalStorage(t)}};s._getEntityInfo=function(e,t){var r={entityTypeName:e||"",entitySetName:t||""};if(r.entitySetName.length===0&&r.entityTypeName.length===0||!(r.entitySetName.length===0)&&!(r.entityTypeName.length===0)){throw new Error("sap.ui.fl.fieldExt.Access._getEntityInfo()"+"Inconsistent input parameters EntityType: "+r.entityTypeName+" EntitySet: "+r.entitySetName)}return r};s._parseServiceUri=function(e){if(e.toLowerCase().indexOf(this._sODataV4ResourcePathPrefix)!==-1){return this._parseV4ServiceUri(e)}return this._parseV2ServiceUri(e)};s._parseV2ServiceUri=function(e){var t=/.*sap\/opu\/odata\/([^\/]+)\/([^\/]+)/i;var r=/([^;]+);v=(\d{1,4})/i;var i="sap/opu/odata";var s;if(e.toLowerCase().indexOf(i)!==-1){var a=e.match(t);if(!a||a.length!==3){throw new Error("sap.ui.fl.fieldExt.Access._parseV2ServiceUri: Malformed service URI (Invalid service name)")}if(a[1].toLowerCase()!=="sap"){s="/"+a[1]+"/"+a[2]}else{s=a[2]}}else{if(e.length>0&&e.lastIndexOf("/")+1===e.length){e=e.substring(0,e.length-1)}s=e.substring(e.lastIndexOf("/")+1)}if(s.indexOf(";v=")!==-1){var n=s.match(r);if(!n||n.length!==3){throw new Error("sap.ui.fl.fieldExt.Access._parseV2ServiceUri: Malformed service URI (Invalid version)")}return{serviceName:n[1],serviceVersion:n[2],serviceType:this._mServiceType.v2}}return{serviceName:s,serviceVersion:"0001",serviceType:this._mServiceType.v2}};s._parseV4ServiceUri=function(e){var t=/^\/?sap\/opu\/odata4((?:\/[^/]+){5})(\/[^/]+){1}(\/.*)?/i;var r=e.match(t);if(!r||r.length!==4){throw new Error("sap.ui.fl.fieldExt.Access._parseV4ServiceUri: Malformed service URI")}var i=r[1].split("/");i.splice(0,3);var s=/(\d{1,4})/i;var a=r[2].match(s);return{serviceName:i.join("/"),serviceVersion:a[1],serviceType:this._mServiceType.v4}};s._buildBusinessContextRetrievalUri=function(e,t){var i="/sap/opu/odata/SAP/APS_CUSTOM_FIELD_MAINTENANCE_SRV/";if(e.serviceType===this._mServiceType.v4){var s=this._sODataV4ResourcePathPrefix+e.serviceName+"/"+e.serviceVersion;i+="GetBusinessContextsByResourcePath?"+r({ResourcePath:"'"+s+"'"})}else{i+="GetBusinessContextsByEntityType?"+"ServiceName='"+e.serviceName+"'"+"&ServiceVersion='"+e.serviceVersion+"'"}i+="&EntitySetName='"+t.entitySetName+"'"+"&EntityTypeName='"+t.entityTypeName+"'"+"&$format=json";return i};s._executeAjaxCall=function(e,t,r){var s=this;var a=this._getAjaxSettings();var n=i.Deferred();var o={BusinessContexts:[],ServiceName:t.serviceName,ServiceVersion:t.serviceVersion};i.ajax(e,a).done(function(e){o.BusinessContexts=s._extractBusinessContexts(e);n.resolve(o)}).fail(function(e){if(e.status===404&&t.serviceType===s._mServiceType.v4){n.resolve(o)}else{var i=s._getMessagesFromXHR(e);var a={errorOccured:true,errorMessages:i,serviceName:t.serviceName,serviceVersion:t.serviceVersion,entityType:r.entityTypeName,entitySet:r.entitySetName};n.reject(a)}});return n.promise()};s._getAjaxSettings=function(){var e={type:"GET",async:true,dataType:"json"};return e};s._extractBusinessContexts=function(e){var t=null;var r=[];if(e&&e.d){t=e.d.results}if(t!==null&&t.length>0){for(var i=0;i<t.length;i++){if(t[i].BusinessContext!==null){r.push({BusinessContext:t[i].BusinessContext,BusinessContextDescription:t[i].BusinessContextDescription})}}}return r};s._getMessagesFromXHR=function(e){var t=[];try{var r=JSON.parse(e.responseText);if(r&&r.error&&r.error.message&&r.error.message.value&&r.error.message.value!==""){t.push({severity:"error",text:r.error.message.value})}else{t.push({severity:"error",text:e.responseText})}}catch(e){}return t};s._getCurrentTime=function(){return Date.now()};s._isServiceExpired=function(e){return e.expirationDate<=this._getCurrentTime()};s._getLocalStorage=function(){return new e(e.Type.local)};s.isLocalStorageAvailable=function(){return this._getLocalStorage()&&this._getLocalStorage().isSupported()};s._getServiceItem=function(e){return this._getDataFromLocalStorage()[e.serviceKey]||null};s._createServiceItem=function(e){var t=this._getCurrentTime()+this._iValidityPeriod;var r=this._getSystemInfo();var i=this._extractServiceInfo(e);return{serviceKey:r.getName()+r.getClient()+i.serviceName+i.serviceVersion,expirationDate:t}};s._extractServiceInfo=function(e){if(typeof e==="string"){return this._parseServiceUri(e)}return e};s._isSystemInfoAvailable=function(){var e=t.getUshellContainer();return e&&e.getLogonSystem};s._getSystemInfo=function(){var e=t.getUshellContainer();return e&&e.getLogonSystem()};s._setDataToLocalStorage=function(e){if(this.isLocalStorageAvailable()){this._getLocalStorage().put(s._sStorageKey,JSON.stringify(e))}};s._getDataFromLocalStorage=function(){if(!this.isLocalStorageAvailable()){return{}}var e=this._getLocalStorage().get(s._sStorageKey);if(!e){return{}}return JSON.parse(e)};return s},true);