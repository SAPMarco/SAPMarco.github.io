/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/support/Plugin","sap/ui/core/support/Support","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/model/json/JSONModel","sap/ui/fl/FlexController","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/Utils","sap/ui/fl/support/apps/uiFlexibilityDiagnostics/helper/Extractor"],function(e,i,t,n,s,a,o,p,r){"use strict";var d=i.extend("sap.ui.fl.support.Flexibility",{constructor:function(e){i.apply(this,["sapUiSupportFlexibility","Flexibility",e]);this._oStub=e;if(this.runsAsToolPlugin()){this._aEventIds=[this.getId()+"SetApps",this.getId()+"SetChangesMaps"]}else{this._aEventIds=[this.getId()+"GetApps",this.getId()+"GetChangesMaps"]}}});d.prototype.sDelimiter=";";d.prototype.init=function(e){i.prototype.init.apply(this,arguments);var n="<div class='sapUiSmallMargin'>The applications listed below have been handled by the sap.ui.fl library in this session.</div>"+"<div class='sapUiSmallMarginBegin'>You can download a file containing the data that has been applied to an application as well as "+"relevant runtime information, and then upload this file to the UI Flexibility Diagnostics application for further investigation.</div>"+"<div class='sapUiSmallMarginBegin'>The UI Flexibility Diagnostics application displays graphs and is only available with SAPUI5.</div>";if(e.isToolStub()){this.addStylesheet("sap/ui/fl/support/flexibility");this.oChangesModel=new s;this.oAppModel=new s;this.oToolSettings=new s({hideDependingChanges:false,panelInfoText:n});this.oChangeDetails=new s;this._renderToolPlugin([]);t.getStub().sendEvent(this.getId()+"GetApps",{})}else{this.onsapUiSupportFlexibilityGetApps()}};d.prototype._renderToolPlugin=function(){var e=this;var i=function(){var i=sap.ui.getCore().createRenderManager();i.write("<div id='"+e.getId()+"-FlexCacheArea' class='sapUiSizeCompact'></div>");i.flush(e.$().get(0));i.destroy()};var t=function(){e.oView=sap.ui.view({viewName:"sap.ui.fl.support.diagnostics.Flexibility",type:sap.ui.core.mvc.ViewType.XML,viewData:{plugin:e}});e.oView.placeAt(e.getId()+"-FlexCacheArea");e.oView.setModel(e.oAppModel,"flexApps");e.oView.setModel(e.oToolSettings,"flexToolSettings");e.oView.setModel(e.oChangesModel,"flexChanges");e.oView.setModel(e.oChangeDetails,"flexChangeDetails")};i();t()};d.prototype.onRefresh=function(){t.getStub().sendEvent(this.getId()+"GetApps",{})};d.prototype.onsapUiSupportFlexibilityGetApps=function(){var i=[];if(o._instanceCache){e.each(o._instanceCache,function(t,n){e.each(n,function(e,n){i.push({key:t+this.sDelimiter+e,text:t,additionalText:e,data:r.extractData(n)})}.bind(this))}.bind(this))}this._oStub.sendEvent(this.getId()+"SetApps",i)};d.prototype.onsapUiSupportFlexibilityGetChangesMaps=function(e){var i=e.mParameters.appKey;var t=i.split(this.sDelimiter);var n=t[0];var s=t[1];this._getChangesMapForApp(n,s)};d.prototype.onsapUiSupportFlexibilitySetApps=function(e){var i=e.getParameters();this.oAppModel.setData(i)};d.prototype.onsapUiSupportFlexibilitySetChangesMaps=function(e){var i=e.getParameters();this.oChangesModel.setData(i);this.oView.byId("Tree").expandToLevel(1e3)};d.prototype.exit=function(){i.prototype.exit.apply(this,arguments)};d.prototype._getChangesMapForApp=function(i,t){function s(e,i){u[i]=[];var t=v[i];var n=sap.ui.getCore().byId(i);var s=[];var o=[];var r=[];if(n){if(n.data(a.appliedChangesCustomDataKey)){s=n.data(a.appliedChangesCustomDataKey).split(",")}if(n.data(a.failedChangesCustomDataKeyJs)){o=n.data(a.failedChangesCustomDataKeyJs).split(",")}if(n.data(a.failedChangesCustomDataKeyXml)){r=n.data(a.failedChangesCustomDataKeyXml).split(",")}}u[i]=t.map(p.bind(this,n,s,o,r,e))}function p(e,t,s,a,o,p){var d={id:p.getId(),changeType:p.getChangeType(),selector:p.getSelector(),controlPresent:!!e,indexInAppliedChanges:undefined,indexOfFirstFailing:undefined,dependentControls:[],dependentChanges:[],someDirectDependingChangesFailed:false,someDirectDependingChangesNotApplied:false,isInSubTree:false};var l=s.concat(a);if(d.controlPresent&&t.indexOf(p.getId())>-1){d.indexInAppliedChanges=t.indexOf(p.getId())}if(d.controlPresent&&s.indexOf(p.getId())>-1){d.modifier="JS";d.indexOfFirstFailing=l.indexOf(p.getId())}if(d.controlPresent&&a.indexOf(p.getId())>-1){d.modifier="XML";d.indexOfFirstFailing=l.indexOf(p.getId())}if(p._aDependentSelectorList){var h=r.getAppComponentInstance(i);d.dependentControls=p._aDependentSelectorList.map(function(e){return{id:e.id,controlPresent:n.bySelector(e,h)}})}o[p.getId()]=d;return d}function d(e,i,t){var n=t.dependencies;if(n.indexOf(e.id)!==-1){var s=JSON.stringify(c[i].selector)===JSON.stringify(e.selector);e.isInSubTree=e.isInSubTree||s}}function l(i,t){t.forEach(function(i){e.each(y,d.bind(this,i));i.allDependendingControlsPresent=i.dependentControls.every(function(e){return e.controlPresent});if(y[i.id]&&y[i.id].dependencies){y[i.id].dependencies.forEach(function(e){var t=c[e];var n=t.indexInAppliedChanges===undefined;t=c[e];i.someDirectDependingChangesNotApplied=i.someDirectDependingChangesNotApplied||n;var s=t.indexOfFirstFailing===undefined;var a=s&&n;i.someDirectDependingChangesFailed=i.someDirectDependingChangesFailed||s;i.someDirectDependingChangesNotSuccessfulApplied=i.someDirectDependingChangesNotSuccessfulApplied||a;i.dependentChanges.push(t)})}i.isApplicable=!i.someDirectDependingChangesNotApplied&&i.controlPresent&&i.allDependendingControlsPresent&&!i.someDirectDependingChangesNotApplied;i.isPossibleRootCause=i.isApplicable&&i.indexInAppliedChanges===undefined})}function h(e){e=e.filter(function(i){return!e.some(function(e){return e.dependentChanges.some(function(e){return e.id===i.id})})});return e.map(function(e){return{id:e.id,text:e.changeType,nodes:e.dependentChanges?h(e.dependentChanges):[]}})}function g(e,i){f.push({text:e,nodes:h(i)})}var c={};var u={};var f=[];var C=o.getChangePersistenceForComponent(i,t);var v=C._mChanges.mChanges;var y=C._mChangesInitial.mDependencies;Object.keys(v).forEach(s.bind(this,c));e.each(u,l);e.each(u,g);this._oStub.sendEvent(this.getId()+"SetChangesMaps",{changes:c,tree:f})};return d});