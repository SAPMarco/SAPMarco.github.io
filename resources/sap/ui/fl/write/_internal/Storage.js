/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/StorageUtils","sap/ui/fl/write/_internal/StorageFeaturesMerger","sap/base/util/ObjectPath"],function(e,n,r){"use strict";var t="sap/ui/fl/write/_internal/connectors/";function i(){return e.getConnectors(t,false)}function u(e,n){var r=n.filter(function(n){return n.layers.indexOf("ALL")!==-1||n.layers.indexOf(e)!==-1});if(r.length===1){return r[0]}if(r.length===0){throw new Error("No Connector configuration could be found to write into layer: "+e)}if(r.length>1){throw new Error("sap.ui.core.Configuration 'flexibilityServices' has a misconfiguration: Multiple Connector configurations were found to write into layer: "+e)}}function o(n){var r=n.map(function(n){return n.writeConnectorModule.loadFeatures({url:n.url}).then(function(e){return{features:e,layers:n.layers}}).catch(e.logAndResolveDefault.bind(null,{features:{},layers:n.layers},n,"loadFeatures"))});return Promise.all(r)}function a(e){if(!e){return Promise.reject("No layer was provided")}return i().then(u.bind(this,e))}function l(e){if(e.draft){return new Promise(function(n,r){sap.ui.require(["sap/ui/fl/write/api/FeaturesAPI"],function(t){t.isVersioningEnabled(e.layer).then(function(t){if(t){n()}else{r("Draft is not supported for the given layer: "+e.layer)}})})})}return Promise.resolve()}function s(e,n){return l(n).then(a.bind(undefined,n.layer)).then(function(t){n.url=t.url;var i=r.get(e,t.writeConnectorModule);return i.call(t.writeConnectorModule,n)})}var f={};f.write=function(e){return s("write",e)};f.remove=function(e){return s("remove",e)};f.update=function(e){return s("update",e)};f.reset=function(e){return s("reset",e)};f.getFlexInfo=function(e){return s("getFlexInfo",e)};f.loadFeatures=function(){return i().then(o).then(n.mergeResults)};f.publish=function(e){return s("publish",e)};f.versions={load:function(e){return i().then(s.bind(undefined,"versions.load",e))},activate:function(e){return i().then(s.bind(undefined,"versions.activate",e))},discardDraft:function(e){return i().then(s.bind(undefined,"versions.discardDraft",e))}};return f},true);