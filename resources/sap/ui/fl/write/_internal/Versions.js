/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Storage","sap/ui/fl/Utils"],function(e,r,n){"use strict";var t={};function i(r){var n=e.getChangePersistenceForComponent(r.nonNormalizedReference,r.appVersion);var t=n.getDirtyChanges().concat();t.forEach(function(e){n.deleteChange(e,true)});return t.length>0}function a(e){return e.some(function(e){return e.versionNumber===0})}function s(e,r){if(a(e)){e.shift()}e.splice(0,0,r);return e}var o={};o.initialize=function(e){var n=e.reference;var i=e.layer;if(t[n]&&t[n][i]){return Promise.resolve(t[n][i])}return r.versions.load(e).then(function(e){t[n]=t[n]||{};t[n][i]=e;return t[n][i]})};o.getVersions=function(e){var r=e.reference;var n=e.layer;if(!t[r]||!t[r][n]){throw Error("Versions for reference '"+r+"' and layer '"+n+"' were not initialized.")}return t[r][n]};o.clearInstances=function(){t={}};o.ensureDraftVersionExists=function(e){var r=n.normalizeReference(e.reference);var i=t[r][e.layer];if(!a(i)){t[r][e.layer].splice(0,0,{versionNumber:0})}};o.activateDraft=function(n){var t=o.getVersions(n);var i=a(t);var f=e.getChangePersistenceForComponent(n.nonNormalizedReference,n.appVersion);var u=f.getDirtyChanges().length>0;var c;if(u){c=f.saveDirtyChanges(false,undefined,true)}else{c=Promise.resolve()}if(!i&&!u){return Promise.reject("No draft exists")}return c.then(r.versions.activate.bind(undefined,n)).then(function(e){return s(t,e)})};o.discardDraft=function(e){var n=o.getVersions(e);if(a(n)){return r.versions.discardDraft(e).then(function(){n.shift();i(e);return true})}var t=i(e);return Promise.resolve(t)};return o});