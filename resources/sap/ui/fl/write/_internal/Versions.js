/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/registry/Settings","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Storage","sap/base/util/UriParameters","sap/ui/model/json/JSONModel","sap/ui/fl/Utils","sap/ui/model/BindingMode"],function(e,r,t,n,i,a,s){"use strict";var o={};var f=9;var c=f+1;function d(e,r,t){var a=l(t);var o=sap.ui.fl.Versions.Original;t.forEach(function(e){if(e.version===sap.ui.fl.Versions.Draft){e.type="draft"}else if(o===sap.ui.fl.Versions.Original){e.type="active";o=e.version}else{e.type="inactive"}});var c=n.fromQuery(window.location.search).get("sap-ui-xx-versionSwitchActive");var d=false;if(c&&c!=="false"){d=true}var u=new i({versioningEnabled:r,versions:t,activeVersion:o,backendDraft:a,dirtyChanges:false,draftAvailable:a,switchVersionsActive:d});u.setDefaultBindingMode(s.OneWay);u.setSizeLimit(f);u.setDirtyChanges=function(e){u.setProperty("/dirtyChanges",e);u.updateDraftVersion();u.updateBindings(true)};u.updateDraftVersion=function(){var e=u.getProperty("/versions");var r=u.getProperty("/versioningEnabled");var t=u.getProperty("/dirtyChanges");var n=u.getProperty("/backendDraft");var i=r&&(t||n);u.setProperty("/draftAvailable",i);if(!l(e)&&i){e.splice(0,0,{version:sap.ui.fl.Versions.Draft,type:"draft"});u.updateBindings(true)}if(l(e)&&!i){e.shift();u.updateBindings(true)}};return u}function u(e,r){var t=[];var n=r.changePersistences;n.forEach(function(e){t=e.getDirtyChanges().concat();t.forEach(function(r){e.deleteChange(r,true)})});return t.length>0}function v(e){var t={dirtyChangesExist:false,changePersistences:[]};if(e.reference){var n=r.getChangePersistenceForComponent(e.reference,e.appVersion);if(n.getDirtyChanges().length>0){t.dirtyChangesExist=true;t.changePersistences.push(n)}}if(e.nonNormalizedReference){var i=r.getChangePersistenceForComponent(e.nonNormalizedReference,e.appVersion);if(i.getDirtyChanges().length>0){t.dirtyChangesExist=true;t.changePersistences.push(i)}}return t}function l(e){return e.some(function(e){return e.version===sap.ui.fl.Versions.Draft})}var g={};g.initialize=function(r){var n=r.reference;var i=r.layer;r.limit=c;return e.getInstance().then(function(e){var a=e.isVersioningEnabled(i);var s=a?t.versions.load(r):Promise.resolve([]);return s.then(function(e){o[n]=o[n]||{};o[n][i]=o[n][i]||{};o[n][i]=d(r,a,e);return o[n][i]})})};g.getVersionsModel=function(e){var r=e.reference;var t=e.layer;if(!o[r]||!o[r][t]){throw Error("Versions Model for reference '"+r+"' and layer '"+t+"' were not initialized.")}var n=v(e);if(n.dirtyChangesExist){o[r][t].updateDraftVersion(e)}return o[r][t]};g.clearInstances=function(){o={}};g.onAllChangesSaved=function(e){e.reference=a.normalizeReference(e.reference);var r=g.getVersionsModel(e);var t=r.getProperty("/versioningEnabled");var n=r.getProperty("/dirtyChanges");r.setProperty("/dirtyChanges",true);r.setProperty("/backendDraft",t&&n);r.updateDraftVersion()};g.activateDraft=function(e){var r=g.getVersionsModel(e);var n=r.getProperty("/versions");var i=l(n);if(!i){return Promise.reject("No draft exists")}var a=[];if(r.getProperty("/dirtyChanges")){var s=v(e);var o=s.changePersistences;a=o.map(function(r){return r.saveDirtyChanges(e.appComponent,false,undefined,true)})}return Promise.all(a).then(t.versions.activate.bind(undefined,e)).then(function(e){n.forEach(function(e){e.type="inactive"});e.type="active";n.shift();n.splice(0,0,e);r.setProperty("/backendDraft",false);r.setProperty("/dirtyChanges",false);r.setProperty("/draftAvailable",false);r.setProperty("/activeVersion",e.version);r.updateBindings(true)})};g.discardDraft=function(e){var r=g.getVersionsModel(e);var n=r.getProperty("/versions");var i=v(e);var a=r.getProperty("/backendDraft");var s=a?t.versions.discardDraft(e):Promise.resolve();return s.then(function(){n.shift();r.setProperty("/backendDraft",false);r.setProperty("/dirtyChanges",false);r.setProperty("/draftAvailable",false);r.updateBindings(true);var t=u(e,i);return{backendChangesDiscarded:a,dirtyChangesDiscarded:t}})};return g});