/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Storage","sap/ui/fl/Utils"],function(e,r,n){"use strict";var t={};function i(e){var r=e.reference;var n=e.layer;return t[r]&&t[r][n]&&t[r][n].backendDraft}function a(e,r){var n=e.reference;var i=e.layer;if(t[n]){t[n][i].backendDraft=r}}function s(e,r){var n=[];var t=r.changePersistences;t.forEach(function(e){n=e.getDirtyChanges().concat();n.forEach(function(r){e.deleteChange(r,true)})});return n.length>0}function f(r){var n={dirtyChangesExist:false,changePersistences:[]};if(r.reference){var t=e.getChangePersistenceForComponent(r.reference,r.appVersion);if(t.getDirtyChanges().length>0){n.dirtyChangesExist=true;n.changePersistences.push(t)}}if(r.nonNormalizedReference){var i=e.getChangePersistenceForComponent(r.nonNormalizedReference,r.appVersion);if(i.getDirtyChanges().length>0){n.dirtyChangesExist=true;n.changePersistences.push(i)}}return n}function c(e){return e.some(function(e){return e.versionNumber===0})}function o(e,r){if(c(e)){e.shift()}e.splice(0,0,r);return e}var u={};u.initialize=function(e){var n=e.reference;var i=e.layer;return r.versions.load(e).then(function(e){t[n]=t[n]||{};t[n][i]=e;t[n][i].backendDraft=c(e);return t[n][i]})};u.getVersions=function(e){var r=e.reference;var n=e.layer;if(!t[r]||!t[r][n]){throw Error("Versions for reference '"+r+"' and layer '"+n+"' were not initialized.")}var i=f(e);if(i.dirtyChangesExist){this.ensureDraftVersionExists(e)}return t[r][n]};u.clearInstances=function(){t={}};u.ensureDraftVersionExists=function(e){var r=n.normalizeReference(e.reference);var i=t[r][e.layer];if(!c(i)){t[r][e.layer].splice(0,0,{versionNumber:0})}};u.activateDraft=function(e){var n=u.getVersions(e);var t=c(n);if(!t){return Promise.reject("No draft exists")}var i=f(e);var s=[];if(i.dirtyChangesExist){var h=i.changePersistences;s=h.map(function(r){return r.saveDirtyChanges(e.appComponent,false,undefined,true)})}return Promise.all(s).then(r.versions.activate.bind(undefined,e)).then(function(r){a(e,false);return o(n,r)})};u.discardDraft=function(e){var n=u.getVersions(e);var t=f(e);if(i(e)){return r.versions.discardDraft(e).then(function(){n.shift();a(e,false);var r=s(e,t);return{backendChangesDiscarded:true,dirtyChangesDiscarded:r}})}n.shift();var c=s(e,t);return Promise.resolve({backendChangesDiscarded:false,dirtyChangesDiscarded:c})};return u});