/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/isPlainObject","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Core","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/_internal/condenser/classifications/LastOneWins","sap/ui/fl/write/_internal/condenser/classifications/Reverse","sap/ui/fl/write/_internal/condenser/UIReconstruction","sap/ui/fl/write/_internal/condenser/Utils","sap/ui/fl/Change","sap/ui/fl/Utils","sap/ui/performance/Measurement"],function(e,n,i,s,r,t,a,o,f,c,l,u){"use strict";var d={};var p="unclassified";var C={lastOneWins:t,reverse:a};function h(e,n){return n.classification===sap.ui.fl.condenser.Classification.Create&&e[sap.ui.fl.condenser.Classification.Move]}function v(e,n){return n.classification===sap.ui.fl.condenser.Classification.Move&&e[sap.ui.fl.condenser.Classification.Destroy]}function g(e,n){return n.classification===sap.ui.fl.condenser.Classification.Create&&e[sap.ui.fl.condenser.Classification.Destroy]}function y(e,n,i,s){if(!v(e,i)&&!g(e,i)){var r=i.classification;if(!e[r]){i.change=s;e[r]=[i]}}if(h(e,i)||g(e,i)){delete e[sap.ui.fl.condenser.Classification.Move];delete e[sap.ui.fl.condenser.Classification.Destroy]}o.addChange(n,i)}function _(e,n,i,s,r){if(!e[s.type]){e[s.type]={}}var t=e[s.type];if(s.type===f.NOT_INDEX_RELEVANT){if(!t[s.classification]){t[s.classification]={}}var a=t[s.classification];C[s.classification].addToChangesMap(a,s.uniqueKey,r)}else{i.push(r);y(t,n,s,r)}}function I(e,n,i){if(!e[n]){e[n]=[]}e[n].push(i)}function E(e,n){var t=i.getControlIdBySelector(n.getSelector(),e);var a=s.byId(t);if(a){var o={modifier:i,appComponent:e,view:l.getViewForControl(a)};var f=r.getControlIfTemplateAffected(n,a,o);return Promise.resolve(r.getChangeHandler(n,f,o)).then(function(e){if(e&&typeof e.getCondenserInfo==="function"){return e.getCondenserInfo(n)}})}return Promise.resolve()}function m(e,n,s,r){var t=n!==undefined?n.affectedControl:i.getControlIdBySelector(s.getSelector(),r);if(!e[t]){e[t]={}}return e[t]}function A(e,n,i,s,r){return r.reduce(function(r,t){return r.then(M.bind(this,e,n,i,s,t))}.bind(this),Promise.resolve())}function M(e,n,i,s,r){return E(e,r).then(function(t){N(t,e);var a=m(n,t,r,e);if(t!==undefined){x(t);_(a,i,s,t,r)}else{I(a,p,r);n[p]=true}})}function x(e){if(C[e.classification]){e.type=f.NOT_INDEX_RELEVANT}else{e.type=f.INDEX_RELEVANT}}function N(e,n){["affectedControl","sourceContainer","targetContainer"].forEach(function(s){if(e&&e[s]){e[s]=i.getControlIdBySelector(e[s],n)}})}function O(i,s){e(i,function(e,r){if(C[e]&&C[e].getChangesFromMap){C[e].getChangesFromMap(i,e).forEach(function(e){s.push(e)})}else if(n(r)){return O(r,s)}else if(Array.isArray(r)){r.forEach(function(e){if(e instanceof c){s.push(e)}else{s.push(e.change)}})}});return s}function R(e){return O(e,[])}function T(i,s){e(i,function(e,i){if(n(i)){T(i,s)}else if(Array.isArray(i)){i.forEach(function(e){if(!(e instanceof c)){s.push(e)}})}});return s}function w(e,n){n.sort(function(n,i){return e.indexOf(n)-e.indexOf(i)})}function b(e,n){var i=e.map(function(e){return e.getId()});n.forEach(function(n){if(i.indexOf(n.getId())===-1){e.push(n)}})}d.condense=function(e,n){u.start("Condenser_overall","Condenser overall - CondenserClass",["sap.ui.fl","Condenser"]);var i={};var s={};var r=[];var t=[];var a=[];n.slice(0).reverse().forEach(function(e){if(e instanceof c&&e.isApplyProcessFinished()){a.push(e)}else{t.push(e)}});u.start("Condenser_defineMaps","defining of maps - CondenserClass",["sap.ui.fl","Condenser"]);return A(e,i,s,r,a).then(function(){u.end("Condenser_defineMaps");var e=i[p];if(!e){o.compareAndUpdate(i,s)}var a=R(i);if(e){b(a,r)}a=a.concat(t);w(n,a);if(!e){u.start("Condenser_handleIndexRelatedChanges","handle index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var f=T(i,[]);u.start("Condenser_sort","sort index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var c=o.sortIndexRelatedChanges(s,f);u.end("Condenser_sort");o.swapChanges(c,a);u.end("Condenser_handleIndexRelatedChanges")}u.end("Condenser_overall");return a})};return d});