/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/isPlainObject","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Core","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/_internal/condenser/classifications/LastOneWins","sap/ui/fl/write/_internal/condenser/classifications/Reverse","sap/ui/fl/write/_internal/condenser/UIReconstruction","sap/ui/fl/write/_internal/condenser/Utils","sap/ui/fl/Change","sap/ui/fl/Utils","sap/ui/performance/Measurement"],function(e,n,i,r,t,s,a,o,f,c,l,u){"use strict";var d={};var p="unclassified";var C={lastOneWins:s,reverse:a};function h(e,n){return n.classification===sap.ui.fl.condenser.Classification.Create&&e[sap.ui.fl.condenser.Classification.Move]}function v(e,n){return n.classification===sap.ui.fl.condenser.Classification.Move&&e[sap.ui.fl.condenser.Classification.Destroy]}function g(e,n){return n.classification===sap.ui.fl.condenser.Classification.Create&&e[sap.ui.fl.condenser.Classification.Destroy]}function y(e,n,i,r){if(!v(e,i)&&!g(e,i)){var t=i.classification;if(!e[t]){i.change=r;e[t]=[i]}}if(h(e,i)||g(e,i)){delete e[sap.ui.fl.condenser.Classification.Move];delete e[sap.ui.fl.condenser.Classification.Destroy]}o.addChange(n,i)}function _(e,n,i,r,t){if(!e[r.type]){e[r.type]={}}var s=e[r.type];if(r.type===f.NOT_INDEX_RELEVANT){if(!s[r.classification]){s[r.classification]={}}var a=s[r.classification];C[r.classification].addToChangesMap(a,r.uniqueKey,t)}else{i.push(t);y(s,n,r,t)}}function I(e,n,i){if(!e[n]){e[n]=[]}e[n].push(i)}function E(e,n){var s=i.getControlIdBySelector(n.getSelector(),e);var a=r.byId(s);if(a){var o={modifier:i,appComponent:e,view:l.getViewForControl(a)};var f=t.getControlIfTemplateAffected(n,a,o);return Promise.resolve(t.getChangeHandler(n,f,o)).then(function(e){if(e&&typeof e.getCondenserInfo==="function"){return e.getCondenserInfo(n)}})}return Promise.resolve()}function m(e,n,r,t){var s=n!==undefined?n.affectedControl:i.getControlIdBySelector(r.getSelector(),t);if(!e[s]){e[s]={}}return e[s]}function M(e,n,i,r,t){return t.reduce(function(t,s){return t.then(A.bind(this,e,n,i,r,s))}.bind(this),Promise.resolve())}function A(e,n,i,r,t){return E(e,t).then(function(s){N(s,e);var a=m(n,s,t,e);if(s!==undefined){x(s);_(a,i,r,s,t)}else{I(a,p,t);n[p]=true}})}function x(e){if(C[e.classification]){e.type=f.NOT_INDEX_RELEVANT}else{e.type=f.INDEX_RELEVANT}}function N(e,n){["affectedControl","sourceContainer","targetContainer"].forEach(function(r){if(e&&e[r]){e[r]=i.getControlIdBySelector(e[r],n)}})}function O(i,r){e(i,function(e,t){if(C[e]&&C[e].getChangesFromMap){C[e].getChangesFromMap(i,e).forEach(function(e){r.push(e)})}else if(n(t)){return O(t,r)}else if(Array.isArray(t)){t.forEach(function(e){if(e instanceof c){r.push(e)}else{r.push(e.change)}})}});return r}function R(e){return O(e,[])}function T(i,r){e(i,function(e,i){if(n(i)){T(i,r)}else if(Array.isArray(i)){i.forEach(function(e){if(!(e instanceof c)){r.push(e)}})}});return r}function w(e,n){n.sort(function(n,i){return e.indexOf(n)-e.indexOf(i)})}function b(e,n){var i=e.map(function(e){return e.getId()});n.forEach(function(n){if(i.indexOf(n.getId())===-1){e.push(n)}})}d.condense=function(e,n){u.start("Condenser_overall","Condenser overall - CondenserClass",["sap.ui.fl","Condenser"]);var i={};var r={};var t=n.slice(0).reverse();var s=[];var a=t.filter(function(e){return!(e instanceof c)});t=t.filter(function(e){return e instanceof c});u.start("Condenser_defineMaps","defining of maps - CondenserClass",["sap.ui.fl","Condenser"]);return M(e,i,r,s,t).then(function(){u.end("Condenser_defineMaps");var e=i[p];if(!e){o.compareAndUpdate(i,r)}var t=R(i);if(e){b(t,s)}t=t.concat(a);w(n,t);if(!e){u.start("Condenser_handleIndexRelatedChanges","handle index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var f=T(i,[]);u.start("Condenser_sort","sort index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var c=o.sortIndexRelatedChanges(r,f);u.end("Condenser_sort");o.swapChanges(c,t);u.end("Condenser_handleIndexRelatedChanges")}u.end("Condenser_overall");return t})};return d});