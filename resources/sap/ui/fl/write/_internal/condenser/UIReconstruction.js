/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_isEqual","sap/base/util/each","sap/ui/fl/write/_internal/condenser/classifications/Create","sap/ui/fl/write/_internal/condenser/classifications/Destroy","sap/ui/fl/write/_internal/condenser/classifications/Move","sap/ui/fl/write/_internal/condenser/Utils"],function(n,e,i,t,r,a){"use strict";var f={};var c={create:i,destroy:t,move:r};function o(n,i){e(n,function(n,t){e(t,function(e,r){i(t,n,r,e)})})}function s(n,e,i){n.splice(i,0,n.splice(e,1)[0])}function u(n,e){var i={};o(n,function(n,t,r,f){var c=r[a.TARGET_UI];c.forEach(function(n){e.forEach(function(e){if(n===e.affectedControl){if(!i[t]){i[t]={}}var r=i[t];if(!r[f]){r[f]=[]}var a=r[f];a.push(e)}})})});return i}function l(n){return!n.some(function(n){return n.classification!==sap.ui.fl.condenser.Classification.Create})}function v(n){return!n.some(function(n){return a.isUnknown(n)})}function h(n){return n.getTargetIndex(n.change)}function d(n){n.sort(function(n,e){var i=h(n);var t=h(e);return i-t})}function g(n){return!n.some(function(n){return!a.isUnknown(n)})}function E(n,e){var i=e.targetContainer;var t=e.affectedControl;var r=e.getTargetIndex(e.change);var f=n[i][e.targetAggregation];a.extendArrayWithPlaceholders(f,undefined,r);var c=f.indexOf(t);s(f,c,r)}function I(e,i){var t;if(e.length<i.length){t=i.slice(e.length);if(!g(t)){return false}i=i.slice(0,e.length)}else if(e.length>i.length){t=e.slice(i.length,e.length);if(!g(t)){return false}e=e.slice(0,i.length)}return n(e,i)}function T(n,e,i,t,r){var f={};r.forEach(function(n){var t=n.targetContainer;if(!f[t]){f[t]={}}var r=f[t];if(!r[e]){r[e]=a.initializeArrayWithPlaceholders(0,i.length-1)}c[n.classification].simulate(r[e],n,i)});r.forEach(function(n){if(n.classification===sap.ui.fl.condenser.Classification.Move){E(f,n)}});var o=f[n][e];if(I(t,o)){return true}return false}function p(n,i){o(i,function(i,t,r){r[a.TARGET_UI].forEach(function(i,t){if(!a.isUnknown(i)){var r=n[i];var f=r[a.INDEX_RELEVANT];e(f,function(n,e){if(n!==sap.ui.fl.condenser.Classification.Destroy){e.forEach(function(n){n.setTargetIndex(n.change,t)})}})}})})}function A(n,e){o(e,function(e,i,t,r){var f=t[a.INITIAL_UI];var c=t[a.TARGET_UI];if(I(f,c)){c.forEach(function(e){var i=n[e];if(i!==undefined){delete i[a.INDEX_RELEVANT]}});delete e[r]}})}function _(n,e){o(e,function(e,i,t){var r=t[a.INITIAL_UI];var f=t[a.TARGET_UI];r.forEach(function(e,i){var t=n[e];if(!t||!t[a.INDEX_RELEVANT]){var r=a.PLACEHOLDER+i;var c=f.indexOf(e);if(c>=0){f[c]=r}}})})}f.swapChanges=function(n,e){var i=n.map(function(n){return e.indexOf(n)}).sort();n.forEach(function(n){e[i.shift()]=n})};f.sortIndexRelatedChanges=function(n,e){var i=[];var t=u(n,e);o(t,function(e,t,r,f){var c=n[t][f][a.TARGET_UI];var o=n[t][f][a.INITIAL_UI];if(v(c)||l(r)){d(r)}else if(!T(t,f,o,c,r)){var u=false;var h=r.length;while(h!==0&&!u){var g=0;var E=1;while(E<r.length&&!u){s(r,g,E);u=T(t,f,o,c,r);g++;E++}h--}}r.forEach(function(n){i=i.concat(n.change)})});return i};f.addChange=function(n,e){c[e.classification].addToReconstructionMap(n,e)};f.compareAndUpdate=function(n,e){A(n,e);_(n,e);p(n,e)};return f});