/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/includes","sap/base/util/restricted/_omit","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/api/FeaturesAPI","sap/base/Log","sap/ui/fl/Layer"],function(e,n,t,r,a,s,o,l,i,c){"use strict";function g(n){return n._getMap&&e(s.getChangeTypes(),n._getMap().changeType)||n.getChangeType&&e(s.getChangeTypes(),n.getChangeType())}function u(e){e.includeCtrlVariants=true;e.invalidateCache=false;return h._getUIChanges(e).then(function(e){return e.length>0})}function p(e){e.includeCtrlVariants=true;e.invalidateCache=false;return h._getUIChanges(e).then(function(e){return e.some(function(e){return e.packageName==="$TMP"||e.packageName===""})})}var h={hasHigherLayerChanges:function(e){return a.getFlexControllerInstance(e.selector).hasHigherLayerChanges(n(e,"selector"))},save:function(e){var t=a.getFlexControllerInstance(e.selector);var r=a.getDescriptorFlexControllerInstance(e.selector);e.invalidateCache=true;var s=a.getAppComponentForSelector(e.selector);e.componentId=s.getId();return t.saveAll(s,e.skipUpdateCache,e.draft,s).then(r.saveAll.bind(r,s,e.skipUpdateCache,e.draft)).then(h._getUIChanges.bind(null,n(e,"skipUpdateCache")))},getResetAndPublishInfo:function(e){return Promise.all([u(e),p(e),l.isPublishAvailable()]).then(function(n){var t={isResetEnabled:n[0],isPublishEnabled:n[1]};var r=n[2];var s=!(e.layer===c.USER)&&(!t.isResetEnabled||r&&!t.isPublishEnabled);if(s){return a.getFlexControllerInstance(e.selector).getResetAndPublishInfo(e).then(function(e){t.isResetEnabled=t.isResetEnabled||e.isResetEnabled;t.isPublishEnabled=t.isPublishEnabled||e.isPublishEnabled;return t}).catch(function(e){i.error("Sending request to flex/info route failed: "+e.message);return t})}return t})},reset:function(e){var n=a.getAppComponentForSelector(e.selector);var t=a.getFlexControllerInstance(n);var r=[e.layer,e.generator,n,e.selectorIds,e.changeTypes];return t.resetChanges.apply(t,r)},publish:function(e){e.styleClass=e.styleClass||"";var n=a.getAppComponentForSelector(e.selector);return a.getFlexControllerInstance(n)._oChangePersistence.transportAllUIChanges({},e.styleClass,e.layer,e.appVariantDescriptors)},add:function(e){if(g(e.change)){return e.change.store()}var n=a.getAppComponentForSelector(e.selector);return a.getFlexControllerInstance(n).addPreparedChange(e.change,n)},remove:function(e){if(!e.selector){throw new Error("An invalid selector was passed so change could not be removed with id: "+e.change.getId())}var n=a.getAppComponentForSelector(e.selector);if(!n){throw new Error("Invalid application component for selector, change could not be removed with id: "+e.change.getId())}if(g(e.change)){var s=a.getDescriptorFlexControllerInstance(n);s.deleteChange(e.change,n);return}var o=t.bySelector(e.change.getSelector(),n);var l=a.getFlexControllerInstance(n);if(o){r.destroyAppliedCustomData(o,e.change,t)}l.deleteChange(e.change,n)},_condense:function(e){return Promise.resolve().then(function(){if(!e.selector){throw Error("An invalid selector was passed")}var n=a.getAppComponentForSelector(e.selector);if(!n){throw Error("Invalid application component for selector")}if(!e.changes||e.changes&&!Array.isArray(e.changes)){throw Error("Invalid array of changes")}return o.condense(n,e.changes)})},_getUIChanges:function(e){if(e.layer){e.currentLayer=e.layer}return a.getFlexControllerInstance(e.selector)._oChangePersistence.getChangesForComponent(n(e,["invalidateCache","selector"]),e.invalidateCache)}};return h},true);