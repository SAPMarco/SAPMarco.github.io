/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/base/util/UriParameters"],function(a,e,r,t,s,i){"use strict";function n(a){return s.isVersioningEnabled(a.layer).then(function(e){if(e){return t.isDraftAvailable({selector:a.selector,layer:a.layer})}})}function l(a){var r=a.layer===e.USER;if(!r){return i.hasHigherLayerChanges({selector:a.selector,ignoreMaxLayerParameter:a.ignoreMaxLayerParameter})}}var u={getReloadReasonsForStart:function(a){var e=u.hasMaxLayerParameterWithValue({value:a.layer});var r=u.hasVersionParameterWithValue({value:sap.ui.fl.Versions.Draft.toString()});return Promise.all([!e?l(a):false,!r?n(a):false]).then(function(e){a.hasHigherLayerChanges=!!e[0];a.hasDraftChanges=!!e[1];return a})},hasVersionParameterWithValue:function(a){return r.hasParameterAndValue(sap.ui.fl.Versions.UrlParameter,a.value)},hasMaxLayerParameterWithValue:function(e){var t=a.FL_MAX_LAYER_PARAM;return r.hasParameterAndValue(t,e.value)},handleUrlParametersForStandalone:function(e){if(e.hasHigherLayerChanges){e.parameters=r.handleUrlParameters(e.parameters,a.FL_MAX_LAYER_PARAM,e.layer)}var t=new RegExp(sap.ui.fl.Versions.UrlParameter+"=-?\\d*&?","g");e.parameters=e.parameters.replace(t,"");if(e.hasDraftChanges){e.parameters=r.handleUrlParameters(e.parameters,sap.ui.fl.Versions.UrlParameter,sap.ui.fl.Versions.Draft)}if(e.parameters==="?"){e.parameters=""}return e.parameters},handleParametersOnStart:function(e){var t=r.getParsedURLHash();t.params=t.params||{};if(e.hasHigherLayerChanges){t.params[a.FL_MAX_LAYER_PARAM]=[e.layer]}if(e.hasDraftChanges){t.params[sap.ui.fl.Versions.UrlParameter]=[sap.ui.fl.Versions.Draft]}return t},initialDraftGotActivated:function(a){if(a.versioningEnabled){var e=this.hasVersionParameterWithValue({value:sap.ui.fl.Versions.Draft.toString()});return!t.isDraftAvailable(a)&&e}return false},getReloadMethod:function(a){var e={NOT_NEEDED:"NO_RELOAD",RELOAD_PAGE:"HARD_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION"};a.reloadMethod=e.NOT_NEEDED;a.hasDraft=a.hasDirtyDraftChanges||u.hasVersionParameterWithValue({value:sap.ui.fl.Versions.Draft.toString()});a.hasHigherLayerChanges=u.hasMaxLayerParameterWithValue({value:a.layer});a.initialDraftGotActivated=u.initialDraftGotActivated(a);if(a.changesNeedReload||a.hasDraft||a.hasHigherLayerChanges||a.initialDraftGotActivated){a.reloadMethod=e.RELOAD_PAGE;if(!a.changesNeedReload&&r.getUshellContainer()){a.reloadMethod=e.VIA_HASH}}return a}};return u});