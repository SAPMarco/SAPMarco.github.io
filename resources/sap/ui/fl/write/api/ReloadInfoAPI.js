/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/base/util/UriParameters"],function(a,e,r,t,i,s){"use strict";function n(a){return i.isVersioningEnabled(a.layer).then(function(e){if(e){return t.isDraftAvailable({selector:a.selector,layer:a.layer})}})}function l(a){var r=a.layer===e.USER;if(!r){return s.hasHigherLayerChanges({selector:a.selector,ignoreMaxLayerParameter:a.ignoreMaxLayerParameter})}}var h={getReloadReasonsForStart:function(a){var e=h.hasMaxLayerParameterWithValue({value:a.layer});var r=h.hasVersionParameterWithValue({value:a.layer});return Promise.all([!e?l(a):false,!r?n(a):false]).then(function(e){a.hasHigherLayerChanges=!!e[0];a.hasDraftChanges=!!e[1];return a})},hasVersionParameterWithValue:function(e){var t=a.FL_VERSION_PARAM;return r.hasParameterAndValue(t,e.value)},hasMaxLayerParameterWithValue:function(e){var t=a.FL_MAX_LAYER_PARAM;return r.hasParameterAndValue(t,e.value)},handleUrlParametersForStandalone:function(e){var t=r.getUshellContainer();if(!t){if(e.hasHigherLayerChanges){e.parameters=r.handleUrlParameters(e.parameters,a.FL_MAX_LAYER_PARAM,e.layer)}if(e.hasDraftChanges){e.parameters=r.handleUrlParameters(e.parameters,a.FL_VERSION_PARAM,e.layer)}}return e.parameters},handleParametersOnStart:function(e){var t=r.getParsedURLHash();t.params=t.params||{};if(e.hasHigherLayerChanges){t.params[a.FL_MAX_LAYER_PARAM]=[e.layer]}if(e.hasDraftChanges){t.params[a.FL_VERSION_PARAM]=[e.layer]}return t},initialDraftGotActivated:function(a){if(a.versioningEnabled){var e=this.hasVersionParameterWithValue({value:a.layer});var r=t.getVersions(a);return r&&r[0]&&r[0].versionNumber!==0&&e}return false},getReloadMethod:function(a){var e={NOT_NEEDED:"NO_RELOAD",RELOAD_PAGE:"HARD_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION"};a.reloadMethod=e.NOT_NEEDED;a.hasDraftChanges=a.hasDirtyDraftChanges||h.hasVersionParameterWithValue({value:a.layer});a.hasHigherLayerChanges=h.hasMaxLayerParameterWithValue({value:a.layer});a.initialDraftGotActivated=h.initialDraftGotActivated(a);if(a.changesNeedReload||a.hasDraftChanges||a.hasHigherLayerChanges||a.initialDraftGotActivated){a.reloadMethod=e.RELOAD_PAGE;if(!a.changesNeedReload&&r.getUshellContainer()){a.reloadMethod=e.VIA_HASH}}return a}};return h});