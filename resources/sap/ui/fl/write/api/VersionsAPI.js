/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/write/_internal/Versions","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexState/ManifestUtils"],function(e,r,n,t){"use strict";function o(e){if(e){var r=e.getManifest();var o=t.getFlexReference({manifest:r,componentData:e.getComponentData()});var i=n.getAppVersionFromManifest(r)}return{reference:o,appVersion:i}}var i={};i.initialize=function(e){if(!e.selector){return Promise.reject("No selector was provided")}if(!e.layer){return Promise.reject("No layer was provided")}var t=n.getAppComponentForControl(e.selector);var i=o(t);if(!i.reference){return Promise.reject("The application ID could not be determined")}return r.initialize({reference:n.normalizeReference(i.reference),layer:e.layer})};i.isDraftAvailable=function(e){var r=i.getVersions(e);var n=r.find(function(e){return e.versionNumber===0});return!!n};i.getVersions=function(e){if(!e.selector){throw Error("No selector was provided")}if(!e.layer){throw Error("No layer was provided")}var t=n.getAppComponentForControl(e.selector);var i=o(t);if(!i.reference){throw Error("The application ID could not be determined")}return r.getVersions({nonNormalizedReference:i.reference,reference:n.normalizeReference(i.reference),layer:e.layer})};i.loadDraftForApplication=function(r){if(!r.selector){return Promise.reject("No selector was provided")}if(!r.layer){return Promise.reject("No layer was provided")}var t=n.getAppComponentForControl(r.selector);var i=o(t);if(!i.reference){return Promise.reject("The application ID could not be determined")}return e.clearAndInitialize({componentId:t.getId(),reference:i.reference,draftLayer:r.layer})};i.activateDraft=function(e){if(!e.selector){return Promise.reject("No selector was provided")}if(!e.layer){return Promise.reject("No layer was provided")}if(!e.title){return Promise.reject("No version title was provided")}var t=n.getAppComponentForControl(e.selector);var i=o(t);if(!i.reference){return Promise.reject("The application ID could not be determined")}return r.activateDraft({nonNormalizedReference:i.reference,reference:n.normalizeReference(i.reference),appVersion:i.appVersion,layer:e.layer,title:e.title,appComponent:t})};i.discardDraft=function(t){if(!t.selector){return Promise.reject("No selector was provided")}if(!t.layer){return Promise.reject("No layer was provided")}var i=n.getAppComponentForControl(t.selector);var a=o(i);if(!a.reference){return Promise.reject("The application ID could not be determined")}return r.discardDraft({nonNormalizedReference:a.reference,reference:n.normalizeReference(a.reference),layer:t.layer,appVersion:a.appVersion}).then(function(r){if(r.backendChangesDiscarded){e.clearAndInitialize({componentId:i.getId(),reference:a.reference,draftLayer:t.layer})}return r})};return i});