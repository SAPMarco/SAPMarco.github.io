/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/library","sap/ui/core/library","sap/ui/dom/includeScript","sap/ui/integration/cards/BaseContent","sap/ui/integration/thirdparty/adaptivecards","sap/ui/integration/thirdparty/adaptivecards-templating","sap/ui/integration/thirdparty/markdown-it","sap/ui/integration/cards/adaptivecards/elements/UI5InputText","sap/ui/integration/cards/adaptivecards/elements/UI5InputNumber","sap/ui/integration/cards/adaptivecards/elements/UI5InputChoiceSet","sap/ui/integration/cards/adaptivecards/elements/UI5InputTime","sap/ui/integration/cards/adaptivecards/elements/UI5InputDate","sap/ui/integration/cards/adaptivecards/elements/UI5InputToggle","sap/ui/integration/cards/adaptivecards/overwrites/ActionRender","sap/ui/integration/cards/adaptivecards/elements/hostConfig","sap/m/VBox","sap/m/MessageStrip","sap/ui/core/HTML","sap/ui/core/Core","sap/ui/model/json/JSONModel","sap/base/Log","sap/ui/integration/util/LoadingProvider","sap/ui/Device"],function(e,t,n,i,r,a,o,s,d,p,u,g,c,l,C,y,h,f,m,v,_,T,b){"use strict";var R=t.MessageType;var w=i.extend("sap.ui.integration.cards.AdaptiveContent",{metadata:{library:"sap.ui.integration"},renderer:{apiVersion:2,render:function(e,t){var n=i.getMetadata().getRenderer();return n.render.apply(this,arguments)}}});w.prototype.init=function(){this.setComponentsReady(false);this._bAdaptiveCardElementsReady=false;this._setupCardContent();this._setupAdaptiveCardDependency();this._loadDependencies();this._oLoadingProvider=new T};w.prototype.onAfterRendering=function(){this._renderMSCardContent(this._oCardTemplate||this._oCardConfig)};w.prototype._setupCardContent=function(){var e=new h(this.getId()+"-message",{showCloseButton:true,visible:false}),t=new f(this.getId()+"content",{preferDOM:false,content:"<div>&nbsp;</div>"});e.addStyleClass("sapUiTinyMargin");this.setAggregation("_content",new y({items:[e,t]}))};w.prototype.setConfiguration=function(e){this._oCardConfig=e;if(e&&e.request&&e.request.url){this._loadManifestFromUrl(e.request.url);return}this._handleMarkDown();this._setupMSCardContent()};w.prototype.getConfiguration=function(){return this._oCardConfig};w.prototype._handleMarkDown=function(){var e=this;r.AdaptiveCard.onProcessMarkdown=function(t,n){var i=e.getParent(),r=i&&i.getManifestEntry("/sap.card/configuration/enableMarkdown");if(r){n.outputHtml=(new o).render(t);n.didProcess=true;return n}}};w.prototype._loadManifestFromUrl=function(e){var t=new v,n=this;t.loadData(e).then(function(){n._oCardConfig=Object.assign(n._oCardConfig,t.getData())}).then(function(){n._handleMarkDown();n._setupMSCardContent()}).then(function(){t.destroy();t=null}).catch(function(){_.error("No JSON file found on this URL. Please provide a correct path to the JSON-serialized card object model file.")})};w.prototype._setupAdaptiveCardDependency=function(){this.adaptiveCardInstance=new r.AdaptiveCard;this._doMSCardsOverwrites();this._adjustHostConfig();this._handleActions();this._replaceElements();this._isRtl()};w.prototype._doMSCardsOverwrites=function(){r.Action.prototype.render=l};w.prototype._adjustHostConfig=function(){this.adaptiveCardInstance.hostConfig=new r.HostConfig(C)};w.prototype._isRtl=function(){this.adaptiveCardInstance.isRtl=function(){return m.getConfiguration().getRTL()}};w.prototype._handleActions=function(){this.adaptiveCardInstance.onExecuteAction=function(t){var n,i,a;if(t instanceof r.OpenUrlAction){i={url:t.url};n=e.CardActionType.Navigation}else if(t instanceof r.SubmitAction){i={data:t.data};n=e.CardActionType.Submit}else{return}a=this.getActions();if(a){a.fireAction(this,n,i)}}.bind(this)};w.prototype.onActionSubmitStart=function(e){this.getParent().setBusy(true)};w.prototype.onActionSubmitEnd=function(e,t){var n=m.getLibraryResourceBundle("sap.ui.integration"),i=t?n.getText("CARDS_ADAPTIVE_ACTION_SUBMIT_ERROR"):n.getText("CARDS_ADAPTIVE_ACTION_SUBMIT_SUCCESS"),r=t?R.Error:R.Success;this.showMessage(i,r);this.getParent().setBusy(false)};w.prototype.showMessage=function(e,t){var n=this.getAggregation("_content").getItems()[0];n.applySettings({type:t,text:e,visible:true})};w.prototype._replaceElements=function(){r.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Text");r.AdaptiveCard.elementTypeRegistry.registerType("Input.Text",function(){return new s});r.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Number");r.AdaptiveCard.elementTypeRegistry.registerType("Input.Number",function(){return new d});r.AdaptiveCard.elementTypeRegistry.unregisterType("Input.ChoiceSet");r.AdaptiveCard.elementTypeRegistry.registerType("Input.ChoiceSet",function(){return new p});r.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Time");r.AdaptiveCard.elementTypeRegistry.registerType("Input.Time",function(){return new u});r.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Date");r.AdaptiveCard.elementTypeRegistry.registerType("Input.Date",function(){return new g});r.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Toggle");r.AdaptiveCard.elementTypeRegistry.registerType("Input.Toggle",function(){return new c})};w.prototype.setCardDataProvider=function(e){this._oCardDataProvider=e};w.prototype._setupMSCardContent=function(){var e=this._oCardConfig,t,n=this._oCardDataProvider;if(!this.adaptiveCardInstance||!e){return}t=e.$data||e.data;if(!t&&!n){this._oCardTemplate=null;this._renderMSCardContent(e);return}if(e.$data){t={json:t}}this._setDataConfiguration(t)};w.prototype.onDataChanged=function(){var e=this.getBindingContext().getPath(),t=this.getModel().getProperty(e);this._oCardTemplate=this._setTemplating(this._oCardConfig,t);this._oLoadingProvider.setLoading(false);this.invalidate()};w.prototype._renderMSCardContent=function(e){var t=this.getAggregation("_content").getItems()[1].$(),n=!!this.isLoading();this.setBusy(n);this.getAggregation("_content").toggleStyleClass("sapFCardContentHidden",n);if(this.adaptiveCardInstance&&e&&t.length){this.adaptiveCardInstance.parse(e);t.html(this.adaptiveCardInstance.render());this._bAdaptiveCardElementsReady=true;this._fireCardReadyEvent();if(this.adaptiveCardInstance.renderedElement){this.adaptiveCardInstance.renderedElement.tabIndex=-1}}};w.prototype._fireCardReadyEvent=function(){if(this._bAdaptiveCardElementsReady&&this.getComponentsReady()){this._bReady=true;this.fireEvent("_ready")}};w.prototype._setTemplating=function(e,t){var n=new a.Template(e),i=new a.EvaluationContext;i.$root=t;return n.expand(i)};w.prototype._loadDependencies=function(){if(this.getComponentsReady()){_.debug("WebComponents were already loaded");this._fireCardReadyEvent();return}if(window.customElements){window.customElements.whenDefined("ui5-button").then(function(){if(!this.getComponentsReady()){this.setComponentsReady(true);this._fireCardReadyEvent()}}.bind(this))}setTimeout(function(){if(this.getComponentsReady()){_.debug("WebComponents were already loaded");return}n({id:"webcomponents-loader",url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/webcomponentsjs/webcomponents-loader.js")})}.bind(this));document.addEventListener("WebComponentsReady",function(){if(this.getComponentsReady()){_.debug("WebComponents were already loaded");return}if(b.browser.edge||b.browser.msie){n({id:"webcomponents-bundle-es5",url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/bundle.es5.js")})}else{n({id:"webcomponents-bundle",attributes:{type:"module"},url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/bundle.esm.js")})}this.setComponentsReady(true);this._fireCardReadyEvent()}.bind(this))};w.prototype.setComponentsReady=function(e){this._bComponentsReady=e;return this};w.prototype.getComponentsReady=function(){return!!this._bComponentsReady};return w});