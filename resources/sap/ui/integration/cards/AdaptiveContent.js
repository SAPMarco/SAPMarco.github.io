/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/library","sap/ui/core/library","sap/ui/dom/includeScript","sap/ui/integration/cards/BaseContent","sap/ui/integration/cards/adaptivecards/elements/hostConfig","sap/m/VBox","sap/m/MessageStrip","sap/ui/core/HTML","sap/ui/core/Core","sap/ui/model/json/JSONModel","sap/base/Log","sap/ui/integration/util/LoadingProvider","sap/ui/Device"],function(e,t,n,i,r,a,o,s,d,p,u,g,c){"use strict";var l,C,y,h,f,m,v,_,b,T;var w=t.MessageType;var A=i.extend("sap.ui.integration.cards.AdaptiveContent",{metadata:{library:"sap.ui.integration"},renderer:{apiVersion:2,render:function(e,t){var n=i.getMetadata().getRenderer();return n.render.apply(this,arguments)}}});A.prototype.init=function(){this.setComponentsReady(false);this._bAdaptiveCardElementsReady=false;this._setupCardContent();this.setAggregation("_loadingProvider",new g)};A.prototype.onAfterRendering=function(){this._renderMSCardContent(this._oCardTemplate||this._oCardConfig)};A.prototype.loadDependencies=function(e){this._loadWebcomponents();var t=[];t.push(new Promise(function(e,t){sap.ui.require(["sap/ui/integration/thirdparty/adaptivecards","sap/ui/integration/thirdparty/adaptivecards-templating","sap/ui/integration/cards/adaptivecards/elements/UI5InputText","sap/ui/integration/cards/adaptivecards/elements/UI5InputNumber","sap/ui/integration/cards/adaptivecards/elements/UI5InputChoiceSet","sap/ui/integration/cards/adaptivecards/elements/UI5InputTime","sap/ui/integration/cards/adaptivecards/elements/UI5InputDate","sap/ui/integration/cards/adaptivecards/elements/UI5InputToggle","sap/ui/integration/cards/adaptivecards/overwrites/ActionRender"],function(t,n,i,r,a,o,s,d,p){l=t;C=n;h=i;f=r;m=a;v=o;_=s;b=d;T=p;this._setupAdaptiveCardDependency();e()}.bind(this),t)}.bind(this)));if(e.get("/sap.card/configuration/enableMarkdown")){t.push(new Promise(function(e,t){sap.ui.require(["sap/ui/integration/thirdparty/markdown-it"],function(t){y=t;e()},t)}))}return Promise.all(t)};A.prototype._setupCardContent=function(){var e=new o(this.getId()+"-message",{showCloseButton:true,visible:false}),t=new s(this.getId()+"content",{preferDOM:false,content:"<div>&nbsp;</div>"});e.addStyleClass("sapUiTinyMargin");this.setAggregation("_content",new a({items:[e,t]}))};A.prototype.setConfiguration=function(e){this._oCardConfig=e;if(e&&e.request&&e.request.url){this._loadManifestFromUrl(e.request.url);return}this._handleMarkDown();this._setupMSCardContent()};A.prototype.getConfiguration=function(){return this._oCardConfig};A.prototype._handleMarkDown=function(){var e=this;l.AdaptiveCard.onProcessMarkdown=function(t,n){var i=e.getParent(),r=i&&i.getManifestEntry("/sap.card/configuration/enableMarkdown");if(r){n.outputHtml=(new y).render(t);n.didProcess=true;return n}}};A.prototype._loadManifestFromUrl=function(e){var t=new p,n=this;t.loadData(e).then(function(){n._oCardConfig=Object.assign(n._oCardConfig,t.getData())}).then(function(){n._handleMarkDown();n._setupMSCardContent()}).then(function(){t.destroy();t=null}).catch(function(){u.error("No JSON file found on this URL. Please provide a correct path to the JSON-serialized card object model file.")})};A.prototype._setupAdaptiveCardDependency=function(){this.adaptiveCardInstance=new l.AdaptiveCard;this._doMSCardsOverwrites();this._adjustHostConfig();this._handleActions();this._replaceElements();this._isRtl()};A.prototype._doMSCardsOverwrites=function(){l.Action.prototype.render=T};A.prototype._adjustHostConfig=function(){this.adaptiveCardInstance.hostConfig=new l.HostConfig(r)};A.prototype._isRtl=function(){this.adaptiveCardInstance.isRtl=function(){return d.getConfiguration().getRTL()}};A.prototype._handleActions=function(){this.adaptiveCardInstance.onExecuteAction=function(t){var n,i,r;if(t instanceof l.OpenUrlAction){i={url:t.url};n=e.CardActionType.Navigation}else if(t instanceof l.SubmitAction){i={data:t.data};n=e.CardActionType.Submit}else{return}r=this.getActions();if(r){r.fireAction(this,n,i)}}.bind(this)};A.prototype.onActionSubmitStart=function(e){this.getParent().setBusy(true)};A.prototype.onActionSubmitEnd=function(e,t){var n=d.getLibraryResourceBundle("sap.ui.integration"),i=t?n.getText("CARDS_ADAPTIVE_ACTION_SUBMIT_ERROR"):n.getText("CARDS_ADAPTIVE_ACTION_SUBMIT_SUCCESS"),r=t?w.Error:w.Success;this.showMessage(i,r);this.getParent().setBusy(false)};A.prototype.showMessage=function(e,t){var n=this.getAggregation("_content").getItems()[0];n.applySettings({type:t,text:e,visible:true})};A.prototype._replaceElements=function(){l.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Text");l.AdaptiveCard.elementTypeRegistry.registerType("Input.Text",function(){return new h});l.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Number");l.AdaptiveCard.elementTypeRegistry.registerType("Input.Number",function(){return new f});l.AdaptiveCard.elementTypeRegistry.unregisterType("Input.ChoiceSet");l.AdaptiveCard.elementTypeRegistry.registerType("Input.ChoiceSet",function(){return new m});l.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Time");l.AdaptiveCard.elementTypeRegistry.registerType("Input.Time",function(){return new v});l.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Date");l.AdaptiveCard.elementTypeRegistry.registerType("Input.Date",function(){return new _});l.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Toggle");l.AdaptiveCard.elementTypeRegistry.registerType("Input.Toggle",function(){return new b})};A.prototype.setCardDataProvider=function(e){this._oCardDataProvider=e};A.prototype._setupMSCardContent=function(){var e=this._oCardConfig,t,n=this._oCardDataProvider;if(!this.adaptiveCardInstance||!e){return}t=e.$data||e.data;if(!t&&!n){this._oCardTemplate=null;this._renderMSCardContent(e);return}if(e.$data){t={json:t}}this._setDataConfiguration(t)};A.prototype.onDataChanged=function(){var e=this.getBindingContext().getPath(),t=this.getModel().getProperty(e);this._oCardTemplate=this._setTemplating(this._oCardConfig,t);this.getAggregation("_loadingProvider").setLoading(false);this.invalidate()};A.prototype._renderMSCardContent=function(e){var t=this.getAggregation("_content").getItems()[1].$(),n=!!this.isLoading();this.setBusy(n);this.getAggregation("_content").toggleStyleClass("sapFCardContentHidden",n);if(this.adaptiveCardInstance&&e&&t.length){this.adaptiveCardInstance.parse(e);t.html(this.adaptiveCardInstance.render());this._bAdaptiveCardElementsReady=true;this._fireCardReadyEvent();if(this.adaptiveCardInstance.renderedElement){this.adaptiveCardInstance.renderedElement.tabIndex=-1}}};A.prototype._fireCardReadyEvent=function(){if(this._bAdaptiveCardElementsReady&&this.getComponentsReady()){this._bReady=true;this.fireEvent("_ready")}};A.prototype._setTemplating=function(e,t){var n=new C.Template(e),i=new C.EvaluationContext;i.$root=t;return n.expand(i)};A.prototype._loadWebcomponents=function(){if(this.getComponentsReady()){u.debug("WebComponents were already loaded");this._fireCardReadyEvent();return}if(window.customElements){window.customElements.whenDefined("ui5-button").then(function(){if(!this.getComponentsReady()){this.setComponentsReady(true);this._fireCardReadyEvent()}}.bind(this))}setTimeout(function(){if(this.getComponentsReady()){u.debug("WebComponents were already loaded");return}n({id:"webcomponents-loader",url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/webcomponentsjs/webcomponents-loader.js")})}.bind(this));document.addEventListener("WebComponentsReady",function(){if(this.getComponentsReady()){u.debug("WebComponents were already loaded");return}if(c.browser.edge||c.browser.msie){n({id:"webcomponents-bundle-es5",url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/bundle.es5.js")})}else{n({id:"webcomponents-bundle",attributes:{type:"module"},url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/bundle.esm.js")})}this.setComponentsReady(true);this._fireCardReadyEvent()}.bind(this))};A.prototype.setComponentsReady=function(e){this._bComponentsReady=e;return this};A.prototype.getComponentsReady=function(){return!!this._bComponentsReady};return A});