/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./CalendarContentRenderer","sap/ui/core/ResizeHandler","sap/ui/integration/library","sap/ui/integration/cards/BaseContent","sap/ui/integration/util/BindingHelper","sap/ui/integration/util/BindingResolver","sap/f/CalendarInCard","sap/f/PlanningCalendarInCardLegend","sap/m/library","sap/m/Button","sap/m/FlexBox","sap/ui/core/format/DateFormat","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/unified/CalendarAppointment","sap/ui/unified/DateTypeRange","sap/ui/core/date/UniversalDate","sap/ui/unified/CalendarLegendItem"],function(t,e,i,a,n,s,o,r,p,l,m,g,d,h,u,f,_,c){"use strict";var D=i.AreaType;var y=a.extend("sap.ui.integration.cards.CalendarContent",{renderer:t,metadata:{library:"sap.ui.integration",properties:{visibleAppointmentsCount:{type:"int",group:"Data",defaultValue:2},noAppointmentsText:{type:"string",group:"Misc",defaultValue:null}},aggregations:{appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment"}}}});y.prototype._createCardContent=function(){this._oCalendar=new o(this.getId()+"-navigation",{select:function(t){var e=t.getSource().getSelectedDates()[0].getStartDate();this._setParameters(t,t.getParameter("startDate"));this._refreshVisibleAppointments(e);this.invalidate()}.bind(this)});this._oLegend=new r(this.getId()+"-legend",{columnWidth:"7.5rem",standardItems:[]});this._oContent=new m(this.getId()+"-wrapper",{items:[this._oCalendar,this._oLegend]});this.setAggregation("_content",this._oContent);this._oFormatAria=g.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY 'at' "+I.call(this).getTimePattern("medium")})};y.prototype.init=function(){this._aVisibleAppointments=[];a.prototype.init.apply(this,arguments);this._createCardContent();this.fireEvent("_actionContentReady")};y.prototype.exit=function(){if(this._sTwoColumnsResizeListener){e.deregister(this._sTwoColumnsResizeListener);this._sTwoColumnsResizeListener=undefined}a.prototype.exit.apply(this,arguments);if(this._oAppointmentTemplate){this._oAppointmentTemplate.destroy();this._oAppointmentTemplate=null}if(this._oSpecialDateTemplate){this._oSpecialDateTemplate.destroy();this._oSpecialDateTemplate=null}if(this._oCalendarLegendItemTemplate){this._oCalendarLegendItemTemplate.destroy();this._oCalendarLegendItemTemplate=null}if(this._oAppointmentLegendItemTemplate){this._oAppointmentLegendItemTemplate.destroy();this._oAppointmentLegendItemTemplate=null}if(this._oActions){this._oActions.destroy();this._oActions=null}};y.prototype.onDataChanged=function(){this._setParameters()};y.prototype.onBeforeRendering=function(){var t=this._oCalendar.getSelectedDates().length?this._oCalendar.getSelectedDates()[0].getStartDate():this._oCalendar.getStartDate();this._refreshVisibleAppointments(t);this.getModel("parameters").setProperty("/visibleItems",this._iVisibleItems);this.getModel("parameters").setProperty("/allItems",this._iAllItems)};y.prototype.onAfterRendering=function(){a.prototype.onAfterRendering.call(this,arguments);if(!this._sTwoColumnsResizeListener){this._sTwoColumnsResizeListener=e.register(this,this.resizeHandler);this.resizeHandler({control:this,target:this.getDomRef()})}};y.prototype.resizeHandler=function(t){t.control.toggleStyleClass("sapMPCInCardTwoColumns",t.target.getBoundingClientRect().width>576)};y.prototype.setConfiguration=function(t){a.prototype.setConfiguration.apply(this,arguments);if(!t){return this}if(t.item){this._addItem(t.item)}if(t.specialDate){this._addSpecialDate(t.specialDate)}if(t.legendItem){this._addLegendItem(t.legendItem)}if(t.date){this._addDate(t.date)}if(t.maxItems){this._addMaxItems(t.maxItems)}if(t.maxLegendItems){this._addMaxLegendItems(t.maxLegendItems)}if(t.noItemsText){this._addNoItemsText(t.noItemsText)}if(t.moreItems&&t.moreItems.actions){this._oActions.setAreaType(D.Content);this._oActions.attach(t.moreItems,this._getMoreButton())}return this};y.prototype._setParameters=function(t,e){var i=this.getConfiguration&&this.getConfiguration(),a=i&&i.item&&i.item.path,n,s,o,r,p,l=g.getDateTimeInstance();if(e){n=e}else if(this._oCalendar.getSelectedDates().length){n=this._oCalendar.getSelectedDates()[0].getStartDate()}else{n=this._oCalendar.getStartDate()}s=new Date(n.getFullYear(),n.getMonth(),n.getDate());o=new Date(n.getFullYear(),n.getMonth(),n.getDate());o.setDate(o.getDate()+1);p=a?this.getModel().getProperty(a).filter(function(t){var e=l.parse(t.start).getTime(),i=l.parse(t.end).getTime();if(e>=s.getTime()&&e<o.getTime()||i>=s.getTime()&&i<o.getTime()||e<=s.getTime()&&i>o.getTime()){return t}}):[];this._iAllItems=p.length;if(i&&typeof i.maxItems==="object"){r=i&&this.getConfiguration().maxItems&&"/"+this.getConfiguration().maxItems.binding.getPath();this._iMaxItems=this.getModel().getProperty(r)}else{this._iMaxItems=i&&this.getConfiguration().maxItems}this._iVisibleItems=Math.min(this._iMaxItems,this._iAllItems);if(this.getModel("parameters")){this.getModel("parameters").setProperty("/visibleItems",this._iVisibleItems);this.getModel("parameters").setProperty("/allItems",this._iAllItems)}};y.prototype._refreshVisibleAppointments=function(t){this._aVisibleAppointments=this._calculateVisibleAppointments(this.getAppointments(),t)};y.prototype._calculateVisibleAppointments=function(t,e){var i=this._isAppointmentInSelectedDate(e);var a=function(t,i){var a=t.getEndDate(),n=new Date;if(e.getDate()===n.getDate()&&e.getMonth()===n.getMonth()&&e.getFullYear()===n.getFullYear()){return this._iAllItems-i<this._iVisibleItems||a.getTime()>n.getTime()}return true};var n=t.filter(i,this).sort(this._sortByStartHourCB).filter(a,this).slice(0,this._iVisibleItems);return n};y.prototype._sortByStartHourCB=function(t,e){return t.getStartDate().getTime()-e.getStartDate().getTime()||e.getEndDate().getTime()-t.getEndDate().getTime()};y.prototype._isAppointmentInSelectedDate=function(t){return function(e){var i=e.getStartDate().getTime(),a=e.getEndDate().getTime(),n=t.getTime(),s=_.getInstance(new Date(t.getTime())),o,r,p,l;s.setDate(s.getDate()+1);o=s.getTime();r=i<n&&a>o;p=i>=n&&i<o;l=a>n&&a<=o;return r||p||l}};y.prototype._getVisibleAppointments=function(){return this._aVisibleAppointments};y.prototype.formatDate=function(t){var e=g.getDateTimeInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss.SSSXXX"}).parse(t);if(!e){e=g.getInstance({pattern:"yyyy-MM-dd"}).parse(t)}return e};y.prototype._addItem=function(t){var e={title:t.template.title,text:t.template.text,type:t.template.type},i;if(t.template.startDate){e.startDate=n.formattedProperty(t.template.startDate,this.formatDate)}if(t.template.endDate){e.endDate=n.formattedProperty(t.template.endDate,this.formatDate)}if(t.template.icon&&t.template.icon.src){e.icon=n.formattedProperty(t.template.icon.src,function(t){return this._oIconFormatter.formatSrc(t,this._sAppId)}.bind(this))}this._oAppointmentTemplate=new u(e);i={path:t.path,template:this._oAppointmentTemplate};this._bindAggregationToControl("appointments",this,i)};y.prototype._addSpecialDate=function(t){var e=t.template,i;if(e.startDate){e.startDate=n.formattedProperty(e.startDate,this.formatDate)}if(e.endDate){e.endDate=n.formattedProperty(e.endDate,this.formatDate)}this._oSpecialDateTemplate=new f(e);i={path:t.path,template:this._oSpecialDateTemplate};this._bindAggregationToControl("specialDates",this._oCalendar,i)};y.prototype._addLegendItem=function(t){var e={text:t.template.text,type:t.template.type},i={text:t.template.text,type:t.template.type},a,n;this._oCalendarLegendItemTemplate=new c(e);a={path:t.path,template:this._oCalendarLegendItemTemplate,filters:new d({path:"category",operator:h.Contains,value1:"calendar"})};this._bindAggregationToControl("items",this._oLegend,a);this._oAppointmentLegendItemTemplate=new c(i);n={path:t.path,template:this._oAppointmentLegendItemTemplate,filters:new d({path:"category",operator:h.Contains,value1:"appointment"})};this._bindAggregationToControl("appointmentItems",this._oLegend,n)};y.prototype._addDate=function(t){if(s.isBindingInfo(t)){if(!t){return}var e=new f;e.bindProperty("startDate",n.formattedProperty(t,this.formatDate));this._oCalendar.addSelectedDate(e)}else{this._oCalendar.addSelectedDate(new f({startDate:this.formatDate(t)}))}};y.prototype._addMaxItems=function(t){if(s.isBindingInfo(t)){t&&this.bindProperty("visibleAppointmentsCount",t)}else{this.setVisibleAppointmentsCount(t)}};y.prototype._addMaxLegendItems=function(t){if(s.isBindingInfo(t)){t&&this._oLegend.bindProperty("visibleLegendItemsCount",t)}else{this._oLegend.setVisibleLegendItemsCount(t)}};y.prototype._addNoItemsText=function(t){if(s.isBindingInfo(t)){t&&this.bindProperty("noAppointmentsText",t)}else{this.setNoAppointmentsText(t)}};y.prototype._getMoreButton=function(){if(!this._oMoreAppsButton){this._oMoreAppsButton=new l({text:"More"})}return this._oMoreAppsButton};y.prototype._bNeedForMoreButton=function(){return this._iAllItems>this.getVisibleAppointmentsCount()};y.prototype._getCurrentAppointment=function(){var t=this._getVisibleAppointments(),e=new Date,i,a,n,s,o=this._oCalendar.getSelectedDates().length?this._oCalendar.getSelectedDates()[0].getStartDate():this._oCalendar.getStartDate();if(o.getDate()===e.getDate()&&o.getMonth()===e.getMonth()&&o.getFullYear()===e.getFullYear()){for(s=t.length-1;s>=0;s--){i=t[s];a=i.getStartDate().getTime();n=i.getEndDate().getTime();if(e.getTime()>a&&e.getTime()<n){return i}}}};function I(){if(!this._oLocaleData){var t=C.call(this);var e=new sap.ui.core.Locale(t);this._oLocaleData=sap.ui.core.LocaleData.getInstance(e)}return this._oLocaleData}function C(){if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString()}return this._sLocale}return y});