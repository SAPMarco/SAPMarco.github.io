/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/isEmptyObject","sap/f/cards/Header","sap/f/cards/HeaderRenderer","sap/m/library","sap/ui/integration/util/BindingHelper","sap/ui/model/json/JSONModel","sap/ui/integration/util/LoadingProvider"],function(t,i,e,a,o,r,s){"use strict";var n=a.AvatarColor;var d=i.extend("sap.ui.integration.cards.Header",{constructor:function(e,a,r,s){e=e||{};this._sAppId=r;this._bIsEmpty=t(e);var d={title:e.title,subtitle:e.subTitle};if(e.status&&e.status.text&&!e.status.text.format){d.statusText=e.status.text}if(e.icon){d.iconSrc=e.icon.src;d.iconDisplayShape=e.icon.shape;d.iconInitials=e.icon.text;d.iconAlt=e.icon.alt;d.iconBackgroundColor=e.icon.backgroundColor||(e.icon.text?n.Accent6:n.Transparent)}if(d.iconSrc){d.iconSrc=o.formattedProperty(d.iconSrc,function(t){return s.formatSrc(t,r)})}d.toolbar=a;i.call(this,d);if(a){a.attachVisibilityChange(this._handleToolbarVisibilityChange.bind(this))}},metadata:{library:"sap.ui.integration",properties:{}},renderer:e});d.prototype.init=function(){i.prototype.init.call(this);this._bReady=false;this._oLoadingProvider=new s;this._aReadyPromises=[];this._awaitEvent("_dataReady");this._awaitEvent("_actionHeaderReady");Promise.all(this._aReadyPromises).then(function(){this._bReady=true;this.fireEvent("_ready")}.bind(this))};d.prototype.exit=function(){i.prototype.exit.call(this);this._oServiceManager=null;this._oDataProviderFactory=null;if(this._oLoadingProvider){this._oLoadingProvider.destroy();this._oLoadingProvider=null}if(this._oDataProvider){this._oDataProvider.destroy();this._oDataProvider=null}if(this._oActions){this._oActions.destroy();this._oActions=null}};d.prototype.isReady=function(){return this._bReady};d.prototype.isLoading=function(){var t=this._oLoadingProvider,i=this.getParent(),e=i.getMetadata()._sClassName==="sap.ui.integration.widgets.Card"?i.isLoading():false;return!t.getDataProviderJSON()&&(t.getLoadingState()||e)};d.prototype._updateModel=function(t){this.getModel().setData(t)};d.prototype._handleError=function(t){this.fireEvent("_error",{logMessage:t})};d.prototype._handleToolbarVisibilityChange=function(t){var i=t.getParameter("visible");if(this._bIsEmpty&&this.getVisible()!==i){this.setVisible(i);setTimeout(function(){this.invalidate()}.bind(this),0)}};d.prototype._awaitEvent=function(t){this._aReadyPromises.push(new Promise(function(i){this.attachEventOnce(t,function(){i()})}.bind(this)))};d.prototype.setServiceManager=function(t){this._oServiceManager=t;return this};d.prototype.setDataProviderFactory=function(t){this._oDataProviderFactory=t;return this};d.prototype._setDataConfiguration=function(t){var i="/";if(t&&t.path){i=t.path}this.bindObject(i);if(this._oDataProvider){this._oDataProvider.destroy()}this._oDataProvider=this._oDataProviderFactory.create(t,this._oServiceManager);if(this._oDataProvider){this.setModel(new r);this._oDataProvider.attachDataRequested(function(){this.onDataRequested()}.bind(this));this._oDataProvider.attachDataChanged(function(t){this._updateModel(t.getParameter("data"));this.onDataRequestComplete()}.bind(this));this._oDataProvider.attachError(function(t){this._handleError(t.getParameter("message"));this.onDataRequestComplete()}.bind(this));this._oDataProvider.triggerDataUpdate()}else{this.fireEvent("_dataReady")}};d.prototype.onDataRequested=function(){this._oLoadingProvider.createLoadingState(this._oDataProvider)};d.prototype.onDataRequestComplete=function(){this.fireEvent("_dataReady");this._oLoadingProvider.setLoading(false);this._oLoadingProvider.removeHeaderPlaceholder(this)};return d});