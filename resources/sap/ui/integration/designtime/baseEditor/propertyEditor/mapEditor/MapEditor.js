/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/designtime/baseEditor/propertyEditor/BasePropertyEditor","sap/base/util/deepClone","sap/base/util/deepEqual","sap/ui/model/json/JSONModel","sap/base/util/restricted/_merge","sap/base/util/restricted/_omit","sap/base/util/isPlainObject","sap/base/util/includes"],function(e,t,i,a,s,n,r,u){"use strict";var o={string:"BASE_EDITOR.MAP.TYPES.STRING",boolean:"BASE_EDITOR.MAP.TYPES.BOOLEAN",number:"BASE_EDITOR.MAP.TYPES.NUMBER",integer:"BASE_EDITOR.MAP.TYPES.INTEGER",date:"BASE_EDITOR.MAP.TYPES.DATE",datetime:"BASE_EDITOR.MAP.TYPES.DATETIME",icon:"BASE_EDITOR.MAP.TYPES.ICON",simpleicon:"BASE_EDITOR.MAP.TYPES.SIMPLEICON",group:"BASE_EDITOR.MAP.TYPES.GROUP"};var l=e.extend("sap.ui.integration.designtime.baseEditor.propertyEditor.mapEditor.MapEditor",{xmlFragment:"sap.ui.integration.designtime.baseEditor.propertyEditor.mapEditor.MapEditor",metadata:{library:"sap.ui.integration"},init:function(){e.prototype.init.apply(this,arguments);this._itemsModel=new a;this._itemsModel.setDefaultBindingMode("OneWay");this.setModel(this._itemsModel,"itemsModel");this._supportedTypesModel=new a;this._supportedTypesModel.setDefaultBindingMode("OneWay");this.setModel(this._supportedTypesModel,"supportedTypes");this.attachModelContextChange(function(){if(this.getModel("i18n")){var e=this.getModel("i18n").getResourceBundle();this._aSupportedTypes=Object.keys(o).map(function(t){return{key:t,label:e.getText(o[t])}});this._setSupportedTypesModel()}},this);this.attachConfigChange(this._setSupportedTypesModel,this);this._mTypes={}},setValue:function(t){t=r(t)?t:{};var i=this._getPositions(t);this.setDesigntimeMetadata(s({},this.getDesigntimeMetadata(),Object.keys(i).reduce(function(e,t){e[t]={__value:{position:i[t]}};return e},{})));e.prototype.setValue.call(this,t);var a=this._processValue(t);a=a.sort(function(e,t){return i[e.key]-i[t.key]}).map(function(e,t){e.index=t;e.total=a.length;return e});this._itemsModel.setData(a)},_processValue:function(e){return Object.keys(e).map(function(i){var a=this._prepareInputValue(e[i],i);this._mTypes[i]=a.type;var s={key:i,value:a,designtime:this.getNestedDesigntimeMetadata(i)};return this.getConfig().includeInvalidEntries||this._isValidItem(s,t(e[i]))?s:undefined},this).filter(Boolean)},_getPositions:function(e){var t=Object.keys(e);var i=t.map(function(e){var t=this.getNestedDesigntimeMetadataValue(e).position;return t>=0?t:-1}.bind(this));var a=i.reduce(function(e,t){return Math.max(e,t)},-1);var s={};i.forEach(function(e,i){s[t[i]]=e>=0?e:++a});return s},_prepareInputValue:function(e,i){var a=this.processInputValue(t(e),i);if(!a.type){a.type=this._mTypes[i]||this._getDesigntimeMetadataValue(i).type||this._getDefaultType(a.value)}return a},_getDesigntimeMetadataValue:function(e){var t=(this.getConfig()||{}).designtime||{};var i=t[e]||{};return i.__value||{}},_isValidItem:function(e){var t=e.value.type;return t&&u(this._getAllowedTypes(),t)},_getDefaultType:function(e){var t=this._getAllowedTypes();var i=typeof e;var a=u(t,i)?i:undefined;if(!a&&u(t,"string")){a="string"}return a},_getAllowedTypes:function(){return(this.getConfig()||l.configMetadata).allowedTypes},_setSupportedTypesModel:function(){var e=this._getAllowedTypes();this._supportedTypesModel.setData(this._aSupportedTypes.filter(function(t){return u(e,t.key)}))},formatItemConfig:function(e){var t=e.key;var i=e.value.type;var a=e.value.value;if(i==="boolean"){a=e.value.value!==false}var s=(e.designtime||{}).__value;var n=this.getConfig();return[{label:this.getI18nProperty("BASE_EDITOR.MAP.KEY"),path:"key",value:t,type:"string",enabled:n.allowKeyChange,itemKey:t,allowBindings:false,validators:[{type:"isUniqueKey",config:{keys:function(){return Object.keys(this.getValue())}.bind(this),currentKey:function(e){return e.getValue()}}}]},{label:this.getI18nProperty("BASE_EDITOR.MAP.TYPE"),path:"type",value:i,type:"select",items:this._getAllowedTypes().map(function(e){return{key:e,title:this.getI18nProperty(o[e])}}.bind(this)),visible:n.allowTypeChange,itemKey:t,allowBindings:false},{label:this.getI18nProperty("BASE_EDITOR.MAP.VALUE"),path:"value",value:a,type:i&&u(this._getAllowedTypes(),i)?i:this._getDefaultType(a),visible:i!=="group",itemKey:t,designtime:(s||{}).value}]},getExpectedWrapperCount:function(e){return this._processValue(e).length},processInputValue:function(e){return{value:e}},processOutputValue:function(e){return e.value},_onRemoveElement:function(e){var i=e.getSource().getBindingContext("itemsModel").getObject().key;var a=this.getValue();this.setValue(n(a,i));var s=t(this.getDesigntimeMetadata());delete s[i];this.setDesigntimeMetadata(s)},_onAddElement:function(){var e=s({},this.getValue());var t=this._getUniqueKey(e);e[t]=this.processOutputValue(this._getItemTemplate());this.setValue(e)},_moveUp:function(e){var t=e.getSource().data("index");if(t>0){var i=this._itemsModel.getData();this._swapPositions(i[t].key,i[t-1].key)}},_moveDown:function(e){var t=e.getSource().data("index");var i=this._itemsModel.getData();if(t<i.length-1){this._swapPositions(i[t].key,i[t+1].key)}},_swapPositions:function(e,t){var i={};i[e]={__value:{position:this.getNestedDesigntimeMetadataValue(t).position}};i[t]={__value:{position:this.getNestedDesigntimeMetadataValue(e).position}};this.setDesigntimeMetadata(s({},this.getDesigntimeMetadata(),i));this.setValue(this.getValue())},_getItemTemplate:function(){return{value:"",type:"string"}},_isNewItem:function(e){return i(e.value,this._prepareInputValue(this.processOutputValue(this._getItemTemplate())))},_getUniqueKey:function(e){var t="key";var i=0;while(e.hasOwnProperty(t)){t="key"+ ++i}return t},_propertyEditorsChange:function(e){var t=e.getParameter("previousPropertyEditors");var i=e.getParameter("propertyEditors");if(Array.isArray(t)){t.forEach(function(e){e.detachValueChange(this._onItemChange,this);e.detachDesigntimeMetadataChange(this._onDesigntimeValueChange,this)},this)}if(Array.isArray(i)){i.forEach(function(e){e.attachValueChange(this._onItemChange,this);e.attachDesigntimeMetadataChange(this._onDesigntimeValueChange,this)},this)}},_onItemChange:function(e){var t=e.getSource().getConfig().itemKey;var i=e.getParameter("path");var a=this.getItemChangeHandlers()[i];if(typeof a!=="function"){a=this._onFieldChange}a.call(this,t,e)},_onDesigntimeValueChange:function(e){var t=e.getSource().getConfig().itemKey;var i=e.getParameter("path");if(i!=="value"){return}this._onDesigntimeChange(t,e)},_onDesigntimeChange:function(e,t){var i=s({},this.getConfig().designtime);var a={__value:{}};a.__value[t.getParameter("path")]=t.getParameter("value");i[e]=s({},i[e],a);this.setDesigntimeMetadata(i);this.setValue(this.getValue())},getItemChangeHandlers:function(){return{key:this._onKeyChange,type:this._onTypeChange}},_onKeyChange:function(e,t){if(t.getParameter("previousValue")===undefined){return}var i=s({},this.getValue());var a=t.getParameter("value");if(a!==e){var n={};Object.keys(i).forEach(function(t){var s=t===e?a:t;n[s]=i[t]});if(n[a]&&n[a].type!=="group"&&n[a].manifestpath&&n[a].manifestpath.startsWith("/sap.card/configuration/parameters/")){n[a].manifestpath="/sap.card/configuration/parameters/"+a+"/value"}this._mTypes[a]=this._mTypes[e];delete this._mTypes[e];this.setValue(n);var r=s({},this.getConfig().designtime);if(r.hasOwnProperty(e)){r[a]=r[e];if(r[a].__value&&r[a].__value.type&&r[a].__value.type!=="group"&&r[a].__value.manifestpath){r[a].__value.manifestpath=r[a].__value.manifestpath.replace(e,a)}delete r[e];this.setDesigntimeMetadata(r)}}},_onTypeChange:function(e,t){if(t.getParameter("previousValue")===undefined){return}var i=s({},this.getValue());var a=t.getParameter("value");var n=t.getParameter("previousValue");if(a!==n){var r=this.processInputValue(i[e]);r.type=a;i[e]=this.processOutputValue(r);if(a==="simpleicon"){i[e].visualization={type:"IconSelect",settings:{value:"{currentSettings>value}",editable:"{currentSettings>editable}"}}}else{delete i[e].visualization}this._mTypes[e]=a;this.setValue(i);var u=s({},this.getConfig().designtime);if(u.hasOwnProperty(e)){if(a==="simpleicon"){u[e].__value.visualization={type:"IconSelect",settings:{value:"{currentSettings>value}",editable:"{currentSettings>editable}"}}}else{delete u[e].__value.visualization}u[e].__value.type=a;this.setDesigntimeMetadata(u)}}},_onFieldChange:function(e,t){var i=s({},this.getValue());var a=t.getParameter("path");var n=t.getParameter("value");var r=this.processInputValue(i[e]);r[a]=n;i[e]=this.processOutputValue(r);this.setValue(i)},renderer:e.getMetadata().getRenderer().render});l.configMetadata=Object.assign({},e.configMetadata,{allowKeyChange:{defaultValue:true,mergeStrategy:"mostRestrictiveWins"},allowTypeChange:{defaultValue:true,mergeStrategy:"mostRestrictiveWins"},allowAddAndRemove:{defaultValue:true,mergeStrategy:"mostRestrictiveWins"},allowedTypes:{defaultValue:["string"],mergeStrategy:"intersection"},allowSorting:{defaultValue:true,mergeStrategy:"mostRestrictiveWins"},includeInvalidEntries:{defaultValue:true,mergeStrategy:"mostRestrictiveWins"}});return l});