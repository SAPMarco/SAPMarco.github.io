/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_CancelablePromise","sap/base/util/restricted/_isEqual","sap/base/util/restricted/_omit","sap/base/util/merge","sap/base/util/deepClone","sap/base/util/ObjectPath","./CardEditor","sap/ui/integration/designtime/baseEditor/BaseEditor","sap/ui/integration/Designtime","sap/ui/integration/util/CardMerger","sap/base/util/LoaderExtensions","sap/base/Log"],function(i,t,e,a,n,s,r,o,f,l,g,u){"use strict";var p="";p=g.loadResource("sap/ui/integration/designtime/cardEditor/ConfigurationTemplate.js",{dataType:"text",failOnError:false,async:false});var m=r.extend("sap.ui.integration.designtime.cardEditor.BASEditor",{metadata:{library:"sap.ui.integration",events:{configurationChange:{},createConfiguration:{},error:{},designtimeInited:{}}},renderer:r.getMetadata().getRenderer()});m.prototype.getManifest=function(){return this._oCurrent.manifest};m.prototype.getConfigurationClass=function(){return this._oCurrent.configurationclass};m.prototype.getConfiguration=function(){return this._oCurrent.configuration};m.prototype.getConfigurationString=function(){return this._oCurrent.configurationstring};m.prototype._generateDesigntimeJSConfig=function(){var i=this._formatExportedDesigntimeMetadata(this.getDesigntimeMetadata());var t=this.getJson();if(this._eventTimeout){clearTimeout(this._eventTimeout);this._eventTimeout=null}this._eventTimeout=setTimeout(function(){var e={form:{items:{}}};var n=a(e,this._oDesigntimeJSConfig);var r={};var o=[];var l;if(t){var g=s.get(["sap.card","configuration","parameters"],t);var u=s.get(["sap.card","configuration","parameters"],this._oDesigntimeMetadataModel.getData());if(!g){this._oDesigntimeJSConfig.form.items={};this._oCurrent={configuration:this._cleanConfig(this._oDesigntimeJSConfig),manifest:this._cleanJson(),configurationclass:this._fnDesigntime,configurationstring:this._cleanConfig(this._oDesigntimeJSConfig,true)};this.fireConfigurationChange(this._oCurrent);return}var p=Object.keys(g);for(var m in n.form.items){l=a({},n.form.items[m]);if(!g[m]){if(u[m]){if(l.type==="group"){g[m]={}}else if(l.manifestpath&&!l.manifestpath.startsWith("/sap.card/configuration/parameters")){var h=l.manifestpath;if(h.startsWith("/")){h=h.substring(1)}var c=s.get(h.split("/"),t)||l.defaultValue||"";g[m]={value:c}}}else{delete n.form.items[m];continue}}var d=p.indexOf(m);if(d>-1){p.splice(d,1)}var v;if(n.form.items[m].visualization){v=g[m].visualization}n.form.items[m]=a(l,g[m]);if(v){n.form.items[m].visualization=v;v=null}if(l.type==="group"){delete n.form.items[m].manifestpath}else if(!n.form.items[m].manifestpath){u[m].manifestpath="/sap.card/configuration/parameters/"+m+"/value";u[m].__value.manifestpath="/sap.card/configuration/parameters/"+m+"/value";n.form.items[m].manifestpath="/sap.card/configuration/parameters/"+m+"/value"}}if(p.length>0){for(var _=0;_<p.length;_++){var C=p[_];var b=g[C];n.form.items[C]={manifestpath:"/sap.card/configuration/parameters/"+C+"/value",type:b.type||"string",label:b.label,translatable:false,editable:b.editable,visible:b.visible}}g[C]=a(n.form.items[C],g[C])}}if(i){var g=s.get(["sap.card","configuration","parameters"],t);if(n){for(var m in i){var y=i[m];var D=m.substring(m.lastIndexOf("/")+1);if(!m.startsWith("sap.card/configuration/parameters")){continue}var J=n.form.items[D]||{};var v;if(J.visualization){v=J.visualization}l=a(J,g[D]);if(y.hasOwnProperty("label")){l.label=y.label}if(y.hasOwnProperty("position")){l.position=y.position}if(l.editable==="false"){l.editable=false}else if(l.editable==="true"){l.editable=false}if(l.visible==="false"){l.visible=false}else if(l.visible==="true"){l.visible=false}if(l.type==="group"){delete l.manifestpath}if(v){l.visualization=v;v=null}l.__key=D;o[l.position]=l}for(var _=0;_<o.length;_++){l=o[_];if(!l){continue}r[l.__key]=l;delete l.__key;delete l.position}n.form.items=r}}this._oDesigntimeJSConfig=n;var S=this._cleanConfig(this._oDesigntimeJSConfig);this._fnDesigntime=function(i){return new f(i)}.bind(this,S);this._oCurrent={configuration:S,manifest:this._cleanJson(t),configurationclass:this._fnDesigntime,configurationstring:this._cleanConfig(this._oDesigntimeJSConfig,true)};this._oDataModel.setData(this._prepareData(t));this.fireConfigurationChange(this._oCurrent)}.bind(this),500)};m.prototype.init=function(){r.prototype.init.apply(this,arguments);this._oCurrent={configuration:null,manifest:null,configurationclass:null}};m.prototype._applyDefaultValue=function(i){if(i.value===undefined||i.value===null){switch(i.type){case"boolean":i.value=i.defaultValue||false;break;case"integer":case"number":i.value=i.defaultValue||0;break;case"string[]":i.value=i.defaultValue||[];break;default:i.value=i.defaultValue||""}}};m.prototype.getJson=function(i){if(i===true){return this._cleanJson()}else{return o.prototype.getJson.apply(this,arguments)}};m.prototype._cleanJson=function(i,t){i=i||this.getJson();var e=c(s.get(["sap.card","designtime"],i)||"");if(!e){s.set(["sap.card","designtime"],"dt/configuration",i)}i=n(i);var t=t!==false;if(t){var a=s.get(["sap.card","configuration","parameters"],i);for(var r in a){var o=a[r];if(o&&o.type==="group"){delete a[r];continue}if(this._oDesigntimeJSConfig&&this._oDesigntimeJSConfig.form&&this._oDesigntimeJSConfig.form.items){var f=this._oDesigntimeJSConfig.form.items[r]||{};if(f.type==="group"){delete a[r];continue}if(f.manifestpath&&!f.manifestpath.startsWith("/sap.card/configuration/parameters")){var l=f.manifestpath;if(l.startsWith("/")){l=l.substring(1)}if(f.type==="simpleicon"){f.type="string"}s.set(l.split("/"),f.value,i);delete a[r];continue}}a[r]={value:a[r].value}}}if(this._i18n){s.set(["sap.app","i18n"],this._i18n,i)}return i};m.prototype._cleanConfig=function(i,t){var i=a({},i);for(var e in i.form.items){var n=i.form.items[e];if(n.type==="simpleicon"){if(!n.visualization){n.visualization={type:"IconSelect",settings:{value:"{currentSettings>value}",editable:"{currentSettings>editable}"}}}n.type="string"}delete n.value}if(t){var s=JSON.stringify(i,null,"\t");s=s.replace(/\"\$\$([a-zA-Z]*)\$\$\"/g,function(i){return i.substring(3,i.length-3)});return s}return i};m.prototype._generateMetadataFromJSConfig=function(i){var t={};if(i){this._oDesigntimeJSConfig=a(this._oDesigntimeJSConfig,i)}if(this._oDesigntimeJSConfig){var e=this._oDesigntimeJSConfig.form.items;var n=0;for(var r in e){var o="sap.card/configuration/parameters/"+r,f=o.split("/"),l;t[o]=a({},e[r]);l=t[o];l.position=n++;if(l.visualization){if(l.visualization.type==="IconSelect"){l.type="simpleicon"}}if(l.manifestpath&&(!l.manifestpath.startsWith("/sap.card/configuration/parameters/")||!s.get(f,this._oInitialJson))){s.set(f,l,this._oInitialJson)}s.set(f,l,this._oInitialJson);if(!l.hasOwnProperty("type")){this.fireError({name:"Designtime Error",detail:{message:"Type of parameter "+r+" not exist"}})}else if(l.type===""){this.fireError({name:"Designtime Error",detail:{message:"Type of parameter "+r+" is Invalid"}})}if(l.type!=="group"){if(!l.hasOwnProperty("value")){var g=l.manifestpath.substring(1).split("/"),u=s.get(g,this._oInitialJson);if(u!==undefined){l.value=u}else{this._applyDefaultValue(l)}}else{this._applyDefaultValue(l)}if(s.get(f,this._oInitialJson)){if(s.get(f,this._oInitialJson).value===undefined){s.get(f,this._oInitialJson).value=l.value}}}}}return t};m.prototype.setJson=function(t){if(!this._i18n){this._i18n=s.get(["sap.app","i18n"],t)}o.prototype.setJson.apply(this,arguments);if(!this.__generateDesigntimeJSConfigAttached){this.attachDesigntimeMetadataChange(this._generateDesigntimeJSConfig.bind(this));this.attachJsonChange(this._generateDesigntimeJSConfig.bind(this));this.__generateDesigntimeJSConfigAttached=true}var t=this.getJson();var e=s.get(["sap.app","id"],t);if(this._bDesigntimeInit&&this._bCardId!==e){if(this._oDesigntimePromise){this._oDesigntimePromise.cancel()}delete this._bCardId;delete this._bDesigntimeInit}if(!this._bDesigntimeInit){this.setPreventInitialization(true);this._bCardId=e;var a;var n=c(s.get(["sap.card","designtime"],t)||"");if(!n){var r=p;s.set(["sap.card","designtime"],"dt/configuration",t);a="sap/ui/integration/designtime/cardEditor/ConfigurationTemplate";this.fireCreateConfiguration({file:"dt/configuration.js",content:r,manifest:this._cleanJson(t,false)});return}var f=c(this.getBaseUrl()||"");if(f&&n){var g={};var m=c(f);var v=d(n);var _=m+"/"+v;var C=e.replace(/\./g,"/")+"/"+v;g[C]=_;g[C+"js"]=_.substring(0,_.lastIndexOf("/"));var b=_.replace(g[C+"js"]+"/","");sap.ui.loader.config({paths:g});var y=this;this._oDesigntimePromise=new i(function(i){var t=C+"js"+"/"+b+".js";if(a){t=a+".js"}sap.ui.loader._.loadJSResourceAsync(t).then(function(t){if(!t){y.fireError({name:"Designtime Error",detail:{message:"Invalid file format"}})}else if(t){var e=new t;y._oDesigntimeJSConfig=e.getSettings();y._fnDesigntime=t;var a=y._generateMetadataFromJSConfig();t=e.getMetadata().getClass();i(a)}}).catch(function(i){u.error(i);y.fireError({name:"Designtime Error",detail:i})})});this._oDesigntimePromise.then(function(i){this.setPreventInitialization(false);var t=i;t=l.mergeCardDesigntimeMetadata(t,this.getDesigntimeChanges());this._oInitialDesigntimeMetadata=t;this.setDesigntimeMetadata(h(t),true);this._bDesigntimeInit=true;this.fireDesigntimeInited()}.bind(this))}else{this.setPreventInitialization(false)}}};m.prototype.initialize=function(){if(!this._bDesigntimeInit){this.attachEventOnce("designtimeInited",this.initialize);return}if(!this._bPreventInitialization){this._initialize()}};m.prototype.getConfigurationTemplate=function(){return p};m.prototype.updateDesigntimeMetadata=function(i,t){var e=this._generateMetadataFromJSConfig(i);this.setDesigntimeMetadata(h(e),t)};function h(i){var t={};Object.keys(i).forEach(function(e){s.set(e.split("/"),{__value:n(i[e])},t)});return t}function c(i){return i.trim().replace(/\/*$/,"")}function d(i){return i.replace(/^\.\//,"")}return m});