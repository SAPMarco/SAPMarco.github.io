/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_CancelablePromise","sap/base/util/restricted/_isEqual","sap/base/util/restricted/_omit","sap/base/util/merge","sap/base/util/deepClone","sap/base/util/deepEqual","sap/base/util/ObjectPath","./CardEditor","sap/ui/integration/designtime/baseEditor/BaseEditor","sap/ui/integration/Designtime","sap/ui/integration/util/CardMerger","sap/base/util/LoaderExtensions","sap/base/Log"],function(e,t,i,a,n,s,r,o,f,l,u,g,p){"use strict";var m="";m=g.loadResource("sap/ui/integration/designtime/cardEditor/ConfigurationTemplate.js",{dataType:"text",failOnError:false,async:false});var h=o.extend("sap.ui.integration.designtime.cardEditor.BASEditor",{metadata:{library:"sap.ui.integration",events:{configurationChange:{},createConfiguration:{},error:{},designtimeInited:{}}},renderer:o.getMetadata().getRenderer()});h.prototype.getManifest=function(){return this._oCurrent.manifest};h.prototype.getConfigurationClass=function(){return this._oCurrent.configurationclass};h.prototype.getConfiguration=function(){return this._oCurrent.configuration};h.prototype.getConfigurationString=function(){return this._oCurrent.configurationstring};h.prototype._generateDesigntimeJSConfig=function(){var e=this._formatExportedDesigntimeMetadata(this.getDesigntimeMetadata());var i=this.getJson();if(this._eventTimeout){clearTimeout(this._eventTimeout);this._eventTimeout=null}this._eventTimeout=setTimeout(function(){var n={form:{items:{}}};var o=a(n,this._oDesigntimeJSConfig);var f={};var u=[];var g;if(!r.get(["sap.card","configuration"],i)){r.set(["sap.card","configuration"],{parameters:{}},i)}else if(!r.get(["sap.card","configuration","parameters"],i)){r.set(["sap.card","configuration","parameters"],{},i)}var p=r.get(["sap.card","configuration","parameters"],i);if(i){var m=r.get(["sap.card","configuration","parameters"],this._oDesigntimeMetadataModel.getData());if(s(p,{})&&!m){this._oDesigntimeJSConfig.form.items={};this._oCurrent={configuration:this._cleanConfig(this._oDesigntimeJSConfig),manifest:this._cleanJson(),configurationclass:this._fnDesigntime,configurationstring:this._cleanConfig(this._oDesigntimeJSConfig,true)};this.fireConfigurationChange(this._oCurrent);return}var h=Object.keys(p);for(var c in o.form.items){g=a({},o.form.items[c]);if(!p[c]){if(m[c]){if(g.type==="group"){p[c]={}}else if(g.manifestpath&&!g.manifestpath.startsWith("/sap.card/configuration/parameters")){var d=g.manifestpath;if(d.startsWith("/")){d=d.substring(1)}var v=r.get(d.split("/"),i)||g.defaultValue||"";p[c]={value:v}}}else{delete o.form.items[c];continue}}else if(g.manifestpath&&!g.manifestpath.startsWith("/sap.card/configuration/parameters")){var d=g.manifestpath;if(d.startsWith("/")){d=d.substring(1)}var _=d.split("/");var v=r.get(_,i);var y=r.get(_,this._oInitialJson);if(!t(v,y)){p[c].value=v}else{r.set(_,p[c].value,i)}}var C=h.indexOf(c);if(C>-1){h.splice(C,1)}var b;if(p[c].visualization){b=p[c].visualization}var D;if(p[c].values){D=p[c].values}o.form.items[c]=a(g,p[c]);if(!m[c].__value.visualization){delete o.form.items[c].visualization}else if(b){o.form.items[c].visualization=b;b=null}if(!m[c].__value.values){delete o.form.items[c].values}else if(D){o.form.items[c].values=D;D=null}if(g.type==="group"){delete o.form.items[c].manifestpath}else if(!o.form.items[c].manifestpath){m[c].manifestpath="/sap.card/configuration/parameters/"+c+"/value";m[c].__value.manifestpath="/sap.card/configuration/parameters/"+c+"/value";o.form.items[c].manifestpath="/sap.card/configuration/parameters/"+c+"/value"}}if(h.length>0){for(var J=0;J<h.length;J++){var S=h[J];var I=p[S];o.form.items[S]={manifestpath:"/sap.card/configuration/parameters/"+S+"/value",type:I.type||"string",label:I.label,translatable:false,editable:I.editable,visible:I.visible}}p[S]=a(o.form.items[S],p[S])}}if(e){if(o){for(var c in e){var E=e[c];var z=c.substring(c.lastIndexOf("/")+1);if(!c.startsWith("sap.card/configuration/parameters")){continue}var M=o.form.items[z]||{};var b;if(M.visualization){b=M.visualization}var D;if(M.values){D=M.values}g=a(M,p[z]);if(E.hasOwnProperty("label")){g.label=E.label}if(E.hasOwnProperty("position")){g.position=E.position}if(g.editable==="false"){g.editable=false}else if(g.editable==="true"){g.editable=false}if(g.visible==="false"){g.visible=false}else if(g.visible==="true"){g.visible=false}if(g.type==="group"){delete g.manifestpath}if(b){g.visualization=b;b=null}if(D){g.values=D;D=null}g.__key=z;u[g.position]=g}for(var J=0;J<u.length;J++){g=u[J];if(!g){continue}f[g.__key]=g;delete g.__key;delete g.position}o.form.items=f}}this._oDesigntimeJSConfig=o;var P=this._cleanConfig(this._oDesigntimeJSConfig);this._fnDesigntime=function(e){return new l(e)}.bind(this,P);this._oCurrent={configuration:P,manifest:this._cleanJson(i),configurationclass:this._fnDesigntime,configurationstring:this._cleanConfig(this._oDesigntimeJSConfig,true)};this._oDataModel.setData(this._prepareData(i));this.fireConfigurationChange(this._oCurrent);this._oInitialJson=i}.bind(this),500)};h.prototype.init=function(){o.prototype.init.apply(this,arguments);this._oCurrent={configuration:null,manifest:null,configurationclass:null}};h.prototype._applyDefaultValue=function(e){if(e.value===undefined||e.value===null){switch(e.type){case"boolean":e.value=e.defaultValue||false;break;case"integer":case"number":e.value=e.defaultValue||0;break;case"string[]":e.value=e.defaultValue||[];break;default:e.value=e.defaultValue||""}}};h.prototype.getJson=function(e){if(e===true){return this._cleanJson()}else{return f.prototype.getJson.apply(this,arguments)}};h.prototype._cleanJson=function(e,t){e=e||this.getJson();var i=d(r.get(["sap.card","designtime"],e)||"");if(!i){r.set(["sap.card","designtime"],"dt/configuration",e)}e=n(e);var t=t!==false;if(t){var a=r.get(["sap.card","configuration","parameters"],e);for(var s in a){var o=a[s];if(o&&o.type==="group"){delete a[s];continue}if(this._oDesigntimeJSConfig&&this._oDesigntimeJSConfig.form&&this._oDesigntimeJSConfig.form.items){var f=this._oDesigntimeJSConfig.form.items[s]||{};if(f.type==="group"){delete a[s];continue}if(f.manifestpath&&!f.manifestpath.startsWith("/sap.card/configuration/parameters")){var l=f.manifestpath;if(l.startsWith("/")){l=l.substring(1)}if(f.type==="simpleicon"){f.type="string"}if(f.type==="string[]"){f.type="array"}r.set(l.split("/"),f.value,e);delete a[s];continue}}a[s]={value:a[s].value}}}if(this._i18n){r.set(["sap.app","i18n"],this._i18n,e)}return e};h.prototype._cleanConfig=function(e,t){var e=a({},e);for(var i in e.form.items){var n=e.form.items[i];if(n.type==="simpleicon"){if(!n.visualization){n.visualization={type:"IconSelect",settings:{value:"{currentSettings>value}",editable:"{currentSettings>editable}"}}}n.type="string"}if(n.type==="array"){n.type="string[]"}if(n.type!=="string[]"&&n.type!="string"){delete n.values}delete n.value}if(t){var s=JSON.stringify(e,null,"\t");s=s.replace(/\"\$\$([a-zA-Z]*)\$\$\"/g,function(e){return e.substring(3,e.length-3)});return s}return e};h.prototype._generateMetadataFromJSConfig=function(e){var t={};if(e){this._oDesigntimeJSConfig=a(this._oDesigntimeJSConfig,e)}if(this._oDesigntimeJSConfig){var i=this._oDesigntimeJSConfig.form.items;var n=0;for(var s in i){var o="sap.card/configuration/parameters/"+s,f=o.split("/"),l;t[o]=a({},i[s]);l=t[o];l.position=n++;if(l.visualization){if(l.visualization.type==="IconSelect"){l.type="simpleicon"}}if(l.type==="string[]"){l.type="array"}if(l.manifestpath&&(!l.manifestpath.startsWith("/sap.card/configuration/parameters/")||!r.get(f,this._oInitialJson))){r.set(f,l,this._oInitialJson)}if(!l.hasOwnProperty("type")){this.fireError({name:"Designtime Error",detail:{message:"Type of parameter "+s+" not exist"}})}else if(l.type===""){this.fireError({name:"Designtime Error",detail:{message:"Type of parameter "+s+" is Invalid"}})}if(l.type!=="group"){if(!l.hasOwnProperty("value")){var u=l.manifestpath.substring(1).split("/"),g=r.get(u,this._oInitialJson);if(g!==undefined){l.value=g}else{this._applyDefaultValue(l)}}else{this._applyDefaultValue(l)}if(r.get(f,this._oInitialJson)){if(r.get(f,this._oInitialJson).value===undefined){r.get(f,this._oInitialJson).value=l.value}}}}}return t};h.prototype.setJson=function(t){if(!this._i18n){this._i18n=r.get(["sap.app","i18n"],t)}f.prototype.setJson.apply(this,arguments);if(!this.__generateDesigntimeJSConfigAttached){this.attachDesigntimeMetadataChange(this._generateDesigntimeJSConfig.bind(this));this.attachJsonChange(this._generateDesigntimeJSConfig.bind(this));this.__generateDesigntimeJSConfigAttached=true}var t=this.getJson();var i=r.get(["sap.app","id"],t);if(this._bDesigntimeInit&&this._bCardId!==i){if(this._oDesigntimePromise){this._oDesigntimePromise.cancel()}delete this._bCardId;delete this._bDesigntimeInit}if(!this._bDesigntimeInit){this.setPreventInitialization(true);this._bCardId=i;var a;var n=d(r.get(["sap.card","designtime"],t)||"");if(!n){var s=m;r.set(["sap.card","designtime"],"dt/configuration",t);a="sap/ui/integration/designtime/cardEditor/ConfigurationTemplate";this.fireCreateConfiguration({file:"dt/configuration.js",content:s,manifest:this._cleanJson(t,false)});return}var o=d(this.getBaseUrl()||"");if(o&&n){var l={};var g=d(o);var h=v(n);var _=g+"/"+h;var y=i.replace(/\./g,"/")+"/"+h;l[y]=_;l[y+"js"]=_.substring(0,_.lastIndexOf("/"));var C=_.replace(l[y+"js"]+"/","");sap.ui.loader.config({paths:l});var b=this;this._oDesigntimePromise=new e(function(e){var t=y+"js"+"/"+C+".js";if(a){t=a+".js"}sap.ui.loader._.loadJSResourceAsync(t).then(function(t){if(!t){b.fireError({name:"Designtime Error",detail:{message:"Invalid file format"}})}else if(t){var i=new t;b._oDesigntimeJSConfig=i.getSettings();b._fnDesigntime=t;var a=b._generateMetadataFromJSConfig();t=i.getMetadata().getClass();e(a)}}).catch(function(e){p.error(e);b.fireError({name:"Designtime Error",detail:e})})});this._oDesigntimePromise.then(function(e){this.setPreventInitialization(false);var t=e;t=u.mergeCardDesigntimeMetadata(t,this.getDesigntimeChanges());this._oInitialDesigntimeMetadata=t;this.setDesigntimeMetadata(c(t),true);this._bDesigntimeInit=true;this.fireDesigntimeInited()}.bind(this))}else{this.setPreventInitialization(false)}}};h.prototype.initialize=function(){if(!this._bDesigntimeInit){this.attachEventOnce("designtimeInited",this.initialize);return}if(!this._bPreventInitialization){this._initialize()}};h.prototype.getConfigurationTemplate=function(){return m};h.prototype.updateDesigntimeMetadata=function(e,t){var i=this._generateMetadataFromJSConfig(e);this._oInitialDesigntimeMetadata=i;this.setDesigntimeMetadata(c(i),t)};h.prototype.setDestinations=function(e){if(Array.isArray(e)&&e.length>0){var t=this.getConfig();if(!t.properties){t.properties={destinations:{}}}else if(!t.properties.destinations){t.properties.destinations={}}t.properties.destinations.allowedValues=e;this.setConfig(t)}};function c(e){var t={};Object.keys(e).forEach(function(i){r.set(i.split("/"),{__value:n(e[i])},t)});return t}function d(e){return e.trim().replace(/\/*$/,"")}function v(e){return e.replace(/^\.\//,"")}return h});