/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["ui5loader","sap/ui/core/Control","sap/ui/core/Core","sap/base/util/deepClone","sap/base/util/merge","sap/ui/integration/widgets/Card","sap/ui/integration/Designtime","sap/ui/model/json/JSONModel","sap/ui/integration/util/CardMerger","sap/m/Label","sap/m/Title","sap/m/Panel","sap/m/HBox","sap/m/VBox","sap/ui/core/Icon","sap/m/ResponsivePopover","sap/m/Popover","sap/m/Text","sap/base/Log","sap/ui/core/Popup","sap/base/i18n/ResourceBundle","sap/ui/thirdparty/URI","sap/ui/dom/includeStylesheet","sap/base/util/LoaderExtensions","sap/ui/core/theming/Parameters","sap/base/util/ObjectPath","sap/m/FormattedText","sap/m/MessageStrip","sap/base/util/includes"],function(e,t,i,a,s,n,r,o,l,d,f,g,u,p,h,_,c,m,v,y,C,b,M,D,T,E,I,P,x){"use strict";var A=c.prototype.init;c.prototype.init=function(){A.apply(this,arguments);var e=this.oPopup._applyPosition,t=this;this.oPopup._applyPosition=function(){var i=t.close;t.close=function(){};e.apply(this,arguments);t.close=i}};function S(e){if(e&&e.nodeType!==1){return 0}var t=parseInt(window.getComputedStyle(e).getPropertyValue("z-index"));if(isNaN(t)){return S(e.parentNode)}return t+1}var O=/\{\{(?!parameters.)(?!destinations.)([^\}\}]+)\}\}/g,w=5e3,L=i.getLibraryResourceBundle("sap.ui.integration");var R=t.extend("sap.ui.integration.designtime.editor.CardEditor",{metadata:{library:"sap.ui.integration",properties:{card:{type:"any",defaultValue:null},mode:{type:"string",defaultValue:"admin"},language:{type:"string",defaultValue:""},allowDynamicValues:{type:"boolean",defaultValue:false},allowSettings:{type:"boolean",defaultValue:false},designtime:{type:"object"}},aggregations:{_formContent:{type:"sap.ui.core.Control",multiple:true,visibility:"hidden"},_preview:{type:"sap.ui.integration.designtime.editor.CardPreview",multiple:false,visibility:"hidden"},_messageStrip:{type:"sap.m.MessageStrip",multiple:false,visibility:"hidden"}},events:{ready:{}}},renderer:function(e,t){e.openStart("div");t.getMode()==="translation"?e.addClass("sapUiIntegrationCardEditorTranslation"):e.addClass("sapUiIntegrationCardEditorPreview");e.addClass("sapUiIntegrationCardEditor");e.writeClasses();e.writeElementData(t);e.openEnd();if(t.isReady()){var i=t.getAggregation("_preview");var a=false;if(i&&i.getSettings()&&i.getSettings().preview&&i.getSettings().preview.modes==="None"){a=true}e.openStart("div");t.getMode()==="translation"||a?e.addClass("sapUiIntegrationCardEditorFormWithNoPreview"):e.addClass("sapUiIntegrationCardEditorForm");if(t.getMode()!=="translation"){e.addClass("settingsButtonSpace")}e.writeClasses();e.openEnd();if(t.getMode()!=="translation"){e.renderControl(t.getAggregation("_messageStrip"))}var s=t.getAggregation("_formContent");if(s){var n;var r;var o;var l;var d=[];var f=2;var g;var h=function(){return new sap.m.FlexItemData({growFactor:1,baseSize:"0",maxWidth:"50%"})};var _=function(){if(d.length>0){var e=f-d.length;for(var t=0;t<e;t++){d.push(new p({}))}n.addContent(new u({items:d}));d=[]}};for(var c=0;c<s.length;c++){var m=s[c];if(t.getMode()!=="translation"){if(m.isA("sap.m.Panel")){if(n){_();if(n.getContent().length>0){e.renderControl(n)}}n=m;n.addStyleClass("sapUiIntegrationCardEditorItem");if(c===s.length-1){_();if(n.getContent().length>0){e.renderControl(n)}}continue}if(m.isA("sap.m.FormattedText")){n.addContent(new u({items:m}).addStyleClass("sapUiIntegrationCardEditorHint"));continue}if(m.isA("sap.m.Label")){m.addStyleClass("sapUiIntegrationCardEditorItemLabel");var v=m.getDependents()&&m.getDependents()[0];var y=null;y=new u({items:[m.addStyleClass("description")]});if(v){y.addItem(v)}if(m._oMessageIcon){y.addItem(m._oMessageIcon)}if(m._cols===1){if(d.length===f){n.addContent(new u({items:d}));d=[]}y.addStyleClass("col1box");l=y?y:m;continue}_();if(m._sOriginalType==="boolean"){o=y?y:m}else{n.addContent(y?y:m)}}else if(m._cols===1){var C=new p({items:[l,m]});C.addStyleClass("col1");d.push(C);l=null}else if(o){m.setLayoutData(h());o.setLayoutData(h());n.addContent(new u({items:[o,m]}));o=null}else{n.addContent(m)}if(c===s.length-1){_();if(n.getContent().length>0){e.renderControl(n)}}}else{if(c===0){r=m;e.renderControl(r);r.addStyleClass("sapUiIntegrationCardEditorTranslationPanel");continue}if(m.isA("sap.m.Panel")){if(n&&n.getContent().length>0){r.addContent(n)}n=m;n.addStyleClass("sapUiIntegrationCardEditorTranslationSubPanel");continue}if(m.isA("sap.m.FormattedText")){continue}if(m.isA("sap.m.Label")){n.addContent(m);continue}if(m.isOrigLangField){g=m;continue}g.setLayoutData(h());g.addStyleClass("sapUiIntegrationFieldTranslationText");m.setLayoutData(h());var b=new u({items:[g,m]});n.addContent(b);if(c===s.length-1){r.addContent(n)}}}}e.close("div");i&&e.renderControl(i)}e.close("div")}});R.prototype.init=function(){this._ready=false;this._aFieldReadyPromise=[];this._oResourceBundle=L;this._appliedLayerManifestChanges=[];this._currentLayerManifestChanges={};this._mDestinationDataProviders={};this.setAggregation("_messageStrip",new P({showIcon:false}))};R.prototype.isReady=function(){return this._ready};function V(e,t,i,a){a=a||"";i=i||[];if(typeof e==="object"){if(!e[t]){for(var s in e){V(e[s],t,i,a+"/"+s)}}else{if(e.type){i.push({path:e.pathvalue||a.substring(1),value:e.pathvalue||"{context>"+a.substring(1)+"/value}",object:e})}else{i.push({path:a.substring(1),object:e});for(var s in e){V(e[s],t,i,a+"/"+s)}}}}return i}R.prototype._filterManifestChangesByLayer=function(e){var t=this;var i=[],a={":layer":l.layers[t.getMode()]},s=l.layers[this.getMode()];e.manifestChanges.forEach(function(e){var t=e.hasOwnProperty(":layer")?e[":layer"]:1e3;if(t<s){i.push(e)}else if(t===s){a=e}});e.manifestChanges=i;t._currentLayerManifestChanges=a};R.prototype.setCard=function(e,t){this._ready=false;if(e===this.getProperty("card")){return this}if(this._oEditorCard){this._oEditorCard.destroy()}if(this._oDesigntimeInstance){this._oDesigntimeInstance.destroy()}this.setProperty("card",e,t);Promise.resolve().then(function(){this._initCard(e)}.bind(this));return this};R.prototype.setLanguage=function(e,t){if(!e||typeof e!=="string"){return this}this._language=e.replace("-","_");if(this.getLanguage()!=e){L=i.getLibraryResourceBundle("sap.ui.integration");this._oResourceBundle=L}this.setProperty("language",e,t);if(!R._languages[this._language]){this._language=this._language.split("_")[0]}if(!R._languages[this._language]){v.warning("The language: "+e+" is currently unknown, some UI controls might show "+e+" instead of the language name.")}return this};R.prototype.onAfterRendering=function(){if(this.getDomRef()){this._iZIndex=S(this.getDomRef());y.setInitialZIndex(this._iZIndex)}};R.prototype._getOriginalManifestJson=function(){try{return this._oEditorCard._oCardManifest._oManifest.getRawJson()}catch(e){return{}}};R.prototype._initCard=function(e){if(typeof e==="string"){try{e=JSON.parse(e)}catch(s){var t=i.byId(e);if(!t){var a=document.getElementById(e);if(a&&a.tagName&&a.tagName==="ui-integration-card"){t=a._getControl()}}e=t}}if(e&&e.isA&&e.isA("sap.ui.integration.widgets.Card")){e={manifest:e.getManifest(),manifestChanges:e.getManifestChanges(),host:e.getHost(),baseUrl:e.getBaseUrl()}}if(typeof e==="object"){var r=l.layers[this.getMode()];if(e.manifestChanges){this._filterManifestChangesByLayer(e)}this._oEditorCard=new n(e);var d=this;this._oEditorCard._prepareToApplyManifestSettings=function(){n.prototype._prepareToApplyManifestSettings.apply(this,arguments);if(!d._oEditorCard._isManifestReady){return}if(d._manifestModel){return}d._appliedLayerManifestChanges=e.manifestChanges;var t=d._oEditorCard.getManifestEntry("/");var i=s({},t);d._oProviderCard=d._oEditorCard;d._oProviderCard._editorManifest=t;d._beforeManifestModel=new o(i);if(r<l.layers["translation"]&&d._currentLayerManifestChanges){t=l.mergeCardDelta(t,[d._currentLayerManifestChanges])}d._manifestModel=new o(t);d._originalManifestModel=new o(d._getOriginalManifestJson());d._initInternal();if(!d._oEditorCard.getModel("i18n")){d._oEditorCard._loadDefaultTranslations()}d.setModel(d._oEditorCard.getModel("i18n"),"i18n");d._createContextModel()};this._oEditorCard.onBeforeRendering()}};R.prototype._initInternal=function(){var e=this._oEditorCard.getManifestEntry("/sap.card/designtime"),t=this._manifestModel.getProperty("/sap.card/configuration"),i,a=this.getDesigntime();if(a){if(typeof a==="function"){i=new Promise(function(e,t){var i=new a;this._applyDesigntimeDefaults(i.getSettings());e(i)}.bind(this))}else if(typeof a==="object"){i=new Promise(function(e,t){sap.ui.require(["sap/ui/integration/Designtime"],function(t){var i=t.extend("test.Designtime");i.prototype.create=function(){return a};var s=new i;this._applyDesigntimeDefaults(s.getSettings());e(s)}.bind(this))}.bind(this))}}else if(e){i=this._oEditorCard.loadDesigntime().then(function(e){this._applyDesigntimeDefaults(e.getSettings());return e}.bind(this))}else{i=Promise.resolve(this._createParameterDesigntime(t))}i.then(function(e){this._oDesigntimeInstance=e;if(this.getMode()==="admin"||this.getMode()==="all"){this._addDestinationSettings(t,this._oDesigntimeInstance)}this._settingsModel=new o(this._oDesigntimeInstance.getSettings());this.setModel(this._settingsModel,"currentSettings");this.setModel(this._settingsModel,"items");this._oProviderCard.setModel(this._settingsModel,"currentSettings");this._oProviderCard.setModel(this._settingsModel,"items");this._applyDesigntimeLayers();this._requireFields().then(function(){this._startEditor()}.bind(this))}.bind(this))};R.prototype.getCurrentSettings=function(){var e=this._settingsModel.getProperty("/"),t={},i;if(e&&e.form&&e.form.items){for(var a in e.form.items){var s=e.form.items[a];if(s.editable&&s.visible){var n="";if(s.manifestpath){n=s.manifestpath.substring(0,s.manifestpath.lastIndexOf("/"))+"/valueTranslations"}if(this.getMode()!=="translation"){if(s.translatable&&!s._changed&&s._translatedDefaultPlaceholder&&!this._currentLayerManifestChanges[s.manifestpath]&&!this._currentLayerManifestChanges[n]){continue}else{t[s.manifestpath]=s.value;if(s.valueItems){t[s.manifestpath.substring(0,s.manifestpath.lastIndexOf("/"))+"/valueItems"]=s.valueItems}}}else if(s.translatable&&s.value){t[s.manifestpath]=s.value}if(s._next&&this.getAllowSettings()){if(s._next.editable===false){i=i||{};i[s._settingspath+"/editable"]=false}if(s._next.visible===false){i=i||{};i[s._settingspath+"/visible"]=false}if(typeof s._next.allowDynamicValues==="boolean"&&this.getAllowDynamicValues()){i=i||{};i[s._settingspath+"/allowDynamicValues"]=s._next.allowDynamicValues}}}}}if(this.getMode()!=="translation"){t[":multipleLanguage"]=true}t[":layer"]=l.layers[this.getMode()];t[":errors"]=this.checkCurrentSettings()[":errors"];if(i){t[":designtime"]=i}return t};R.prototype.checkCurrentSettings=function(){var e=this._settingsModel.getProperty("/"),t={};if(e&&e.form&&e.form.items){for(var i in e.form.items){var a=e.form.items[i];if(a.editable){if((a.isValid||a.required)&&!(this.getMode()==="translation"&&a.translatable)){if(a.isValid){t[a.manifestpath]=a.isValid(a)}t[a.manifestpath]=true;var s=a.value;var n=a.type;if(n==="string"&&s===""){t[a.manifestpath]=s}if((n==="date"||n==="datetime")&&isNaN(Date.parse(s))){t[a.manifestpath]=s}if(n==="integer"){if(isNaN(parseInt(s))){t[a.manifestpath]=s}else if(s<a.min||s>a.max){t[a.manifestpath]=s}}if(n==="number"){if(isNaN(parseFloat(s))){t[a.manifestpath]=s}else if(s<a.min||s>a.max){t[a.manifestpath]=s}}}}}t[":layer"]=l.layers[this.getMode()]}t[":errors"]=Object.values(t).indexOf(false)>-1;return t};R.prototype._createContextModel=function(){var e=this._oEditorCard.getHostInstance(),t=new o({}),i=new o([]);this.setModel(t,"context");this.setModel(i,"contextflat");i._getPathObject=function(e){var t=this.getData().filter(function(t){if(t.path===e){return true}});return t.length?t[0]:null};i._getValueObject=function(e){var t=this.getData()||[];t=t.filter(function(t){if(t.value===e||t.object.value===e){return true}});return t.length?t[0]:null};var a=new Promise(function(t,i){if(e&&e.getContext){var a=false;setTimeout(function(){if(a){return}v.error("Card Editor context could not be determined with "+w+".");a=true;t({})},w);e.getContext().then(function(e){if(a){v.error("Card Editor context returned after more than "+w+". Context is ignored.")}a=true;t(e||{})})}else{t({})}});a.then(function(e){var a={};a["empty"]=R._contextEntries.empty;for(var s in e){a[s]=e[s]}a["card.internal"]=R._contextEntries["card.internal"];t.setData(a);i.setData(V(a,"label"))});t.getProperty=function(t,i){var a=this.resolve(t,i);if(a.endsWith("/value")){this._mValues=this._mValues||{};if(this._mValues.hasOwnProperty(a)){return this._mValues[a]}this._mValues[a]=undefined;e.getContextValue(a.substring(1)).then(function(e){this._mValues[a]=e;this.checkUpdate()}.bind(this));return undefined}else{return o.prototype.getProperty.apply(this,arguments)}}};R.fieldMap={string:"sap/ui/integration/designtime/editor/fields/StringField",integer:"sap/ui/integration/designtime/editor/fields/IntegerField",number:"sap/ui/integration/designtime/editor/fields/NumberField",boolean:"sap/ui/integration/designtime/editor/fields/BooleanField",date:"sap/ui/integration/designtime/editor/fields/DateField",datetime:"sap/ui/integration/designtime/editor/fields/DateTimeField","string[]":"sap/ui/integration/designtime/editor/fields/ListField",destination:"sap/ui/integration/designtime/editor/fields/DestinationField"};R.Fields=null;R.prototype._requireFields=function(){if(R.Fields){return Promise.resolve()}return new Promise(function(e){sap.ui.require(Object.values(R.fieldMap),function(){R.Fields={};for(var t in R.fieldMap){R.Fields[t]=arguments[Object.keys(R.fieldMap).indexOf(t)]}e()})})};R.prototype._createLabel=function(e){var t=new d({text:e.label,tooltip:e.tooltip||e.label,required:e.required&&e.editable||false,visible:e.visible,objectBindings:{currentSettings:{path:"currentSettings>"+e._settingspath},items:{path:"items>/form/items"}}});t._cols=e.cols||2;t._sOriginalType=e.type;if(e.description){var i=new h({src:"sap-icon://message-information",color:"Marker",size:"12px",useIconTooltip:false,visible:this.getMode()!=="translation"});i.addStyleClass("sapUiIntegrationCardEditorDescriptionIcon");t.addDependent(i);t._oDescriptionIcon=i;i.onmouseover=function(t){this._getPopover().getContent()[0].applySettings({text:e.description});this._getPopover().openBy(t);t.addDependent(this._getPopover())}.bind(this,i);i.onmouseout=function(e){this._getPopover().close();e.removeDependent(this._getPopover())}.bind(this,i)}var a=new h({src:"sap-icon://message-information",size:"12px",useIconTooltip:false});a.addStyleClass("sapUiIntegrationCardEditorMessageIcon");t._oMessageIcon=a;return t};R.prototype._getPopover=function(){if(this._oPopover){return this._oPopover}var e=new m({text:""});e.addStyleClass("sapUiTinyMargin sapUiIntegrationCardEditorDescriptionText");this._oPopover=new _({showHeader:false,content:[e]});this._oPopover.addStyleClass("sapUiIntegrationCardEditorPopover");return this._oPopover};R.prototype._updateProviderCard=function(e){if(this._ready){var t=this._oProviderCard._editorManifest;if(e.length===0){return}for(var i=0;i<e.length;i++){var a=e[i];a.config._cancel=true}delete t["sap.card"].header;delete t["sap.card"].content;delete t["sap.card"].data;t["sap.card"].type="List";var s=this._oProviderCard;this._oProviderCard=new n({manifest:t,baseUrl:this._getBaseUrl(),host:this._oProviderCard.getHost()});this._oProviderCard.setManifestChanges([this.getCurrentSettings()]);this._oProviderCard._editorManifest=t;var r=this;this._oProviderCard._fillFiltersModel=function(){if(!r._oProviderCard._oDataProviderFactory){return}r._bIgnoreUpdates=true;for(var t=0;t<e.length;t++){var i=e[t];i.config._cancel=false;r._addValueListModel(i.config,i.field,true)}r._bIgnoreUpdates=false};this._oProviderCard.setVisible(false);this._oProviderCard.setModel(this._settingsModel,"items");this._oProviderCard.setModel(this._settingsModel,"currentSettings");this._oProviderCard.onBeforeRendering();if(s&&s!==this._oEditorCard){s.destroy()}}};R.prototype._createField=function(e){var t=new R.Fields[e.type]({configuration:e,mode:this.getMode(),host:this._oEditorCard.getHostInstance(),objectBindings:{currentSettings:{path:"currentSettings>"+e._settingspath},items:{path:"items>/form/items"}},visible:e.visible});this._aFieldReadyPromise.push(t._readyPromise);var i=this._settingsModel.bindProperty(e._settingspath+"/value");i.attachChange(function(){if(!this._bIgnoreUpdates){e._changed=true;if(e._dependentFields&&e._dependentFields.length>0){this._updateProviderCard(e._dependentFields)}this._updatePreview()}}.bind(this));this._addValueListModel(e,t);t._cols=e.cols||2;return t};R.prototype._addValueListModel=function(e,t,i){if(e.values){var a;if(e.values.data){if(this._oProviderCard&&this._oProviderCard._oDataProviderFactory){a=t.getModel();if(!a){a=new o({});t.setModel(a,undefined)}var n=this._oProviderCard._oDataProviderFactory.create(e.values.data);n.bindObject({path:"items>/form/items"});n.bindObject({path:"currentSettings>"+e._settingspath});var r=n.getData();this._settingsModel.setProperty(e._settingspath+"/_loading",true);r.then(function(i){if(e._cancel){e._values=[];return}if(e.type==="string[]"){var s=e.values.data.path;if(s&&s!=="/"){if(s.startsWith("/")){s=s.substring(1)}if(s.endsWith("/")){s=s.substring(0,s.length-1)}var n=s.split("/");var r=E.get(n,i);if(Array.isArray(r)){for(var o in r){var l=t.getKeyFromItem(r[o]);if(Array.isArray(e.value)&&e.value.length>0&&x(e.value,l)){r[o].Selected=L.getText("CARDEDITOR_ITEM_SELECTED")}else{r[o].Selected=L.getText("CARDEDITOR_ITEM_UNSELECTED")}}E.set(n,r,i)}}else if(Array.isArray(i)){for(var o in i){var l=t.getKeyFromItem(i[o]);if(Array.isArray(e.value)&&e.value.length>0&&x(e.value,l)){i[o].Selected=L.getText("CARDEDITOR_ITEM_SELECTED")}else{i[o].Selected=L.getText("CARDEDITOR_ITEM_UNSELECTED")}}}}e._values=i;a.setData(i);a.checkUpdate(true);a.firePropertyChange();this._settingsModel.setProperty(e._settingspath+"/_loading",false)}.bind(this)).catch(function(){e._values={};a.setData({});a.checkUpdate(true);this._settingsModel.setProperty(e._settingspath+"/_loading",false)}.bind(this))}t.bindObject({path:e.values.data.path||"/"})}else if(this._oProviderCard&&this._oProviderCard.getAggregation("_extension")){a=this._oProviderCard.getAggregation("_extension").getModel();t.bindObject({path:e.values.path||"/"});t.setModel(a,undefined)}if(!i){var l=JSON.stringify(e.values.data);if(l){var d=/parameters\.([^\}\}]+)|destinations\.([^\}\}]+)|\{items\>[\/?\w+]+\}|\{currentSettings\>[\/?\w+]+\}/g,f=l.match(d);if(f){for(var g=0;g<f.length;g++){var u="/value";var p="/sap.card/configuration/";if(f[g].indexOf("destinations.")===0||f[g].indexOf("parameters.")===0){if(f[g].indexOf("destinations.")===0){u="/name"}p=p+f[g].replace(".","/")+u}else if(f[g].indexOf("{items>")===0){p=p+"parameters/"+f[g].slice(7,-1)}else if(f[g].indexOf("{currentSettings>")===0){if(f[g].endsWith("suggestValue}")){p=p+"parameters/"+e._settingspath.substring(e._settingspath.lastIndexOf("/")+1)+"/value"}else{p=p+"parameters/"+f[g].slice(17,-1)}}var h=this._mItemsByPaths[p];if(h){var _=s({},e);h._dependentFields=h._dependentFields||[];h._dependentFields.push({field:t,config:_})}}}}}}};R.prototype._addItem=function(e){var t=this.getMode();if(this.getAllowDynamicValues()===false||!e.allowDynamicValues){e.allowDynamicValues=false}if(this.getAllowSettings()===false){e.allowSettings=false}e._beforeValue=this._beforeManifestModel.getProperty(e.manifestpath);e.__cols=e.cols||2;if(e.visible===false||!e.translatable&&t==="translation"&&e.type!=="group"){return}if(e.type==="group"){var i=new g({headerText:e.label,visible:e.visible,expandable:e.expandable!==false,expanded:e.expanded!==false,width:"auto",backgroundDesign:"Transparent",objectBindings:{currentSettings:{path:"currentSettings>"+e._settingspath},items:{path:"items>/form/items"}}});this.addAggregation("_formContent",i);i._cols=e.cols||2;if(e.hint){this._addHint(e.hint)}return}var s=null;if(t==="translation"){if(typeof e.value==="string"&&e.value.indexOf("{")===0||typeof e.values!=="undefined"){return}e._language={value:e.value};e.cols=1;delete e.values;var n=a(e,10);n._settingspath+="/_language";n.editable=false;n.required=false;if(typeof n._beforeValue!=="undefined"&&!(n._beforeValue.startsWith("{i18n>")&&n._beforeValue.endsWith("}"))){n.value=n._beforeValue}if(!n.value){n.value="-"}var r=this._createLabel(n);this.addAggregation("_formContent",r);var o=this._createField(n);o.isOrigLangField=true;this.addAggregation("_formContent",o);e.value=e._translatedDefaultValue||"";e.editable=e.visible=e.translatable;if(this._currentLayerManifestChanges){e.value=this._currentLayerManifestChanges[e.manifestpath]||e.value}e.label=e._translatedLabel||"";e.required=false}else{s=this._createLabel(e);this.addAggregation("_formContent",s)}var o=this._createField(e);o.setAssociation("_messageIcon",s&&s._oMessageIcon);this.addAggregation("_formContent",o);if(e.hint&&e.type==="boolean"&&(!e.cols||e.cols===2)){this._addHint(e.hint)}if(s){s._oMessageIcon.onmouseover=function(e){e._showMessage()}.bind(this,o);s._oMessageIcon.onmouseout=function(e){e._hideMessage()}.bind(this,o)}e.cols=e.__cols;delete e.__cols};R.prototype._addHint=function(e){e=e.replace(/<a href/g,"<a target='blank' href");var t=new I({htmlText:e});this.addAggregation("_formContent",t)};R.prototype._getCurrentLanguageSpecificText=function(e){var t=this._language;if(this._oTranslationBundle){var i=this._oTranslationBundle.getText(e,[],true);if(i===undefined){return""}return i}if(!t){return""}var a=this._oEditorCard.getManifestEntry("/sap.app/i18n");if(!a){return""}if(typeof a==="string"){var s=[t];if(t.indexOf("_")>-1){s.push(t.substring(0,t.indexOf("_")))}if(!x(s,"en")){s.push("en")}this._oTranslationBundle=C.create({url:this._getBaseUrl()+a,async:false,locale:t,supportedLocales:s,fallbackLocale:"en"});return this._getCurrentLanguageSpecificText(e)}};R.prototype._getBaseUrl=function(){if(this._oEditorCard&&this._oEditorCard.isReady()){return this._oEditorCard.getBaseUrl()||this.oCardEditor._oEditorCard._oCardManifest.getUrl()}return""};R.prototype._startEditor=function(){var e=this._settingsModel.getProperty("/");var t;if(e.form&&e.form.items){t=e.form.items;var a=this._language||this.getLanguage()||i.getConfiguration().getLanguage().replaceAll("-","_");if(this.getMode()==="translation"){this._addItem({type:"group",translatable:true,expandable:false,label:L.getText("CARDEDITOR_ORIGINALLANG")+": "+R._languages[a]})}var s=false;for(var n in t){var r=t[n];if(r.type==="group"){break}else if(r.visible){s=true;break}}if(s){this._addItem({type:"group",translatable:true,label:L.getText("CARDEDITOR_PARAMETERS_GENERALSETTINGS")})}this._mItemsByPaths={};for(var o in t){var r=t[o];if(r){r.label=r.label||o;var l;if(r.manifestpath){this._mItemsByPaths[r.manifestpath]=r;l=this._currentLayerManifestChanges[r.manifestpath]}r._changed=l!==undefined;if(r.values){r.translatable=false}if(r.type==="string"){r._translatedDefaultPlaceholder=this._getManifestDefaultValue(r.manifestpath)||r.defaultValue;var d=null,f=r._translatedDefaultPlaceholder;if(f){if(this._isValueWithHandlebarsTranslation(f)){d=f.substring(2,f.length-2)}else if(f.startsWith("{i18n>")){d=f.substring(6,f.length-1)}if(d){r.translatable=true;r._translatedDefaultValue=this.getModel("i18n").getResourceBundle().getText(d);if(r._changed){r.value=l}else{r.value=r._translatedDefaultValue}if(r.valueTranslations&&r.valueTranslations[a]){r.value=r.valueTranslations[a]}if(this.getMode()==="translation"){r._translatedDefaultValue=this._getCurrentLanguageSpecificText(d)}}else if(r.translatable&&this.getMode()==="translation"){r._translatedDefaultValue=r._translatedDefaultPlaceholder}}if(this.getMode()==="translation"){if(r.valueTranslations&&r.valueTranslations[a]){r._translatedDefaultValue=r.valueTranslations[a]}if(this._isValueWithHandlebarsTranslation(r.label)){r._translatedLabel=this._getCurrentLanguageSpecificText(r.label.substring(2,r.label.length-2),true)}else if(r.label&&r.label.startsWith("{i18n>")){r._translatedLabel=this._getCurrentLanguageSpecificText(r.label.substring(6,r.label.length-1),true)}}}else if(r.type==="string[]"){var g=r.manifestpath.substring(0,r.manifestpath.lastIndexOf("/"))+"/valueItems";var u=this._manifestModel.getProperty(g);if(u){r.valueItems=u}}}}}for(var o in t){var r=t[o];this._addItem(r)}if(this.getMode()!=="translation"){this._initPreview().then(function(){Promise.all(this._aFieldReadyPromise).then(function(){this._ready=true;this.fireReady()}.bind(this))}.bind(this))}else{Promise.all(this._aFieldReadyPromise).then(function(){this._ready=true;this.fireReady()}.bind(this))}};R.prototype.destroy=function(){if(this._oEditorCard){this._oEditorCard.destroy()}if(this._oPopover){this._oPopover.destroy()}if(this._oDesigntimeInstance){this._oDesigntimeInstance.destroy()}this._manifestModel=null;this._originalManifestModel=null;this._settingsModel=null;t.prototype.destroy.apply(this,arguments)};R.prototype._initPreview=function(){return new Promise(function(e,t){sap.ui.require(["sap/ui/integration/designtime/editor/CardPreview"],function(t){var i=new t({settings:this._oDesigntimeInstance.getSettings(),card:this._oEditorCard});this.setAggregation("_preview",i);e()}.bind(this))}.bind(this))};R.prototype._updatePreview=function(){var e=this.getAggregation("_preview");if(e){e.update()}};R.prototype._applyDesigntimeDefaults=function(e){e=e||{};e.form=e.form||{};e.form.items=e.form.items||{};e.preview=e.preview||{modes:"Abstract"};var t=e.form.items||e.form.items;for(var i in t){var a=t[i];if(a.manifestpath){a.value=this._manifestModel.getProperty(a.manifestpath)}if(a.visible===undefined||a.visible===null){a.visible=true}if(typeof a.translatable!=="boolean"){a.translatable=false}if(a.editable===undefined||a.editable===null){a.editable=true}if(!a.label){a.label=i}if(!a.type||a.type==="enum"){a.type="string"}if(a.value===undefined||a.value===null){switch(a.type){case"boolean":a.value=a.defaultValue||false;break;case"integer":case"number":a.value=a.defaultValue||0;break;case"string[]":a.value=a.defaultValue||[];break;default:a.value=a.defaultValue||""}}if(a.type==="group"){if(a.visible===undefined||a.value===null){a.visible=true}}a._settingspath="/form/items/"+i}};R.prototype._applyDesigntimeLayers=function(e){if(this._appliedLayerManifestChanges&&Array.isArray(this._appliedLayerManifestChanges)){for(var t=0;t<this._appliedLayerManifestChanges.length;t++){var i=this._appliedLayerManifestChanges[t][":designtime"];if(i){var a=Object.keys(i);for(var s=0;s<a.length;s++){this._settingsModel.setProperty(a[s],i[a[s]])}}}}if(this._currentLayerManifestChanges){var i=this._currentLayerManifestChanges[":designtime"];if(i){var a=Object.keys(i);for(var s=0;s<a.length;s++){var n=a[s],r=n.substring(0,n.lastIndexOf("/")+1)+"_next";if(!this._settingsModel.getProperty(r)){this._settingsModel.setProperty(r,{})}var r=n.substring(0,n.lastIndexOf("/")+1)+"_next",o=n.substring(n.lastIndexOf("/")+1);this._settingsModel.setProperty(r+"/"+o,i[a[s]])}}}};R.prototype._createParameterDesigntime=function(e){var t={},i="/sap.card/configuration/parameters/",a=this.getMode();if(e&&e.parameters){t.form=t.form||{};t.form.items=t.form.items||{};var n=t.form.items;Object.keys(e.parameters).forEach(function(t){n[t]=s({manifestpath:i+t+"/value",editable:a!=="translation",_settingspath:"/form/items/"+t},e.parameters[t]);var r=n[t];if(!r.type){r.type="string"}if(!r.hasOwnProperty("visible")){r.visible=true}})}return new r(t)};R.prototype._addDestinationSettings=function(e){var t=this._oDesigntimeInstance.getSettings(),i="/sap.card/configuration/destinations/";t.form=t.form||{};t.form.items=t.form.items||{};if(t&&e&&e.destinations){if(!t.form.items["destination.group"]){t.form.items["destination.group"]={label:L.getText("CARDEDITOR_DESTINATIONS")||"Destinations",type:"group",visible:true}}var a=t.form.items,n=this._oEditorCard.getHostInstance();Object.keys(e.destinations).forEach(function(t){a[t+".destinaton"]=s({manifestpath:i+t+"/name",visible:true,type:"destination",editable:true,allowDynamicValues:false,allowSettings:false,value:e.destinations[t].name,defaultValue:e.destinations[t].defaultUrl,_settingspath:"/form/items/"+[t+".destinaton"],_values:[],_destinationName:t},e.destinations[t]);if(typeof a[t+".destinaton"].label==="undefined"){a[t+".destinaton"].label=t}if(n){a[t+".destinaton"]._loading=true}});var r=false;if(n){this._oEditorCard.getHostInstance().getDestinations().then(function(t){r=true;Object.keys(e.destinations).forEach(function(e){a[e+".destinaton"]._values=t;a[e+".destinaton"]._loading=false;this._settingsModel.checkUpdate(true)}.bind(this))}.bind(this)).catch(function(){return this._oEditorCard.getHostInstance().getDestinations()}.bind(this)).then(function(t){if(r){return}Object.keys(e.destinations).forEach(function(e){a[e+".destinaton"]._values=t;a[e+".destinaton"]._loading=false;this._settingsModel.checkUpdate(true)}.bind(this))}.bind(this)).catch(function(t){Object.keys(e.destinations).forEach(function(e){a[e+".destinaton"]._loading=false;this._settingsModel.checkUpdate(true)}.bind(this));v.error("Can not get destinations list from '"+n.getId()+"'.")}.bind(this))}}};R.prototype._getManifestDefaultValue=function(e){return this._originalManifestModel.getProperty(e)};R.prototype._isValueWithHandlebarsTranslation=function(e){if(typeof e==="string"){return!!e.match(O)}return false};R._contextEntries={empty:{label:L.getText("CARDEDITOR_CONTEXT_EMPTY_VAL"),type:"string",description:L.getText("CARDEDITOR_CONTEXT_EMPTY_DESC"),placeholder:"",value:""},"card.internal":{label:L.getText("CARDEDITOR_CONTEXT_CARD_INTERNAL_VAL"),todayIso:{type:"string",label:L.getText("CARDEDITOR_CONTEXT_CARD_TODAY_VAL"),description:L.getText("CARDEDITOR_CONTEXT_CARD_TODAY_DESC"),tags:[],placeholder:L.getText("CARDEDITOR_CONTEXT_CARD_TODAY_VAL"),customize:["format.dataTime"],value:"{{parameters.TODAY_ISO}}"},nowIso:{type:"string",label:L.getText("CARDEDITOR_CONTEXT_CARD_NOW_VAL"),description:L.getText("CARDEDITOR_CONTEXT_CARD_NOW_DESC"),tags:[],placeholder:L.getText("CARDEDITOR_CONTEXT_CARD_NOW_VAL"),customize:["dateFormatters"],value:"{{parameters.NOW_ISO}}"},currentLanguage:{type:"string",label:L.getText("CARDEDITOR_CONTEXT_CARD_LANG_VAL"),description:L.getText("CARDEDITOR_CONTEXT_CARD_LANG_VAL"),tags:["technical"],customize:["languageFormatters"],placeholder:L.getText("CARDEDITOR_CONTEXT_CARD_LANG_VAL"),value:"{{parameters.LOCALE}}"}}};R._languages={};R._appendThemeVars=function(){var e=document.getElementById("sap-ui-integration-editor-style");if(e&&e.parentNode){e.parentNode.removeChild(e)}var t=["sapUiButtonHoverBackground","sapUiBaseBG","sapUiContentLabelColor","sapUiTileSeparatorColor","sapUiHighlight","sapUiListSelectionBackgroundColor","sapUiNegativeText","sapUiCriticalText","sapUiPositiveText","sapUiChartScrollbarBorderColor"],i=document.createElement("style");i.setAttribute("id","sap-ui-integration-editor-style");for(var a=0;a<t.length;a++){t[a]="--"+t[a]+":"+T.get(t[a])}i.innerHTML=".sapUiIntegrationCardEditor, .sapUiIntegrationFieldSettings, .sapUiIntegrationIconSelectList {"+t.join(";")+"}";document.body.appendChild(i)};R.init=function(){this.init=function(){};R._appendThemeVars();i.attachThemeChanged(function(){R._appendThemeVars()});var e=sap.ui.require.toUrl("sap.ui.integration.designtime.editor.css.CardEditor".replace(/\./g,"/")+".css");M(e);D.loadResource("sap/ui/integration/designtime/editor/languages.json",{dataType:"json",failOnError:false,async:true}).then(function(e){R._languages=e})};R.init();return R});