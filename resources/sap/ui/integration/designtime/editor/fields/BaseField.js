/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/m/Button","sap/m/MultiInput","./Settings","sap/m/Token","sap/ui/core/Core"],function(t,e,i,n,s,a){"use strict";var o=a.getLibraryResourceBundle("sap.ui.integration"),r="sap/ui/integration/designtime/editor/fields/viz";var l=t.extend("sap.ui.integration.designtime.editor.fields.Base",{metadata:{properties:{configuration:{type:"object"},specialButton:{type:"object"},mode:{type:"string"},host:{type:"object"},visible:{type:"boolean",defaultValue:true}},aggregations:{_field:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_settingsButton:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_dynamicField:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},events:{afterInit:{}}},renderer:function(t,e){var i=e.getAggregation("_field"),n=e.getAggregation("_settingsButton"),s=e._getDynamicField();t.openStart("div");t.addClass("sapUiIntegrationCardEditorItemField");if(i&&i.getWidth&&!n){}if(!e.getVisible()){t.addStyle("display","none")}t.writeClasses();t.writeStyles();t.writeElementData(e);t.openEnd();if(e.getVisible()){t.openStart("span");t.writeClasses();t.openEnd();t.openStart("span");t.addClass("sapUiIntegrationCardEditorEditor");if(e._hasDynamicValue()){t.addStyle("width","1px");t.addStyle("opacity","0")}t.writeStyles();t.writeClasses();t.openEnd();t.renderControl(i);t.close("span");t.close("span");if(n||e._hasDynamicValue()){t.openStart("span");t.addClass("sapUiIntegrationCardEditorSettings");t.writeClasses();t.openEnd();t.openStart("span");t.addClass("sapUiIntegrationCardEditorSettingsField");if(e._hasDynamicValue()){t.addStyle("width","calc(100% - 2.5rem)");t.addStyle("opacity","1")}t.writeClasses();t.writeStyles();t.openEnd();t.renderControl(s);t.close("span");t.openStart("span");t.addClass("sapUiIntegrationCardEditorSettingsButton");t.writeClasses();t.openEnd();t.renderControl(n);t.close("span");t.close("span")}}t.close("div")}});l.prototype.init=function(){this._readyPromise=new Promise(function(t){this._fieldResolver=t}.bind(this))};l.prototype.setConfiguration=function(t,e){if(t!==this.getConfiguration()){this.setProperty("configuration",t,e);if(t){Promise.resolve().then(function(){this.initEditor(t)}.bind(this))}}return this};l.prototype.initEditor=function(e){var i;this.initVisualization&&this.initVisualization(e);if(this._visualization.editor){i=this._visualization.editor}else if(this._visualization.type){if(typeof this._visualization.type==="string"){if(this._visualization.type.indexOf("/")===-1){this._visualization.type=r+"/"+this._visualization.type;this._visualization.settings=this._visualization.settings||{value:"{currentSettings>value}",editable:"{currentSettings>editable}"}}sap.ui.require([this._visualization.type],function(t){this._visualization.type=t;this.initEditor(e)}.bind(this));return}i=new this._visualization.type(this._visualization.settings||{})}if(i instanceof t){this.setAggregation("_field",i)}var n=this.getMode();e.allowSettings=e.allowSettings||e.allowSettings!==false&&n==="admin";e.allowDynamicValues=e.allowDynamicValues||e.allowDynamicValues!==false;e._changeDynamicValues=e.visible&&e.editable&&(e.allowDynamicValues||e.allowSettings)&&n!=="translation";if(e._changeDynamicValues){this._addSettingsButton()}this._applySettings(e)};l.prototype.initVisualization=function(){};l.prototype._hasDynamicValue=function(){var t=this._getCurrentProperty("value");var e=typeof t==="string"&&(t.indexOf("{context>")===0||t.indexOf("{{parameters")===0);this._setCurrentProperty("_hasDynamicValue",e);return e};l.prototype._hasSettings=function(){var t=this.getConfiguration();if(t._next){t._hasSettings=t._next.editable===false||t._next.visible===false||t._next.allowDynamicValues===false}else{t._hasSettings=false}return t._hasSettings};l.prototype._getDynamicField=function(){var t=this.getAggregation("_dynamicField");if(!t){var t=new i({showValueHelp:false});this.setAggregation("_dynamicField",t)}return t};l.prototype._hideDynamicField=function(){var t=this._getDynamicField(),e=this.getAggregation("_field");if(t.getDomRef()){var i=t.getDomRef().parentNode.style;i.width="1px";i.opacity=0;i=e.getDomRef().parentNode.style;e.getDomRef().style.visibility="visible";i.width="calc(100% - 2.5rem)";i.opacity=1}};l.prototype._showDynamicField=function(){var t=this._getDynamicField(),e=this.getAggregation("_field");if(t.getDomRef()){var i=t.getDomRef().parentNode.style;i.width="calc(100% - 2.5rem)";i.opacity=1;i=e.getDomRef().parentNode.style;e.getDomRef().style.visibility="hidden";i.width="1px";i.opacity=0}};l.prototype._getSettingsPanel=function(){if(!this._oSettingsPanel){this._oSettingsPanel=new n}return this._oSettingsPanel};l.prototype._openSettingsDialog=function(t){var e=this._getSettingsPanel();window.setTimeout(function(){e.setConfiguration(this.getConfiguration());e.open(this.getAggregation("_settingsButton"),this.getAggregation("_settingsButton"),this.getParent().getAggregation("_preview"),this.getHost(),this,this._applySettings.bind(this),this._cancelSettings.bind(this))}.bind(this),t||600)};l.prototype._addSettingsButton=function(){this._getDynamicField();this.setAggregation("_settingsButton",new e({icon:"{= ${currentSettings>_hasDynamicValue} ? 'sap-icon://display-more' : 'sap-icon://enter-more'}",type:"Transparent",tooltip:o.getText("CARDEDITOR_FIELD_MORE_SETTINGS"),press:function(){this._openSettingsDialog(200)}.bind(this)}))};l.prototype._setCurrentProperty=function(t,e){if(this._getCurrentProperty(t)!==e){this.getModel("currentSettings").setProperty(t,e,this.getBindingContext("currentSettings"))}};l.prototype._getCurrentProperty=function(t){return this.getModel("currentSettings").getProperty(t,this.getBindingContext("currentSettings"))};l.prototype._applySettings=function(t){var e=this._getDynamicField(),i=this.getModel("contextflat")._getValueObject(t.value);e.removeAllTokens();if(!this._getCurrentProperty("_changeDynamicValues")){e.setEnabled(false)}if(i&&i.path!=="empty"){if(i.object.value&&i.object.value.indexOf("{{")==0){this._setCurrentProperty("value",i.object.value)}else{this._setCurrentProperty("value",i.value)}e.addToken(new s({text:i.object.label,delete:function(){this._setCurrentProperty("value","");if(!this._hasDynamicValue()){this._hideDynamicField()}this._applyButtonStyles();window.setTimeout(function(){this.getAggregation("_field").focus()}.bind(this),100)}.bind(this)}))}else{this._setCurrentProperty("value",t.value);this._setCurrentProperty("_changed",t._changed);this._hideDynamicField()}this._setCurrentProperty("_next",t._next);this._applyButtonStyles();if(!this._hasDynamicValue()){this._hideDynamicField()}else{this._showDynamicField()}this._fieldResolver&&this._fieldResolver();this._fieldResolver=null};l.prototype._cancelSettings=function(){this._applyButtonStyles();if(!this._hasDynamicValue()){this._hideDynamicField()}};l.prototype._applyButtonStyles=function(){if(!this._hasDynamicValue()){this.removeStyleClass("dynamicvalue")}else{this.addStyleClass("dynamicvalue")}if(!this._hasSettings()){this.removeStyleClass("settings")}else{this.addStyleClass("settings")}};return l});