/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/designtime/editor/fields/BaseField","sap/m/Input","sap/m/Text","sap/m/MultiComboBox","sap/ui/core/ListItem","sap/base/util/each","sap/base/util/restricted/_debounce","sap/base/util/ObjectPath","sap/base/util/includes","sap/ui/core/SeparatorItem","sap/ui/core/Core","sap/ui/model/Sorter"],function(e,t,r,i,a,s,n,o,u,l,g,h){"use strict";var c="/";var v=g.getLibraryResourceBundle("sap.ui.integration");var d=e.extend("sap.ui.integration.designtime.editor.fields.ListField",{renderer:e.getMetadata().getRenderer()});d.prototype.initVisualization=function(e){var a=this;var s=e.visualization;if(!s){if(e.editable){if(e.values){var n=this.formatListItem(e.values.item);s={type:i,settings:{selectedKeys:{path:"currentSettings>value"},editable:{path:"currentSettings>editable"},showSecondaryValues:true,width:"100%",items:{path:"",template:n,sorter:[new h({path:"Selected",descending:false,group:true})],groupHeaderFactory:a.getGroupHeader}}};if(this.isFilterBackend(e)){s.settings.selectedKeys={parts:["currentSettings>value","currentSettings>suggestValue"],formatter:function(e,t){if(t){a.setSuggestValue()}return e}}}}else{s={type:t,settings:{value:{path:"currentSettings>value",formatter:function(e){e=e||[];return e.join(",")}},change:function(e){var t=e.getSource();t.getBinding("value").setRawValue(t.getValue().split(","))},editable:e.editable,placeholder:e.placeholder}}}}else{s={type:r,settings:{text:{path:"currentSettings>value"},wrapping:false}}}}this._visualization=s;this.attachAfterInit(this._afterInit)};d.prototype._afterInit=function(){var e=this.getAggregation("_field");if(e instanceof i){var t=this.getConfiguration();this.prepareFieldsInKey(t);if(this.isFilterBackend(t)){this.onInput=n(this.onInput,500);e.oninput=this.onInput;e.attachSelectionChange(this.onSelectionChangeForFilterBackend);e.attachSelectionFinish(this.onSelectionFinish);var r=this.getModel();r.attachPropertyChange(this.mergeSelectedItems,this)}else{e.attachSelectionChange(this.onSelectionChange)}}};d.prototype.prepareFieldsInKey=function(e){this._sKeySeparator=e.values.keySeparator;if(!this._sKeySeparator){this._sKeySeparator=c}var t=e.values.item.key;this._aFields=t.split(this._sKeySeparator);for(var r in this._aFields){if(this._aFields[r].startsWith("{")){this._aFields[r]=this._aFields[r].substring(1)}if(this._aFields[r].endsWith("}")){this._aFields[r]=this._aFields[r].substring(0,this._aFields[r].length-1)}}};d.prototype.getKeyFromItem=function(e){var t="";this._aFields.forEach(function(r){t+=e[r].toString()+this._sKeySeparator}.bind(this));if(t.endsWith(this._sKeySeparator)){t=t.substring(0,t.length-this._sKeySeparator.length)}return t};d.prototype.mergeSelectedItems=function(e){var t=this.getConfiguration();if(!t.valueItems){t.valueItems=[]}var r=t.values.data.path||"/";var i=this.getModel();var a=i.getData();if(r!=="/"){if(r.startsWith("/")){r=r.substring(1)}if(r.endsWith("/")){r=r.substring(0,r.length-1)}var s=r.split("/");var n=o.get(s,a);if(Array.isArray(n)){var l=t.valueItems.map(function(e){return this.getKeyFromItem(e)}.bind(this));var g=n.filter(function(e){var t=this.getKeyFromItem(e);return!u(l,t)}.bind(this));var h=g.filter(function(e){return e.Selected===v.getText("CARDEDITOR_ITEM_SELECTED")});t.valueItems=t.valueItems.concat(h);var c=g.filter(function(e){return e.Selected!==v.getText("CARDEDITOR_ITEM_SELECTED")});n=t.valueItems.concat(c)}else{n=t.valueItems}o.set(s,n,a)}else if(Array.isArray(a)){var l=t.valueItems.map(function(e){return this.getKeyFromItem(e)}.bind(this));var g=a.filter(function(e){var t=this.getKeyFromItem(e);return!u(l,t)}.bind(this));var h=g.filter(function(e){return e.Selected===v.getText("CARDEDITOR_ITEM_SELECTED")});t.valueItems=t.valueItems.concat(h);var c=g.filter(function(e){return e.Selected!==v.getText("CARDEDITOR_ITEM_SELECTED")});a=t.valueItems.concat(c)}else{a=t.valueItems}i.setData(a);this.setSuggestValue()};d.prototype.setSuggestValue=function(){var e=this.getAggregation("_field");var t=this.getBindingContext("currentSettings").sPath;var r=this.getModel("currentSettings");var i=r.getProperty(t+"/suggestValue");if(i&&i!==""){e.setValue(i)}};d.prototype.getGroupHeader=function(e){return new l({text:e.key})};d.prototype.onSelectionChangeForFilterBackend=function(e){var t=e.oSource.getParent();var r=t.getConfiguration();var i=e.getParameter("changedItem");var a=i.getKey();var s=e.getParameter("selected");if(!s){if(r.valueItems){r.valueItems=r.valueItems.filter(function(e){var r=t.getKeyFromItem(e);return r!==a})}}else{var n=this.getModel().getData();var u=r.values.data.path||"/";if(u!=="/"){if(u.startsWith("/")){u=u.substring(1)}if(u.endsWith("/")){u=u.substring(0,u.length-1)}var l=u.split("/");n=o.get(l,n)}if(n){if(!r.valueItems){r.valueItems=[]}n.some(function(e){var i=t.getKeyFromItem(e);if(i===a){e.Selected=v.getText("CARDEDITOR_ITEM_SELECTED");r.valueItems=r.valueItems.concat([e]);return true}return false})}}var g=r.valueItems.map(function(e){return t.getKeyFromItem(e)});var h=this.getBindingContext("currentSettings").sPath;var c=this.getModel("currentSettings");c.setProperty(h+"/value",g)};d.prototype.onSelectionChange=function(e){var t=e.oSource.getParent();var r=t.getConfiguration();var i=e.getParameter("changedItem");var a=i.getKey();var s=e.getParameter("selected");var n=this.getModel().getData();var u=r.values.data.path||"/";if(u!=="/"){if(u.startsWith("/")){u=u.substring(1)}if(u.endsWith("/")){u=u.substring(0,u.length-1)}var l=u.split("/");var g=o.get(l,n);if(Array.isArray(g)){for(var h in g){var c=t.getKeyFromItem(g[h]);if(c===a){if(s){g[h].Selected=v.getText("CARDEDITOR_ITEM_SELECTED")}else{g[h].Selected=v.getText("CARDEDITOR_ITEM_UNSELECTED")}}}o.set(l,g,n)}}else if(Array.isArray(n)){for(var h in n){var c=t.getKeyFromItem(n[h]);if(c===a){if(s){n[h].Selected=v.getText("CARDEDITOR_ITEM_SELECTED")}else{n[h].Selected=v.getText("CARDEDITOR_ITEM_UNSELECTED")}}}}this.getModel().setData(n);this.getModel().checkUpdate(true)};d.prototype.onSelectionFinish=function(e){var t=this.getParent();var r=t.getConfiguration();var i=e.getParameter("selectedItems").map(function(e){return e.getKey()});var a=this.getModel().getData();var s=r.values.data.path||"/";if(s!=="/"){if(s.startsWith("/")){s=s.substring(1)}if(s.endsWith("/")){s=s.substring(0,s.length-1)}var n=s.split("/");a=o.get(n,a)}if(a){r.valueItems=a.filter(function(e){var r=t.getKeyFromItem(e);return u(i,r)})}var l=this.getBindingContext("currentSettings").sPath;var g=this.getModel("currentSettings");g.setProperty(l+"/value",i);g.setProperty(l+"/suggestValue","")};d.prototype.onInput=function(e){var t=e.target.value;var r=this.getBindingContext("currentSettings").sPath;var i=this.getModel("currentSettings");i.setProperty(r+"/suggestValue",t);i.setProperty(r+"/_loading",true);var a=i.getBindings();var n=r.substring(r.lastIndexOf("/")+1);s(a,function(e,t){if(t.sPath==="/form/items/"+n+"/value"){t.checkUpdate(true)}});e.srcControl.open();e.srcControl._getSuggestionsPopover()._sTypedInValue=t};return d});