/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/m/ResponsivePopover","sap/ui/model/json/JSONModel","sap/m/Button","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/m/VBox","sap/m/HBox","sap/m/Select","sap/ui/core/ListItem","sap/m/Label","sap/m/Text","sap/m/Title","sap/m/CheckBox","sap/m/Menu","sap/m/MenuItem","sap/m/Input","sap/ui/integration/util/ParameterMap","sap/base/util/merge","sap/ui/core/Core"],function(e,t,a,n,s,i,r,l,o,d,u,c,m,p,f,g,y,_,h,S){"use strict";var v=e.extend("sap.ui.integration.designtime.editor.fields.Settings",{metadata:{},renderer:function(){}});v.prototype.setConfiguration=function(e){this._originalConfig=e;e=h({},e);var t=new a(e);this.setModel(t,"currentSettings");this.bindElement({path:"currentSettings>/"})};v.prototype.open=function(e,t,a,n,s,i,r){this.addDependent(A);this.oHost=n;this.fnApply=i;this.fnCancel=r;this._oOpener=s;T=true;e.addDependent(this);w=this;this.getModel("currentSettings").checkUpdate(true,true);K(b.getText("CARDEDITOR_SELECT_FROM_LIST"),[]);if(t){A.setContentWidth(a.getDomRef().offsetWidth+30+"px");A.setContentHeight(a.getDomRef().offsetHeight-80+"px");A.setPlacement("Right");R.setValue(e._label);A.openBy(e)}else{A.open()}x=this.getModel("currentSettings");if(x.getProperty("/_hasDynamicValue")){N()}else if(x.getProperty("/_hasSettings")){O()}else if(x.getProperty("/allowDynamicValues")){N()}else if(x.getProperty("/allowSettings")){O()}};var b=S.getLibraryResourceBundle("sap.ui.integration"),x,T,w=null,D,C,I,R,E,M,P,V;v.prototype._applyCurrentSettings=function(){this.fnApply(x.getData())};v.prototype._cancelCurrentSettings=function(){this.fnCancel(this._originalConfig)};v.prototype.destroy=function(){this.removeDependent(A);return e.prototype.destroy.apply(this,arguments)};var A=new t({showArrow:true,contentWidth:"400px",showHeader:false,horizontalScrolling:false,modal:false,endButton:new n({text:b.getText("CARDEDITOR_MORE_CANCEL"),press:function(){A.close()}}),beginButton:new n({text:b.getText("CARDEDITOR_MORE_OK"),type:"Emphasized",press:function(){w._applyCurrentSettings();T=false;A.close()}}),afterClose:function(){if(T){w._cancelCurrentSettings()}T=true}});A.attachAfterOpen(function(){var e=this.getDomRef().querySelector("footer"),t=k.getDomRef();if(t.nextSibling!==e){e.parentNode.insertBefore(t,e);e.style.marginTop="0rem";t.style.display="flex"}var a=G.getDomRef(),n=e.querySelector("button").parentNode;if(a){n.insertBefore(a,n.firstChild)}window.requestAnimationFrame(function(){A.getDomRef()&&(A.getDomRef().style.opacity="1")})});function O(){C.setVisible(true);D.setVisible(false);$.setSelectedKey("settings");var e=k.getDomRef();window.requestAnimationFrame(function(){e&&(e.style.opacity="0")})}function N(){C.setVisible(false);D.setVisible(true);$.setSelectedKey("dynamic");var e=w.getModel("contextflat"),t=e._getValueObject(x.getProperty("/value"));if(t&&t.object.label){R.setValue(t.object.label);K(t.object.description,t.object.tags);if(t.path==="empty"){R.setValue(t.object.label)}Q(t)}var a=k.getDomRef();window.requestAnimationFrame(function(){a&&(a.style.opacity="1")})}A.addStyleClass("sapUiIntegrationFieldSettings");var $=new s({width:"100%",visible:"{= ${currentSettings>allowDynamicValues} && ${currentSettings>allowSettings}}"});var j=new i({text:b.getText("CARDEDITOR_MORE_DYNAMICVALUES"),key:"dynamic",icon:"{= ${currentSettings>_hasDynamicValue} ? 'sap-icon://display-more' : 'sap-icon://enter-more'}",width:"50%",press:N});j.addStyleClass("dynbtn sel");var L=new i({text:b.getText("CARDEDITOR_MORE_SETTINGS"),key:"settings",icon:"sap-icon://action-settings",width:"50%",press:O});L.addStyleClass("setbtn");$.addItem(j);$.addItem(L);var B=new c({text:b.getText("CARDEDITOR_MORE_DYNAMICVALUES"),visible:"{= ${currentSettings>allowDynamicValues} && !${currentSettings>allowSettings}}"});B.addStyleClass("sapUiTinyMagin");var U=new c({text:b.getText("CARDEDITOR_MORE_SETTINGS"),visible:"{= !${currentSettings>allowDynamicValues} && ${currentSettings>allowSettings}}"});U.addStyleClass("sapUiTinyMagin");var H=new l({width:"100%",items:[$,B,U]});H.addStyleClass("headertitle");var k=new r({width:"100%",items:[new c({text:b.getText("CARDEDITOR_ACTUAL_VALUE")}),new y({value:{path:"currentSettings>_currentContextValue"},editable:false})]});k.addStyleClass("currentval");var G=new n({type:"Transparent",text:b.getText("CARDEDITOR_MORE_RESET"),enabled:"{= ${currentSettings>_next/visible} === false || ${currentSettings>_next/editable} === false || ${currentSettings>_next/allowDynamicValues} === false || ${currentSettings>_beforeValue} !== ${currentSettings>value}}",tooltip:b.getText("CARDEDITOR_MORE_SETTINGS_P_ADMIN_RESET"),press:function(){q("visible",true);q("editable",true);q("allowDynamicValues",true);if(x.getProperty("/translatable")){x.setProperty("/value",x.getProperty("/_translatedDefaultValue"));x.setProperty("/_changed",false)}else{x.setProperty("/value",x.getProperty("/_beforeValue"))}A.getBeginButton().firePress()}});G.addStyleClass("resetbutton");var F=new r({width:"100%",items:[H,k,G]});F.addStyleClass("tabs");A.setCustomHeader(F);function q(e,t){if(!x.getProperty("/_next")){x.setProperty("/_next",{})}x.setProperty("/_next/"+e,t)}function z(e,t){var a=[];for(var n in e){if(e[n]&&e[n].label){var s=new g({text:e[n].label});s.__data=e[n];e[n].pathvalue=(t+"/"+n).substring(1);a.push(s);var i=z(e[n],t+"/"+n);for(var r=0;r<i.length;r++){s.addItem(i[r])}}}return a}function W(){D=new r({visible:true});C=new r({visible:false});D.addStyleClass("sapUiSmallMargin");R=new y({width:"100%",showValueHelp:true,valueHelpOnly:true,valueHelpRequest:function(){if(E){E.destroy()}E=new f({});M=z(D.getModel("context").getData(),"");for(var e=0;e<M.length;e++){E.addItem(M[e])}E.attachItemSelected(function(e){var t=e.getParameter("item").__data;K(t.description||"",t.tags||[]);R.setValue(t.placeholder||t.label);var a=w.getModel("contextflat");Q(a._getPathObject(t.pathvalue))});R.addDependent(E);E.addStyleClass("sapUiIntegrationFieldSettingsMenu");E.openBy(R,false,null,null,"1 0")}});R.addStyleClass("selectvariable");var e=new r({items:[new u({text:"Select a dynamic value"}),R]});D.addItem(e);I=new c({text:"",maxLines:6,renderWhitespace:true});e=new r({width:"100%",items:[I]});I.addStyleClass("description");D.addItem(e);if(Y.length===-1){P=new o({width:"100%",enabled:true,change:function(){V.setText(P.getSelectedItem()._data.description)}});e=new r({visible:false,items:[new u({text:"Customize the value..."}),P]});D.addItem(e);V=new c({text:"",maxLines:4,renderWhitespace:true});V.addStyleClass("description");e=new r({width:"100%",items:[V]});D.addItem(e);D.getItems()[2].getItems()[0].addStyleClass("sapUiTinyMarginTop")}D.getItems()[0].getItems()[0].addStyleClass("sapUiTinyMarginTop");C.addStyleClass("sapUiSmallMargin");C.addItem(new l({items:[new m({text:b.getText("CARDEDITOR_MORE_SETTINGS_P_ADMIN")}),new n({type:"Transparent",tooltip:b.getText("CARDEDITOR_MORE_SETTINGS_P_ADMIN_RESET"),enabled:"{= ${currentSettings>_next/visible} === false || ${currentSettings>_next/editable} === false || ${currentSettings>_next/allowDynamicValues} === false}",icon:"sap-icon://reset",visible:false,press:function(){C.getItems()[1].getItems()[1].focus();q("visible",true);q("editable",true);q("allowDynamicValues",true)}})]}));C.addItem(new l({items:[new u({text:b.getText("CARDEDITOR_MORE_SETTINGS_P_ADMIN_VISIBLE")}),new p({selected:"{= ${currentSettings>_next/visible} !== false}",select:function(e){q("visible",e.getParameter("selected"))}})]}));C.addItem(new l({items:[new u({text:b.getText("CARDEDITOR_MORE_SETTINGS_P_ADMIN_EDIT")}),new p({selected:"{= ${currentSettings>_next/editable} !== false}",enabled:"{= ${currentSettings>_next/visible} !== false}",select:function(e){q("editable",e.getParameter("selected"))}})]}));C.addItem(new l({visible:"{= ${currentSettings>allowDynamicValues}!== false}",items:[new u({text:b.getText("CARDEDITOR_MORE_SETTINGS_P_ADMIN_DYN")}),new p({selected:"{= ${currentSettings>_next/allowDynamicValues} !== false}",enabled:"{= ${currentSettings>_next/visible} !== false && ${currentSettings>_next/editable} !== false}",select:function(e){q("allowDynamicValues",e.getParameter("selected"))}})]}));var t=C.getItems();t[0].addStyleClass("stitle");t[1].addStyleClass("cbrow");t[2].addStyleClass("cbrow");t[3].addStyleClass("cbrow");A.addContent(D);A.addContent(C)}var Y=[{formatMethod:"format.DateTime",sourceTypes:["datetime","date"],label:"Relative date/datetime text of the value",description:"Should be applied to dynamic values of type date or datetime or string values that represent a datetime in the format 'yyyy-MM-ddZhh:mm:ss'",example:"4 weeks ago",syntax:"handlebars",binding:"{= format.dateTime('__|VALUE|__',{relative:true})}"},{formatMethod:"format.DateTime",sourceTypes:["datetime","date"],label:"Short date/datetime text of the value",description:"Should be applied to dynamic values of type date, date-time or text values that represent a datetime in the format 'yyyy-MM-ddZhh:mm:ss.sss'",example:"9/18/20, 2:09 PM",binding:"{= format.dateTime('__|VALUE|__',{style:'short'})}"},{formatMethod:"format.DateTime",sourceTypes:["datetime","date"],label:"Medium date/datetime text of the value",description:"Should be applied to dynamic values of type date, date-time or text values that represent a datetime in the format 'yyyy-MM-ddThh:mm:ss.sssZ'",example:"Sep 18, 2020, 2:09:04 PM",binding:"{= format.dateTime('__|VALUE|__',{style:'medium'})}"},{formatMethod:"format.DateTime",sourceTypes:["datetime","date"],label:"Long date, date-time text of the value",description:"Should be applied to dynamic values of type date or date-time or string values that represent a datetime in the format 'yyyy-MM-ddThh:mm:ss.sssZ'",example:"Sep 18, 2020, 2:09:04 PM",binding:"{= format.dateTime('__|VALUE|__',{style:'long'})}"}];function Z(e,t){e=e||[];P.removeAllItems();var a=[];P.addItem(new d({text:"No customizing needed",key:""}));for(var n=0;n<Y.length;n++){var s=Y[n],i=new d({text:s.label,key:"key"+n});i._data=s;if(s.sourceTypes.indexOf(t)>-1||e.indexOf(s.formatMethod)>-1){P.addItem(i)}else{a.push(i)}}for(var n=0;n<a.length;n++){P.addItem(a[n])}}W();function K(e,t){t=t||[];if(t.indexOf("technical")>-1){e=e+"\n"+b.getText("CARDEDITOR_MORE_DYNAMICVALUES_TECHHINT")}I.setText(e)}function J(e){if(Y.length===-1){if(!e){P.removeAllItems();P.addItem(new d({text:"No customizing available for this value"}));V.setText("");P.setEnabled(false)}else{Z(e.customize,e.type);P.setEnabled(true)}}}function Q(e){if(e){x.setProperty("/_hasDynamicValue",true);var t=e.value;x.setProperty("/value",t);x.setProperty("/_contextpath",e.path);if(e.object&&e.object.value&&e.object.value.indexOf("{{")===0){x.setProperty("/_currentContextValue",_.processPredefinedParameter(e.object.value));J(e.object)}else{if(e.path==="empty"){x.setProperty("/value","");x.setProperty("/_currentContextValue","");x.setProperty("/_hasDynamicValue",false);J()}else{J(e.object);if(e.object&&e.object.hasOwnProperty("value")){x.setProperty("/_currentContextValue",e.object.value)}else{w.oHost.getContextValue(e.path+"/value").then(function(t){if(t===null){x.setProperty("/_currentContextValue","(not available)")}else{x.setProperty("/_currentContextValue",t)}e.object&&(e.object.value=t)})}}}}}v._private=function(){return{oPopover:A,oSegmentedButton:$,oSettingsButton:L,oDynamicPanel:D,oSettingsPanel:C,oCurrentModel:x,updateCurrentValue:Q,oCurrentInstance:w,oDynamicValueField:R,getMenuItems:function(){return M},getMenu:function(){return E}}};return v});