/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/designtime/editor/fields/BaseField","sap/m/Input","sap/m/Text","sap/m/Title","sap/m/Select","sap/m/ComboBox","sap/m/Popover","sap/m/Button","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/ui/core/ListItem","sap/m/List","sap/m/CustomListItem","sap/m/VBox","./viz/IconSelect","sap/base/util/each","sap/base/util/restricted/_debounce","sap/ui/core/Core","sap/ui/model/json/JSONModel","sap/ui/integration/designtime/editor/CardResourceBundles","sap/base/util/deepClone","sap/ui/model/Sorter","sap/ui/core/SeparatorItem","sap/base/util/includes","sap/base/util/merge","sap/ui/core/CustomData"],function(e,t,a,n,r,s,i,l,u,o,g,d,p,c,v,T,_,f,h,I,L,S,P,O,y,D){"use strict";var m=e.extend("sap.ui.integration.designtime.editor.fields.StringField",{renderer:e.getMetadata().getRenderer()});m.prototype.initVisualization=function(e){var n=e.visualization;if(!n){if(e.editable){if(e.enum){var i=new g({key:{path:"currentSettings>"},text:{path:"currentSettings>"}});n={type:r,settings:{selectedKey:{path:"currentSettings>value"},forceSelection:false,editable:e.editable,showSecondaryValues:false,width:"100%",items:{path:"currentSettings>enum",template:i}}}}else if(e.values){var i=this.formatListItem(e.values.item);if(!e.values.item.key){e.values.item.key=e.values.item.text}n={type:s,settings:{busy:{path:"currentSettings>_loading"},selectedKey:{path:"currentSettings>value"},editable:e.editable,showSecondaryValues:true,width:"100%",items:{path:"",template:i}}};if(this.isFilterBackend(e)){n.settings.selectedKey={parts:["currentSettings>value","currentSettings>suggestValue"],formatter:function(e,t){if((!e||e==="")&&t){return t.replaceAll("''","'")}else{return e}}}}}else{n={type:t,settings:{value:{path:"currentSettings>value"},tooltip:{path:"currentSettings>value"},editable:e.editable,placeholder:e.placeholder}}}}else if(this.getMode()==="translation"){n={type:a,settings:{text:{path:"currentSettings>value"},tooltip:{path:"currentSettings>value"},wrapping:false}}}else{n={type:t,settings:{value:{path:"currentSettings>value"},tooltip:{path:"currentSettings>value"},editable:false}}}}this._visualization=n;this.attachAfterInit(this._afterInit)};m.prototype._afterInit=function(){var e=this.getAggregation("_field");if(e instanceof s){var t=this.getConfiguration();if(this.isFilterBackend(t)){this.onInput=_(this.onInput,500);e.oninput=this.onInput;e.attachSelectionChange(this.onSelectionChange)}}};m.prototype.onSelectionChange=function(e){var t=e.getParameter("selectedItem")||{};var a=t.getKey();var n=this.getBindingContext("currentSettings").sPath;var r=this.getModel("currentSettings");r.setProperty(n+"/value",a)};m.prototype.onInput=function(e){var t=e.target.value;var a=this.getBindingContext("currentSettings").sPath;var n=this.getModel("currentSettings");n.setProperty(a+"/suggestValue",t.replaceAll("'","''"));n.setProperty(a+"/_loading",true);n.setProperty(a+"/value","");var r=n.getBindings();var s=a.substring(a.lastIndexOf("/")+1);T(r,function(e,t){if(t.sPath==="/form/items/"+s+"/value"){t.checkUpdate(true)}});var i=e.srcControl;i.open();i.setValue(t);i.setSelection(null)};m.prototype.getOriginTranslatedValues=function(e){var t=[];var a=I.getInstance(e._resourceBundleURL);for(var n in a){var r=a[n];var s;if(e._translatedDefaultPlaceholder.startsWith("{i18n>")&&e._translatedDefaultPlaceholder.endsWith("}")){s=e._translatedDefaultPlaceholder.substring(6,e._translatedDefaultPlaceholder.length-1)}else if(e._translatedDefaultPlaceholder.startsWith("{{")&&e._translatedDefaultPlaceholder.endsWith("}}")){s=e._translatedDefaultPlaceholder.substring(2,e._translatedDefaultPlaceholder.length-2)}var i="";var l="";if(s&&r){var u=r.resourceBundle.getText(s,[],true);if(u!==undefined){i=u;l=u}}else{i=e._translatedDefaultPlaceholder;l=e._translatedDefaultPlaceholder}var o={key:n,desription:r.language,value:i,originValue:l,editable:true};t.push(o)}return t};m.prototype.openTranslationListPopup=function(e){var r=this;var s=e.getSource();var g=s.getParent();var v=g.getConfiguration();if(!r._aOriginTranslatedValues){r._aOriginTranslatedValues=g.getOriginTranslatedValues(v)}var T=L(r._aOriginTranslatedValues);var _=f.getLibraryResourceBundle("sap.ui.integration");T.forEach(function(e){if(v.valueTranslations&&v.valueTranslations[e.key]){e.value=v.valueTranslations[e.key];if(!O(r._aUpdatedLanguages,e.key)){e.originValue=e.value}}e.status=_.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_NOTUPDATED");if(e.key===_.sLocale){e.editable=false}});var I={currentLanguage:{},isUpdated:false,translatedLanguages:[]};var P;if(T){T.forEach(function(e){if(O(r._aUpdatedLanguages,e.key)){e.value=v.valueTranslations[e.key];e.status=_.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_UPDATED")}if(e.key===_.sLocale){e.value=s.getValue();I.currentLanguage=e}else{I.translatedLanguages.push(e)}})}if(!r._oTranslationPopover){var m=new d({items:{path:"languages>/translatedLanguages",template:new p({content:[new c({items:[new a({text:"{languages>desription}"}),new t({value:"{languages>value}",editable:"{languages>editable}"})]})],customData:[new D({key:"{languages>key}",value:"{languages>desription}"})]}),sorter:[new S({path:"status",descending:true,group:true})],groupHeaderFactory:r.getGroupHeader}});r._oTranslationPopover=new i({placement:"Right",contentWidth:"300px",contentHeight:"345px",customHeader:new c({items:[new n({text:_.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_TITLE")}).addStyleClass("sapMPopoverTitle"),new n({text:_.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_CURRENTLANGUAGE")}).addStyleClass("sapMHeaderTitle"),new c({items:[new a({text:"{languages>/currentLanguage/desription}"}),new t({value:"{languages>/currentLanguage/value}",editable:false})]}).addStyleClass("sapMCurrentLanguageVBox"),new n({text:_.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_OTHERLANGUAGES")}).addStyleClass("sapMHeaderTitle")]}),content:m,footer:new u({content:[new o,new l({type:"Emphasized",text:_.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_BUTTON_SAVE"),enabled:"{languages>/isUpdated}",press:function(){var e=r._oTranslationPopover.getModel("languages").getData();var t=L(v.valueTranslations);var a={};var n=[];e.translatedLanguages.forEach(function(e){if(e.value!==e.originValue){a[e.key]=e.value;n.push(e.key)}});if(e.currentLanguage.value!=e.currentLanguage.originValue){a[e.currentLanguage.key]=e.currentLanguage.value;n.push(e.currentLanguage.key)}if(a!=={}){v.valueTranslations=y(t,a);v._changed=true}if(n.length>0){r._aUpdatedLanguages=n}r._oTranslationPopover.close()}}),new l({text:_.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_BUTTON_CANCEL"),press:function(){r._oTranslationPopover.close()}})]})}).addStyleClass("sapUiIntegrationFieldTranslation");P=new h(I);P.attachPropertyChange(function(e){var t=P.getData();var a=_.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_UPDATED");var n=_.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_NOTUPDATED");var r=false;t.translatedLanguages.forEach(function(e){if(e.value!==e.originValue){e.status=a;r=true}else{e.status=n}});t.isUpdated=r;P.setData(t);P.checkUpdate(true)});r._oTranslationPopover.setModel(P,"languages")}else{P=r._oTranslationPopover.getModel("languages");P.setData(I);P.checkUpdate(true)}r._oTranslationPopover.openBy(s)};m.prototype.getGroupHeader=function(e){return new P({text:e.key})};return m});