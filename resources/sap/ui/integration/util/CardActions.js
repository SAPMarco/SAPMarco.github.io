/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./BindingResolver","../library","sap/base/Log","sap/m/library","sap/ui/util/openWindow","sap/ui/base/ManagedObject"],function(e,t,n,r,i,a){"use strict";function o(e){if(e&&typeof e==="object"){return e.name}return e}var c=t.CardActionArea,s=t.CardActionType;var f=a.extend("sap.ui.integration.util.CardActions",{metadata:{library:"sap.ui.integration",properties:{card:{type:"object"}}}});f.prototype.attach=function(e){var t=e.control,n=e.area;e.actionControl=e.actionControl||e.control;e.enabledPropertyValue=e.enabledPropertyValue||true;e.disabledPropertyValue=e.disabledPropertyValue||false;if(!e.actions){this._fireActionReady(t,n);return}var r=e.actions[0];if(r&&r.type){e.action=r;this._attachAction(e)}else{this._fireActionReady(t,n)}};f.prototype._attachAction=function(e){var t=e.action,n=e.area,r=e.control,i=e.actionControl,a=e.enabledPropertyName,o=e.enabledPropertyValue,c=e.disabledPropertyValue,s=true,f=this._isSingleAction(n),u=true;if(a){s=false;if(t.service&&!f){this._setControlEnabledStateUsingService(t,r,i,a,o,c)}else{this._setControlEnabledState(t,i,a,o,c)}}if(t.service&&f){this._getSingleActionEnabledState(t,r).then(function(e){if(e){this._attachPressEvent(i,t,r)}this._fireActionReady(r,n)}.bind(this));return}if(s){u=t.enabled!==false&&t.enabled!=="false"}if(u){this._attachPressEvent(i,t,r)}this._fireActionReady(r,n)};f.prototype._setControlEnabledStateUsingService=function(t,n,r,i,c,s){var f=a.bindingParser("{path:''}");f.formatter=function(r){var i=this.getBindingContext(),a,f;if(i){a=i.getPath()}f=e.resolveValue(t.parameters,n,a);if(r.__resolved){if(!r.__enabled||r.__enabled==="false"){return s}return c}if(!r.__promise){r.__promise=true;n._oServiceManager.getService(o(t.service)).then(function(e){if(e){e.enabled({parameters:f}).then(function(e){r.__resolved=true;r.__enabled=e;n.getModel().checkUpdate(true)}).catch(function(){r.__resolved=true;r.__enabled=false})}else{r.__resolved=true;r.__enabled=false}})}return s};r.bindProperty(i,f)};f.prototype._setControlEnabledState=function(e,t,n,r,i){var a,o;if(typeof e.enabled==="object"){a=e.enabled;a.formatter=function(e){if(!e||e==="false"){return i}return r}}if(a){t.bindProperty(n,a)}else{o=e.enabled===false||e.enabled==="false"?i:r;t.setProperty(n,o)}};f.prototype._getSingleActionEnabledState=function(t,n){var r=n.getBindingContext(),i,a;if(r){a=r.getPath()}i=e.resolveValue(t.parameters,n,a);return new Promise(function(e){n._oServiceManager.getService(o(t.service)).then(function(t){if(t){t.enabled({parameters:i}).then(function(t){e(t)}).catch(function(){e(false)})}else{e(false)}}).catch(function(){e(false)})})};f.prototype._fireActionReady=function(e,t){var n=t===c.Header;var r=n?"_actionHeaderReady":"_actionContentReady";e.fireEvent(r)};f.prototype._handleServiceAction=function(t,r,i){var a=t.getBindingContext(),c;if(a){c=a.getPath()}i._oServiceManager.getService(o(r.service)).then(function(n){if(n){n.navigate({parameters:e.resolveValue(r.parameters,t,c)})}}).catch(function(e){n.error("Navigation service unavailable",e)}).finally(function(){this._processAction(t,r,c)}.bind(this))};f.prototype._handleAction=function(e,t){var n=e.getBindingContext(),r;if(n){r=n.getPath()}this._processAction(e,t,r)};f.prototype._attachPressEvent=function(e,t,n){e.attachPress(function(e){var r=e.getSource();if(t.service){this._handleServiceAction(r,t,n)}else{this._handleAction(r,t)}}.bind(this))};f.prototype._processAction=function(t,n,r){var i=this._getHostInstance(),a=this.getCard(),o=n.url;if(o){o=e.resolveValue(o,t,r)}f.fireAction({card:a,host:i,action:n,parameters:e.resolveValue(n.parameters,t,r),source:t,url:o})};f.prototype._getHostInstance=function(){var e=this.getCard();if(e){return e.getHostInstance()}return null};f.prototype.fireAction=function(e,t,n){var r=this._getHostInstance(),i=this.getCard(),a=this._extractActionConfigurations(i,n),o={card:i,host:r,action:{type:t},parameters:a,source:e};f.fireAction(o)};f.fireAction=function(e){var t=e.host,n=e.card,r=n.getAggregation("_extension"),i=e.action,a=e.parameters||{},o={type:i.type,card:n,actionSource:e.source,parameters:a},c=Object.assign({},o,{manifestParameters:a}),s=n.fireAction(c);if(!s){return false}if(t){s=t.fireAction(o)}if(!s){return false}if(r){s=r.fireAction(o)}if(s){f._doPredefinedAction(e)}return s};f._doPredefinedAction=function(e){var t=e.action,n=e.parameters,r=t.type,i,a,o,c;if(n){o=n.url;c=n.target}switch(r){case s.Navigation:if(t.service){break}i=e.url||o;a=t.target||c||"_blank";if(i){f.openUrl(i,a)}break;case s.Custom:if(typeof t.action==="function"){t.action(e.card,e.source)}break;case s.Submit:if(e.source&&e.source.isA("sap.ui.integration.cards.BaseContent")){f.handleSubmitAction(e)}break;default:break}};f.openUrl=function(e,t){i(e,t)};f.handleSubmitAction=function(e){var t,r=e.card,i=r._oDataProviderFactory,a=e.source,o=e.parameters;if(!o.configuration){return}a.onActionSubmitStart(o);t=i.create({request:o.configuration});t.getData().then(function(e){a.onActionSubmitEnd(e,null)},function(e){n.error(e);a.onActionSubmitEnd(null,{error:e})}).finally(function(){i.remove(t)})};f.prototype._extractActionConfigurations=function(e,t){var n=e&&e.getManifestEntry("/sap.card/configuration/actionHandlers/submit"),r=t.data||{};if(!n){return t}return{data:r,configuration:{mode:n.mode||"cors",url:n.url,method:n.method||"POST",parameters:Object.assign({},r,n.parameters),headers:n.headers,xhrFields:{withCredentials:!!n.withCredentials}}}};f.prototype._isSingleAction=function(e){return[c.Header,c.Content,c.ContentItemDetail].indexOf(e)>-1};return f});