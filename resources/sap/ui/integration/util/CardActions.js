/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./BindingResolver","../library","sap/base/Log","sap/m/library","sap/ui/base/ManagedObject"],function(e,t,n,r,a){"use strict";function i(e){if(e&&typeof e==="object"){return e.name}return e}var o=t.AreaType,s=t.CardActionType,c=r.ListType;var f=a.extend("sap.ui.integration.util.CardActions",{metadata:{library:"sap.ui.integration",properties:{card:{type:"object"},areaType:{type:"sap.ui.integration.AreaType",defaultValue:o.None}}}});f.prototype.exit=function(){this._oAreaControl=null};f.prototype.attach=function(e,t){this._oAreaControl=t;if(!e.actions){this._fireActionReady();return}var n=e.actions[0];if(n&&n.type){this._attachAction(e,n)}else{this._fireActionReady()}};f.prototype._setItemTemplateTypeFormatter=function(t){var n=this,r=n._oAreaControl,o=r._oItemTemplate;var s=a.bindingParser("{path:''}");s.formatter=function(n){var a=this.getBindingContext(),o,s;if(a){o=a.getPath()}s=e.resolveValue(t.parameters,r,o);if(n.__resolved){if(!n.__enabled||n.__enabled==="false"){return c.Inactive}return c.Navigation}if(!n.__promise){n.__promise=true;r._oServiceManager.getService(i(t.service)).then(function(e){if(e){e.enabled({parameters:s}).then(function(e){n.__resolved=true;n.__enabled=e;r.getModel().checkUpdate(true)}).catch(function(){n.__resolved=true;n.__enabled=false})}else{n.__resolved=true;n.__enabled=false}})}return c.Inactive};o.bindProperty("type",s)};f.prototype._setSingleActionEnabledState=function(t,n){var r=this._oAreaControl,a=r.getBindingContext(),o,s;if(a){s=a.getPath()}o=e.resolveValue(n.parameters,r,s);return new Promise(function(e){r._oServiceManager.getService(i(n.service)).then(function(t){if(t){t.enabled({parameters:o}).then(function(t){e(t)}).catch(function(){e(false)})}else{e(false)}}).catch(function(){e(false)})})};f.prototype._setItemTemplateEnabledState=function(e){var t,n,r=this._oAreaControl._oItemTemplate;if(typeof e.enabled==="object"){t=e.enabled;t.formatter=function(e){if(!e||e==="false"){return c.Inactive}return c.Navigation}}if(t){r.bindProperty("type",t)}else{n=e.enabled===false||e.enabled==="false"?c.Inactive:c.Navigation;r.setProperty("type",n)}};f.prototype._fireActionReady=function(){var e=this.getAreaType()===o.Header;var t=e?"_actionHeaderReady":"_actionContentReady";this._oAreaControl.fireEvent(t)};f.prototype._handleServiceAction=function(t,r){var a=t.getBindingContext(),o;if(a){o=a.getPath()}this._oAreaControl._oServiceManager.getService(i(r.service)).then(function(n){if(n){n.navigate({parameters:e.resolveValue(r.parameters,t,o)})}}).catch(function(e){n.error("Navigation service unavailable",e)}).finally(function(){this._processAction(t,r,o)}.bind(this))};f.prototype._handleAction=function(e,t){var n=e.getBindingContext(),r;if(n){r=n.getPath()}this._processAction(e,t,r)};f.prototype._attachPressEvent=function(e,t,n){e.attachPress(function(e){var n=e.getSource();if(t.service){this._handleServiceAction(n,t)}else{this._handleAction(n,t)}}.bind(this))};f.prototype._attachAction=function(e,t){var n=this.getAreaType()===o.ContentItem?this._oAreaControl._oItemTemplate:this._oAreaControl,r=true,a=this.getAreaType(),i=a===o.Header||a===o.Content,s=a===o.ContentItem,c=true;if(t.service){if(this.getAreaType()===o.ContentItem){this._setItemTemplateTypeFormatter(t)}r=false}else if(s){this._setItemTemplateEnabledState(t);r=false}if(i&&t.service){this._setSingleActionEnabledState(e,t).then(function(e){if(e){this._attachPressEvent(n,t,i)}this._fireActionReady()}.bind(this))}else{if(r){c=t.enabled!==false&&t.enabled!=="false"}if(c){this._attachPressEvent(n,t,i)}this._fireActionReady()}};f.prototype._processAction=function(t,n,r){var a=this._getHostInstance(),i=this.getCard(),o=n.url;if(o){o=e.resolveValue(o,t,r)}f.fireAction({card:i,host:a,action:n,parameters:e.resolveValue(n.parameters,t,r),source:t,url:o})};f.prototype._getHostInstance=function(){var e=this.getCard();if(e){return e.getHostInstance()}return null};f.prototype.fireAction=function(e,t,n){var r=this._getHostInstance(),a=this.getCard(),i=this._extractActionConfigurations(a,n),o={card:a,host:r,action:{type:t},parameters:i,source:e};f.fireAction(o)};f.fireAction=function(e){var t=e.host,n=e.card,r=n.getAggregation("_extension"),a=e.action,i=e.parameters||{},o={type:a.type,card:n,actionSource:e.source,parameters:i},s=Object.assign({},o,{manifestParameters:i}),c=n.fireAction(s);if(!c){return false}if(t){c=t.fireAction(o)}if(!c){return false}if(r){c=r.fireAction(o)}if(c){f._doPredefinedAction(e)}return c};f._doPredefinedAction=function(e){var t=e.action,n=e.parameters,r=t.type,a,i,o,c;if(n){o=n.url;c=n.target}switch(r){case s.Navigation:if(t.service){break}a=e.url||o;i=t.target||c||"_blank";if(a){f.openUrl(a,i)}break;case s.Custom:if(typeof t.action==="function"){t.action(e.card,e.source)}break;case s.Submit:if(e.source&&e.source.isA("sap.ui.integration.cards.BaseContent")){f.handleSubmitAction(e)}break;default:break}};f.openUrl=function(e,t){window.open(e,t)};f.handleSubmitAction=function(e){var t,r=e.card,a=r._oDataProviderFactory,i=e.source,o=e.parameters;if(!o.configuration){return}i.onActionSubmitStart(o);t=a.create({request:o.configuration});t.getData().then(function(e){i.onActionSubmitEnd(e,null)},function(e){n.error(e);i.onActionSubmitEnd(null,{error:e})}).finally(function(){a.remove(t)})};f.prototype._extractActionConfigurations=function(e,t){var n=e&&e.getManifestEntry("/sap.card/configuration/actionHandlers/submit"),r=t.data||{};if(!n){return t}return{data:r,configuration:{mode:n.mode||"cors",url:n.url,method:n.method||"POST",parameters:Object.assign({},r,n.parameters),headers:n.headers,xhrFields:{withCredentials:!!n.withCredentials}}}};return f});