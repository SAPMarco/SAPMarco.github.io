/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../controls/ActionsToolbar","sap/ui/base/Interface","sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/ui/integration/util/Manifest","sap/ui/integration/util/ServiceManager","sap/base/Log","sap/base/util/merge","sap/base/util/deepEqual","sap/ui/integration/util/DataProviderFactory","sap/m/HBox","sap/ui/core/Icon","sap/m/Text","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/integration/util/ContextModel","sap/base/util/LoaderExtensions","sap/f/CardRenderer","sap/f/CardBase","sap/f/library","sap/ui/integration/library","sap/ui/integration/util/Destinations","sap/ui/integration/util/LoadingProvider","sap/ui/integration/util/HeaderFactory","sap/ui/integration/util/ContentFactory","sap/ui/integration/util/BindingHelper","sap/ui/integration/util/BindingResolver","sap/ui/integration/formatters/IconFormatter","sap/ui/integration/util/FilterBarFactory","sap/ui/integration/util/CardActions"],function(t,e,i,r,a,n,s,o,d,h,f,p,u,g,c,l,_,y,C,v,M,m,P,A,R,D,b,T,E,S){"use strict";var w={TYPE:"/sap.card/type",DATA:"/sap.card/data",HEADER:"/sap.card/header",HEADER_POSITION:"/sap.card/headerPosition",CONTENT:"/sap.card/content",SERVICES:"/sap.ui5/services",APP_TYPE:"/sap.app/type",PARAMS:"/sap.card/configuration/parameters",DESTINATIONS:"/sap.card/configuration/destinations",FILTERS:"/sap.card/configuration/filters"};var F=v.cards.HeaderPosition;var I=M.CardDataMode;var x=C.extend("sap.ui.integration.widgets.Card",{metadata:{library:"sap.ui.integration",properties:{manifest:{type:"any",defaultValue:""},parameters:{type:"object",defaultValue:null},dataMode:{type:"sap.ui.integration.CardDataMode",group:"Behavior",defaultValue:I.Active},baseUrl:{type:"sap.ui.core.URI",defaultValue:null},manifestChanges:{type:"object[]"}},aggregations:{actionDefinitions:{type:"sap.ui.integration.ActionDefinition",multiple:true,forwarding:{getter:"_getActionsToolbar",aggregation:"actionDefinitions"}},_header:{type:"sap.f.cards.IHeader",multiple:false,visibility:"hidden"},_filterBar:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_extension:{type:"sap.ui.integration.Extension",multiple:false,visibility:"hidden"}},events:{action:{allowPreventDefault:true,parameters:{actionSource:{type:"sap.ui.core.Control"},manifestParameters:{type:"object"},parameters:{type:"object"},type:{type:"sap.ui.integration.CardActionType"}}},manifestReady:{},manifestApplied:{}},associations:{host:{}}},renderer:y});x.prototype.init=function(){C.prototype.init.call(this);this.setModel(new g,"parameters");this.setModel(new g,"filters");this.setModel(new l,"context");this._busyStates=new Map;this._oContentFactory=new R(this);this._oLimitedInterface=new e(this,["getParameters","getCombinedParameters","getManifestEntry","resolveDestination","request","showMessage","getBaseUrl","getTranslatedText","getModel","triggerAction","addActionDefinition","removeActionDefinition","insertActionDefinition","getActionDefinition","indexOfActionDefinition","destroyActionDefinition"])};x.prototype._initReadyState=function(){this._aReadyPromises=[];this._awaitEvent("_headerReady");this._awaitEvent("_filterBarReady");this._awaitEvent("_contentReady");this._awaitEvent("_cardReady");Promise.all(this._aReadyPromises).then(function(){this._bReady=true;this.fireEvent("_ready")}.bind(this))};x.prototype._clearReadyState=function(){this._bReady=false;this._aReadyPromises=[]};x.prototype.onBeforeRendering=function(){if(this.getDataMode()!==I.Active){return}this.startManifestProcessing()};x.prototype.startManifestProcessing=function(){if(this._bApplyManifest||this._bApplyParameters){this._clearReadyState();this._initReadyState()}if(this._bApplyManifest){var t=this.getManifest();if(!t){this.destroyManifest()}else{this.createManifest(t,this.getBaseUrl())}}if(!this._bApplyManifest&&this._bApplyParameters){this._oCardManifest.processParameters(this._getContextAndRuntimeParams());this._applyManifestSettings()}this._bApplyManifest=false;this._bApplyParameters=false;this._refreshActionsMenu()};x.prototype.setManifest=function(t){this.setProperty("manifest",t);this.destroyActionDefinitions();this._bApplyManifest=true;return this};x.prototype.setManifestChanges=function(t){this.setProperty("manifestChanges",t);this._bApplyManifest=true;return this};x.prototype.setParameters=function(t){this.setProperty("parameters",t);this._bApplyParameters=true;return this};x.prototype.setParameter=function(t,e){var i=this.getParameters()||{};i[t]=e;this.setParameters(i);return this};x.prototype.setHost=function(t){this.setAssociation("host",t);var e=this.getHostInstance();this.getModel("context").setHost(e);if(this._oDestinations){this._oDestinations.setHost(e)}return this};x.prototype.createManifest=function(t,e){var i={};this._isManifestReady=false;if(typeof t==="string"){i.manifestUrl=t;t=null}if(this._oCardManifest){this._oCardManifest.destroy()}this.destroyAggregation("_extension");this._oCardManifest=new a("sap.card",t,e,this.getManifestChanges());this._oCardManifest.load(i).then(function(){this._registerManifestModulePath();this._isManifestReady=true;this.fireManifestReady();return this._loadExtension()}.bind(this)).then(this._applyManifest.bind(this)).catch(this._applyManifest.bind(this))};x.prototype._loadExtension=function(){var t=this._oCardManifest.get("/sap.card/extension");if(!t){return null}var e=this._oCardManifest.get("/sap.app/id").replace(/\./g,"/")+"/"+t;return new Promise(function(i,r){sap.ui.require([e],function(t){var e=new t;e._setCard(this,this._oLimitedInterface);this.setAggregation("_extension",e);i()}.bind(this),function(e){s.error("Failed to load "+t+". Check if the path is correct.");r(e)})}.bind(this))};x.prototype._applyManifest=function(){var t=this._oCardManifest;if(t&&t.getResourceBundle()){this._enhanceI18nModel(t.getResourceBundle())}if(this._hasContextParams()){this._resolveContextParams().then(function(t){this._oContextParameters=t;this._applyManifestWithParams()}.bind(this));return}this._applyManifestWithParams()};x.prototype._applyManifestWithParams=function(){var t=this._oCardManifest,e=this._getContextAndRuntimeParams();t.processParameters(e);this._prepareToApplyManifestSettings();this._applyManifestSettings()};x.prototype._loadDefaultTranslations=function(){if(this._defaultTranslationsLoaded){return}var t=r.getLibraryResourceBundle("sap.ui.integration");this._enhanceI18nModel(t);this._defaultTranslationsLoaded=true};x.prototype._enhanceI18nModel=function(t){var e=this.getModel("i18n");if(e){e.enhance(t);return}e=new c({bundle:t});this.setModel(e,"i18n")};x.prototype._hasContextParams=function(){var t=this._oCardManifest.get(w.PARAMS),e,i;for(e in t){i=t[e].value;if(typeof i==="string"&&i.indexOf("{context>")!==-1){return true}}return false};x.prototype._resolveContextParams=function(){var t=this.getModel("context"),e=this._oCardManifest.get(w.PARAMS),i={},r,a;for(r in e){a=e[r].value;if(typeof a==="string"&&a.indexOf("{context>")!==-1){i[r]=a}}b.resolveValue(i,this,"/");return t.waitForPendingProperties().then(function(){return b.resolveValue(i,this,"/")}.bind(this))};x.prototype._getContextAndRuntimeParams=function(){var t=this._oContextParameters||{},e=this.getParameters()||{};return o(t,e)};x.prototype._awaitEvent=function(t){this._aReadyPromises.push(new Promise(function(e){this.attachEventOnce(t,function(){e()})}.bind(this)))};x.prototype.isReady=function(){return this._bReady};x.prototype.refresh=function(){if(this.getDataMode()===I.Active){this._bApplyManifest=true;this.invalidate()}};x.prototype._refreshActionsMenu=function(){var t=this.getCardHeader(),e=this.getHostInstance(),i=this.getAggregation("_extension"),r=[];if(!t){return}if(e){r=r.concat(e.getActions()||[])}if(i){r=r.concat(i.getActions()||[])}if(d(r,this._getActionsToolbar()._aActions)){return}this._getActionsToolbar().initializeContent(this)};x.prototype.exit=function(){C.prototype.exit.call(this);this.destroyManifest();this._busyStates=null;this._oContentFactory=null;if(this._oActionsToolbar){this._oActionsToolbar.destroy();this._oActionsToolbar=null}};x.prototype.destroyManifest=function(){if(this._oCardManifest){this._oCardManifest.destroy();this._oCardManifest=null}if(this._oServiceManager){this._oServiceManager.destroy();this._oServiceManager=null}if(this._oDataProviderFactory){this._oDataProviderFactory.destroy();this._oDataProviderFactory=null;this._oDataProvider=null}if(this._oLoadingProvider){this._oLoadingProvider.destroy();this._oLoadingProvider=null}if(this._oTemporaryContent){this._oTemporaryContent.destroy();this._oTemporaryContent=null}if(this._oDestinations){this._oDestinations.destroy();this._oDestinations=null}if(this._oIconFormatter){this._oIconFormatter.destroy();this._oIconFormatter=null}this.destroyAggregation("_header");this.destroyAggregation("_filterBar");this.destroyAggregation("_content");this._aReadyPromises=null;this._busyStates.clear();this.getModel("filters").setData({});this._oContextParameters=null};x.prototype._registerManifestModulePath=function(){if(!this._oCardManifest){return}this._sAppId=this._oCardManifest.get("/sap.app/id");if(this._sAppId){_.registerResourcePath(this._sAppId.replace(/\./g,"/"),this._oCardManifest.getUrl())}else{s.error("Card sap.app/id entry in the manifest is mandatory")}};x.prototype.getManifest=function(){var t=this.getProperty("manifest");if(t&&typeof t==="object"){return i.extend(true,{},t)}return t};x.prototype.getParameters=function(){var t=this.getProperty("parameters");if(t&&typeof t==="object"){return i.extend(true,{},t)}return t};x.prototype.getCombinedParameters=function(){if(!this._isManifestReady){s.error("The manifest is not ready. Consider using the 'manifestReady' event.","sap.ui.integration.widgets.Card");return null}var t=this._oCardManifest.getProcessedParameters(this._getContextAndRuntimeParams()),e={},i;for(i in t){e[i]=t[i].value}return e};x.prototype.getManifestEntry=function(t){if(!this._isManifestReady){s.error("The manifest is not ready. Consider using the 'manifestReady' event.","sap.ui.integration.widgets.Card");return null}return this._oCardManifest.get(t)};x.prototype.getManifestRawJson=function(){if(!this._oCardManifest||!this._oCardManifest){s.error("The manifest is not ready. Consider using the 'manifestReady' event.","sap.ui.integration.widgets.Card");return{}}return this._oCardManifest.getInitialJson()};x.prototype.getManifestWithMergedChanges=function(){if(!this._oCardManifest||!this._oCardManifest._oManifest){s.error("The manifest is not ready. Consider using the 'manifestReady' event.","sap.ui.integration.widgets.Card");return{}}return i.extend(true,{},this._oCardManifest._oManifest.getRawJson())};x.prototype.resolveDestination=function(t){return this._oDestinations.getUrl(t)};x.prototype.showMessage=function(t,e){var i=this.getCardContent();if(!i||!i.showMessage){s.error("The experimental feature 'showMessage' is currently available only for an Adaptive Card.");return}i.showMessage(t,e)};x.prototype.getTranslatedText=function(t,e,i){var r=this.getModel("i18n"),a;if(!r){s.warning("There are no translations available. Either the i18n configuration is missing or the method is called too early.");return null}a=r.getResourceBundle();return a.getText(t,e,i)};x.prototype.getDataProviderFactory=function(){if(!this._oDataProviderFactory){s.error("The DataProviderFactory instance is not ready yet. Consider using the event 'manifestApplied'.","sap.ui.integration.widgets.Card");return null}return this._oDataProviderFactory};x.prototype.getRuntimeUrl=function(t){var e=this._sAppId,i,r=t&&t.trim().replace(/^\//,"");if(e===null){s.error("The manifest is not ready so the URL can not be resolved. Consider using the 'manifestReady' event.","sap.ui.integration.widgets.Card");return null}if(!e){return t}i=e.replace(/\./g,"/");return sap.ui.require.toUrl(i+"/"+r)};x.prototype._prepareToApplyManifestSettings=function(){var t=this._oCardManifest.get(w.APP_TYPE),e=this.getAggregation("_extension");if(t&&t!=="card"){s.error("sap.app/type entry in manifest is not 'card'")}if(this._oDataProviderFactory){this._oDataProviderFactory.destroy()}this._oDestinations=new m(this.getHostInstance(),this._oCardManifest.get(w.DESTINATIONS));this._oIconFormatter=new T(this._oDestinations);this._oDataProviderFactory=new h(this._oDestinations,e,this);this._oLoadingProvider=new P;if(e){e.onCardReady()}this._fillFiltersModel()};x.prototype._fillFiltersModel=function(){var t=this.getModel("filters"),e=this._oCardManifest.get(w.FILTERS);for(var i in e){t.setProperty("/"+i,{value:e[i].value})}};x.prototype._applyManifestSettings=function(){this._applyServiceManifestSettings();this._applyFilterBarManifestSettings();this._applyDataManifestSettings();this._applyHeaderManifestSettings();this._applyContentManifestSettings();this.fireManifestApplied()};x.prototype._applyDataManifestSettings=function(){var t=this._oCardManifest.get(w.DATA);if(!t){this.fireEvent("_cardReady");return}this.bindObject(t.path||"/");if(this._oDataProvider){this._oDataProvider.destroy()}this._oDataProvider=this._oDataProviderFactory.create(t,this._oServiceManager);if(this._oDataProvider){this.setModel(new g);this._oDataProvider.attachDataRequested(function(){this.onDataRequested()}.bind(this));this._oDataProvider.attachDataChanged(function(t){this.getModel().setData(t.getParameter("data"));if(this._createContentPromise){this._createContentPromise.then(function(t){t.onDataChanged()})}this.onDataRequestComplete()}.bind(this));this._oDataProvider.attachError(function(t){this._handleError("Data service unavailable. "+t.getParameter("message"));this.onDataRequestComplete()}.bind(this));this._oDataProvider.triggerDataUpdate()}};x.prototype._handleCardLoading=function(){var t=this.getCardContent();if(t&&!t.hasStyleClass("sapFCardErrorContent")&&t._oLoadingPlaceholder){var e=t.getAggregation("_content");if(e){e.removeStyleClass("sapFCardContentHidden")}t._oLoadingPlaceholder.destroy()}if(this._oLoadingProvider){this._oLoadingProvider.removeHeaderPlaceholder(this.getCardHeader())}this._oLoadingProvider.setLoading(false)};x.prototype._applyServiceManifestSettings=function(){var t=this._oCardManifest.get(w.SERVICES);if(!t){return}if(!this._oServiceManager){this._oServiceManager=new n(t,this)}};x.prototype.getCardHeader=function(){return this.getAggregation("_header")};x.prototype.getCardHeaderPosition=function(){if(!this._oCardManifest){return"Top"}return this._oCardManifest.get(w.HEADER_POSITION)||F.Top};x.prototype.getCardContent=function(){return this.getAggregation("_content")};x.prototype._getActionsToolbar=function(){if(!this._oActionsToolbar){this._oActionsToolbar=new t;this._oActionsToolbar.setCard(this)}return this._oActionsToolbar};x.prototype._applyHeaderManifestSettings=function(){var t=this.createHeader();this.destroyAggregation("_header");if(!t){this.fireEvent("_headerReady");return}this.setAggregation("_header",t);if(t.isReady()){this.fireEvent("_headerReady")}else{t.attachEvent("_ready",function(){this.fireEvent("_headerReady")}.bind(this))}};x.prototype._applyFilterBarManifestSettings=function(){var t=this.createFilterBar();this.destroyAggregation("_filterBar");if(!t){this.fireEvent("_filterBarReady");return}t.attachEventOnce("_filterBarDataReady",function(){this.fireEvent("_filterBarReady")}.bind(this));this.setAggregation("_filterBar",t)};x.prototype.getHostInstance=function(){var t=this.getHost();if(!t){return null}return r.byId(t)};x.prototype._applyContentManifestSettings=function(){var t=this._oCardManifest.get(w.TYPE),e=this.getContentManifest(),i=t+" "+this._oRb.getText("ARIA_ROLEDESCRIPTION_CARD");this._ariaText.setText(i);if(!e){this.fireEvent("_contentReady");return}this._setTemporaryContent(t,e);if(this._bIsPreviewMode){this.fireEvent("_contentReady");return}this._createContentPromise=this.createContent({cardType:t,contentManifest:e,serviceManager:this._oServiceManager,dataProviderFactory:this._oDataProviderFactory,iconFormatter:this._oIconFormatter,appId:this._sAppId}).then(function(t){this._setCardContent(t);return t}.bind(this));this._createContentPromise.catch(function(t){if(t){this._handleError(t)}}.bind(this))};x.prototype.createHeader=function(){var t=this._oCardManifest.get(w.HEADER),e=new A(this);return e.create(t,this._getActionsToolbar())};x.prototype.createFilterBar=function(){var t=this._oCardManifest.get(w.FILTERS),e=this.getModel("filters"),i=e.getProperty("/"),r=new E(this);return r.create(t,i)};x.prototype.getContentManifest=function(){var t=this._oCardManifest.get(w.TYPE),e=t&&t.toLowerCase()==="component",i=this._oCardManifest.get(w.CONTENT),r=!!i;if(r&&!t){s.error("Card type property is mandatory!");return null}if(!r&&!e){return null}if(e){i=o(i,{componentManifest:this._oCardManifest.getJson()})}return i};x.prototype.createContent=function(t){t.cardManifest=this._oCardManifest;return this._oContentFactory.create(t)};x.prototype.onAfterRendering=function(){var t;if(this._oCardManifest&&this._oCardManifest.get(w.TYPE)){t=this._oCardManifest.get(w.TYPE).toLowerCase()}this.toggleStyleClass("sapFCardAnalytical",t==="analytical")};x.prototype._setCardContent=function(t){t.attachEvent("_error",function(t){this._handleError(t.getParameter("logMessage"),t.getParameter("displayMessage"))}.bind(this));var e=this.getAggregation("_content");if(e&&e!==this._oTemporaryContent){e.destroy()}this.setAggregation("_content",t);if(t.isReady()){this.fireEvent("_contentReady")}else{t.attachEvent("_ready",function(){this.fireEvent("_contentReady")}.bind(this))}};x.prototype._setTemporaryContent=function(t,e){var i=this._getTemporaryContent(t,e),r=this.getAggregation("_content");if(r&&r!==i){r.destroy()}this.setAggregation("_content",i)};x.prototype._handleError=function(t,e){s.error(t);this.fireEvent("_error",{message:t});var i="Unable to load the data.",r=e||i,a=this.getAggregation("_content");var n=new f({justifyContent:"Center",alignItems:"Center",items:[new p({src:"sap-icon://message-error",size:"1rem"}).addStyleClass("sapUiTinyMargin"),new u({text:r})]}).addStyleClass("sapFCardErrorContent");if(a&&!a.hasStyleClass("sapFCardErrorContent")){a.destroy();if(a===this._oTemporaryContent){this._oTemporaryContent=null}this.fireEvent("_contentReady")}n.addEventDelegate({onAfterRendering:function(){if(!this._oCardManifest){return}var t=this._oCardManifest.get(w.TYPE),e=this._oCardManifest.get(w.CONTENT),i=this._oContentFactory.getClass(t),r;if(!i){return}r=i.getMetadata().getRenderer().getMinHeight(e,n);if(this.getHeight()==="auto"){n.$().css({"min-height":r})}}},this);this.setAggregation("_content",n)};x.prototype._getTemporaryContent=function(t,e){if(!this._oTemporaryContent&&this._oLoadingProvider){this._oTemporaryContent=this._oLoadingProvider.createContentPlaceholder(e,t);this._oTemporaryContent.addEventDelegate({onAfterRendering:function(){if(!this._oCardManifest){return}var i=this._oContentFactory.getClass(t).getMetadata().getRenderer().getMinHeight(e,this._oTemporaryContent);if(this.getHeight()==="auto"){this._oTemporaryContent.$().css({"min-height":i})}}},this)}return this._oTemporaryContent};x.prototype.setDataMode=function(t){if(this._oDataProviderFactory&&t===I.Inactive){this._oDataProviderFactory.destroy();this._oDataProviderFactory=null}this.setProperty("dataMode",t,true);if(this.getProperty("dataMode")===I.Active){this.refresh()}return this};x.prototype.loadDesigntime=function(){if(this._oDesigntime){return Promise.resolve(this._oDesigntime)}if(!this._oCardManifest){return new Promise(function(t,e){this.attachManifestReady(function(){this.loadDesigntime().then(t,e)}.bind(this))}.bind(this))}var t=this._oCardManifest.get("/sap.app/id");if(!t){return Promise.reject("App id not maintained")}return new Promise(function(t,e){var i=this._oCardManifest.get("/sap.card/designtime"),r=this._oCardManifest.get("/sap.app/id").replace(/\./g,"/")+"/"+i;if(r){sap.ui.require([r],function(e){e=new e;e._readyPromise(this._oLimitedInterface,this).then(function(){this._oDesigntime=e;t(e)}.bind(this))}.bind(this),function(){e({error:r+" not found"})})}else{e()}}.bind(this))};x.prototype.isLoading=function(){return this._oLoadingProvider?this._oLoadingProvider.getLoadingState():false};x.prototype.getFocusDomRef=function(){var t=this.getCardHeader();if(t&&t.getDomRef()){return t.getDomRef()}return this.getDomRef()};x.prototype.onDataRequested=function(){this._oLoadingProvider.createLoadingState(this._oDataProvider)};x.prototype.onDataRequestComplete=function(){this.fireEvent("_cardReady");this._handleCardLoading();this._oLoadingProvider.setLoading(false)};x.prototype.request=function(t){return this._oDataProviderFactory.create({request:t}).setAllowCustomDataType(true).getData()};x.prototype.triggerAction=function(t){S.fireAction({card:this,host:this.getHostInstance(),action:t,parameters:t.parameters,source:this})};x.prototype._setPreviewMode=function(t){this._bIsPreviewMode=t;if(t){this.addStyleClass("sapFCardPreview")}else{this.removeStyleClass("sapFCardPreview")}this._bApplyManifest=true;this.invalidate()};x.prototype.getBindingNamespaces=function(){var t={},e=this.getAggregation("_extension");if(e){t.extension={formatters:e.getFormatters()}}return t};return x});