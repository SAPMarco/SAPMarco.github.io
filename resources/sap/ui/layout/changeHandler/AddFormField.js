/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/fl/changeHandler/ChangeHandlerMediator","sap/base/Log","sap/base/util/merge"],function(e,n,t,r){"use strict";function o(e){return e&&e.content&&e.content.createFunction}function i(e,n){var t=e.content;if(t){return e.content.newFieldSelector&&e.content.newFieldIndex!==undefined&&e.content.bindingPath&&e.content.oDataServiceVersion&&!!o(n)}return false}function a(e,n){return new Promise(function(n){sap.ui.require([e.name],n)}).then(function(t){var o=r({aggregationName:"formElements",payload:e.payload},n);return t.createControlForProperty(o).then(function(e){var r=n.modifier.getId(e.control);o.labelFor=r;return t.createLabel(o).then(function(n){return{label:n,control:e.control,valueHelp:e.valueHelp}})})})}function l(e,r){return n.getChangeHandlerSettings({scenario:"addODataFieldWithLabel",oDataServiceVersion:e.content&&e.content.oDataServiceVersion}).then(function(n){if(i(e,n)){var a=o(n);return a(r.modifier,r)}else{t.error("Change does not contain sufficient information to be applied or ChangeHandlerMediator could not be retrieved: ["+e.layer+"]"+e.namespace+"/"+e.fileName+"."+e.fileType)}})}var d={};d.applyChange=function(n,t,o){var i=n.getDefinition();var d=o.view;var c=i.content.newFieldIndex;var f=o.appComponent;var u=i.content;var g=u.newFieldSelector;var p=r({},u.newFieldSelector);p.id=p.id+"-field";var v=u.bindingPath;var s={appComponent:o.appComponent,view:o.view,fieldSelector:p,bindingPath:v,modifier:o.modifier};if(o.modifier.bySelector(g,f)){return e.markAsNotApplicable("Control to be created already exists:"+g)}var m={newFieldSelector:g};var h=o.modifier.getFlexDelegate(t);var C=h?a(h,s):l(i,s);return C.then(function(e){var t=o.modifier.createControl("sap.ui.layout.form.FormElement",f,d,g);o.modifier.insertAggregation(t,"label",e.label,0,d);o.modifier.insertAggregation(t,"fields",e.control,0,d);var r=n.getDependentControl("parentFormContainer",o);o.modifier.insertAggregation(r,"formElements",t,c,d);if(e.valueHelp){o.modifier.insertAggregation(r,"dependents",e.valueHelp,0,d);var i=o.modifier.getSelector(o.modifier.getId(e.valueHelp),f);m.valueHelpSelector=i}n.setRevertData(m);return true})};d.completeChangeContent=function(e,n,t){var r=t.appComponent;var o=e.getDefinition();if(!o.content){o.content={}}if(n.parentId){e.addDependentControl(n.parentId,"parentFormContainer",t)}else{throw new Error("oSpecificChangeInfo.parentId attribute required")}if(n.bindingPath){o.content.bindingPath=n.bindingPath}else{throw new Error("oSpecificChangeInfo.bindingPath attribute required")}if(n.newControlId){o.content.newFieldSelector=t.modifier.getSelector(n.newControlId,r)}else{throw new Error("oSpecificChangeInfo.newControlId attribute required")}if(n.index===undefined){throw new Error("oSpecificChangeInfo.targetIndex attribute required")}else{o.content.newFieldIndex=n.index}if(n.oDataServiceVersion===undefined){throw new Error("oSpecificChangeInfo.oDataServiceVersion attribute required")}else{o.content.oDataServiceVersion=n.oDataServiceVersion}};d.revertChange=function(e,n,t){var r=t.appComponent;var o=t.view;var i=t.modifier;var a=e.getRevertData().newFieldSelector;var l=e.getRevertData().valueHelpSelector;var d=i.bySelector(a,r,o);var c=e.getDependentControl("parentFormContainer",t);i.removeAggregation(c,"formElements",d);i.destroy(d);if(l){var f=i.bySelector(l,r,o);i.removeAggregation(c,"dependents",f);i.destroy(f)}e.resetRevertData();return true};return d},true);