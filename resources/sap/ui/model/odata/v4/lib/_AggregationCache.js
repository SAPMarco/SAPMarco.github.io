/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_AggregationHelper","./_Cache","./_GrandTotalHelper","./_GroupLock","./_Helper","./_MinMaxHelper","sap/base/Log","sap/ui/base/SyncPromise"],function(e,t,n,r,i,a,o,l){"use strict";function s(e,r,i,a,o){t.call(this,e,r,o,true);this.oAggregation=i;if(i.groupLevels.length){if(o.$count){throw new Error("Unsupported system query option: $count")}if(o.$filter){throw new Error("Unsupported system query option: $filter")}this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$created=0;this.oFirstLevel=this.createGroupLevelCache(null,a)}else{this.oFirstLevel=t.create(e,r,o,true);n.enhanceCacheWithGrandTotal(this.oFirstLevel,i,o)}}s.prototype=Object.create(t.prototype);s.prototype.addElements=function(e,t,n,r){var a=this.aElements;if(t<0){throw new Error("Illegal offset: "+t)}e.forEach(function(e,o){var l=a[t+o],s,u=i.getPrivateAnnotation(e,"predicate");if(l){if(l===e){return}s=i.getPrivateAnnotation(l,"parent");if(!s){throw new Error("Unexpected element")}if(s!==n||i.getPrivateAnnotation(l,"index")!==r+o){throw new Error("Wrong placeholder")}}else if(t+o>=a.length){throw new Error("Array index out of bounds: "+(t+o))}a[t+o]=e;a.$byPredicate[u]=e})};s.prototype.collapse=function(e){var t=0,n=this.aElements,a=this.fetchValue(r.$cached,e).getResult(),o=a["@$ui5.node.level"],l=n.indexOf(a),s=l+1;i.updateAll(this.mChangeListeners,e,a,{"@$ui5.node.isExpanded":false});while(s<n.length&&n[s]["@$ui5.node.level"]>o){delete n.$byPredicate[i.getPrivateAnnotation(n[s],"predicate")];t+=1;s+=1}i.setPrivateAnnotation(a,"spliced",n.splice(l+1,t));n.$count-=t;return t};s.prototype.createGroupLevelCache=function(r,a){var o=this.oAggregation,l,u,c,d,h,f,g,p;f=r?r["@$ui5.node.level"]+1:1;h=f>o.groupLevels.length;d=h?o.groupLevels.concat(Object.keys(o.group).sort()):o.groupLevels.slice(0,f);l=Object.keys(o.aggregate).concat(Object.keys(o.group));g=Object.assign({},this.mQueryOptions);c=e.filterOrderby(g.$orderby,o,f);if(c){g.$orderby=c}else{delete g.$orderby}p=!h&&Object.keys(o.aggregate).some(function(e){return o.aggregate[e].subtotals});if(r){g.$$filterBeforeAggregate=i.getPrivateAnnotation(r,"filter")}if(!a){delete g.$count;g=e.buildApply(o,g,f)}g.$count=true;u=t.create(this.oRequestor,this.sResourcePath,g,true);if(a){n.enhanceCacheWithGrandTotal(u,o,g)}u.calculateKeyPredicate=s.calculateKeyPredicate.bind(null,r,d,l,h,p,this.aElements.$byPredicate);return u};s.prototype.expand=function(t,n){var a,o,s=typeof n==="string"?this.fetchValue(r.$cached,n).getResult():n,u=i.getPrivateAnnotation(s,"spliced"),c=this;if(n!==s){i.updateAll(this.mChangeListeners,n,s,{"@$ui5.node.isExpanded":true})}if(u){i.deletePrivateAnnotation(s,"spliced");this.aElements.splice.apply(this.aElements,[this.aElements.indexOf(s)+1,0].concat(u));o=u.length;this.aElements.$count+=o;u.forEach(function(e){var t=i.getPrivateAnnotation(e,"predicate");if(t){c.aElements.$byPredicate[t]=e;if(i.getPrivateAnnotation(e,"expanding")){i.deletePrivateAnnotation(e,"expanding");o+=c.expand(r.$cached,e).getResult()}}});return l.resolve(o)}a=i.getPrivateAnnotation(s,"cache");if(!a){a=this.createGroupLevelCache(s);i.setPrivateAnnotation(s,"cache",a)}return a.read(0,this.iReadLength,0,t).then(function(t){var n=c.aElements.indexOf(s)+1,r;if(!s["@$ui5.node.isExpanded"]){i.deletePrivateAnnotation(s,"spliced");return 0}if(!n){i.setPrivateAnnotation(s,"expanding",true);return 0}o=t.value.$count;if(n===c.aElements.length){c.aElements.length+=o}else{for(r=c.aElements.length-1;r>=n;r-=1){c.aElements[r+o]=c.aElements[r];delete c.aElements[r]}}c.addElements(t.value,n,a,0);c.aElements.$count+=o;for(r=n+t.value.length;r<n+o;r+=1){c.aElements[r]=e.createPlaceholder(s["@$ui5.node.level"]+1,r-n,a)}return o},function(e){i.updateAll(c.mChangeListeners,n,s,{"@$ui5.node.isExpanded":false});throw e})};s.prototype.fetchValue=function(e,t,n,r){var i=this;if(t==="$count"){if(!this.mQueryOptions.$count){o.error("Failed to drill-down into $count, invalid segment: $count",this.toString(),"sap.ui.model.odata.v4.lib._Cache");return l.resolve()}return this.oFirstLevel.fetchValue(e,t).then(function(){return i.oFirstLevel.iLeafCount})}if(this.oAggregation.groupLevels.length){this.registerChange(t,r);return this.drillDown(this.aElements,t,e)}return this.oFirstLevel.fetchValue(e,t,n,r)};s.prototype.read=function(t,n,r,a,o){var s,u,c,d,h,f=this.oAggregation.groupLevels.length,g=[],p=this;function v(e,t){var n=d,r=i.getPrivateAnnotation(p.aElements[e],"index"),l=p.aElements[e];g.push(d.read(r,t-e,0,a.getUnlockedCopy(),o).then(function(t){var i=false,a;if(l!==p.aElements[e]&&t.value[0]!==p.aElements[e]){i=true;e=p.aElements.indexOf(l);if(e<0){e=p.aElements.indexOf(t.value[0]);if(e<0){a=new Error("Collapse before read has finished");a.canceled=true;throw a}}}p.addElements(t.value,e,n,r);if(i){a=new Error("Collapse or expand before read has finished");a.canceled=true;throw a}}))}if(f&&this.aElements.length){for(s=t,u=Math.min(t+n,this.aElements.length);s<u;s+=1){c=i.getPrivateAnnotation(this.aElements[s],"parent");if(c!==d){if(h){v(h,s);d=h=undefined}if(c){h=s;d=c}}}if(h){v(h,s)}a.unlock();return l.all(g).then(function(){var e=p.aElements.slice(t,t+n);e.$count=p.aElements.$count;return{value:e}})}return this.oFirstLevel.read(t,n,r,a,o).then(function(i){var a;if(f){p.aElements.length=p.aElements.$count=i.value.$count;p.addElements(i.value,t,p.oFirstLevel,t);for(a=0;a<p.aElements.$count;a+=1){if(!p.aElements[a]){p.aElements[a]=e.createPlaceholder(0,a,p.oFirstLevel)}}p.iReadLength=n+r}else{i.value.forEach(function(e){if(!("@$ui5.node.level"in e)){e["@$ui5.node.isExpanded"]=undefined;e["@$ui5.node.isTotal"]=false;e["@$ui5.node.level"]=1}})}return i})};s.prototype.refreshKeptElement=function(){};s.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,e.buildApply(this.oAggregation,this.mQueryOptions),false,true)};s.calculateKeyPredicate=function(t,n,r,a,o,l,s,u,c){var d;function h(e){return JSON.stringify(i.publicClone(e))}n.forEach(function(e){if(!(e in s)){s[e]=t[e]}});d=i.getKeyPredicate(s,c,u,n,true);if(d in l){throw new Error("Multi-unit situation detected: "+h(s)+" vs. "+h(l[d]))}i.setPrivateAnnotation(s,"predicate",d);if(!a){i.setPrivateAnnotation(s,"filter",i.getKeyFilter(s,c,u,n))}if(s["@$ui5.node.level"]!==0){e.setAnnotations(s,a?undefined:false,o,t?t["@$ui5.node.level"]+1:1,r)}};s.create=function(n,r,i,o,l,u,c){var d,h,f;if(o){h=e.hasGrandTotal(o.aggregate);f=e.hasMinOrMax(o.aggregate);d=o.groupLevels.length||h||f;if(d){if("$expand"in l){throw new Error("Unsupported system query option: $expand")}if("$select"in l){throw new Error("Unsupported system query option: $select")}if(f){return a.createCache(n,r,o,l)}return new s(n,r,o,h,l)}}if(l.$$filterBeforeAggregate){l.$apply="filter("+l.$$filterBeforeAggregate+")/"+l.$apply;delete l.$$filterBeforeAggregate}return t.create(n,r,l,u,i,c)};return s},false);