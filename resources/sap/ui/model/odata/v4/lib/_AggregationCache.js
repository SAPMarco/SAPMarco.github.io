/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_AggregationHelper","./_Cache","./_GroupLock","./_Helper","./_Parser","sap/base/Log","sap/ui/base/SyncPromise"],function(e,t,i,n,r,s,o){"use strict";var u=/,|%2C|%2c/,a=new RegExp("^"+r.sODataIdentifier+"(?:"+r.sWhitespace+"+(?:asc|desc))?$"),l=new RegExp(r.sWhitespace+"+");function c(i,n,r,s){var o={},u,a;t.call(this,i,n,s,true);this.oAggregation=r;if(e.hasMinOrMax(r.aggregate)){if(r.groupLevels.length){throw new Error("Unsupported group levels together with min/max")}this.oMeasureRangePromise=new Promise(function(e,t){a=e});u=e.buildApply(r,s,o);this.oFirstLevel=t.create(i,n,u,true);this.oFirstLevel.getResourcePath=c.getResourcePath.bind(this.oFirstLevel,r,s);this.oFirstLevel.handleResponse=c.handleResponse.bind(this.oFirstLevel,null,o,a,this.oFirstLevel.handleResponse)}else if(r.groupLevels.length){this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$created=0;if(s.$count){throw new Error("Unsupported system query option: $count")}if(s.$filter){throw new Error("Unsupported system query option: $filter")}this.oFirstLevel=this.createGroupLevelCache()}else{this.oFirstLevel=t.create(i,n,s,true);this.oFirstLevel.getResourcePath=c.getResourcePath.bind(this.oFirstLevel,r,s);this.oFirstLevel.handleResponse=c.handleResponse.bind(this.oFirstLevel,r,null,null,this.oFirstLevel.handleResponse)}}c.prototype=Object.create(t.prototype);c.prototype.addElements=function(e,t){var i=this.aElements;e.forEach(function(e,r){var s=n.getPrivateAnnotation(e,"predicate");i[t+r]=e;i.$byPredicate[s]=e})};c.prototype.createGroupLevelCache=function(i){var r,s,o,u,a,l,h,g,d;l=i?i["@$ui5.node.level"]+1:1;s=c.filterAggregation(this.oAggregation,l);u=s.$groupBy;delete s.$groupBy;h=s.$missing;delete s.$missing;g=Object.assign({},this.mQueryOptions);o=c.filterOrderby(this.mQueryOptions.$orderby,s);if(o){g.$orderby=o}else{delete g.$orderby}if(i){g.$$filterBeforeAggregate=n.getPrivateAnnotation(i,"filter")}delete g.$count;g=e.buildApply(s,g);g.$count=true;r=t.create(this.oRequestor,this.sResourcePath,g,true);a=!s.groupLevels.length;d=!a&&Object.keys(s.aggregate).length>0;r.calculateKeyPredicate=c.calculateKeyPredicate.bind(null,i,u,h,a,d,this.aElements.$byPredicate);return r};c.prototype.expand=function(e,t){var r,s,o=this;s=this.fetchValue(i.$cached,t).getResult();n.updateAll(this.mChangeListeners,t,s,{"@$ui5.node.isExpanded":true});r=this.createGroupLevelCache(s);return r.read(0,this.iReadLength,0,e).then(function(e){var t=e.value.$count,i=o.aElements.indexOf(s)+1,n;for(n=o.aElements.length-1;n>=i;n-=1){o.aElements[n+t]=o.aElements[n]}o.addElements(e.value,i);o.aElements.$count+=t;return t},function(e){n.updateAll(o.mChangeListeners,t,s,{"@$ui5.node.isExpanded":false});throw e})};c.prototype.fetchValue=function(e,t,i,n){var r=this;if(t==="$count"){if(!this.mQueryOptions.$count){s.error("Failed to drill-down into $count, invalid segment: $count",this.toString(),"sap.ui.model.odata.v4.lib._Cache");return o.resolve()}if(!this.oMeasureRangePromise){return this.oFirstLevel.fetchValue(e,t).then(function(){return r.oFirstLevel.iLeafCount})}}if(this.oAggregation.groupLevels.length){this.registerChange(t,n);return this.drillDown(this.aElements,t,e)}return this.oFirstLevel.fetchValue(e,t,i,n)};c.prototype.getMeasureRangePromise=function(){return this.oMeasureRangePromise};c.prototype.read=function(e,t,i,n,r){var s=this.oAggregation.groupLevels.length,u,a=this;if(s&&this.aElements[0]&&this.aElements[0]["@$ui5.node.isExpanded"]){u={value:this.aElements.slice(e,e+t)};u.value.$count=this.aElements.$count;return o.resolve(u)}return this.oFirstLevel.read(e,t,i,n,r).then(function(n){if(s){a.addElements(n.value,e);a.aElements.$count=n.value.$count;a.iReadLength=t+i}else if(!a.oMeasureRangePromise){n.value.forEach(function(e){if(!("@$ui5.node.level"in e)){e["@$ui5.node.isExpanded"]=undefined;e["@$ui5.node.isTotal"]=false;e["@$ui5.node.level"]=1}})}return n})};c.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,e.buildApply(this.oAggregation,this.mQueryOptions),false,true)};c.calculateKeyPredicate=function(e,t,i,r,s,o,u,a,l){var c;function h(e){return JSON.stringify(n.publicClone(e))}t.forEach(function(t){if(!(t in u)){u[t]=e[t]}});i.forEach(function(e){u[e]=null});c=n.getKeyPredicate(u,l,a,t,true);if(c in o){throw new Error("Multi-unit situation detected: "+h(u)+" vs. "+h(o[c]))}n.setPrivateAnnotation(u,"predicate",c);if(!r){n.setPrivateAnnotation(u,"filter",n.getKeyFilter(u,l,a,t))}if(u["@$ui5.node.level"]!==0){u["@$ui5.node.isExpanded"]=r?undefined:false;u["@$ui5.node.isTotal"]=s;u["@$ui5.node.level"]=e?e["@$ui5.node.level"]+1:1}};c.create=function(e,t,i,n){return new c(e,t,i,n)};c.filterAggregation=function(e,t){var i,n,r;function s(e,t){e[t]=this[t];return e}function o(e,t){return t.reduce(s.bind(e),{})}function u(e,t){return Object.keys(e).filter(t)}function a(t){return!e.aggregate[t].subtotals}function l(t){return e.aggregate[t].subtotals}function c(t){return e.groupLevels.indexOf(t)<0}n=e.groupLevels.slice(t-1,t);i={aggregate:n.length?o(e.aggregate,u(e.aggregate,l)):e.aggregate,groupLevels:n,$groupBy:e.groupLevels.slice(0,t)};r=u(e.group,c).sort();if(n.length){i.group={};i.$missing=e.groupLevels.slice(t).concat(r).concat(Object.keys(e.aggregate).filter(a))}else{i.group=o(e.group,r);i.$groupBy=i.$groupBy.concat(r);i.$missing=[]}return i};c.filterOrderby=function(e,t){if(e){return e.split(u).filter(function(e){var i;if(a.test(e)){i=e.split(l)[0];return i in t.aggregate||i in t.group||t.groupLevels.indexOf(i)>=0}return true}).join(",")}};c.getResourcePath=function(t,i,n,r){i=Object.assign({},i,{$skip:n,$top:r-n});i=e.buildApply(t,i,null,this.bFollowUp);this.bFollowUp=true;return this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,i,false,true)};c.handleResponse=function(e,t,i,n,r,s,o,u){var a,l={},c;function h(e){l[e]=l[e]||{};return l[e]}if(t){c=o.value.shift();o["@odata.count"]=c.UI5__count;for(a in t){h(t[a].measure)[t[a].method]=c[a]}i(l);this.handleResponse=n}else{c=o.value[0];if("UI5__count"in c){this.iLeafCount=parseInt(c.UI5__count);o["@odata.count"]=this.iLeafCount+1;if(r>0){o.value.shift()}}if(r===0){c["@$ui5.node.isExpanded"]=true;c["@$ui5.node.isTotal"]=true;c["@$ui5.node.level"]=0;Object.keys(c).forEach(function(e){if(e.startsWith("UI5grand__")){c[e.slice(10)]=c[e]}});Object.keys(e.aggregate).forEach(function(e){c[e]=c[e]||null});Object.keys(e.group).forEach(function(e){c[e]=null})}}n.call(this,r,s,o,u)};return c},false);