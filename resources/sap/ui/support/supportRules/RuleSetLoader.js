/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/support/supportRules/RuleSet","sap/ui/support/supportRules/CommunicationBus","sap/ui/support/supportRules/WCBChannels","sap/ui/support/supportRules/RuleSerializer","sap/ui/support/supportRules/Constants","sap/ui/support/supportRules/util/Utils"],function(e,t,r,u,i,s,a){"use strict";var n=function(){var e;return function(t){if(!e){e=document.createElement("a")}e.href=t;return e.href.replace(/\/$/,"")}}();var l="sprt";var o=e.sap.getModulePath("sap.ui.support");var p=o.replace("/sap/ui/support","");var c=n(p);var f={};f._mRuleSets={};f._mRuleSets[s.TEMP_RULESETS_NAME]={lib:{name:s.TEMP_RULESETS_NAME},ruleset:new t({name:s.TEMP_RULESETS_NAME})};f.getRuleSets=function(){return this._mRuleSets};f.addRuleSet=function(e,t){this._mRuleSets[e]=t};f.getRuleSet=function(e){return this._mRuleSets[e]};f._fetchSupportRuleSets=function(e,s){var a=this,n=s||sap.ui.getCore().getLoadedLibraries(),l=this._fetchLibraryNamesWithSupportRules(n);var o=new Promise(function(s){t.versionInfo=sap.ui.getVersionInfo();l.then(function(n){var l=a._fetchLibraryFiles(n,f._fetchRuleSet);Promise.all(l).then(function(){a._bRulesCreated=true;r.publish(u.UPDATE_SUPPORT_RULES,{sRuleSet:i.serialize(a._mRuleSets),oVersionInfo:t.versionInfo});s();if(e&&typeof e==="function"){e()}})})});return o};f.loadAdditionalRuleSets=function(e){var t=this,s=t._fetchLibraryFiles(e,t._fetchRuleSet);Promise.all(s).then(function(){t._bRulesCreated=true;r.publish(u.UPDATE_SUPPORT_RULES,{sRuleSet:i.serialize(t._mRuleSets)})})};f._fetchLibraryNamesWithSupportRules=function(t){return new Promise(function(r){a.canLoadInternalRulesAsync().then(function(u){var i={publicRules:[],internalRules:[],allRules:[]};t=t||{};var s=[];Object.keys(t).forEach(function(t){var r=new Promise(function(r){var u=c+"/"+t.replace(/\./g,"/")+"/.supportrc";e.ajax({type:"GET",dataType:"json",url:u,success:function(e){r({lib:t,rcData:e})},error:function(){r({lib:t,rcData:null})}})});s.push(r)});Promise.all(s).then(function(e){e.forEach(function(e){if(e.rcData){var t=false;if(e.rcData.publicRules){i.publicRules.push(e.lib);t=true}if(u&&e.rcData.internalRules){i.internalRules.push(e.lib);t=true}if(t&&i.allRules.indexOf(e.lib)<0){i.allRules.push(e.lib)}}r(i)})})})})};f._fetchLibraryFiles=function(t,i,s){var n=[],l=this,o=e.sap.getModulePath("sap.ui.support"),p=o.replace("sap/ui/support",""),c=a.canLoadInternalRules(),f=c&&t.internalRules.length>0,R=0,h=t.publicRules.length;var S=sap.ui.getCore().getConfiguration().getSupportMode();var _=S&&S.indexOf("silent")>-1;if(f){h+=t.internalRules.length}function b(){R+=1;var e=Math.ceil(R/h*100);r.publish(u.CURRENT_LOADING_PROGRESS,{value:e})}if(t.publicRules.length>0){t.publicRules.forEach(function(e){var t=l._registerLibraryPath(e,o,p);if(t){var r=l._requireRuleSet(t.customizableLibName,i);if(!_&&!s){r.then(function(){b()})}n.push(r)}})}if(c&&t.internalRules.length>0){t.internalRules.forEach(function(e){var t=l._registerLibraryPath(e,o,p);if(t){var r=l._requireRuleSet(t.internalLibName,i);if(!_&&!s){r.then(function(){b()})}n.push(r)}})}return n};f._registerLibraryPath=function(t,r,u){if(this._mRuleSets[t]){return null}var i=t.replace(/\./g,"/");var s=t;var a=this._getLoadFromSupportOrigin();if(a){s+="."+l;e.sap.registerModulePath(s,u+t.replace(/\./g,"/"))}var n=s+".internal";var o=u.replace("resources/","")+"test-resources/"+i+"/internal";e.sap.registerModulePath(n,o);return{internalLibName:n,customizableLibName:s}};f._requireRuleSet=function(e,t){var r=this;return new Promise(function(u){try{sap.ui.require([e.replace(/\./g,"/")+"/library.support"],function(){t.call(r,e);u()},u)}catch(e){u()}})};f._fetchRuleSet=function(r){try{var u,i,a,n=e.sap.getObject(r).library.support;if(!n){throw"The library.support file was not fetched successfully."}u=r.replace("."+l,"").replace(".internal","");i=e.extend({},n);a=this._mRuleSets[u];if(!(i.ruleset instanceof t)){i=this._createRuleSet(i)}if(a){a.ruleset._mRules=e.extend(a.ruleset._mRules,i.ruleset._mRules)}else{a=i}this._mRuleSets[u]=a}catch(t){e.sap.log.error("["+s.SUPPORT_ASSISTANT_NAME+"] Failed to load RuleSet for "+r+" library",t)}};f._getLoadFromSupportOrigin=function(){var t=false;var r=new window.URI(e.sap.getModulePath("sap.ui.core"));var u=new window.URI(e.sap.getModulePath("sap.ui.support"));if(r.protocol()!==u.protocol()||r.host()!==u.host()){t=true}return t};f.fetchNonLoadedRuleSets=function(e){var t=[],i={};sap.ui.getVersionInfo().libraries.forEach(function(e){i[e.name]=e});this._fetchLibraryNamesWithSupportRules(i).then(function(i){i.allRules.forEach(function(r){if(e.indexOf(r)<0){t.push(r)}});r.publish(u.POST_AVAILABLE_LIBRARIES,{libNames:t})})};f._onLibraryChanged=function(e){var t=this;if(e.getParameter("stereotype")==="library"&&f._bRulesCreated){t._oMainPromise=f._fetchSupportRuleSets()}};f.updateRuleSets=function(e){this._oMainPromise=f._fetchSupportRuleSets(e)};f._createRuleSet=function(r){var u={name:r.name,niceName:r.niceName};var i=new t(u);for(var s=0;s<r.ruleset.length;s++){var a=r.ruleset[s];if(e.isArray(a)){for(var n=0;n<a.length;n++){i.addRule(a[n])}}else{i.addRule(a)}}return{lib:u,ruleset:i}};f.getAllRules=function(){var t={};Object.keys(this._mRuleSets).map(function(r){t=e.extend(t,this._mRuleSets[r].ruleset.getRules())},this);return t};f.getAllRuleDescriptors=function(){var e=this.getAllRules();return Object.keys(e).map(function(t){return{libName:e[t].libName,ruleId:t}})};return f},true);