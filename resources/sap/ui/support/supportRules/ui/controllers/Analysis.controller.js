/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/support/supportRules/ui/controllers/BaseController","sap/ui/model/json/JSONModel","sap/m/Panel","sap/m/List","sap/m/ListItemBase","sap/m/StandardListItem","sap/m/InputListItem","sap/m/Button","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/Label","sap/m/MessageToast","sap/ui/support/supportRules/CommunicationBus","sap/ui/support/supportRules/WCBChannels","sap/ui/support/supportRules/ui/models/SharedModel","sap/ui/support/supportRules/RuleSerializer","sap/ui/support/supportRules/Constants","sap/ui/support/supportRules/Storage","sap/ui/support/supportRules/ui/models/SelectionUtils","sap/ui/support/supportRules/ui/controllers/PresetsController","sap/ui/support/supportRules/ui/models/PresetsUtils","sap/ui/support/supportRules/ui/models/CustomJSONListSelection"],function(jQuery,BaseController,JSONModel,Panel,List,ListItemBase,StandardListItem,InputListItem,Button,Toolbar,ToolbarSpacer,Label,MessageToast,CommunicationBus,channelNames,SharedModel,RuleSerializer,Constants,Storage,SelectionUtils,PresetsController,PresetsUtils,CustomJSONListSelection){"use strict";return BaseController.extend("sap.ui.support.supportRules.ui.controllers.Analysis",{onInit:function(){this.model=SharedModel;this.setCommunicationSubscriptions();this.tempRulesLoaded=false;this.getView().setModel(this.model);this.treeTable=SelectionUtils.treeTable=this.byId("ruleList");this.ruleSetView=this.byId("ruleSetsView");this.rulesViewContainer=this.byId("rulesNavContainer");this.bAdditionalViewLoaded=false;this.bAdditionalRulesetsLoaded=false;this.oApplicationinfo={};new CustomJSONListSelection(this.treeTable,true,"id");CommunicationBus.subscribe(channelNames.UPDATE_SUPPORT_RULES,function(){if(!this.bAdditionalViewLoaded){CommunicationBus.publish(channelNames.RESIZE_FRAME,{bigger:true});this.bAdditionalViewLoaded=true;this.loadAdditionalUI()}},this);if(this.model.getProperty("/persistingSettings")){var e=Storage.getVisibleColumns()||[];if(e.length){this.setColumnVisibility(e,true)}}this.byId("presetVariant").addEventDelegate({onclick:this.onPresetVariantClick.bind(this)});this.treeTable.attachEvent("rowSelectionChange",function(e){if(e.getParameter("userInteraction")){PresetsUtils.syncCurrentSelectionPreset(SelectionUtils.getSelectedRules())}})},loadAdditionalUI:function(){this._ruleDetails=sap.ui.xmlfragment("sap.ui.support.supportRules.ui.views.RuleDetails",this);this.byId("rulesDisplayPage").addContentArea(this._ruleDetails);this._ruleCreateUpdatePages=sap.ui.xmlfragment("sap.ui.support.supportRules.ui.views.RuleUpdate",this);this._ruleCreateUpdatePages.forEach(function(e){this.byId("rulesNavContainer").insertPage(e)},this);this._updateRuleList()},onAfterRendering:function(){var e=function(){CommunicationBus.publish(channelNames.ON_INIT_ANALYSIS_CTRL);sap.ui.getCore().detachThemeChanged(e)};if(sap.ui.getCore().isThemeApplied()){CommunicationBus.publish(channelNames.ON_INIT_ANALYSIS_CTRL)}else{sap.ui.getCore().attachThemeChanged(e)}},onAsyncSwitch:function(e){var t=e.getSource();if(e.getParameter("selected")){var s=t.getCustomData()[0].getValue()==="true";var i=t.getProperty("groupName")==="asyncContext"?"/newRule":"/editRule";this.model.setProperty(i+"/async",s);this._updateCheckFunction(i,s)}},_updateCheckFunction:function(e,t){var s=this.model.getProperty(e+"/check");if(!s){return}var i=s.match(/function[^(]*\(([^)]*)\)/);if(!i){return}var o=i[1].trim().split(/\W+/);o[0]=o[0]||"oIssueManager";o[1]=o[1]||"oCoreFacade";o[2]=o[2]||"oScope";if(t){o[3]=o[3]||"fnResolve"}else{o=o.slice(0,3)}var r=s.replace(/function[^(]*\(([^)]*)\)/,"function ("+o.join(", ")+")");this.model.setProperty(e+"/check",r)},getTemporaryLib:function(){var e=this.model.getProperty("/libraries");for(var t=0;t<e.length;t++){if(e[t].title==Constants.TEMP_RULESETS_NAME){return e[t]}}},setCommunicationSubscriptions:function(){CommunicationBus.subscribe(channelNames.UPDATE_SUPPORT_RULES,this.updatesupportRules,this);CommunicationBus.subscribe(channelNames.VERIFY_RULE_CREATE_RESULT,function(e){var t=e.result,s=RuleSerializer.deserialize(e.newRule,true),i=this.getTemporaryLib();if(t=="success"){i.rules.push(s);if(!this.oJsonModel){this.oJsonModel=new JSONModel;this.treeTable.setModel(this.oJsonModel,"treeModel")}this._syncTreeTableVieModelTempRulesLib(i,this.model.getProperty("/treeModel"));PresetsUtils.syncCurrentSelectionPreset(SelectionUtils.getSelectedRules());if(Storage.readPersistenceCookie(Constants.COOKIE_NAME)){SelectionUtils.persistSelection();Storage.setRules(i.rules);if(this.showRuleCreatedToast){MessageToast.show('Your temporary rule "'+s.id+'" was persisted in the local storage');this.showRuleCreatedToast=false}}this.oJsonModel.setData(this.model.getProperty("/treeModel"));var o=this.model.getProperty("/newEmptyRule");this.model.setProperty("/newRule",jQuery.extend(true,{},o));this.goToRuleProperties();this.model.setProperty("/selectedRule",s);this._updateRuleList();this.treeTable.updateSelectionFromModel()}else{MessageToast.show("Add rule failed because: "+t)}},this);CommunicationBus.subscribe(channelNames.VERIFY_RULE_UPDATE_RESULT,function(e){var t=e.result,s=RuleSerializer.deserialize(e.updateRule,true),i=this;if(t==="success"){var o=this.model.getProperty("/editRuleSource"),r=this.model.getProperty("/treeModel"),n=this.model.getProperty("/libraries");n.forEach(function(e,t){if(e.title===Constants.TEMP_RULESETS_NAME){e.rules.forEach(function(t,r){if(t.id===o.id){e.rules[r]=s;if(i.model.getProperty("/persistingSettings")){Storage.setRules(e.rules)}}});i._syncTreeTableVieModelTempRule(s,r)}});this.oJsonModel.setData(r);this.model.checkUpdate(true);this.model.setProperty("/selectedRule",s);SelectionUtils.getSelectedRules();this.treeTable.updateSelectionFromModel();this.goToRuleProperties()}else{MessageToast.show("Update rule failed because: "+t)}},this);CommunicationBus.subscribe(channelNames.POST_AVAILABLE_LIBRARIES,function(e){this.bAdditionalRulesetsLoaded=true;this.model.setProperty("/availableLibrariesSet",e.libNames);this.rulesViewContainer.setBusy(false)},this);CommunicationBus.subscribe(channelNames.POST_APPLICATION_INFORMATION,function(e){this.oApplicationinfo=e},this);CommunicationBus.subscribe(channelNames.POST_AVAILABLE_COMPONENTS,function(e){var t=[],s=this.model.getProperty("/executionScopeComponents"),i=Storage.getSelectedScopeComponents(),o;for(var r=0;r<e.length;r+=1){t.push({text:e[r]})}if(s&&s.length>0){for(o=0;o<t.length;o++){t[o].selected=this.checkIfComponentIsSelected(t[o],s)}}else if(i&&i.length>0){for(o=0;o<t.length;o++){t[o].selected=this.checkIfComponentIsSelected(t[o],i)}}this.model.setProperty("/executionScopeComponents",t)},this);CommunicationBus.subscribe(channelNames.GET_RULES_MODEL,function(e){this.oJsonModel=new JSONModel;this.treeTable.setModel(this.oJsonModel,"treeModel");this.oJsonModel.setData(e);var t=Storage.readPersistenceCookie(Constants.COOKIE_NAME),s=this.model.getProperty("/loadingAdditionalRuleSets");if(s){e=SelectionUtils._syncSelectionAdditionalRuleSetsMainModel(e,this.model.getProperty("/treeModel"));e=SelectionUtils._deselectAdditionalRuleSets(e,this.model.getProperty("/namesOfLoadedAdditionalRuleSets"))}if(t){this.model.setProperty("/treeModel",e);this.initializeTempRules();var i=SelectionUtils.updateSelectedRulesFromLocalStorage(e);if(i){e=i}PresetsUtils.loadCustomPresets()}if(t||s){this.oJsonModel.setData(e);this.treeTable.updateSelectionFromModel()}else{this.treeTable.selectAll()}this.model.setProperty("/treeModel",e);this.model.setProperty("/selectedRulesCount",SelectionUtils.getSelectedRules().length);PresetsUtils.initializeSelectionPresets(SelectionUtils.getSelectedRules())},this);CommunicationBus.subscribe(channelNames.POST_MESSAGE,function(e){MessageToast.show(e.message)},this);CommunicationBus.subscribe(channelNames.ON_ANALYZE_STARTED,function(e){this.model.setProperty("/showProgressIndicator",true)},this)},checkIfComponentIsSelected:function(e,t){for(var s=0;s<t.length;s+=1){if(t[s].text==e.text&&t[s].selected){return true}}return false},onAnalyze:function(){var e=this.model.getProperty("/selectionPresetsCurrent"),t=this._getExecutionContext();if(!e.selections.length>0){MessageToast.show("Select some rules to be analyzed.");return}if(t.type==="components"&&t.components.length===0){MessageToast.show("Please select some components to be analyzed.");return}CommunicationBus.publish(channelNames.ON_ANALYZE_REQUEST,{rulePreset:e,executionContext:t})},_getExecutionContext:function(){var e={type:this.model.getProperty("/analyzeContext/key")};if(e.type==="subtree"){e.parentId=this.model.getProperty("/subtreeExecutionContextId")}if(e.type==="components"){var t=sap.ui.getCore().byId("componentsSelectionContainer"),s=t.getContent();e.components=[];s.forEach(function(t){if(t.getSelected()){e.components.push(t.getText())}})}return e},onSelectedRuleSets:function(e){var t=true,s=this.model.getProperty("/selectedRule"),i=e.getParameter("selectedKey")==="additionalRulesets";if(i||!s){t=false}if(!this.bAdditionalRulesetsLoaded&&i){this.rulesViewContainer.setBusyIndicatorDelay(0);this.rulesViewContainer.setBusy(true);CommunicationBus.publish(channelNames.GET_NON_LOADED_RULE_SETS,{loadedRulesets:this._getLoadedRulesets()})}this.getView().getModel().setProperty("/showRuleProperties",t)},_getLoadedRulesets:function(){var e=this.treeTable.getModel("treeModel").getData(),t=[];Object.keys(e).forEach(function(s){var i=e[s].name;if(i&&i!=="temporary"){t.push(i)}});return t},_syncTreeTableVieModelTempRulesLib:function(e,t){var s,i,o,r,n,l,a=function(e){return e.id===i.id};for(var u in t){s=t[u];o=t[u].nodes;if(s.name!==Constants.TEMP_RULESETS_NAME){continue}t[u].nodes=[];for(var d in e.rules){i=e.rules[d];r=o[d]!==undefined?o[d].selected:true;if(this.tempRulesFromStorage){n=this.tempRulesFromStorage.filter(a);if(n.length>0){r=n[0].selected;l=this.tempRulesFromStorage.indexOf(n[0]);this.tempRulesFromStorage.splice(l,1);if(r===false){s.selected=false}}if(this.tempRulesFromStorage.length===0){this.tempRulesFromStorage.length=null}}s.nodes.push({name:i.title,description:i.description,id:i.id,audiences:i.audiences.toString(),categories:i.categories.toString(),minversion:i.minversion,resolution:i.resolution,title:i.title,selected:r,libName:s.name,check:i.check})}this.model.setProperty("/treeModel",t);return s}},_syncTreeTableVieModelTempRule:function(e,t){var s=this.model.getProperty("/editRuleSource");for(var i in t){if(t[i].name===Constants.TEMP_RULESETS_NAME){for(var o in t[i].nodes){if(t[i].nodes[o].id===s.id){t[i].nodes[o]={name:e.title,description:e.description,id:e.id,audiences:e.audiences,categories:e.categories,minversion:e.minversion,resolution:e.resolution,selected:t[i].nodes[o].selected,title:e.title,libName:t[i].name,check:e.check}}}}}},_hasSelectedComponent:function(){var e=sap.ui.getCore().byId("componentsSelectionContainer").getContent();function t(e){return e.getSelected()}return e.some(t)},onAnalyzeSettings:function(e){CommunicationBus.publish(channelNames.GET_AVAILABLE_COMPONENTS);if(!this._settingsPopover){this._settingsPopover=sap.ui.xmlfragment("sap.ui.support.supportRules.ui.views.AnalyzeSettings",this);this.getView().addDependent(this._settingsPopover)}this._settingsPopover.openBy(e.getSource())},onContextSelect:function(e){if(e.getParameter("selected")){var t=e.getSource(),s=t.getCustomData()[0].getValue(),i=this.model.getProperty("/executionScopes")[s];if(s==="components"&&!this._hasSelectedComponent()){var o=sap.ui.getCore().byId("componentsSelectionContainer").getContent();if(o.length>0){o[0].setSelected(true);this.onScopeComponentSelect(null)}}this.model.setProperty("/analyzeContext",i)}if(Storage.readPersistenceCookie(Constants.COOKIE_NAME)){this.persistExecutionScope()}},onExecutionContextChange:function(e){var t=e.getSource().getValue();if(t){this.model.setProperty("/subtreeExecutionContextId",t)}if(Storage.readPersistenceCookie(Constants.COOKIE_NAME)){this.persistExecutionScope()}},onScopeComponentSelect:function(e){var t=this.model.getProperty("/executionScopeComponents");if(Storage.readPersistenceCookie(Constants.COOKIE_NAME)){Storage.setSelectedScopeComponents(t)}},onBeforePopoverOpen:function(){if(this.model.getProperty("/executionScopeComponents").length===0){CommunicationBus.publish(channelNames.GET_AVAILABLE_COMPONENTS)}},createNewRulePress:function(e){var t=this.model.getProperty("/newEmptyRule");this.model.setProperty("/selectedSetPreviewKey","availableRules");this.model.setProperty("/newRule",jQuery.extend(true,{},t));this.model.setProperty("/tempLink",{href:"",text:""});this.goToCreateRule()},goToRuleProperties:function(){var e=this.byId("rulesNavContainer");e.to(this.byId("rulesDisplayPage"),"show")},createRuleString:function(e){if(!e){return""}var t="{\n",s=0,i=Object.keys(e).length;for(var o in e){var r=e[o];s++;t+="\t";t+=o+": ";if(o==="check"){t+=r.split("\n").join("\n\t")}else{t+=JSON.stringify(r)}if(s<i){t+=","}t+="\n"}t+="}";return t},updateRule:function(){var e=this.model.getProperty("/editRuleSource/id"),t=this.model.getProperty("/editRule");if(this.checkFunctionString(t.check)){CommunicationBus.publish(channelNames.VERIFY_UPDATE_RULE,{oldId:e,updateObj:RuleSerializer.serialize(t)})}},updatesupportRules:function(e){e=RuleSerializer.deserialize(e.sRuleSet);CommunicationBus.publish(channelNames.REQUEST_RULES_MODEL,e);var t=[],s=this;for(var i in e){var o=[],r=e[i].ruleset._mRules;for(var n in r){var l=r[n];l.libName=i;l.selected=true;o.push(l)}t.push({title:i,type:"library",rules:o,selected:true})}var a;if(t[0].rules[0]){a=t[0].rules[0]}else{a=t[1].rules[0]}s.placeTemporaryRulesetAtStart(t);s.model.setProperty("/selectedRuleStringify","");s.model.setProperty("/selectedRule",a);s.model.setProperty("/selectedRuleStringify",s.createRuleString(a));s.model.setProperty("/libraries",t);var u=s.model.getProperty("/loadingAdditionalRuleSets");if(u){MessageToast.show("Additional rule set(s) loaded!");this.ruleSetView.setSelectedKey("availableRules")}},initializeTempRules:function(){var e=Storage.getRules(),t=this.model.getProperty("/loadingAdditionalRuleSets");if(e&&!t&&!this.tempRulesLoaded){this.tempRulesFromStorage=e;this.tempRulesLoaded=true;e.forEach(function(e){CommunicationBus.publish(channelNames.VERIFY_CREATE_RULE,RuleSerializer.serialize(e))});this.persistedTempRulesCount=e.length}},placeTemporaryRulesetAtStart:function(e){for(var t=0;t<e.length;t++){var s=e[t];if(s.title===Constants.TEMP_RULESETS_NAME){var i=s;e.splice(t,1);e.unshift(i);return}}},addLinkToRule:function(e){var t=this.model.getProperty("/tempLink"),s=jQuery.extend(true,{},t),i=e.getSource().getProperty("text"),o=i==="Add"?"/newRule":"/editRule",r=this.model.getProperty(o+"/resolutionurls");if(r){r.push(s)}else{this.model.setProperty(o+"/resolutionurls","");r.push(s)}this.model.setProperty("/tempLink",{href:"",text:""});this.model.checkUpdate(true,true)},goToCreateRule:function(){var e=this.byId("rulesNavContainer");e.to(sap.ui.getCore().byId("rulesCreatePage"),"show")},checkFunctionString:function(functionString){try{eval("var testAsignedVar = "+functionString)}catch(e){MessageToast.show("Your check function contains errors, and can't be evaluated:"+e);return false}return true},addNewRule:function(){var e=this.model.getProperty("/newRule");if(this.checkFunctionString(e.check)){this.showRuleCreatedToast=true;CommunicationBus.publish(channelNames.VERIFY_CREATE_RULE,RuleSerializer.serialize(e))}},rulesToolbarITHSelect:function(e){if(e.getParameter("key")==="jsonOutput"){var t=this.model.getProperty("/newRule"),s=this.createRuleString(t);this.model.setProperty("/newRuleStringified",s)}},rulesToolbarEditITHSelect:function(e){if(e.getParameter("key")==="jsonOutput"){var t=this.model.getProperty("/editRule"),s=this.createRuleString(t);this.model.setProperty("/updateRuleStringified",s)}},loadMarkedSupportLibraries:function(){var e=this.byId("availableLibrariesSet"),t=[],s=this.model.getProperty("/availableLibrariesSet");t=e.getSelectedItems().map(function(e){return e.getTitle()});e.getItems().forEach(function(e){e.setSelected(false)});if(t.length>0){s=s.filter(function(e){return t.indexOf(e)<0});this.model.setProperty("/availableLibrariesSet",s);this.model.setProperty("/namesOfLoadedAdditionalRuleSets",t);CommunicationBus.publish(channelNames.LOAD_RULESETS,{aLibNames:{publicRules:t,internalRules:t}});this.model.setProperty("/loadingAdditionalRuleSets",true);this.model.setProperty("/showRuleProperties",true)}else{MessageToast.show("Select additional RuleSet to be loaded.")}},onCellClick:function(e){if(e.getParameter("rowBindingContext")){var t=e.getParameter("rowBindingContext").getObject(),s,i="",o=false;if(t.id&&t.type!=="lib"){s=this.getMainModelFromTreeViewModel(t);i=this.createRuleString(s);o=true}this.model.setProperty("/selectedRuleStringify",i);this.model.setProperty("/selectedRule",s);this.model.setProperty("/showRuleProperties",o)}},getMainModelFromTreeViewModel:function(e){var t=this.model.getProperty("/libraries"),s=null;t.forEach(function(i,o){t[o].rules.forEach(function(t){if(e.id===t.id){s=t}})});return s},_generateRuleId:function(e){var t=0,s=this.getTemporaryLib(),i=s.rules,o,r=function(s){return s.id===e+t};while(++t){o=i.some(r);if(!o){return e+t}}},duplicateRule:function(e){var t=e.getSource().getBindingContext("treeModel").getPath(),s=this.treeTable.getBinding().getModel().getProperty(t),i=this.getMainModelFromTreeViewModel(s),o=jQuery.extend(true,{},i);o.id=this._generateRuleId(o.id);this.model.setProperty("/newRule",o);this.model.checkUpdate(true,false);this.goToCreateRule()},editRule:function(e){var t=e.getSource().getBindingContext("treeModel").getPath(),s=this.treeTable.getBinding().getModel().getProperty(t),i=this.getMainModelFromTreeViewModel(s);this.model.setProperty("/editRuleSource",i);this.model.setProperty("/editRule",jQuery.extend(true,{},i));this.model.checkUpdate(true,true);var o=this.byId("rulesNavContainer");o.to(sap.ui.getCore().byId("ruleUpdatePage"),"show")},deleteTemporaryRule:function(e){var t=this.getObjectOnTreeRow(e),s=this.treeTable.getBinding().getModel().getData(),i=this.model.getProperty("/libraries"),o;i.forEach(function(e){if(e.title===Constants.TEMP_RULESETS_NAME){o=e.rules.filter(function(e){return e.id!==t.id});e.rules=o}});for(var r in s){if(s[r].name===Constants.TEMP_RULESETS_NAME){for(var n in s[r].nodes){if(s[r].nodes[n].id===t.id){s[r].nodes.splice(n,1)}}}}this.oJsonModel.setData(s);CommunicationBus.publish(channelNames.DELETE_RULE,RuleSerializer.serialize(t));this._updateRuleList();PresetsUtils.syncCurrentSelectionPreset(SelectionUtils.getSelectedRules());if(Storage.readPersistenceCookie(Constants.COOKIE_NAME)){Storage.removeSelectedRules(o);SelectionUtils.persistSelection()}},getObjectOnTreeRow:function(e){var t=e.getSource().getBindingContext("treeModel").getPath(),s=this.treeTable.getBinding().getModel().getProperty(t),i=this.model.getProperty("/libraries");i.forEach(function(e,t){e.rules.forEach(function(e){if(e.id===s.id){s.check=e.check}})});return s},_updateRuleList:function(){var e=this.getView().byId("ruleList"),t=this.getTemporaryLib()["rules"];if(!t.length){e.setRowActionCount(1)}else{e.setRowActionCount(2)}},setColumnVisibility:function(e,t){var s=this.treeTable.getColumns();s.forEach(function(s){s.setVisible(!t);e.forEach(function(e){if(s.sId.includes(e)){s.setVisible(t)}})})},onColumnVisibilityChange:function(e){var t=e.getParameter("column"),s=e.getParameter("newVisible");if(!this.model.getProperty("/persistingSettings")){return}t.setVisible(s);this.persistVisibleColumns()},onPresetVariantClick:function(){if(!this._PresetsController){this._PresetsController=new PresetsController(this.model,this.getView())}this._PresetsController.openPresetVariant()}})});