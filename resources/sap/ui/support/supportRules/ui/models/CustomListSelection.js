/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/deepExtend","sap/ui/base/EventProvider","sap/ui/model/SelectionModel","sap/ui/support/supportRules/ui/models/SharedModel"],function(e,t,n,i){"use strict";function o(e,t){if(!e||!t){return false}var n=sap.ui.require(t);return!!(n&&e instanceof n)}var l={isIndexSelected:function(e){return this._isSelectedInModel(e)},setSelectedIndex:function(e){},getSelectedIndices:function(){return[]},setSelectionInterval:function(e,t){this._doChangeSelection("setSelectionInterval",arguments)},addSelectionInterval:function(e,t){this._doChangeSelection("addSelectionInterval",arguments)},removeSelectionInterval:function(e,t){this._doChangeSelection("removeSelectionInterval",arguments)},selectAll:function(){this._doChangeSelection("selectAll",[this._getBinding().getLength()-1])},getSelectedIndex:function(){return this._getSelectionModel().getLeadSelectedIndex()},clearSelection:function(){if(this._ignoreClearSelection){this._initializeSelectionModel();return}this._doChangeSelection("clearSelection",arguments)},_getSelectedIndicesCount:function(){return this._getSelectionModel().getSelectedIndices().length},_initializeSelectionModel:function(){return this._initializeSelectionModel()},updateSelectionFromModel:function(){return this.updateSelectionFromModel()},syncParentNodeSelectionWithChildren:function(e,t){return this.syncParentNodeSelectionWithChildren(e,t)}};function r(e,t){return function(){return l[e].apply(t,arguments)}}var s=t.extend("sap.ui.support.supportRules.ui.models.CustomListSelection",{constructor:function(e,n){t.call(this);var i=this;this._keys={};this._key=n;this._control=e;this._UITable=o(this._control,"sap/ui/table/Table");this._tree=o(this._control,"sap/ui/table/TreeTable")||o(this._control,"sap/m/Tree");if(this._UITable){this._aggregation="rows";for(var s in l){this._control[s]=r(s,this)}this._control.__onBindingChange=this._control._onBindingChange;this._control._onBindingChange=function(e){i._ignoreClearSelection=true;this.__onBindingChange.apply(this,arguments);if(e.getParameter("reason")!=="filter"&&e.getParameter("reason")!=="sort"){i._ignoreClearSelection=false}};this.attachEvent("selectionChange",function(e){i._getControl()._onSelectionChanged(e)})}else{this._aggregation="items";this._control.attachSelectionChange(function(t){var n=i._getSelectionModel();var o=t.getParameter("listItems");var l=[];for(var r=0;r<o.length;r++){var s=o[r].getSelected();var c=e.indexOfItem(o[r]);l.push(c);if(s){n.addSelectionInterval(c,c)}else{n.removeSelectionInterval(c,c)}}var t=i.oEventPool.borrowObject("selectionChanged",i,{rowIndices:l});i._updateModelAfterSelectionChange(t);i.oEventPool.returnObject(t);i._initializeSelectionModel()});this._control.attachUpdateFinished(function(){i._getSelectionModel(true)});this._doAfterInitSelectionModel=function(){var e=this._getControl().getItems();for(var t=0;t<e.length;t++){e[t].setSelected(this._isSelectedInModel(t),true)}}}if(this._isTree()){e.attachToggleOpenState(function(){i._getSelectionModel(true)})}},attachRowSelectionChange:function(e){this.attachEvent("selectionChange",e)},getSelectedKeys:function(){var e=[];for(var t in this._keys){if(!!this._keys[t]){e.push(t)}}return e},_getControl:function(){return this._control},_isUITable:function(){return this._UITable},_isTree:function(){return this._tree},_getBinding:function(){return this._getControl().getBinding(this._aggregation)},_getContextByIndex:function(e){return this._getBinding().getContexts(e,1)[0]},_getSelectionModel:function(e){if(!this.selectionmodel||e){this._initializeSelectionModel()}return this.selectionmodel},_getSelectedIndicesFromModel:function(){var e=this._getBinding();var t=[];if(e){var n=e.getModel();var i=e.getLength();for(var o=0;o<i;o++){var l=this._getContextByIndex(o);if(!l){return t}if(this._checkSelectionForContext(n,l)){t.push(o)}}}return t},_updateModelAfterSelectionChange:function(e){},updateSelectionFromModel:function(){var e=this._getBinding();var t=e.getModel();var n=t.getData();var i=this._getAllIndicesInModel();var o=this;function l(e,i,r){var s=t.getProperty(e+"/nodes");if(o._isTree()&&o._dependent){if(s&&s.length){for(var c=0;c<s.length;c++){var a=e.split("");l(e+"/nodes/"+c+"",t.getData()[a[1]].nodes[c].selected,true)}}else{var a=e.split("/");o.bTempSelected=true;a.pop();a.pop();var d=a.join("/"),h=d.split("/");if(n[h[1]]){o.bTempSelected=n[h[1]].selected}o._setSelectionForContext(t,t.createBindingContext(d),o.bTempSelected)}}o._setSelectionForContext(t,t.createBindingContext(e),i)}for(var r=0;r<i.length;r++){var s=this._getContextByIndex(i[r]),c=s.getPath(),a=c.split("/"),d=true;if(a[2]){if(n[a[1]].nodes[a[3]]){d=n[a[1]].nodes[a[3]].selected}}else{d=n[a[1]].selected}l(c,d)}this._finalizeSelectionUpdate()},_getAllIndicesInModel:function(){var e=this._getBinding();var t=[];if(e){var n=e.getLength();for(var i=0;i<n;i++){t.push(i)}}return t},_isSelectedInModel:function(e){var t=this._getBinding();var n=t?t.getLength():0;if(!t||e>=n){return false}return this._checkSelectionForContext(t.getModel(),this._getContextByIndex(e))},_finalizeSelectionUpdate:function(){this._initializeSelectionModel();this._getSelectionModel();this._fireRowSelectionChange()},_checkSelectionForContext:function(e,t){var n;if(this._key==="$PATH"){n=t.getPath()}else{n=e.getProperty(this._key,t)}return!!this._keys[n]},_setSelectionForContext:function(e,t,n){var i;if(this._key==="$PATH"){i=t.getPath()}else{i=e.getProperty(this._key,t)}if(n){this._keys[i]=true}else{delete this._keys[i]}},_initializeSelectionModel:function(){if(!this.selectionmodel){this.selectionmodel=new n(n.MULTI_SELECTION)}else{this.selectionmodel.clearSelection()}var e=this._getSelectedIndicesFromModel();for(var t=0;t<e.length;t++){this.selectionmodel.addSelectionInterval(e[t],e[t])}if(this._doAfterInitSelectionModel){this._doAfterInitSelectionModel()}},_doUpdateModelAfterSelectionChange:function(e){this._getSelectionModel().detachSelectionChanged(this._doUpdateModelAfterSelectionChange,this);this._updateModelAfterSelectionChange(e)},_doChangeSelection:function(e,t){var n=this._getSelectionModel();n.attachSelectionChanged(this._doUpdateModelAfterSelectionChange,this);n[e].apply(n,t)},_fireRowSelectionChange:function(){this.fireEvent("selectionChange",{selectedKeys:this.getSelectedKeys()})},syncParentNodeSelectionWithChildren:function(t,n){var o=e({},t);Object.keys(o).forEach(function(e){var t=true;o[e].nodes.forEach(function(n){if(!n.selected){t=false;o[e].selected=false}else if(t){o[e].selected=true}})});i.setProperty("/treeModel",o);n.setData(e({},o))},updateModelAfterChangedSelection:function(e,t,n){var i=t.split("/");if(i[2]){if(e[i[1]].nodes.length!==0){e[i[1]].nodes[i[3]].selected=n}}else{e[i[1]].selected=n}}});return s});