/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./AnalyticalColumn","./Table","./TreeTable","./TableRenderer","./library","sap/ui/model/analytics/ODataModelAdapter","sap/ui/model/SelectionModel","sap/ui/model/Sorter","sap/ui/unified/Menu","sap/ui/unified/MenuItem","./utils/TableUtils","./plugins/BindingSelection","sap/base/Log","sap/base/assert","sap/ui/thirdparty/jquery","sap/base/util/UriParameters"],function(e,t,o,r,n,i,a,s,u,p,l,d,m,f,g,c){"use strict";var h=n.GroupEventType,y=n.SortOrder,_=n.TreeAutoExpandMode;var v=t.extend("sap.ui.table.AnalyticalTable",{metadata:{library:"sap.ui.table",properties:{sumOnTop:{type:"boolean",group:"Appearance",defaultValue:false,deprecated:true},numberOfExpandedLevels:{type:"int",group:"Misc",defaultValue:0,deprecated:true},autoExpandMode:{type:"string",group:"Misc",defaultValue:"Bundled",deprecated:true},columnVisibilityMenuSorter:{type:"any",group:"Appearance",defaultValue:null},collapseRecursive:{type:"boolean",defaultValue:true},dirty:{type:"boolean",group:"Appearance",defaultValue:null,deprecated:true}},designtime:"sap/ui/table/designtime/AnalyticalTable.designtime"},renderer:"sap.ui.table.TableRenderer"});v.prototype._getFixedBottomRowContexts=function(){var e=this.getBinding("rows");if(e){return[e.getGrandTotalNode()]}};v.prototype._getContexts=o.prototype._getContexts;v.prototype._getRowContexts=o.prototype._getRowContexts;v.prototype.init=function(){t.prototype.init.apply(this,arguments);this.addStyleClass("sapUiAnalyticalTable");this.setShowColumnVisibilityMenu(true);this.setEnableColumnFreeze(true);this.setEnableCellFilter(true);this._aGroupedColumns=[];this._bSuspendUpdateAnalyticalInfo=false;this._mGroupHeaderMenuItems=null;l.Grouping.setGroupMode(this);l.Hook.register(this,l.Hook.Keys.Row.UpdateState,this._updateRowState,this);l.Hook.register(this,l.Hook.Keys.Table.OpenMenu,this._onOpenTableContextMenu,this)};v.prototype.exit=function(){t.prototype.exit.apply(this,arguments);this._cleanupGroupHeaderMenuItems()};v.prototype._adaptLocalization=function(e,o){return t.prototype._adaptLocalization.apply(this,arguments).then(function(){if(o){this._cleanupGroupHeaderMenuItems()}}.bind(this))};v.prototype.setFixedRowCount=function(){m.error("The property fixedRowCount is not supported by control sap.ui.table.AnalyticalTable!");return this};v.prototype.setFixedBottomRowCount=function(){m.error("The property fixedBottomRowCount is managed by control sap.ui.table.AnalyticalTable!");return this};v.prototype.setDirty=function(e){m.error("The property dirty of control sap.ui.table.AnalyticalTable is deprecated. Please use showOverlay instead.");this.setProperty("dirty",e,true);this.setShowOverlay(this.getDirty());return this};v.prototype.setEnableGrouping=function(){m.error("The property enableGrouping is not supported by the sap.ui.table.AnalyticalTable control");return this};v.prototype.setGroupBy=function(){m.warning("The groupBy association is not supported by the sap.ui.table.AnalyticalTable control");return this};v.prototype.getModel=function(e){var o=t.prototype.getModel.apply(this,arguments);var r=this.getBindingInfo("rows");if(o&&r&&r.model==e){i.apply(o)}return o};v.prototype._onBindingChange=function(e){t.prototype._onBindingChange.apply(this,arguments);var o=typeof e==="object"?e.getParameter("reason"):e;if(o!=="sort"){this._invalidateColumnMenus()}};v.prototype._bindRows=function(e){this._applyAnalyticalBindingInfo(e);t.prototype._bindRows.call(this,e)};v.prototype._bindAggregation=function(e,o){if(e==="rows"){this._invalidateColumnMenus();this._applyODataModelAnalyticalAdapter(o.model);this.setProperty("firstVisibleRow",0,true)}t.prototype._bindAggregation.call(this,e,o);if(e==="rows"){this._updateTotalRow(true);l.Binding.metadataLoaded(this).then(function(){this._updateColumns(true)}.bind(this))}};v.prototype._applyAnalyticalBindingInfo=function(e){var t=this.getColumns();for(var o=0,r=t.length;o<r;o++){if(t[o].getSorted()){e.sorter=e.sorter||[];e.sorter.push(new s(t[o].getSortProperty()||t[o].getLeadingProperty(),t[o].getSortOrder()===y.Descending))}}e.parameters=e.parameters||{};e.parameters.analyticalInfo=this._getColumnInformation();if(!e.parameters.hasOwnProperty("sumOnTop")){e.parameters.sumOnTop=this.getSumOnTop()}if(!e.parameters.hasOwnProperty("numberOfExpandedLevels")){e.parameters.numberOfExpandedLevels=this.getNumberOfExpandedLevels()}if(e.parameters.numberOfExpandedLevels>this._aGroupedColumns.length){e.parameters.numberOfExpandedLevels=0}if(!e.parameters.hasOwnProperty("autoExpandMode")){var n=this.getAutoExpandMode();if(n!=_.Bundled&&n!=_.Sequential){n=_.Bundled}e.parameters.autoExpandMode=n}};v.prototype._applyODataModelAnalyticalAdapter=function(e){if(e){i.apply(e)}};v.prototype._getColumnInformation=function(){var t=[],o=this.getColumns();for(var r=0;r<this._aGroupedColumns.length;r++){var n=sap.ui.getCore().byId(this._aGroupedColumns[r]);if(!n){continue}t.push({name:n.getLeadingProperty(),visible:n.getVisible(),grouped:n.getGrouped(),total:n.getSummed(),sorted:n.getSorted(),sortOrder:n.getSortOrder(),inResult:n.getInResult(),formatter:n.getGroupHeaderFormatter()})}for(var r=0;r<o.length;r++){var n=o[r];if(this._aGroupedColumns.indexOf(n.getId())>-1){continue}if(!n instanceof e){m.error("You have to use AnalyticalColumns for the Analytical table")}t.push({name:n.getLeadingProperty(),visible:n.getVisible(),grouped:n.getGrouped(),total:n.getSummed(),sorted:n.getSorted(),sortOrder:n.getSortOrder(),inResult:n.getInResult(),formatter:n.getGroupHeaderFormatter()})}return t};v.prototype._updateRowState=function(e){var t=this.getBinding("rows");var o=this.getBindingInfo("rows");var r=e.context;e.context=r.context;if(!e.context){return}if(t.nodeHasChildren(r)){e.type=e.Type.GroupHeader;e.expandable=true}else if(r.nodeState.sum){e.type=e.Type.Summary}e.level=r.level;e.expanded=r.nodeState.expanded;e.contentHidden=e.expanded&&!o.parameters.sumOnTop;e.title=e.type===e.Type.GroupHeader?t.getGroupName(r.context,r.level):""};v.prototype.onRowsUpdated=function(o){t.prototype.onRowsUpdated.apply(this,arguments);var r=this.getRows();var n=this.getBinding("rows");var i=this._getVisibleColumns()[0];for(var a=0;a<r.length;a++){var s=r[a];var u=s.getLevel()-(!s.isGroupHeader()&&!s.isSummary()?1:0);var p=0;for(var d=1;d<u;d++){if(d===1){p=24}else if(d===2){p+=12}else{p+=8}}l.Grouping.setGroupIndent(s,p);var m=s.getCells();var f=m.length;for(var c=0;c<f;c++){var h=e.ofCell(m[c]);var y=n?n.isMeasure(h.getLeadingProperty()):false;var _=g(m[c].$().closest("td"));var v=false;if(s.isSummary()&&y){v=!h.getSummed()}else if(s.isGroupHeader()&&h===i){v=!y}_.toggleClass("sapUiTableCellHidden",v)}}};v.prototype._onOpenTableContextMenu=function(e,t){var o=e.isOfType(l.CELLTYPE.ANYCONTENTCELL)?this.getRows()[e.rowIndex]:null;if(!o||!o.isGroupHeader()){this._removeGroupHeaderMenuItems(t);return}this._iGroupedLevel=o.getLevel();this._addGroupHeaderMenuItems(t)};v.prototype._addGroupHeaderMenuItems=function(e){var t=this;function o(){var e=t._iGroupedLevel-1;if(t._aGroupedColumns[e]){var o=t.getColumns().filter(function(o){return t._aGroupedColumns[e]===o.getId()})[0];return{column:o,index:e}}else{return undefined}}if(!this._mGroupHeaderMenuItems){this._mGroupHeaderMenuItems={}}if(!this._mGroupHeaderMenuItems["visibility"]){this._mGroupHeaderMenuItems["visibility"]=new p({text:l.getResourceText("TBL_SHOW_COLUMN"),select:function(){var e=o();if(e){var r=e.column,n=r.getShowIfGrouped();r.setShowIfGrouped(!n);t.fireGroup({column:r,groupedColumns:r.getParent()._aGroupedColumns,type:!n?h.showGroupedColumn:h.hideGroupedColumn})}}})}e.addItem(this._mGroupHeaderMenuItems["visibility"]);if(!this._mGroupHeaderMenuItems["ungroup"]){this._mGroupHeaderMenuItems["ungroup"]=new p({text:l.getResourceText("TBL_UNGROUP"),select:function(){var e=o();if(e&&e.column){var r=e.column;r.setGrouped(false);t.fireGroup({column:r,groupedColumns:t._aGroupedColumns,type:h.ungroup})}}})}e.addItem(this._mGroupHeaderMenuItems["ungroup"]);if(!this._mGroupHeaderMenuItems["ungroupall"]){this._mGroupHeaderMenuItems["ungroupall"]=new p({text:l.getResourceText("TBL_UNGROUP_ALL"),select:function(){var e=t.getColumns();t.suspendUpdateAnalyticalInfo();for(var o=0;o<e.length;o++){e[o].setGrouped(false)}t.resumeUpdateAnalyticalInfo();t.fireGroup({column:undefined,groupedColumns:[],type:h.ungroupAll})}})}e.addItem(this._mGroupHeaderMenuItems["ungroupall"]);if(!this._mGroupHeaderMenuItems["moveup"]){this._mGroupHeaderMenuItems["moveup"]=new p({text:l.getResourceText("TBL_MOVE_UP"),select:function(){var e=o();if(e){var r=e.column;var n=t._aGroupedColumns.indexOf(r.getId());if(n>0){t._aGroupedColumns[n]=t._aGroupedColumns.splice(n-1,1,t._aGroupedColumns[n])[0];t.updateAnalyticalInfo();t.fireGroup({column:r,groupedColumns:r.getParent()._aGroupedColumns,type:h.moveUp})}}},icon:"sap-icon://arrow-top"})}e.addItem(this._mGroupHeaderMenuItems["moveup"]);if(!this._mGroupHeaderMenuItems["movedown"]){this._mGroupHeaderMenuItems["movedown"]=new p({text:l.getResourceText("TBL_MOVE_DOWN"),select:function(){var e=o();if(e){var r=e.column;var n=t._aGroupedColumns.indexOf(r.getId());if(n<t._aGroupedColumns.length){t._aGroupedColumns[n]=t._aGroupedColumns.splice(n+1,1,t._aGroupedColumns[n])[0];t.updateAnalyticalInfo();t.fireGroup({column:r,groupedColumns:r.getParent()._aGroupedColumns,type:h.moveDown})}}},icon:"sap-icon://arrow-bottom"})}e.addItem(this._mGroupHeaderMenuItems["movedown"]);if(!this._mGroupHeaderMenuItems["sortasc"]){this._mGroupHeaderMenuItems["sortasc"]=new p({text:l.getResourceText("TBL_SORT_ASC"),select:function(){var e=o();if(e){var t=e.column;t.sort(false)}},icon:"sap-icon://up"})}e.addItem(this._mGroupHeaderMenuItems["sortasc"]);if(!this._mGroupHeaderMenuItems["sortdesc"]){this._mGroupHeaderMenuItems["sortdesc"]=new p({text:l.getResourceText("TBL_SORT_DESC"),select:function(){var e=o();if(e){var t=e.column;t.sort(true)}},icon:"sap-icon://down"})}e.addItem(this._mGroupHeaderMenuItems["sortdesc"]);if(!this._mGroupHeaderMenuItems["collapse"]){this._mGroupHeaderMenuItems["collapse"]=new p({text:l.getResourceText("TBL_COLLAPSE_LEVEL"),select:function(){t.getBinding("rows").collapseToLevel(t._iGroupedLevel-1);t.setFirstVisibleRow(0);t._getSelectionPlugin().clearSelection()}})}e.addItem(this._mGroupHeaderMenuItems["collapse"]);if(!this._mGroupHeaderMenuItems["collapseall"]){this._mGroupHeaderMenuItems["collapseall"]=new p({text:l.getResourceText("TBL_COLLAPSE_ALL"),select:function(){t.getBinding("rows").collapseToLevel(0);t.setFirstVisibleRow(0);t._getSelectionPlugin().clearSelection()}})}e.addItem(this._mGroupHeaderMenuItems["collapseall"]);if(!this._mGroupHeaderMenuItems["expand"]){this._mGroupHeaderMenuItems["expand"]=new p({text:l.getResourceText("TBL_EXPAND_LEVEL"),select:function(){t.getBinding("rows").expandToLevel(t._iGroupedLevel);t.setFirstVisibleRow(0);t._getSelectionPlugin().clearSelection()}})}e.addItem(this._mGroupHeaderMenuItems["expand"]);if(!this._mGroupHeaderMenuItems["expandall"]){this._mGroupHeaderMenuItems["expandall"]=new p({text:l.getResourceText("TBL_EXPAND_ALL"),select:function(){t.expandAll()}})}e.addItem(this._mGroupHeaderMenuItems["expandall"]);var r=o();if(r){var n=r.column;if(n.getShowIfGrouped()){this._mGroupHeaderMenuItems["visibility"].setText(l.getResourceText("TBL_HIDE_COLUMN"))}else{this._mGroupHeaderMenuItems["visibility"].setText(l.getResourceText("TBL_SHOW_COLUMN"))}this._mGroupHeaderMenuItems["moveup"].setEnabled(r.index>0);this._mGroupHeaderMenuItems["movedown"].setEnabled(r.index<this._aGroupedColumns.length-1)}else{this._mGroupHeaderMenuItems["moveup"].setEnabled(true);this._mGroupHeaderMenuItems["movedown"].setEnabled(true)}};v.prototype._removeGroupHeaderMenuItems=function(e){if(!this._mGroupHeaderMenuItems){return}for(var t in this._mGroupHeaderMenuItems){e.removeItem(this._mGroupHeaderMenuItems[t])}};v.prototype._cleanupGroupHeaderMenuItems=function(){for(var e in this._mGroupHeaderMenuItems){this._mGroupHeaderMenuItems[e].destroy()}this._mGroupHeaderMenuItems=null};v.prototype.getContextByIndex=function(e){var t=this.getBinding("rows");return e>=0&&t?t.getContextByIndex(e):null};v.prototype.getContextInfoByIndex=function(e){var t=this.getBinding("rows");return e>=0&&t?t.getNodeByIndex(e):null};v.prototype.suspendUpdateAnalyticalInfo=function(){this._bSuspendUpdateAnalyticalInfo=true};v.prototype.resumeUpdateAnalyticalInfo=function(e,t){this._bSuspendUpdateAnalyticalInfo=false;this._updateColumns(e,t)};v.prototype.addColumn=function(e,o){var r=this._getColumn(e);if(r.getGrouped()){this._addGroupedColumn(r.getId())}t.prototype.addColumn.call(this,r,o);this._updateColumns(o);return this};v.prototype.insertColumn=function(e,o,r){var n=this._getColumn(e);if(n.getGrouped()){this._addGroupedColumn(n.getId())}t.prototype.insertColumn.call(this,n,o,r);this._updateColumns(r);return this};v.prototype.removeColumn=function(e,o){var r=t.prototype.removeColumn.apply(this,arguments);if(!this._bReorderInProcess){this._aGroupedColumns=g.grep(this._aGroupedColumns,function(t){if(e.getId){return t!=e.getId()}else{return t==e}})}this.updateAnalyticalInfo(o);return r};v.prototype.removeAllColumns=function(e){this._aGroupedColumns=[];var o=t.prototype.removeAllColumns.apply(this,arguments);this._updateColumns(e);return o};v.prototype._getColumn=function(t){if(typeof t==="string"){var o=new e({leadingProperty:t,template:t,managed:true});return o}else if(t instanceof e){return t}else{throw new Error("Wrong column type. You need to define a string (property) or pass an AnalyticalColumnObject")}};v.prototype._updateColumns=function(e,t){if(!this._bSuspendUpdateAnalyticalInfo){this._updateTableColumnDetails();this.updateAnalyticalInfo(e,t);if(this.bOutput){this.invalidate()}}};v.prototype.updateAnalyticalInfo=function(e,t){if(this._bSuspendUpdateAnalyticalInfo){return}var o=this.getBinding("rows");if(o){var r=this._getColumnInformation();var n=o.getNumberOfExpandedLevels()||0;if(n>this._aGroupedColumns.length){o.setNumberOfExpandedLevels(0)}o.updateAnalyticalInfo(r,t);this._updateTotalRow(e);if(!e){this._getRowContexts()}}};v.prototype.refreshRows=function(){t.prototype.refreshRows.apply(this,arguments);this._updateTotalRow()};v.prototype._updateTotalRow=function(e){var t=this.getBinding("rows");var o=0;var r=this.getRowMode();if(t&&(t.providesGrandTotal()&&t.hasTotaledMeasures())){o=1}if(r){r.setProperty("fixedBottomRowCount",o,e)}else{this.setProperty("fixedBottomRowCount",o,e)}};v.prototype._updateTableColumnDetails=function(){if(this._bSuspendUpdateAnalyticalInfo){return}var e=this.getBinding("rows"),t=e&&e.getAnalyticalQueryResult();if(t){var o=this.getColumns(),r=[],n=[],i=[],a={},s,u;for(var p=0;p<o.length;p++){s=o[p];s._isLastGroupableLeft=false;s._bLastGroupAndGrouped=false;s._bDependendGrouped=false;if(!s.getVisible()){continue}var l=s.getLeadingProperty();u=t.findDimensionByPropertyName(l);if(u){var d=u.getName();if(!a[d]){a[d]={dimension:u,columns:[s]}}else{a[d].columns.push(s)}if(s.getGrouped()&&r.indexOf(d)==-1){r.push(d)}if(i.indexOf(d)==-1){i.push(d)}}}n=g.grep(i,function(e){return r.indexOf(r,e)==-1});if(r.length>0){g.each(r,function(e,t){g.each(a[t].columns,function(e,t){if(!t.getGrouped()){t._bDependendGrouped=true}})});if(r.length==i.length){u=t.findDimensionByPropertyName(sap.ui.getCore().byId(this._aGroupedColumns[this._aGroupedColumns.length-1]).getLeadingProperty());var m=a[u.getName()].columns;g.each(m,function(e,t){t._bLastGroupAndGrouped=true})}}if(n.length==1){g.each(a[n[0]].columns,function(e,t){t._isLastGroupableLeft=true})}}};v.prototype._getFirstMeasureColumnIndex=function(){var e=this.getBinding("rows"),t=e&&e.getAnalyticalQueryResult(),o=this._getVisibleColumns();if(!t){return-1}for(var r=0;r<o.length;r++){var n=o[r],i=n.getLeadingProperty();if(t.findMeasureByName(i)||t.findMeasureByPropertyName(i)){return r}}};v.prototype.getTotalSize=function(){var e=this.getBinding("rows");if(e){return e.getTotalSize()}return 0};v.prototype._onPersoApplied=function(){t.prototype._onPersoApplied.apply(this,arguments);this._aGroupedColumns=[];var e=this.getColumns();for(var o=0,r=e.length;o<r;o++){if(e[o].getGrouped()){this._addGroupedColumn(e[o].getId())}}this._updateColumns()};v.prototype._addGroupedColumn=function(e){if(this._aGroupedColumns.indexOf(e)===-1){this._aGroupedColumns.push(e)}};v.prototype._removeGroupedColumn=function(e){var t=this._aGroupedColumns.indexOf(e);if(t>=0){this._aGroupedColumns.splice(t,1)}};v.prototype.getGroupedColumns=function(){return this._aGroupedColumns};v.prototype.setCollapseRecursive=function(e){var t=this.getBinding("rows");if(t){f(t.setCollapseRecursive,"Collapse Recursive is not supported by the used binding");if(t.setCollapseRecursive){t.setCollapseRecursive(e)}}this.setProperty("collapseRecursive",!!e,true);return this};v.prototype.expand=o.prototype.expand;v.prototype.collapse=o.prototype.collapse;v.prototype.expandAll=function(){var e=this.getBinding("rows");if(e){e.expandToLevel(this._aGroupedColumns.length);this.setFirstVisibleRow(0);this._getSelectionPlugin().clearSelection()}return this};v.prototype.collapseAll=o.prototype.collapseAll;v.prototype.isExpanded=o.prototype.isExpanded;v.prototype.getAnalyticalInfoOfRow=function(e){var t=this.getBinding("rows");var o=e?e.getRowBindingContext():null;if(!l.isA(e,"sap.ui.table.Row")||e.getParent()!==this||!t||!o){return null}var r=o===t.getGrandTotalContext();var n=null;var i=-1;if(r){n=t.getGrandTotalContextInfo();i=0}else{n=this.getContextInfoByIndex(e.getIndex());if(n){i=n.level}}var a=n&&t.nodeHasChildren&&t.nodeHasChildren(n);var s=!a&&!r&&n&&n.nodeState&&n.nodeState.sum;var u=[];if(s||a){var p=this.getGroupedColumns();if(p.length>0&&i>0&&i<=p.length){for(var d=0;d<i;d++){u.push(p[d])}}}return{grandTotal:r,group:a,groupTotal:s,level:i,context:o,groupedColumns:u}};v.prototype.setRowMode=function(e){t.prototype.setRowMode.apply(this,arguments);this._getRowMode().disableFixedRows()};v.prototype._initLegacyRowMode=function(e){t.prototype._initLegacyRowMode.apply(this,arguments);this._getRowMode().disableFixedRows()};v.prototype._createLegacySelectionPlugin=function(){return new d};return v});