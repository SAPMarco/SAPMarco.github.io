/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/core/library","sap/ui/core/Popup","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/Sorter","sap/ui/model/Type","sap/ui/model/type/String","./utils/TableUtils","./library","./ColumnMenu","sap/base/util/ObjectPath","sap/base/util/JSTokenizer","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,t,r,i,n,o,a,s,l,u,p,f,g,h,d,y){"use strict";var c=t.HorizontalAlign,m=p.SortOrder,b=t.ValueState;var v={Standard:"Standard",Creation:"Creation"};var _=new window.WeakMap;var T=e.extend("sap.ui.table.Column",{metadata:{library:"sap.ui.table",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},minWidth:{type:"int",group:"Dimension",defaultValue:0},flexible:{type:"boolean",group:"Behavior",defaultValue:true,deprecated:true},resizable:{type:"boolean",group:"Behavior",defaultValue:true},hAlign:{type:"sap.ui.core.HorizontalAlign",group:"Appearance",defaultValue:c.Begin},sorted:{type:"boolean",group:"Appearance",defaultValue:false},sortOrder:{type:"sap.ui.table.SortOrder",group:"Appearance",defaultValue:m.Ascending},sortProperty:{type:"string",group:"Behavior",defaultValue:null},filtered:{type:"boolean",group:"Appearance",defaultValue:false},filterProperty:{type:"string",group:"Behavior",defaultValue:null},filterValue:{type:"string",group:"Behavior",defaultValue:null},filterOperator:{type:"string",group:"Behavior",defaultValue:null},defaultFilterOperator:{type:"string",group:"Behavior",defaultValue:null},filterType:{type:"any",group:"Misc",defaultValue:null},grouped:{type:"boolean",group:"Appearance",defaultValue:false},visible:{type:"boolean",group:"Appearance",defaultValue:true},name:{type:"string",group:"Appearance",defaultValue:null},showFilterMenuEntry:{type:"boolean",group:"Appearance",defaultValue:true},showSortMenuEntry:{type:"boolean",group:"Appearance",defaultValue:true},headerSpan:{type:"any",group:"Behavior",defaultValue:1},autoResizable:{type:"boolean",group:"Behavior",defaultValue:false}},defaultAggregation:"label",aggregations:{label:{type:"sap.ui.core.Control",altTypes:["string"],multiple:false},multiLabels:{type:"sap.ui.core.Control",multiple:true,singularName:"multiLabel"},template:{type:"sap.ui.core.Control",altTypes:["string"],multiple:false},creationTemplate:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},menu:{type:"sap.ui.unified.Menu",multiple:false}},events:{columnMenuOpen:{allowPreventDefault:true,parameters:{menu:{type:"sap.ui.unified.Menu"}}}}}});T._DEFAULT_FILTER_TYPE=new l;T.prototype.init=function(){this.mSkipPropagation={template:true,creationTemplate:true};this._oSorter=null;this._initTemplateClonePool()};T.prototype._initTemplateClonePool=function(){this._mTemplateClones=Object.keys(v).reduce(function(e,t){e[t]=[];return e},{})};T.prototype.exit=function(){this._destroyTemplateClones();f._destroyColumnVisibilityMenuItem(this.oParent)};T.prototype.setParent=function(t,r,i){f._destroyColumnVisibilityMenuItem(this.oParent);var n=e.prototype.setParent.apply(this,arguments);var o=this.getAggregation("menu");if(o&&typeof o._updateReferences==="function"){o._updateReferences(this)}return n};T.prototype.invalidate=function(t){if(t!==this.getTemplate()&&t!==this.getCreationTemplate()&&!u.isA(t,"sap.ui.table.ColumnMenu")){e.prototype.invalidate.apply(this,arguments)}};T.prototype.setLabel=function(e){var t=e;if(typeof e==="string"){t=p.TableHelper.createLabel({text:e})}this.setAggregation("label",t);return this};T.prototype.setTemplate=function(e){var t=e;var r=this._getTable();var i=this.getTemplate();if(typeof e==="string"){t=p.TableHelper.createTextView().bindProperty("text",e)}this.setAggregation("template",t,true);if(this.getVisible()){this.invalidate()}this._destroyTemplateClones("Standard");if(r&&this.getVisible()){if(t){r.invalidateRowsAggregation()}if(!i||!t){var n=r.getCreationRow();if(n){n._update()}}}return this};T.prototype.destroyTemplate=function(){this.destroyAggregation("template");this._destroyTemplateClones("Standard");var e=this._getTable();var t=e?e.getCreationRow():null;if(t){t._update()}return this};T.prototype.setCreationTemplate=function(e){var t=this._getTable();this.setAggregation("creationTemplate",e,true);this._destroyTemplateClones("Creation");if(e&&t&&this.getVisible()){var r=t.getCreationRow();if(r){r._update()}}return this};T.prototype.getCreationTemplate=function(){return this.getAggregation("creationTemplate")};T.prototype.destroyCreationTemplate=function(){this.destroyAggregation("creationTemplate",true);this._destroyTemplateClones("Creation");return this};T.prototype.getMenu=function(){var e=this.getAggregation("menu");if(!e){e=this._createMenu();this.setMenu(e)}return e};T.prototype.invalidateMenu=function(){var e=this.getAggregation("menu");if(this._bMenuIsColumnMenu){e._invalidate()}};T.prototype._menuHasItems=function(){var e=this.getAggregation("menu");var t=this._getTable();var r=this.isSortableByMenu()||this.isFilterableByMenu()||this.isGroupable()||t&&t.getEnableColumnFreeze()||t&&t.getShowColumnVisibilityMenu();var i=false;var n=false;var o=function(){if(i){throw new Error(u.Hook.Keys.Column.MenuItemNotification+" hook:"+" The notification function cannot be called asynchronously.")}n=true};u.Hook.call(t,u.Hook.Keys.Column.MenuItemNotification,this,o);i=true;return!!(e&&e.getItems().length>0||r||n)};T.prototype.isFilterableByMenu=function(){return!!(this.getFilterProperty()&&this.getShowFilterMenuEntry())};T.prototype.isSortableByMenu=function(){return!!(this.getSortProperty()&&this.getShowSortMenuEntry())};T.prototype.isGroupable=function(){var e=this.getParent();return!!(e&&e.getEnableGrouping&&e.getEnableGrouping()&&this.getSortProperty())};T.prototype.setMenu=function(e){this.setAggregation("menu",e,true);this._bMenuIsColumnMenu=u.isA(e,"sap.ui.table.ColumnMenu");return this};T.prototype._createMenu=function(){if(!this._defaultMenu){this._defaultMenu=new f(this.getId()+"-menu",{ariaLabelledBy:this})}return this._defaultMenu};T.prototype.setSortProperty=function(e){this.setProperty("sortProperty",e);this.invalidateMenu();return this};T.prototype.setSorted=function(e){this.setProperty("sorted",e,true);this._updateIcons();return this};T.prototype.setSortOrder=function(e){this.setProperty("sortOrder",e,true);this._updateIcons();return this};T.prototype.setFilterProperty=function(e){this.invalidateMenu();return this.setProperty("filterProperty",e)};T.prototype.setFiltered=function(e){this.setProperty("filtered",e,true);this._updateIcons();return this};T.prototype.setFilterValue=function(e){this.setProperty("filterValue",e,true);var t=this.getMenu();if(this._bMenuIsColumnMenu){t._setFilterValue(e)}return this};T.prototype.setFilterOperator=function(e){return this.setProperty("filterOperator",e,true)};T.prototype._openMenu=function(e){var t=this.getMenu();if(!this._menuHasItems()){return false}var i=this.fireColumnMenuOpen({menu:t});if(i){var n=r.Dock;var o=e;if(!e){e=this.getDomRef();o=this.getFocusDomRef()}t.open(null,o,n.BeginTop,n.BeginBottom,e);return true}else{return true}};T.prototype.toggleSort=function(){this.sort(this.getSorted()&&this.getSortOrder()===m.Ascending)};T.prototype.sort=function(e,t){var r=this.getParent();if(r){r.pushSortedColumn(this,t);var i=e?m.Descending:m.Ascending;var n=r.fireSort({column:this,sortOrder:i,columnAdded:t});if(n){var o=r.getSortedColumns();var s=r.getColumns();for(var l=0,u=s.length;l<u;l++){if(o.indexOf(s[l])<0){s[l].setProperty("sorted",false,true);s[l].setProperty("sortOrder",m.Ascending,true);s[l]._updateIcons(true);delete s[l]._oSorter}}this.setProperty("sorted",true,true);this.setProperty("sortOrder",i,true);this._oSorter=new a(this.getSortProperty(),this.getSortOrder()===m.Descending);var p=[];for(var l=0,u=o.length;l<u;l++){o[l]._updateIcons(true);p.push(o[l]._oSorter)}r._resetColumnHeaderHeights();r._updateRowHeights(r._collectRowHeights(true),true);var f=r.getBinding("rows");if(f){if(this._updateTableAnalyticalInfo){this._updateTableAnalyticalInfo(true)}f.sort(p)}else{d.warning("Sorting not performed because no binding present",this)}}}return this};T.prototype._updateIcons=function(e){var t=this.getParent(),r=this.getSorted(),i=this.getFiltered();if(!t||!t.getDomRef()){return}this.$().parents(".sapUiTableCHT").find('td[data-sap-ui-colindex="'+this.getIndex()+'"]:not([colspan]):not(.sapUiTableHidden):first').toggleClass("sapUiTableColFiltered",i).toggleClass("sapUiTableColSorted",r).toggleClass("sapUiTableColSortedD",r&&this.getSortOrder()===m.Descending);t._getAccExtension().updateAriaStateOfColumn(this);if(!e){t._resetColumnHeaderHeights();t._updateRowHeights(t._collectRowHeights(true),true)}};T.prototype._renderSortIcon=function(){this._updateIcons()};T.prototype._getFilter=function(){var e,t=this.getFilterProperty(),r=this.getFilterValue(),o=this.getFilterOperator(),a,s,u=this.getFilterType()||T._DEFAULT_FILTER_TYPE,p=u instanceof l,f;if(r){if(!o){f=r.match(/(.*)\s*\.\.\s*(.*)/);if(r.indexOf("=")==0){o=n.EQ;a=r.substr(1)}else if(r.indexOf("!=")==0){o=n.NE;a=r.substr(2)}else if(r.indexOf("<=")==0){o=n.LE;a=r.substr(2)}else if(r.indexOf("<")==0){o=n.LT;a=r.substr(1)}else if(r.indexOf(">=")==0){o=n.GE;a=r.substr(2)}else if(r.indexOf(">")==0){o=n.GT;a=r.substr(1)}else if(f){if(f[1]&&f[2]){o=n.BT;a=f[1];s=f[2]}else if(f[1]&&!f[2]){o=n.GE;a=f[1]}else{o=n.LE;a=f[2]}}else if(p&&r.indexOf("*")==0&&r.lastIndexOf("*")==r.length-1){o=n.Contains;a=r.substr(1,r.length-2)}else if(p&&r.indexOf("*")==0){o=n.EndsWith;a=r.substr(1)}else if(p&&r.lastIndexOf("*")==r.length-1){o=n.StartsWith;a=r.substr(0,r.length-1)}else{if(this.getDefaultFilterOperator()){o=this.getDefaultFilterOperator()}else{if(p){o=n.Contains}else{o=n.EQ}}a=r.substr(0)}if(!s){e=new i(t,o,this._parseFilterValue(a))}else{e=new i(t,o,this._parseFilterValue(a),this._parseFilterValue(s))}}else{e=new i(t,o,this._parseFilterValue(r))}}return e};T.prototype.filter=function(e){var t=this.getParent();if(t&&t.isBound("rows")){var r=t.fireFilter({column:this,value:e});if(r){this.setProperty("filtered",!!e,true);this.setProperty("filterValue",e,true);var i=this.getMenu();if(this._bMenuIsColumnMenu){i._setFilterValue(e)}var n=[];var a=t.getColumns();for(var s=0,l=a.length;s<l;s++){var u=a[s],p;i=u.getMenu();try{p=u._getFilter();if(u._bMenuIsColumnMenu){i._setFilterState(b.None)}}catch(e){if(u._bMenuIsColumnMenu){i._setFilterState(b.Error)}continue}if(p){n.push(p)}}t.getBinding("rows").filter(n,o.Control);this._updateIcons()}}return this};T.prototype._parseFilterValue=function(e){var t=this.getFilterType();if(t){if(y.isFunction(t)){e=t(e)}else{e=t.parseValue(e,"string")}}return e};T.prototype.shouldRender=function(){return this.getVisible()&&!this.getGrouped()&&this.getTemplate()!=null};T.prototype.setProperty=function(t,r){var i=this._getTable();var n=i&&t==="visible"&&this.getProperty(t)!=r;var o=e.prototype.setProperty.apply(this,arguments);if(n){i.invalidateRowsAggregation();var a=i.getCreationRow();if(a){a._update()}}return o};T.prototype.setFilterType=function(e){var t=e;if(typeof e==="string"){try{var r=h.parseJS(e);if(typeof r.type==="string"){var i=g.get(r.type);t=i&&new i(r.formatOptions,r.constraints)}}catch(r){var i=g.get(e);t=i&&new i}if(!(t instanceof s)){d.error("The filter type is not an instance of sap.ui.model.Type! Ignoring the filter type!");t=undefined}}this.setProperty("filterType",t,true);return this};T.prototype.getIndex=function(){var e=this.getParent();if(e){return e.indexOfColumn(this)}else{return-1}};T.prototype._getFreeTemplateClone=function(e){var t=this._mTemplateClones[e];var r=null;if(!t){return null}for(var i=0;i<t.length;i++){if(!t[i]||t[i].bIsDestroyed){t.splice(i,1);i--}else if(!r&&!t[i].getParent()){r=t[i]}}return r};T.prototype.getTemplateClone=function(e,t){if(typeof e!=="number"||this.getTemplate()==null){return null}var r=t==null?"Standard":t;var i=this._getFreeTemplateClone(r);if(!i&&v.hasOwnProperty(r)){var n=this["get"+(r==="Standard"?"":r)+"Template"];var o=n.call(this);if(o){i=o.clone();this._mTemplateClones[r].push(i)}}if(i){_.set(i,this);var a=this.getParent();if(a){a._getAccExtension().addColumnHeaderLabel(this,i)}}return i};function C(e){for(var t=0;t<e.length;t++){if(e[t]!=null&&!e[t].bIsDestroyed){e[t].destroy()}}}T.prototype._destroyTemplateClones=function(e){if(e==null){for(var t in v){C(this._mTemplateClones[t])}this._initTemplateClonePool()}else{C(this._mTemplateClones[e]);this._mTemplateClones[e]=[]}};T.prototype._closeMenu=function(){var e=this.getAggregation("menu");if(e){e.close()}};T.prototype.setVisible=function(e){this.setProperty("visible",e);f._updateVisibilityIcon(this.getParent(),this.getIndex(),e);return this};T.prototype._getTable=function(){var e=this.getParent();return u.isA(e,"sap.ui.table.Table")?e:null};T.ofCell=function(e){return _.get(e)||null};return T});