/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/unified/Menu","sap/ui/unified/MenuItem","sap/ui/unified/MenuTextFieldItem","sap/ui/unified/MenuRenderer","sap/ui/Device","./utils/TableUtils","sap/base/assert","sap/ui/thirdparty/jquery"],function(e,t,i,n,o,u,s,a,l){"use strict";var r=t.extend("sap.ui.table.ColumnMenu",{metadata:{library:"sap.ui.table"},renderer:"sap.ui.unified.MenuRenderer"});r.prototype.init=function(){if(t.prototype.init){t.prototype.init.apply(this,arguments)}this.addStyleClass("sapUiTableColumnMenu");this._bInvalidated=true;this._iPopupClosedTimeoutId=null;this._oColumn=null;this._oTable=null;this._attachPopupClosed()};r.prototype.exit=function(){if(t.prototype.exit){t.prototype.exit.apply(this,arguments)}window.clearTimeout(this._iPopupClosedTimeoutId);this._oColumn=this._oTable=null};r.prototype.onThemeChanged=function(){if(this.getDomRef()){this._invalidate()}};r.prototype.setParent=function(e){this._invalidate();this._updateReferences(e);return t.prototype.setParent.apply(this,arguments)};r.prototype._updateReferences=function(e){this._oColumn=e;if(this._oColumn){a(s.isA(this._oColumn,"sap.ui.table.Column"),"ColumnMenu.setParent: parent must be a subclass of sap.ui.table.Column");this._oTable=this._oColumn.getParent();if(this._oTable){a(s.isA(this._oTable,"sap.ui.table.Table"),"ColumnMenu.setParent: parent of parent must be subclass of sap.ui.table.Table")}}};r._destroyColumnVisibilityMenuItem=function(e){if(!e||!e._oColumnVisibilityMenuItem){return}e._oColumnVisibilityMenuItem.destroy();e._oColumnVisibilityMenuItem=null};r.prototype._removeColumnVisibilityFromAggregation=function(){if(!this.oParent||!this.oParent._oColumnVisibilityMenuItem){return}this.removeAggregation("items",this.oParent._oColumnVisibilityMenuItem,true)};r.prototype._invalidate=function(){this._bInvalidated=true};r.prototype._attachPopupClosed=function(){var e=this;if(!u.support.touch){this.getPopup().attachClosed(function(){e._iPopupClosedTimeoutId=window.setTimeout(function(){if(e._oColumn){if(e._lastFocusedDomRef){e._lastFocusedDomRef.focus()}else{e._oColumn.focus()}}},0)})}};r.prototype.open=function(){if(this._bInvalidated){this._bInvalidated=false;this._removeColumnVisibilityFromAggregation();this.destroyItems();this._addMenuItems()}else if(this._oColumn){this._addColumnVisibilityMenuItem()}s.Hook.call(this._oTable,s.Hook.Keys.Table.OpenMenu,s.getCellInfo(arguments[4]),this);if(this.getItems().length>0){this._lastFocusedDomRef=arguments[4];t.prototype.open.apply(this,arguments)}};r.prototype._addMenuItems=function(){if(this._oColumn){this._addSortMenuItem(false);this._addSortMenuItem(true);this._addFilterMenuItem();this._addGroupMenuItem();this._addFreezeMenuItem();this._addColumnVisibilityMenuItem()}};r.prototype._addSortMenuItem=function(e){var t=this._oColumn;if(t.isSortableByMenu()){var i=e?"desc":"asc";var n=e?"sort-descending":"sort-ascending";this.addItem(this._createMenuItem(i,"TBL_SORT_"+i.toUpperCase(),n,function(i){t.sort(e,i.getParameter("ctrlKey")===true)}))}};r.prototype._addFilterMenuItem=function(){var e=this._oColumn;if(e.isFilterableByMenu()){var t=e.getParent();var i=t&&t.getEnableCustomFilter();if(i){this.addItem(this._createMenuItem("filter","TBL_FILTER_ITEM","filter",function(){t.fireCustomFilter({column:e})}))}else{this.addItem(this._createMenuTextFieldItem("filter","TBL_FILTER","filter",e.getFilterValue(),function(){e.filter(this.getValue())}))}}};r.prototype._addGroupMenuItem=function(){var e=this._oColumn;if(e.isGroupable()){var t=this._oTable;this.addItem(this._createMenuItem("group","TBL_GROUP",null,function(){t.setGroupBy(e)}))}};r.prototype._addFreezeMenuItem=function(){var e=this._oColumn;var t=this._oTable;var i=t&&t.getEnableColumnFreeze();if(i){var n=e.getIndex();var o=n+s.Column.getHeaderSpan(e)==t.getComputedFixedColumnCount();this.addItem(this._createMenuItem("freeze",o?"TBL_UNFREEZE":"TBL_FREEZE",null,function(){var i=t.fireColumnFreeze({column:e});if(i){if(o){t.setFixedColumnCount(0)}else{t.setFixedColumnCount(n+1)}}}))}};r.prototype._addColumnVisibilityMenuItem=function(){var e=this._oTable;if(e&&e.getShowColumnVisibilityMenu()){if(e._oColumnVisibilityMenuItem&&!e._oColumnVisibilityMenuItem.bIsDestroyed){this.addItem(e._oColumnVisibilityMenuItem);return}e._oColumnVisibilityMenuItem=this._createMenuItem("column-visibilty","TBL_COLUMNS");var i=new t(e._oColumnVisibilityMenuItem.getId()+"-menu");e._oColumnVisibilityMenuItem.setSubmenu(i);var n=e.getColumns();if(e.getColumnVisibilityMenuSorter&&typeof e.getColumnVisibilityMenuSorter==="function"){var o=e.getColumnVisibilityMenuSorter();if(typeof o==="function"){n=n.sort(o)}}var u=e.getBinding();var a=s.isA(u,"sap.ui.model.analytics.AnalyticalBinding");var l=e._getVisibleColumns();for(var r=0,m=n.length;r<m;r++){var p=n[r];if(a&&p.isA("sap.ui.table.AnalyticalColumn")){var d=u.getAnalyticalQueryResult();var f=d.getEntityType();var c=u.getModel().getProperty("/#"+f.getTypeDescription().name+"/"+p.getLeadingProperty()+"/sap:visible");if(c&&(c.value==="false"||c.value===false)){continue}}var h=this._createColumnVisibilityMenuItem(i.getId()+"-item-"+r,p);i.addItem(h);if(l.length==1&&l[0]===p){h.setEnabled(false)}}this.addItem(e._oColumnVisibilityMenuItem)}};r.prototype._createColumnVisibilityMenuItem=function(e,t){var n=this._oTable;var o=s.Column.getHeaderText(n,t.getIndex());return new i(e,{text:o,icon:t.getVisible()?"sap-icon://accept":null,ariaLabelledBy:[n.getId()+(t.getVisible()?"-ariahidecolmenu":"-ariashowcolmenu")],select:l.proxy(function(e){var i=!t.getVisible();if(i||s.getVisibleColumnCount(this._oTable)>1){var n=t.getParent();var o=true;if(s.isA(n,"sap.ui.table.Table")){o=n.fireColumnVisibility({column:t,newVisible:i})}if(o){t.setVisible(i)}}},this)})};r.prototype._createMenuItem=function(e,t,n,o){return new i(this.getId()+"-"+e,{text:s.getResourceText(t),icon:n?"sap-icon://"+n:null,select:o||function(){}})};r.prototype._createMenuTextFieldItem=function(e,t,i,o,u){u=u||function(){};return new n(this.getId()+"-"+e,{label:s.getResourceText(t),icon:i?"sap-icon://"+i:null,value:o,select:u||function(){}})};r.prototype._setFilterValue=function(e){var t=this.getParent();var i=t?t.getParent():undefined;var n=sap.ui.getCore().byId(this.getId()+"-filter");if(n&&n.setValue&&(i&&!i.getEnableCustomFilter())){n.setValue(e)}return this};r.prototype._setFilterState=function(e){var t=this.getParent();var i=t?t.getParent():undefined;var n=sap.ui.getCore().byId(this.getId()+"-filter");if(n&&n.setValueState&&(i&&!i.getEnableCustomFilter())){n.setValueState(e)}return this};r._updateVisibilityIcon=function(e,t,i){if(!e||!e._oColumnVisibilityMenuItem){return}var n=i?"sap-icon://accept":"";var o=e._oColumnVisibilityMenuItem.getSubmenu();if(!o){return}var u=o.getItems();var s;for(var a=0;a<u.length;a++){if(u[a].getId().endsWith("-item-"+t)){s=u[a];break}}if(!s){return}s.setProperty("icon",n)};return r});