/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ExtensionBase","./KeyboardDelegate","../utils/TableUtils","sap/ui/core/delegate/ItemNavigation","sap/ui/Device","sap/ui/dom/containsOrEquals","sap/ui/thirdparty/jquery"],function(e,t,i,a,o,n,s){"use strict";var r=false;function l(e){if(o.browser.msie){if(!r){s("head").append('<style type="text/css">'+"/* Avoid focus outline problems in tables */\n"+".sapUiTableStatic[data-sap-ui-table-focus]{}"+"</style>");r=true}var t=i.getCellInfo(e)||{};if(t.isOfType(i.CELLTYPE.ANY)){t.cell.attr("data-sap-ui-table-focus",Date.now())}}}var d={_forward:function(e,t){var i=e._getItemNavigation();if(i!=null&&!e._getKeyboardExtension()._isItemNavigationSuspended()&&!t.isMarked("sapUiTableSkipItemNavigation")){i["on"+t.type](t)}},onfocusin:function(e){d._forward(this,e);l(e.target)},onsapfocusleave:function(e){d._forward(this,e)},onmousedown:function(e){d._forward(this,e)},onsapnext:function(e){d._forward(this,e)},onsapnextmodifiers:function(e){d._forward(this,e)},onsapprevious:function(e){d._forward(this,e)},onsappreviousmodifiers:function(e){d._forward(this,e)},onsappageup:function(e){d._forward(this,e)},onsappagedown:function(e){d._forward(this,e)},onsaphome:function(e){d._forward(this,e)},onsaphomemodifiers:function(e){d._forward(this,e)},onsapend:function(e){d._forward(this,e)},onsapendmodifiers:function(e){d._forward(this,e)},onsapkeyup:function(e){d._forward(this,e)}};var f={onBeforeRendering:function(e){this._oStoredFocusInfo=this.getFocusInfo()},onAfterRendering:function(e){var t=e&&e.isMarked("renderRows");this._getKeyboardExtension().invalidateItemNavigation();if(this._oStoredFocusInfo&&this._oStoredFocusInfo.customId){if(t){this.applyFocusInfo(this._oStoredFocusInfo)}else{this._getKeyboardExtension().initItemNavigation()}}delete this._oStoredFocusInfo},onfocusin:function(e){var t=this._getKeyboardExtension();if(!t._bIgnoreFocusIn){t.initItemNavigation()}else{e.setMarked("sapUiTableIgnoreFocusIn")}if(e.target&&e.target.id===this.getId()+"-rsz"){e.preventDefault();e.setMarked("sapUiTableSkipItemNavigation")}}};var u={_initItemNavigation:function(e){var t=e.getTable();var o=t.$();var n=t.getRows().length;var r=i.getVisibleColumnCount(t);var l=i.hasRowHeader(t);var d=i.hasRowActions(t);var f=i.hasFixedColumns(t);var g;var c=[],p,v,h,m,_;if(f){h=o.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowFixed:not(.sapUiTableCHT)");m=o.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowScroll:not(.sapUiTableCHT)");_=o.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowFixedBottom:not(.sapUiTableCHT)")}var b=o.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowFixed:not(.sapUiTableCHT)");var I=o.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowScroll:not(.sapUiTableCHT)");var T=o.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowFixedBottom:not(.sapUiTableCHT)");if(l){p=o.find(".sapUiTableRowSelectionCell").get();r++}if(d){v=o.find(".sapUiTableRowActionCell").get();r++}for(g=0;g<n;g++){if(l){c.push(p[g])}if(f){c=c.concat(h.find('tr[data-sap-ui-rowindex="'+g+'"]').find("td[tabindex]").get())}c=c.concat(b.find('tr[data-sap-ui-rowindex="'+g+'"]').find("td[tabindex]").get());if(f){c=c.concat(m.find('tr[data-sap-ui-rowindex="'+g+'"]').find("td[tabindex]").get())}c=c.concat(I.find('tr[data-sap-ui-rowindex="'+g+'"]').find("td[tabindex]").get());if(f){c=c.concat(_.find('tr[data-sap-ui-rowindex="'+g+'"]').find("td[tabindex]").get())}c=c.concat(T.find('tr[data-sap-ui-rowindex="'+g+'"]').find("td[tabindex]").get());if(d){c.push(v[g])}}if(t.getColumnHeaderVisible()){var C=[];var N=o.find(".sapUiTableCHT.sapUiTableCtrlFixed>tbody>tr");var y=o.find(".sapUiTableCHT.sapUiTableCtrlScroll>tbody>tr");var w=i.getHeaderRowCount(t);for(g=0;g<w;g++){if(l){C.push(t.getDomRef("selall"))}if(N.length){C=C.concat(s(N.get(g)).find(".sapUiTableHeaderCell").get())}if(y.length){C=C.concat(s(y.get(g)).find(".sapUiTableHeaderCell").get())}if(d){C.push(o.find(".sapUiTableRowActionHeaderCell").children().get(0))}}c=C.concat(c)}if(!e._itemNavigation){e._itemNavigation=new a;e._itemNavigation.setTableMode(true);e._itemNavigation.attachEvent(a.Events.AfterFocus,function(a){var o=i.getFocusedItemInfo(t);o.header=i.getHeaderRowCount(t);o.domRef=null;if(o.row>=o.header){e._oLastFocusedCellInfo=o}},t)}e._itemNavigation.setColumns(r);e._itemNavigation.setRootDomRef(o.find(".sapUiTableCnt").get(0));e._itemNavigation.setItemDomRefs(c);e._itemNavigation.setFocusedIndex(u.getInitialItemNavigationIndex(e));e._itemNavigationInvalidated=false},getInitialItemNavigationIndex:function(e){return i.hasRowHeader(e.getTable())?1:0},isItemNavigationInvalid:function(e){return!e._itemNavigation||e._itemNavigationInvalidated}};var g=e.extend("sap.ui.table.extensions.Keyboard",{_init:function(e,a,o){this._itemNavigation=null;this._itemNavigationInvalidated=false;this._itemNavigationSuspended=false;this._delegate=new t(a);this._actionMode=false;i.addDelegate(e,f,e);i.addDelegate(e,this._delegate,e);i.addDelegate(e,d,e);e._getItemNavigation=function(){return this._itemNavigation}.bind(this);return"KeyboardExtension"},_debug:function(){this._ExtensionHelper=u;this._ItemNavigationDelegate=d;this._ExtensionDelegate=f},destroy:function(){var t=this.getTable();if(t){t.removeEventDelegate(f);t.removeEventDelegate(this._delegate);t.removeEventDelegate(d)}if(this._itemNavigation){this._itemNavigation.destroy();this._itemNavigation=null}if(this._delegate){this._delegate.destroy();this._delegate=null}e.prototype.destroy.apply(this,arguments)}});g.prototype.initItemNavigation=function(){if(u.isItemNavigationInvalid(this)){u._initItemNavigation(this)}};g.prototype.invalidateItemNavigation=function(){this._itemNavigationInvalidated=true};g.prototype.setActionMode=function(e){if(!this._delegate){return}if(e===true&&!this._actionMode&&this._delegate.enterActionMode){this._actionMode=this._delegate.enterActionMode.apply(this.getTable(),Array.prototype.slice.call(arguments,1))===true}else if(e===false&&this._actionMode&&this._delegate.leaveActionMode){this._actionMode=false;this._delegate.leaveActionMode.apply(this.getTable(),Array.prototype.slice.call(arguments,1))}};g.prototype.isInActionMode=function(){return this._actionMode};g.prototype.updateNoDataAndOverlayFocus=function(e){var t=this.getTable();if(!t||!t.getDomRef()){return}if(t.getShowOverlay()){if(n(t.getDomRef(),e)){t.$("overlay").trigger("focus")}}else if(i.isNoDataVisible(t)){if(n(t.getDomRef("sapUiTableCnt"),e)){t.$("noDataCnt").trigger("focus")}}else if(n(t.getDomRef("noDataCnt"),e)||n(t.getDomRef("overlay"),e)){i.focusItem(t,u.getInitialItemNavigationIndex(this))}};g.prototype._suspendItemNavigation=function(){this._itemNavigationSuspended=true};g.prototype._resumeItemNavigation=function(){this._itemNavigationSuspended=false};g.prototype._isItemNavigationSuspended=function(){return this._itemNavigationSuspended};g.prototype._getLastFocusedCellInfo=function(){var e=i.getHeaderRowCount(this.getTable());if(!this._oLastFocusedCellInfo||this._oLastFocusedCellInfo.header!=e){var t=i.getFocusedItemInfo(this.getTable());var a=u.getInitialItemNavigationIndex(this);return{cellInRow:a,row:e,header:e,cellCount:t.cellCount,columnCount:t.columnCount,cell:t.columnCount*e+a}}return this._oLastFocusedCellInfo};g.prototype._setSilentFocus=function(e){this._bIgnoreFocusIn=true;this._setFocus(e);this._bIgnoreFocusIn=false};g.prototype._setFocus=function(e){if(!e){return}var t=this.getTable();var a=i.getCellInfo(e);if(a.isOfType(i.CELLTYPE.ANY)&&t){var o=s(e);if(o.attr("tabindex")!="0"){var n=t._getItemNavigation();if(n&&n.aItemDomRefs){for(var r=0;r<n.aItemDomRefs.length;r++){if(n.aItemDomRefs[r]){n.aItemDomRefs[r].setAttribute("tabindex","-1")}}}o.attr("tabindex","0")}}e.focus()};g.prototype._getTableType=function(){return this._type};return g});