/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ExtensionBase","../utils/TableUtils","../library","sap/ui/Device","sap/ui/performance/trace/Interaction","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,r,t,o,l,i,n){"use strict";var a=t.SharedDomRef;var s=r.Hook.Keys;var c=1e6;var f=2;var u={HORIZONAL:"HORIZONTAL",VERTICAL:"VERTICAL",BOTH:"BOTH"};function d(e,r){i.debug("sap.ui.table.extensions.Scrolling",e,r)}function p(e){return typeof e.isConnected==="boolean"&&e.isConnected||document.body.contains(e)}function g(e,r){var t=true;var o=false;var l=[];var i={cancel:function(){if(this.isCancelled()||!this.isRunning()){return}o=true;for(var e=0;e<l.length;e++){l[e]()}d("Process cancelled: "+r.id)},isCancelled:function(){return o},addCancelListener:function(e){l.push(e)},isRunning:function(){return t},getInfo:function(){return r},onPromiseCreated:function(e){}};var n;d("Process started: "+r.id);if(typeof e==="function"){n=new Promise(function(){e.apply(this,Array.prototype.slice.call(arguments).concat(i))})}else{n=Promise.resolve()}Object.assign(n,i);n.then(function(){if(i.isCancelled()){d("Process finished due to cancellation: "+r.id)}else{d("Process finished: "+r.id)}t=false});i.onPromiseCreated(n);return n}function v(){this.iIndex=0;this.nOffset=0;this.sOffsetType=v.OffsetType.Pixel;this.bIsInitial=true}v.OffsetType={Pixel:"Pixel",Percentage:"Percentage",PercentageOfBuffer:"PercentageOfBuffer"};v.prototype.getIndex=function(){return this.iIndex};v.prototype.getOffset=function(){return this.nOffset};v.prototype.getOffsetType=function(){return this.sOffsetType};v.prototype.isOffsetInPixel=function(){return this.sOffsetType===v.OffsetType.Pixel};v.prototype.isInitial=function(){return this.bIsInitial};v.prototype.setPosition=function(e,r,t){d("ScrollPosition#setPosition(index: "+e+", offset: "+r+", offsetType: "+t+")");if(!v._isPositiveNumber(e)){return}if(!v._isPositiveNumber(r)){this.nOffset=0}this.setIndex(e);this.setOffset(r,t)};v.prototype.setIndex=function(e){d("ScrollPosition#setIndex(index: "+e+")");if(!v._isPositiveNumber(e)){return}this.bIsInitial=false;this.iIndex=e};v.prototype.setOffset=function(e,r){d("ScrollPosition#setOffset(offset: "+e+", offsetType: "+r+")");if(!v._isPositiveNumber(e)){return}this.bIsInitial=false;this.sOffsetType=r in v.OffsetType?r:v.OffsetType.Pixel;if(this.isOffsetInPixel()){this.nOffset=Math.round(e)}else{this.nOffset=Math.min(e,1)}};v.prototype.scrollRows=function(e){var r=this.getIndex()+e;var t=this.getOffset();if(!this.isOffsetInPixel()||r<0){t=0}this.setPosition(Math.max(0,r),t)};v._isPositiveNumber=function(e){return typeof e==="number"&&!isNaN(e)&&e>=0};var S=new window.WeakMap;var h=function(e){if(!e){return{}}if(!S.has(e)){S.set(e,{oHorizontalScrollbar:null,iHorizontalScrollPosition:null,oVerticalScrollbar:null,oVerticalScrollPosition:new v(e),pVerticalScrollUpdateProcess:null,oExternalVerticalScrollbar:null,bIsVerticalScrollbarExternal:false,mTimeouts:{},mAnimationFrames:{},mTouchSessionData:null,aOnRowsUpdatedPreprocessors:[]})}return S.get(e)};h.destroy=function(e){delete S.delete(e)};var b={UpdateFromFirstVisibleRow:{id:"UpdateFromFirstVisibleRow",rank:6},UpdateFromScrollPosition:{id:"UpdateFromScrollPosition",rank:5},RestoreScrollPosition:{id:"RestoreScrollPosition",rank:4},AdjustToTotalRowCount:{id:"AdjustToTotalRowCount",rank:3},OnRowsUpdated:{id:"OnRowsUpdated",rank:3},UpdateFromScrollbar:{id:"UpdateFromScrollbar",rank:2},UpdateFromViewport:{id:"UpdateFromViewport",rank:1},canStart:function(e,r){var t=h(e).pVerticalScrollUpdateProcess;var o=t?t.getInfo():null;if(t&&t.isRunning()&&o.rank>r.rank){d("Cannot start update process "+r.id+" - A higher-ranked update process is currently running ("+o.id+")",e);return false}return true},start:function(e,r,t){if(!b.canStart(e,r)){return}if(h(e).pVerticalScrollUpdateProcess){h(e).pVerticalScrollUpdateProcess.cancel()}h(e).pVerticalScrollUpdateProcess=new g(t,r)}};var T={onScrollbarScroll:function(e){var r=e.target.scrollLeft;var t=e.target._scrollLeft;l.notifyScrollEvent&&l.notifyScrollEvent(e);if(r!==t){var o=T.getScrollAreas(this);e.target._scrollLeft=r;for(var i=0;i<o.length;i++){var n=o[i];if(n!==e.target&&n.scrollLeft!==r){n.scrollLeft=r;n._scrollLeft=r}}h(this).iHorizontalScrollPosition=r}},restoreScrollPosition:function(e){var r=e._getScrollExtension();var t=r.getHorizontalScrollbar();if(t&&h(e).iHorizontalScrollPosition!==null){var o=T.getScrollAreas(e);for(var l=0;l<o.length;l++){var i=o[l];delete i._scrollLeft}if(t.scrollLeft!==h(e).iHorizontalScrollPosition){t.scrollLeft=h(e).iHorizontalScrollPosition}else{var a=n.Event("scroll");a.target=t;T.onScrollbarScroll.call(e,a)}}},onScrollbarMouseDown:function(e){this._getKeyboardExtension().setActionMode(false)},addEventListeners:function(e){var r=e._getScrollExtension();var t=r.getHorizontalScrollbar();var o=T.getScrollAreas(e);if(!r._onHorizontalScrollEventHandler){r._onHorizontalScrollEventHandler=T.onScrollbarScroll.bind(e)}for(var l=0;l<o.length;l++){o[l].addEventListener("scroll",r._onHorizontalScrollEventHandler)}if(t){if(!r._onHorizontalScrollbarMouseDownEventHandler){r._onHorizontalScrollbarMouseDownEventHandler=T.onScrollbarMouseDown.bind(e)}t.addEventListener("mousedown",r._onHorizontalScrollbarMouseDownEventHandler)}},removeEventListeners:function(e){var r=e._getScrollExtension();var t=r.getHorizontalScrollbar();var o=T.getScrollAreas(e);if(r._onHorizontalScrollEventHandler){for(var l=0;l<o.length;l++){o[l].removeEventListener("scroll",r._onHorizontalScrollEventHandler);delete o[l]._scrollLeft}delete r._onHorizontalScrollEventHandler}if(t&&r._onHorizontalScrollbarMouseDownEventHandler){t.removeEventListener("mousedown",r._onHorizontalScrollbarMouseDownEventHandler);delete r._onHorizontalScrollbarMouseDownEventHandler}},getScrollAreas:function(e){var r=e.getDomRef();var t;if(r){t=Array.prototype.slice.call(e.getDomRef().querySelectorAll(".sapUiTableCtrlScr"))}var o=[e._getScrollExtension().getHorizontalScrollbar()].concat(t);return o.filter(function(e){return e!=null})}};var V={performUpdateFromFirstVisibleRow:function(e,t){d("VerticalScrollingHelper.performUpdateFromFirstVisibleRow",e);b.start(e,b.UpdateFromFirstVisibleRow,function(o,l,i){r.Hook.call(e,s.Test.StartAsyncTableUpdate);i.onPromiseCreated=function(t){t.finally(function(){r.Hook.call(e,s.Test.EndAsyncTableUpdate)})};if(t===true){var n=function(){d("VerticalScrollingHelper.performUpdateFromFirstVisibleRow (async: rows update)",e);V._performUpdateFromFirstVisibleRow(e,i).then(o);return false};V.addOnRowsUpdatedPreprocessor(e,n);i.addCancelListener(function(){var r=V.removeOnRowsUpdatedPreprocessor(e,n);if(r){o()}})}else{V._performUpdateFromFirstVisibleRow(e,i).then(o)}})},_performUpdateFromFirstVisibleRow:function(e,r){return V.adjustScrollPositionToFirstVisibleRow(e,r).then(function(){if(V.isIndexInBuffer(e,e.getFirstVisibleRow())){return V.adjustFirstVisibleRowToScrollPositionInBuffer(e,null,r)}return Promise.resolve()}).then(function(){return Promise.all([V.scrollViewport(e,r),V.scrollScrollbar(e,r)])})},performUpdateFromScrollPosition:function(e){d("VerticalScrollingHelper.performUpdateFromScrollPosition",e);b.start(e,b.UpdateFromScrollPosition,function(t,o,l){r.Hook.call(e,s.Test.StartAsyncTableUpdate);l.onPromiseCreated=function(t){t.finally(function(){r.Hook.call(e,s.Test.EndAsyncTableUpdate)})};V.adjustFirstVisibleRowToScrollPosition(e,null,l).then(function(){if(l.isCancelled()){return}var t=h(e).oVerticalScrollPosition;d("VerticalScrollingHelper.performUpdateFromScrollPosition (async: firstVisibleRow update)",e);if(t.getIndex()>e.getFirstVisibleRow()){t.setIndex(e.getFirstVisibleRow());if(r.isVariableRowHeightEnabled(e)){t.setOffset(1,v.OffsetType.Percentage)}else{t.setOffset(0)}}}).then(function(){return Promise.all([V.scrollViewport(e,l),V.scrollScrollbar(e,l)])}).then(t)})},performUpdateFromScrollbar:function(e){var t=h(e);d("VerticalScrollingHelper.performUpdateFromScrollbar",e);clearTimeout(t.mTimeouts.largeDataScrolling);delete t.mTimeouts.largeDataScrolling;b.start(e,b.UpdateFromScrollbar,function(o,l,i){r.Hook.call(e,s.Test.StartAsyncTableUpdate);i.onPromiseCreated=function(t){t.finally(function(){r.Hook.call(e,s.Test.EndAsyncTableUpdate)})};e._getKeyboardExtension().setActionMode(false);if(e._bLargeDataScrolling){t.mTimeouts.largeDataScrolling=setTimeout(function(){delete t.mTimeouts.largeDataScrolling;if(e._getScrollExtension().getVerticalScrollbar()!=null){d("VerticalScrollingHelper.performUpdateFromScrollbar (async: large data scrolling)",e);V._performUpdateFromScrollbar(e,i).then(o)}else{d("VerticalScrollingHelper.performUpdateFromScrollbar (async: large data scrolling): No scrollbar",e)}},300);i.addCancelListener(function(){if(t.mTimeouts.largeDataScrolling!=null){clearTimeout(t.mTimeouts.largeDataScrolling);delete t.mTimeouts.largeDataScrolling;o()}})}else{V._performUpdateFromScrollbar(e,i).then(o)}})},_performUpdateFromScrollbar:function(e,t){return V.adjustScrollPositionToScrollbar(e,t).then(function(){return V.adjustFirstVisibleRowToScrollPosition(e,null,t)}).then(function(){if(r.isVariableRowHeightEnabled(e)){return V.scrollViewport(e,t)}if(t.isCancelled()){return Promise.resolve()}var o=h(e).oVerticalScrollPosition;var l=o.getIndex();var i=e._getMaxFirstRenderedRowIndex();var n=e._aRowHeights;switch(o.getOffsetType()){case v.OffsetType.Percentage:var a=Math.max(0,Math.min(n.length-1,l-i));o.setOffset(n[a]*o.getOffset());break;case v.OffsetType.PercentageOfBuffer:o.setOffset(0);break;default:}return Promise.resolve()})},performUpdateFromViewport:function(e){d("VerticalScrollingHelper.performUpdateFromViewport",e);b.start(e,b.UpdateFromViewport,function(t,o,l){r.Hook.call(e,s.Test.StartAsyncTableUpdate);l.onPromiseCreated=function(t){t.finally(function(){r.Hook.call(e,s.Test.EndAsyncTableUpdate)})};V.adjustScrollPositionToViewport(e,l).then(function(){return V.adjustFirstVisibleRowToScrollPosition(e,true,l)}).then(function(){return V.scrollScrollbar(e,l)}).then(t)})},onScrollbarScroll:function(e){l.notifyScrollEvent&&l.notifyScrollEvent(e);var r=e.target.scrollTop;var t=e.target._scrollTop;var o=r!==t;delete e.target._scrollTop;if(r===0&&!p(e.target)){d("VerticalScrollingHelper.onScrollbarScroll: Scrollbar is not connected with the DOM",this)}else if(o){d("VerticalScrollingHelper.onScrollbarScroll: Scroll position changed to "+r+" by interaction",this);V.performUpdateFromScrollbar(this)}else{d("VerticalScrollingHelper.onScrollbarScroll: Scroll position changed to "+r+" by API",this)}},onViewportScroll:function(e){if(!b.canStart(this,b.UpdateFromViewport)){return}var r=e.target.scrollTop;var t=e.target._scrollTop;delete e.target._scrollTop;if(r!==t){d("VerticalScrollingHelper.onViewportScroll: Scroll position changed to "+r+" by interaction",this);V.performUpdateFromViewport(this)}else{d("VerticalScrollingHelper.onViewportScroll: Scroll position changed to "+r+" by API",this)}},adjustFirstVisibleRowToScrollPosition:function(e,r,t){if(t&&t.isCancelled()){return Promise.resolve()}r=r===true;var o=h(e).oVerticalScrollPosition;var l=o.getIndex();var i=e.getFirstVisibleRow();var n=V.isIndexInBuffer(e,l);var a=n;d("VerticalScrollingHelper.adjustFirstVisibleRowToScrollPosition:"+' Set "firstVisibleRow" from '+i+" to "+l,e);var s=e._setFirstVisibleRowIndex(l,{onScroll:true,suppressEvent:a,suppressRendering:r});if(!s){if(n){return V.adjustFirstVisibleRowToScrollPositionInBuffer(e,true,t)}return Promise.resolve()}return new Promise(function(r){var o=function(o){d("VerticalScrollingHelper.adjustFirstVisibleRowToScrollPosition (async: rows updated):"+" Reason "+o.getParameters().reason,this);if(n){V.adjustFirstVisibleRowToScrollPositionInBuffer(e,true,t).then(r)}else{r()}return false};V.addOnRowsUpdatedPreprocessor(e,o);if(t){t.addCancelListener(function(){var t=V.removeOnRowsUpdatedPreprocessor(e,o);if(t){r()}})}})},adjustFirstVisibleRowToScrollPositionInBuffer:function(e,r,t){if(t&&t.isCancelled()){return Promise.resolve()}r=r===true;var o=h(e).oVerticalScrollPosition;var l=o.getIndex();if(!V.isIndexInBuffer(e,l)){d("VerticalScrollingHelper.adjustFirstVisibleRowToScrollPositionInBuffer:"+" Aborted - Scroll position is not in buffer",e);return Promise.resolve()}var i=l;var n=V.getScrollRangeOfViewport(e);var a=e._getMaxFirstRenderedRowIndex();var s=e._aRowHeights;var c;d("VerticalScrollingHelper.adjustFirstVisibleRowToScrollPositionInBuffer");if(o.getOffsetType()===v.OffsetType.PercentageOfBuffer){var f=n*o.getOffset();i=a;for(c=0;c<s.length;c++){var u=f-s[c];if(u>=0){f=u;i++}else{break}}}else{var p=Math.max(0,Math.min(s.length-1,l-a));var g=0;for(c=0;c<p;c++){g+=s[c];if(g>n){i=a+c;break}}}if(l!==i||r){d('VerticalScrollingHelper.adjustFirstVisibleRowToScrollPositionInBuffer: Set "firstVisibleRow" to '+i,e);e._setFirstVisibleRowIndex(i,{onScroll:true,forceEvent:r,suppressRendering:true})}return Promise.resolve()},adjustScrollPositionToFirstVisibleRow:function(e,r){if(r&&r.isCancelled()){return Promise.resolve()}d("VerticalScrollingHelper.adjustScrollPositionToFirstVisibleRow",e);h(e).oVerticalScrollPosition.setPosition(e.getFirstVisibleRow());return Promise.resolve()},adjustScrollPositionToScrollbar:function(e,t){if(t&&t.isCancelled()){return Promise.resolve()}var o=h(e).oVerticalScrollPosition;var l=V.getScrollPositionOfScrollbar(e);var i=V.getScrollRange(e);var n=V.getScrollRangeRowFraction(e);var a=0;var s=0;var c=v.OffsetType.Percentage;var f;d("VerticalScrollingHelper.adjustScrollPositionToScrollbar",e);if(r.isVariableRowHeightEnabled(e)){if(V.isScrollPositionOfScrollbarInBuffer(e)){var u=V.getScrollRangeBuffer(e);var p=i-u;var g=l-p;var S=g/u;a=e._getMaxFirstRenderedRowIndex();if(V.isIndexInBuffer(e,o.getIndex())){var b=V.getScrollRangeOfViewport(e);var T=b*S;var w=e._aRowHeights;for(var m=0;m<w.length;m++){var R=T-w[m];if(R>=0){T=R;a++}else{s=Math.round(T);c=v.OffsetType.Pixel;break}}}else{s=S;c=v.OffsetType.PercentageOfBuffer}}else{f=l/n;a=Math.floor(f);s=f-a}}else{var P=i-l;var H=P<1;if(H){a=e._getMaxFirstVisibleRowIndex();s=0;c=v.OffsetType.Pixel}else{f=l/n;a=Math.floor(f);s=f-a}}o.setPosition(a,s,c);return Promise.resolve()},adjustScrollPositionToViewport:function(e,r){if(r&&r.isCancelled()){return Promise.resolve()}var t=h(e).oVerticalScrollPosition;var o=e._aRowHeights;var l=e._iRenderedFirstVisibleRow;var i=0;var n=V.getScrollPositionOfViewport(e);d("VerticalScrollingHelper.adjustScrollPositionToViewport",e);for(var a=0;a<o.length;a++){var s=n-o[a];if(s>=0){n=s;l++}else{i=Math.round(n);break}}t.setPosition(l,i);return Promise.resolve()},scrollViewport:function(e,t){if(t&&t.isCancelled()){return Promise.resolve()}var o=h(e).oVerticalScrollPosition;var l=e.getDomRef("tableCCnt");var i=V.getScrollRangeOfViewport(e);var n=e._aRowHeights;if(!r.isVariableRowHeightEnabled(e)||!l||!e.getBinding("rows")){d("VerticalScrollingHelper.scrollViewport: Aborted - Guard clause not passed",e);return Promise.resolve()}if(e._getFirstRenderedRowIndex()!==e._iRenderedFirstVisibleRow){d("VerticalScrollingHelper.scrollViewport: Aborted - Rows will be updated",e);return Promise.resolve()}if(i===0){d("VerticalScrollingHelper.scrollViewport: No overflow in viewport - Scroll to 0",e);e._setFirstVisibleRowIndex(0,{onScroll:true});o.setPosition(0);l.scrollTop=0;return Promise.resolve()}var a=o.getIndex();var s=e._getMaxFirstRenderedRowIndex();var c=0;var f=0;var u;d("VerticalScrollingHelper.scrollViewport");switch(o.getOffsetType()){case v.OffsetType.Pixel:case v.OffsetType.Percentage:if(V.isIndexInBuffer(e,a)){var p=0;f=Math.max(0,Math.min(n.length-1,a-s));for(u=0;u<f;u++){p+=n[u];if(p>i){o.setPosition(s+u,i-c);f=u;break}else{c=p}}}if(o.isOffsetInPixel()){o.setOffset(Math.min(o.getOffset(),n[f]))}else{o.setOffset(n[f]*o.getOffset())}c+=o.getOffset();if(c>i){o.setOffset(o.getOffset()-(c-i));c=i}break;case v.OffsetType.PercentageOfBuffer:if(!V.isIndexInBuffer(e,a)){o.setOffset(0);break}var g=i*o.getOffset();c=Math.round(g);for(u=0;u<n.length;u++){var S=g-n[u];if(S>=0){g=S;f++}else{o.setPosition(s+f,Math.round(g));break}}break;default:}d("VerticalScrollingHelper.scrollViewport: Scroll from "+l.scrollTop+" to "+c,e);l.scrollTop=c;l._scrollTop=l.scrollTop;return Promise.resolve()},scrollScrollbar:function(e,r){if(r&&r.isCancelled()){return Promise.resolve()}var t=h(e);var o=t.oVerticalScrollPosition;var l=o.getIndex();var i=V.getScrollRangeBuffer(e);var n=V.getScrollRange(e);var a=n-i;var s=0;var c=0;var f=V.getScrollRangeOfViewport(e);var u=e._aRowHeights;var p;d("VerticalScrollingHelper.scrollScrollbar",e);if(n===0||u.length===0){d("VerticalScrollingHelper.scrollScrollbar: No scrollable content",e);return Promise.resolve()}switch(o.getOffsetType()){case v.OffsetType.Pixel:case v.OffsetType.Percentage:if(V.isIndexInBuffer(e,l)){var g=0;p=Math.max(0,Math.min(u.length-1,l-e._getMaxFirstRenderedRowIndex()));for(var S=0;S<p;S++){g+=u[S]}if(o.isOffsetInPixel()){g+=Math.min(u[p],o.getOffset())}else{g+=u[p]*o.getOffset()}var b=Math.min(g/f,1);var T=i*b;s=a+T}else{var w=V.getScrollRangeRowFraction(e);s=l*w;if(o.isOffsetInPixel()){p=Math.max(0,Math.min(u.length-1,l-e._iRenderedFirstVisibleRow));s+=w*Math.min(o.getOffset()/u[p],1)}else{s+=w*o.getOffset()}}break;case v.OffsetType.PercentageOfBuffer:if(V.isIndexInBuffer(e,l)){s=a+Math.round(f*o.getOffset())}break;default:}if(s>0&&s<.5){c=1}else if(s>=n-.5&&s<n){c=n-1}else{c=Math.round(s)}var m=e._getScrollExtension().getVerticalScrollbar();if(m){d("VerticalScrollingHelper.scrollScrollbar: Scroll from "+m.scrollTop+" to "+c,e);m.scrollTop=c;m._scrollTop=m.scrollTop}else{d("VerticalScrollingHelper.scrollScrollbar: Not scrolled - No scrollbar available",e)}return Promise.resolve()},getScrollRange:function(e){var r=e._getScrollExtension();var t=r.getVerticalScrollHeight()-r.getVerticalScrollbarHeight();return Math.max(0,t)},getScrollRangeBuffer:function(e){if(!r.isVariableRowHeightEnabled(e)){return 0}return f*e._getBaseRowHeight()},getScrollPositionOfScrollbar:function(e){var r=e._getScrollExtension();if(r.isVerticalScrollbarVisible()){return r.getVerticalScrollbar().scrollTop}else{return 0}},getScrollPositionOfViewport:function(e){var r=e?e.getDomRef("tableCCnt"):null;return r?r.scrollTop:0},getScrollRangeRowFraction:function(e){var t=e._getScrollExtension();var o=e._getTotalRowCount()-e._getRowCounts().count;var l;if(r.isVariableRowHeightEnabled(e)){l=V.getScrollRange(e)-V.getScrollRangeBuffer(e);var i=t.getVerticalScrollHeight()===c;if(!i){l+=e._getBaseRowHeight()}}else{l=V.getScrollRange(e)}return l/Math.max(1,o)},isScrollPositionOfScrollbarInBuffer:function(e){if(!r.isVariableRowHeightEnabled(e)){return false}var t=V.getScrollRange(e);var o=V.getScrollPositionOfScrollbar(e);var l=V.getScrollRangeBuffer(e);return t-o<=l},isIndexInBuffer:function(e,t){if(!r.isVariableRowHeightEnabled(e)){return false}return t>=e._getMaxFirstRenderedRowIndex()},getScrollRangeOfViewport:function(e){if(!e||!e._aRowHeights){return 0}var r=e._aRowHeights;var t=e._getBaseRowHeight()*e._getRowCounts().count;if(e._getRowCounts().count>=e._getTotalRowCount()){r=r.slice(0,e._getTotalRowCount())}var o=r.reduce(function(e,r){return e+r},0)-t;if(o>0){o=Math.ceil(o)}return Math.max(0,o)},addOnRowsUpdatedPreprocessor:function(e,r){h(e).aOnRowsUpdatedPreprocessors.push(r)},removeOnRowsUpdatedPreprocessor:function(e,r){if(!r){h(e).aOnRowsUpdatedPreprocessors=[];return false}var t=h(e).aOnRowsUpdatedPreprocessors.indexOf(r);if(t>-1){h(e).aOnRowsUpdatedPreprocessors.splice(t,1);return true}return false},onRowsUpdated:function(e){d("VerticalScrollingHelper.onRowsUpdated: Reason "+e.getParameters().reason,this);this._getScrollExtension().updateVerticalScrollbarVisibility();if(h(this).aOnRowsUpdatedPreprocessors.length>0){d("VerticalScrollingHelper.onRowsUpdated (preprocessors)",this);var t=h(this).aOnRowsUpdatedPreprocessors.reduce(function(r,t){var o=t.call(this,e);return!(r&&!o)},true);V.removeOnRowsUpdatedPreprocessor(this);if(!t){d("VerticalScrollingHelper.onRowsUpdated (preprocessors): Default prevented",this);return}}if(!r.isVariableRowHeightEnabled(this)){d("VerticalScrollingHelper.onRowsUpdated: Aborted - Variable row heights not enabled",this);return}var o=this;b.start(this,b.OnRowsUpdated,function(e,t,l){r.Hook.call(o,s.Test.StartAsyncTableUpdate);l.onPromiseCreated=function(e){e.finally(function(){r.Hook.call(o,s.Test.EndAsyncTableUpdate)})};V.scrollViewport(o,l).then(function(){return Promise.all([V.adjustFirstVisibleRowToScrollPosition(o,true,l),V.scrollScrollbar(o,l)])}).then(e)})},restoreScrollPosition:function(e,t){d("VerticalScrollingHelper.restoreScrollPosition",e);b.start(e,b.RestoreScrollPosition,function(o,l,i){r.Hook.call(e,s.Test.StartAsyncTableUpdate);i.onPromiseCreated=function(t){t.then(function(){if(!i.isCancelled()){V._restoreScrollPosition(e)}}).finally(function(){r.Hook.call(e,s.Test.EndAsyncTableUpdate)})};if(t!==true){o();return}var n=function(){d("VerticalScrollingHelper.restoreScrollPosition (async: rows updated)",e);o();return false};V.addOnRowsUpdatedPreprocessor(e,n);i.addCancelListener(function(){var r=V.removeOnRowsUpdatedPreprocessor(e,n);if(r){o()}})})},_restoreScrollPosition:function(e){var r=h(e).oVerticalScrollPosition;var t=r.isInitial();d("VerticalScrollingHelper.restoreScrollPosition: "+"Scroll position is"+(t?" ":" not ")+"initial",e);if(t){V.performUpdateFromFirstVisibleRow(e)}else{V.performUpdateFromScrollPosition(e)}},adjustToTotalRowCount:function(e){d("VerticalScrollingHelper.adjustToTotalRowCount",e);var t=e._getScrollExtension();t.updateVerticalScrollbarVisibility();t.updateVerticalScrollHeight();b.start(e,b.AdjustToTotalRowCount,function(t,o,l){r.Hook.call(e,s.Test.StartAsyncTableUpdate);l.onPromiseCreated=function(t){t.then(function(){if(l.isCancelled()||h(e).oVerticalScrollPosition.isInitial()){return}V.scrollViewport(e);V.performUpdateFromScrollPosition(e)}).finally(function(){r.Hook.call(e,s.Test.EndAsyncTableUpdate)})};if(h(e).oVerticalScrollPosition.isInitial()){t()}else{var i=function(){d("VerticalScrollingHelper.adjustToTotalRowCount (async: rows updated)",e);t();return false};V.addOnRowsUpdatedPreprocessor(e,i);l.addCancelListener(function(){var r=V.removeOnRowsUpdatedPreprocessor(e,i);if(r){t()}})}})},addEventListeners:function(e){var r=e._getScrollExtension();var t=V.getScrollAreas(e);var o=e.getDomRef("tableCCnt");if(!r._onVerticalScrollEventHandler){r._onVerticalScrollEventHandler=V.onScrollbarScroll.bind(e)}for(var l=0;l<t.length;l++){t[l].addEventListener("scroll",r._onVerticalScrollEventHandler)}if(o){if(!r._onViewportScrollEventHandler){r._onViewportScrollEventHandler=V.onViewportScroll.bind(e)}o.addEventListener("scroll",r._onViewportScrollEventHandler)}e.attachEvent("_rowsUpdated",V.onRowsUpdated)},removeEventListeners:function(e){var r=e._getScrollExtension();var t=V.getScrollAreas(e);var o=e.getDomRef("tableCCnt");if(r._onVerticalScrollEventHandler){for(var l=0;l<t.length;l++){t[l].removeEventListener("scroll",r._onVerticalScrollEventHandler)}delete r._onVerticalScrollEventHandler}if(o&&r._onViewportScrollEventHandler){o.removeEventListener("scroll",r._onViewportScrollEventHandler);delete r._onViewportScrollEventHandler}e.detachEvent("_rowsUpdated",V.onRowsUpdated)},getScrollAreas:function(e){var r=[e._getScrollExtension().getVerticalScrollbar()];return r.filter(function(e){return e!=null})}};var w={onMouseWheelScrolling:function(e,t){var o=this._getScrollExtension();var l=Math.abs(t.deltaY)>Math.abs(t.deltaX);var i=l?t.deltaY:t.deltaX;var n=l&&t.shiftKey||!l;var a=i>0;var s=false;if(i===0){return}if(n&&(e.scrollDirection===u.HORIZONAL||e.scrollDirection===u.BOTH)){var c=o.getHorizontalScrollbar();if(t.deltaMode!==window.WheelEvent.DOM_DELTA_PIXEL){var f=r.Column.getMinColumnWidth();i=a?f:-f}if(a){s=c.scrollLeft===c.scrollWidth-c.offsetWidth}else{s=c.scrollLeft===0}if(o.isHorizontalScrollbarVisible()&&!s){t.preventDefault();t.stopPropagation();this._getKeyboardExtension().setActionMode(false);c.scrollLeft=c.scrollLeft+i}}else if(!n&&(e.scrollDirection===u.VERTICAL||e.scrollDirection===u.BOTH)){var d=o.getVerticalScrollbar();var p=h(this).oVerticalScrollPosition;if(a){s=d.scrollTop===d.scrollHeight-d.offsetHeight}else{s=d.scrollTop===0}if(!o.isVerticalScrollbarVisible()||s){return}t.preventDefault();t.stopPropagation();if(t.deltaMode===window.WheelEvent.DOM_DELTA_PIXEL){var g=i/this._getDefaultRowHeight();if(g>=0){p.scrollRows(Math.max(1,Math.floor(g)))}else{p.scrollRows(Math.min(-1,Math.ceil(g)))}}else if(t.deltaMode===window.WheelEvent.DOM_DELTA_LINE){p.scrollRows(i)}else if(t.deltaMode===window.WheelEvent.DOM_DELTA_PAGE){p.scrollRows(i*this._getRowCounts().count)}this._getKeyboardExtension().setActionMode(false);V.performUpdateFromScrollPosition(this)}},onTouchStart:function(e,r){if(r.type==="touchstart"||r.pointerType==="touch"){var t=this._getScrollExtension();var o=t.getHorizontalScrollbar();var l=t.getVerticalScrollbar();var i=r.touches?r.touches[0]:r;h(this).mTouchSessionData={initialPageX:i.pageX,initialPageY:i.pageY,initialScrollTop:l?l.scrollTop:0,initialScrollLeft:o?o.scrollLeft:0,initialScrolledToEnd:null,touchMoveDirection:null}}},onTouchMoveScrolling:function(e,r){if(r.type!=="touchmove"&&r.pointerType!=="touch"){return}var t=this._getScrollExtension();var o=h(this).mTouchSessionData;if(!o){return}var l=r.touches?r.touches[0]:r;var i=l.pageX-o.initialPageX;var n=l.pageY-o.initialPageY;var a=false;if(!o.touchMoveDirection){if(i===0&&n===0){return}o.touchMoveDirection=Math.abs(i)>Math.abs(n)?"horizontal":"vertical"}switch(o.touchMoveDirection){case"horizontal":var s=t.getHorizontalScrollbar();if(s&&(e.scrollDirection===u.HORIZONAL||e.scrollDirection===u.BOTH)){this._getKeyboardExtension().setActionMode(false);if(o.initialScrolledToEnd==null){if(i<0){o.initialScrolledToEnd=s.scrollLeft===s.scrollWidth-s.offsetWidth}else{o.initialScrolledToEnd=s.scrollLeft===0}}if(!o.initialScrolledToEnd){s.scrollLeft=o.initialScrollLeft-i;a=true}}break;case"vertical":var c=t.getVerticalScrollbar();if(c&&(e.scrollDirection===u.VERTICAL||e.scrollDirection===u.BOTH)){this._getKeyboardExtension().setActionMode(false);if(o.initialScrolledToEnd==null){if(n<0){o.initialScrolledToEnd=c.scrollTop===c.scrollHeight-c.offsetHeight}else{o.initialScrolledToEnd=c.scrollTop===0}}if(!o.initialScrolledToEnd){c.scrollTop=o.initialScrollTop-n;a=true}}break;default:}if(a){r.preventDefault()}},addEventListeners:function(e){var r=e._getScrollExtension();var t=w.getEventListenerTargets(e);r._mMouseWheelEventListener=this.addMouseWheelEventListener(t,e,{scrollDirection:u.BOTH});r._mTouchEventListener=this.addTouchEventListener(t,e,{scrollDirection:u.BOTH})},addMouseWheelEventListener:function(e,r,t){var o=w.onMouseWheelScrolling.bind(r,t);for(var l=0;l<e.length;l++){e[l].addEventListener("wheel",o)}return{wheel:o}},addTouchEventListener:function(e,r,t){var l=w.onTouchStart.bind(r,t);var i=w.onTouchMoveScrolling.bind(r,t);var n={};for(var a=0;a<e.length;a++){if(o.support.pointer&&o.system.desktop){e[a].addEventListener("pointerdown",l);e[a].addEventListener("pointermove",i,o.browser.chrome?{passive:true}:false)}else if(o.support.touch){e[a].addEventListener("touchstart",l);e[a].addEventListener("touchmove",i)}}if(o.support.pointer&&o.system.desktop){n={pointerdown:l,pointermove:i}}else if(o.support.touch){n={touchstart:l,touchmove:i}}return n},removeEventListeners:function(e){var r=e._getScrollExtension();var t=w.getEventListenerTargets(e);function o(e,r){for(var t in r){var o=r[t];if(o){e.removeEventListener(t,o)}}}for(var l=0;l<t.length;l++){o(t[l],r._mMouseWheelEventListener);o(t[l],r._mTouchEventListener)}delete r._mMouseWheelEventListener;delete r._mTouchEventListener},getEventListenerTargets:function(e){var r=[e.getDomRef("tableCCnt")];return r.filter(function(e){return e!=null})}};var m={onBeforeRendering:function(e){this._getScrollExtension()._clearCache()},onAfterRendering:function(e){var r=this._getScrollExtension();var t=e!=null&&e.isMarked("renderRows");if(t){r.updateVerticalScrollbarHeight();r.updateVerticalScrollHeight()}else{V.restoreScrollPosition(this,this.getBinding("rows")!=null)}T.restoreScrollPosition(this)},onfocusin:function(e){var t;var l=r.getCellInfo(e.target);var i=this._getScrollExtension().getHorizontalScrollbar();if(l.isOfType(r.CELLTYPE.DATACELL)){t=this.getDomRef("sapUiTableCtrlScr")}else if(l.isOfType(r.CELLTYPE.COLUMNHEADER)){t=this.getDomRef("sapUiTableColHdrScr")}if(t&&i&&l.columnIndex>=this.getComputedFixedColumnCount()){var a=n(i);var c=l.cell[0];var f=this._bRtlMode?a.scrollLeftRTL():i.scrollLeft;var u=t.clientWidth;var d=c.offsetLeft;var p=d+c.offsetWidth;var g=d-f;var v=p-u-f;var S;if(g<0&&v<0){S=f+g}else if(v>0&&g>0){S=f+v}if(S!=null){if(this._bRtlMode){a.scrollLeftRTL(S)}else{i.scrollLeft=S}}}var h=r.getParentCell(this,e.target);if(h){var b=this;var T=function(){var e=h.find(".sapUiTableCellInner");if(e.length>0){if(b._bRtlMode){e.scrollLeftRTL(e[0].scrollWidth-e[0].clientWidth)}else{e[0].scrollLeft=0}e[0].scrollTop=0}r.Hook.call(b,s.Test.EndAsyncFocusHandling);r.Hook.call(b,s.Test.EndAsyncTableUpdate)};r.Hook.call(this,s.Test.StartAsyncTableUpdate);r.Hook.call(this,s.Test.StartAsyncFocusHandling);Promise.resolve().then(function(){if(o.browser.safari){window.setTimeout(T,0)}else{T()}})}}};var R=e.extend("sap.ui.table.extensions.Scrolling",{_init:function(e,t,o){r.addDelegate(e,m,e);return"ScrollExtension"},_attachEvents:function(){var e=this.getTable();T.addEventListeners(e);V.addEventListeners(e);w.addEventListeners(e)},_detachEvents:function(){var e=this.getTable();T.removeEventListeners(e);V.removeEventListeners(e);w.removeEventListeners(e)},destroy:function(){var t=this.getTable();r.removeDelegate(t,m);this._clearCache();if(h(t).pVerticalScrollUpdateProcess){h(t).pVerticalScrollUpdateProcess.cancel();h(t).pVerticalScrollUpdateProcess=null}h.destroy(t);e.prototype.destroy.apply(this,arguments)}});R.prototype.scrollVertically=function(e,r,t,o){var l=this.getTable();if(!l){return false}e=e===true;r=r===true;t=t===true;var i=false;var n=l._getTotalRowCount();var a=l._getRowCounts();var s=l.getFirstVisibleRow();var c=r?a.scrollable:1;if(e){if(s+a.count<n){if(o){o()}if(t){setTimeout(function(){l.setFirstVisibleRow(Math.min(s+c,n-a.count))},0)}else{l.setFirstVisibleRow(Math.min(s+c,n-a.count))}i=true}}else if(s>0){if(o){o()}if(t){setTimeout(function(){l.setFirstVisibleRow(Math.max(s-c,0))},0)}else{l.setFirstVisibleRow(Math.max(s-c,0))}i=true}return i};R.prototype.scrollVerticallyMax=function(e){var t=this.getTable();if(!t){return false}e=e===true;var o=false;var l=t.getFirstVisibleRow();if(e){var i=t._getTotalRowCount()-r.getNonEmptyVisibleRowCount(t);if(l<i){t.setFirstVisibleRow(i);o=true}}else if(l>0){t.setFirstVisibleRow(0);o=true}return o};R.prototype.getHorizontalScrollbar=function(){var e=this.getTable();if(e&&!e._bInvalid&&!h(e).oHorizontalScrollbar){h(e).oHorizontalScrollbar=e.getDomRef(a.HorizontalScrollBar)}return h(e).oHorizontalScrollbar||null};R.prototype.getVerticalScrollbar=function(e){var r=this.getTable();var t=this.isVerticalScrollbarExternal();if(r&&!r._bInvalid&&!h(r).oVerticalScrollbar){h(r).oVerticalScrollbar=r.getDomRef(a.VerticalScrollBar);if(!h(r).oVerticalScrollbar&&t){h(r).oVerticalScrollbar=h(r).oExternalVerticalScrollbar}}var o=h(r).oVerticalScrollbar;if(o&&!t&&!e&&!p(o)){return null}return o||null};R.prototype.isHorizontalScrollbarVisible=function(){var e=this.getHorizontalScrollbar();return e!=null&&!e.classList.contains("sapUiTableHidden")};R.prototype.isVerticalScrollbarVisible=function(){var e=this.getVerticalScrollbar();return e!=null&&!e.classList.contains("sapUiTableHidden")};R.prototype.isVerticalScrollbarExternal=function(){return h(this.getTable()).bIsVerticalScrollbarExternal};R.prototype.markVerticalScrollbarAsExternal=function(e){if(e){h(this.getTable()).bIsVerticalScrollbarExternal=true;h(this.getTable()).oExternalVerticalScrollbar=e}};R.prototype.updateHorizontalScrollbar=function(e){var r=this.getTable();var t=this.getHorizontalScrollbar();if(!r||!t||!e){return}var l=r.$();var i=e.tableCtrlScrollWidth;if(o.browser.safari){i=Math.max(i,r._getColumnsWidth(r.getComputedFixedColumnCount()))}var n=i>e.tableCtrlScrWidth;if(n){if(!this.isHorizontalScrollbarVisible()){l.addClass("sapUiTableHScr");t.classList.remove("sapUiTableHidden");if(o.browser.safari){var a=l.find(".sapUiTableCtrlScroll, .sapUiTableColHdrScr > .sapUiTableColHdr");a.outerWidth(i)}}var s=e.tableCtrlFixedWidth;if(l.find(".sapUiTableRowHdrScr").length>0){s+=e.tableRowHdrScrWidth}if(r._bRtlMode){t.style.marginRight=s+"px";t.style.marginLeft=""}else{t.style.marginLeft=s+"px";t.style.marginRight=""}var c=r.getDomRef("hsb-content");if(c){c.style.width=i+"px"}}if(!n&&this.isHorizontalScrollbarVisible()){l.removeClass("sapUiTableHScr");t.classList.add("sapUiTableHidden");if(o.browser.safari){l.find(".sapUiTableCtrlScroll, .sapUiTableColHdr").css("width","")}}};R.prototype.updateVerticalScrollbarHeight=function(){var e=this.getTable();var r=this.getVerticalScrollbar();if(!e||!r){return}r.style.maxHeight=this.getVerticalScrollbarHeight()+"px";r._scrollTop=r.scrollTop};R.prototype.getVerticalScrollbarHeight=function(){var e=this.getTable();if(!e){return 0}return e._getRowCounts().scrollable*e._getBaseRowHeight()};R.prototype.updateVerticalScrollbarPosition=function(){var e=this.getTable();var r=this.getVerticalScrollbar();if(!e||!r){return}var t=e.getDomRef("tableCCnt");if(t){var o=t.offsetTop;var l=e.getDomRef("vsb-bg");if(l){l.style.top=o+"px"}if(e._getRowCounts().fixedTop>0){o+=e._iVsbTop}r.style.top=o+"px"}};R.prototype.updateVerticalScrollPosition=function(e){var r=this.getTable();if(!r){return}V.performUpdateFromFirstVisibleRow(r,e)};R.prototype.adjustToTotalRowCount=function(){V.adjustToTotalRowCount(this.getTable())};R.prototype.restoreVerticalScrollPosition=function(){V.restoreScrollPosition(this.getTable())};R.prototype.updateVerticalScrollHeight=function(){var e=this.getVerticalScrollbar();var r=e?e.firstChild:null;if(!r){return}r.style.height=this.getVerticalScrollHeight()+"px";e._scrollTop=e.scrollTop};R.prototype.getVerticalScrollHeight=function(e){var t=this.getTable();if(!t){return 0}var o=t._getTotalRowCount();var l=t._getRowCounts().count;var i=t._getBaseRowHeight();var n;var a;if(r.isVariableRowHeightEnabled(t)){n=Math.max(o,l+1);a=i*(n-1)+V.getScrollRangeBuffer(t)}else{n=Math.max(o,l);a=i*n}if(e===true){return a}else{return Math.min(c,a)}};R.prototype.updateVerticalScrollbarVisibility=function(){var e=this.getTable();var r=e?e.getDomRef():null;var t=this.getVerticalScrollbar();if(!r||!t){return}var o=this.isVerticalScrollbarRequired();if(o&&!this.isVerticalScrollbarVisible()){if(!this.isVerticalScrollbarExternal()){r.classList.add("sapUiTableVScr")}t.classList.remove("sapUiTableHidden")}if(!o&&this.isVerticalScrollbarVisible()){r.classList.remove("sapUiTableVScr");t.classList.add("sapUiTableHidden")}};R.prototype.isVerticalScrollbarRequired=function(){var e=this.getTable();if(!e){return false}return r.isVariableRowHeightEnabled(e)&&V.getScrollRangeOfViewport(e)>0||e._getTotalRowCount()>e._getRowCounts().count};R.prototype.registerForMouseWheel=function(r,t){var o=this.getTable();if(e.isEnrichedWith(o,"sap.ui.table.extensions.Synchronization")){return w.addMouseWheelEventListener(r,o,t)}else{i.error("This method can only be used with synchronization enabled.",o,"sap.ui.table.extensions.Scrolling#registerForMouseWheel");return null}};R.prototype.registerForTouch=function(r,t){var o=this.getTable();if(e.isEnrichedWith(o,"sap.ui.table.extensions.Synchronization")){return w.addTouchEventListener(r,o,t)}else{i.error("This method can only be used with synchronization enabled.",o,"sap.ui.table.extensions.Scrolling#registerForTouch");return null}};R.prototype._clearCache=function(){h(this.getTable()).oVerticalScrollbar=null;h(this.getTable()).oHorizontalScrollbar=null};R.ScrollDirection=u;return R});