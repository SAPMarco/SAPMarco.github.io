/*
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./PluginBase","../utils/TableUtils","sap/ui/unified/MenuItem","sap/base/util/deepClone"],function(t,e,o,a){"use strict";function i(t,e){var o=t.getProperty(e),a=t.getModel().getMetaModel(),i=a.getMetaPath(t.getPath()+"/"+e),r=a.getUI5Type(i);return r.formatValue(o,"string")}var r=t.extend("sap.ui.table.plugins.V4Aggregation",{metadata:{library:"sap.ui.table",properties:{totalSummaryOnTop:{type:"string",defaultValue:"Off"},totalSummaryOnBottom:{type:"string",defaultValue:"Fixed"},groupSummary:{type:"string",defaultValue:"Bottom"}}}});r.prototype.isApplicable=function(e){return t.prototype.isApplicable.apply(this,arguments)&&e.getMetadata().getName()==="sap.ui.table.Table"};r.prototype.activate=function(){var e=this.getTableBinding();if(e&&!e.getModel().isA("sap.ui.model.odata.v4.ODataModel")){return}t.prototype.activate.apply(this,arguments)};r.prototype.onActivate=function(t){this.setRowCountConstraints({fixedTop:false,fixedBottom:false});e.Grouping.setGroupMode(t);e.Hook.register(t,e.Hook.Keys.Row.UpdateState,this.updateRowState,this);e.Hook.register(t,e.Hook.Keys.Row.Expand,n,this);e.Hook.register(t,e.Hook.Keys.Row.Collapse,s,this)};r.prototype.onDeactivate=function(t){this.setRowCountConstraints();e.Grouping.clearMode(t);e.Hook.deregister(t,e.Hook.Keys.Row.UpdateState,this.updateRowState,this);e.Hook.deregister(this,e.Hook.Keys.Row.Expand,n,this);e.Hook.deregister(this,e.Hook.Keys.Row.Collapse,s,this);var o=t.getBinding();if(o){o.setAggregation()}};r.prototype.onTableRowsBound=function(t){if(t.getModel().isA("sap.ui.model.odata.v4.ODataModel")){this.updateAggregation()}else{this.deactivate()}};r.prototype.updateRowState=function(t){var e=t.context.getValue("@$ui5.node.level");var o=t.context.getValue("@$ui5.node.isTotal");var a=t.context.getValue("@$ui5.node.isExpanded")===undefined;var i=e===0&&o;var r=e>0&&!a;var n=!r&&o;if(i||n){t.type=t.Type.Summary}else if(r){t.type=t.Type.GroupHeader}t.expandable=r;t.expanded=t.context.getValue("@$ui5.node.isExpanded")===true;t.level=e;if(r){t.title=this._aGroupLevelFormatters[e-1](t.context,this._aGroupLevels[e-1])}};r.prototype.setPropertyInfos=function(t){this._aPropertyInfos=t};r.prototype.getPropertyInfos=function(){return this._aPropertyInfos||[]};r.prototype.findPropertyInfo=function(t){return this.getPropertyInfos().find(function(e){return e.name===t})};r.prototype.isPropertyAggregatable=function(t){return t.extension&&t.extension.defaultAggregate?true:false};r.prototype.setAggregationInfo=function(t){if(!t||!t.visible){this._mGroup=undefined;this._mAggregate=undefined;this._aGroupLevels=undefined}else{this._mGroup=this.getPropertyInfos().reduce(function(t,e){if(e.key){t[e.path]={}}return t},{});this._mAggregate={};t.visible.forEach(function(e){var o=this.findPropertyInfo(e);if(o&&o.groupable){this._mGroup[o.path]={}}if(o&&this.isPropertyAggregatable(o)){this._mAggregate[o.path]={grandTotal:t.grandTotal&&t.grandTotal.indexOf(e)>=0,subtotals:t.subtotals&&t.subtotals.indexOf(e)>=0};if(o.unit){var a=this.findPropertyInfo(o.unit);if(a){this._mAggregate[o.path].unit=a.path}}if(o.extension.defaultAggregate.contextDefiningProperties){o.extension.defaultAggregate.contextDefiningProperties.forEach(function(t){var e=this.findPropertyInfo(t);if(e&&(e.groupable||e.key)){this._mGroup[e.path]={}}}.bind(this))}}}.bind(this));this._aGroupLevels=[];this._aGroupLevelFormatters=[];if(t.groupLevels){t.groupLevels.forEach(function(t){var e=this.findPropertyInfo(t);if(e&&e.groupable){this._aGroupLevels.push(e.path);var o=e.groupingDetails&&e.groupingDetails.formatter||i;this._aGroupLevelFormatters.push(o)}}.bind(this))}Object.keys(this._mGroup).forEach(function(t){if(this._mAggregate.hasOwnProperty(t)){if(this._mAggregate[t].grandTotal||this._mAggregate[t].subtotals){delete this._mGroup[t]}else{delete this._mAggregate[t]}}}.bind(this))}this.updateAggregation()};function n(t){var e=t.getRowBindingContext();if(e){e.expand()}}function s(t){var e=t.getRowBindingContext();if(e){e.collapse()}}r.prototype.setTotalSummaryOnTop=function(t){this.setProperty("totalSummaryOnTop",t,true);this.updateAggregation()};r.prototype.setTotalSummaryOnBottom=function(t){this.setProperty("totalSummaryOnBottom",t,true);this.updateAggregation()};r.prototype.setGroupSummary=function(t){this.setProperty("groupSummary",t,true);this.updateAggregation()};r.prototype.updateAggregation=function(){var t=this.getTableBinding();if(!t){return}var e={aggregate:a(this._mAggregate),group:a(this._mGroup),groupLevels:this._aGroupLevels?this._aGroupLevels.slice():undefined};g(this,e);u(this,e);t.setAggregation(e)};function g(t,e){var o=t.getTotalSummaryOnTop();var a=t.getTotalSummaryOnBottom();var i=o==="On"||o==="Fixed";var r=a==="On"||a==="Fixed";var n=Object.keys(e.aggregate).some(function(t){return e.aggregate[t].grandTotal});if(i&&r){e.grandTotalAtBottomOnly=false}else if(r){e.grandTotalAtBottomOnly=true}else if(i){e.grandTotalAtBottomOnly=undefined}else{Object.keys(e.aggregate).forEach(function(t){delete e.aggregate[t].grandTotal})}t.setRowCountConstraints({fixedTop:o==="Fixed"&&n,fixedBottom:a==="Fixed"&&n})}function u(t,e){var o=t.getGroupSummary();if(o==="Top"){e.subtotalsAtBottomOnly=undefined}else if(o==="Bottom"){e.subtotalsAtBottomOnly=true}else if(o==="TopAndBottom"){e.subtotalsAtBottomOnly=false}else{Object.keys(e.aggregate).forEach(function(t){delete e.aggregate[t].subtotals})}}return r});