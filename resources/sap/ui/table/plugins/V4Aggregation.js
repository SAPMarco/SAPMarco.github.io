/*
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./PluginBase","../utils/TableUtils","sap/ui/unified/MenuItem"],function(t,e,o){"use strict";function i(t,e){var o=t.getProperty(e),i=t.getModel().getMetaModel(),a=i.getMetaPath(t.getPath()+"/"+e),r=i.getUI5Type(a);return r.formatValue(o,"string")}var a=t.extend("sap.ui.table.plugins.V4Aggregation",{metadata:{library:"sap.ui.table",properties:{},events:{}}});a.prototype.init=function(){};a.prototype.isApplicable=function(t){return t.getMetadata().getName()==="sap.ui.table.Table"};a.prototype.onActivate=function(o){var i=o.getBinding("rows");if(i&&!i.getModel().isA("sap.ui.model.odata.v4.ODataModel")){return}t.prototype.onActivate.apply(this,arguments);e.Grouping.setGroupMode(o);e.Hook.register(o,e.Hook.Keys.Row.UpdateState,this.updateRowState,this);e.Hook.register(o,e.Hook.Keys.Row.Expand,this.expandRow,this);e.Hook.register(o,e.Hook.Keys.Row.Collapse,this.collapseRow,this)};a.prototype.onDeactivate=function(o){t.prototype.onDeactivate.apply(this,arguments);e.Grouping.clearMode(o);e.Hook.deregister(o,e.Hook.Keys.Row.UpdateState,this.updateRowState,this);e.Hook.deregister(this,e.Hook.Keys.Row.Expand,this.expandRow,this);e.Hook.deregister(this,e.Hook.Keys.Row.Collapse,this.collapseRow,this);var i=o.getBinding("rows");if(i){i.setAggregation()}};a.prototype.onTableRowsBound=function(t){if(t.getModel().isA("sap.ui.model.odata.v4.ODataModel")){this.updateAggregation()}else{this.onDeactivate(this.getTable())}};a.prototype.updateRowState=function(t){var e=t.context.getValue("@$ui5.node.level");if(typeof t.context.getValue("@$ui5.node.isExpanded")==="boolean"){t.type=e===0?t.Type.Summary:t.Type.GroupHeader}t.expandable=t.type===t.Type.GroupHeader;t.expanded=t.context.getValue("@$ui5.node.isExpanded")===true;t.level=e;if(t.type===t.Type.GroupHeader){t.title=this._aGroupLevelFormatters[e-1](t.context,this._aGroupLevels[e-1])}};a.prototype.setPropertyInfos=function(t){this._aPropertyInfos=t};a.prototype.getPropertyInfos=function(){return this._aPropertyInfos||[]};a.prototype.findPropertyInfo=function(t){return this.getPropertyInfos().find(function(e){return e.name===t})};a.prototype.setAggregationInfo=function(t){if(!t||!t.visible){this._mGroup=undefined;this._mAggregate=undefined;this._aGroupLevels=undefined}else{this._mGroup=this.getPropertyInfos().reduce(function(t,e){if(e.key){t[e.path]={}}return t},{});this._mAggregate={};t.visible.forEach(function(e){var o=this.findPropertyInfo(e);if(o&&o.groupable){this._mGroup[o.path]={}}if(o&&o.aggregatable){this._mAggregate[o.path]={grandTotal:t.grandTotal&&t.grandTotal.indexOf(e)>=0,subtotals:t.subtotals&&t.subtotals.indexOf(e)>=0};if(o.aggregationDetails){if(o.aggregationDetails.defaultMethod&&o.aggregationDetails.defaultMethod.unit){var i=this.findPropertyInfo(o.aggregationDetails.defaultMethod.unit);if(i){this._mAggregate[o.path].unit=i.path}}if(o.aggregationDetails.contextDefiningProperties){o.aggregationDetails.contextDefiningProperties.forEach(function(t){var e=this.findPropertyInfo(t);if(e&&e.groupable){this._mGroup[e.path]={}}}.bind(this))}}}}.bind(this));this._aGroupLevels=[];this._aGroupLevelFormatters=[];if(t.groupLevels){t.groupLevels.forEach(function(t){var e=this.findPropertyInfo(t);if(e&&e.groupable){this._aGroupLevels.push(e.path);var o=e.groupingDetails&&e.groupingDetails.formatter||i;this._aGroupLevelFormatters.push(o)}}.bind(this))}}this.updateAggregation()};a.prototype.expandRow=function(t){if(e.isA(t,"sap.ui.table.Row")){var o=t.getRowBindingContext();if(o){o.expand()}}};a.prototype.collapseRow=function(t){if(e.isA(t,"sap.ui.table.Row")){var o=t.getRowBindingContext();if(o){o.collapse()}}};a.prototype.updateAggregation=function(){var t=this.getTableBinding();var e={aggregate:this._mAggregate,group:this._mGroup,groupLevels:this._aGroupLevels};if(t){t.setAggregation(e)}};return a});