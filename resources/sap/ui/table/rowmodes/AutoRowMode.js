/*
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../library","../utils/TableUtils","./RowMode","sap/ui/Device","sap/base/Log"],function(t,e,o,i,a){"use strict";var s=e.createWeakMapFacade();var r=o.extend("sap.ui.table.rowmodes.AutoRowMode",{metadata:{library:"sap.ui.table",properties:{rowContentHeight:{type:"int",defaultValue:0,group:"Appearance"},minRowCount:{type:"int",defaultValue:5,group:"Appearance"},maxRowCount:{type:"int",defaultValue:-1,group:"Appearance"},hideEmptyRows:{type:"boolean",defaultValue:false,group:"Appearance"}}},constructor:function(t){Object.defineProperty(this,"bLegacy",{value:typeof t==="boolean"?t:false});o.apply(this,arguments)}});var n={};function l(t){var e=t.getTable();var o=e?e.getDomRef("tableCCnt"):null;if(o&&i.browser.chrome&&window.devicePixelRatio!==1){var a=document.createElement("table");var s=a.insertRow();var r=t.getRowContentHeight();var n;a.classList.add("sapUiTableCtrl");s.classList.add("sapUiTableTr");if(r>0){s.style.height=t.getBaseRowHeightOfTable()+"px"}o.appendChild(a);n=s.getBoundingClientRect().height;o.removeChild(a);return n}else{return t.getBaseRowHeightOfTable()}}r.prototype.init=function(){o.prototype.init.apply(this,arguments);s(this).iPendingStartTableUpdateSignals=0;s(this).bRowCountAutoAdjustmentActive=false;s(this).iLastAvailableSpace=0;s(this).bTableIsFlexItem=false;this.adjustRowCountToAvailableSpaceAsync=e.throttleFrameWise(this.adjustRowCountToAvailableSpace)};r.prototype.attachEvents=function(){o.prototype.attachEvents.apply(this,arguments);e.addDelegate(this.getTable(),n,this)};r.prototype.detachEvents=function(){o.prototype.detachEvents.apply(this,arguments);e.removeDelegate(this.getTable(),n)};r.prototype.cancelAsyncOperations=function(){o.prototype.cancelAsyncOperations.apply(this,arguments);this.stopAutoRowMode()};r.prototype.registerHooks=function(){o.prototype.registerHooks.apply(this,arguments);e.Hook.register(this.getTable(),e.Hook.Keys.Table.RefreshRows,this._onTableRefreshRows,this);e.Hook.register(this.getTable(),e.Hook.Keys.Table.UpdateSizes,this._onUpdateTableSizes,this)};r.prototype.deregisterHooks=function(){o.prototype.deregisterHooks.apply(this,arguments);e.Hook.deregister(this.getTable(),e.Hook.Keys.Table.RefreshRows,this._onTableRefreshRows,this);e.Hook.deregister(this.getTable(),e.Hook.Keys.Table.UpdateSizes,this._onUpdateTableSizes,this)};r.prototype.setRowCount=function(){a.error("The row count is set automatically and cannot be set manually.",this);return this};r.prototype.getRowCount=function(){if(this.bLegacy){var t=this.getTable();return t?t.getVisibleRowCount():0}return this.getProperty("rowCount")};r.prototype.getFixedTopRowCount=function(){if(this.bLegacy){var t=this.getTable();return t?t.getFixedRowCount():0}return this.getProperty("fixedTopRowCount")};r.prototype.getFixedBottomRowCount=function(){if(this.bLegacy){var t=this.getTable();return t?t.getFixedBottomRowCount():0}return this.getProperty("fixedBottomRowCount")};r.prototype.getMinRowCount=function(){if(this.bLegacy){var t=this.getTable();return t?t.getMinAutoRowCount():0}return this.getProperty("minRowCount")};r.prototype.getRowContentHeight=function(){if(this.bLegacy){var t=this.getTable();return t?t.getRowHeight():0}return this.getProperty("rowContentHeight")};r.prototype.setHideEmptyRows=function(t){this.setProperty("hideEmptyRows",t);if(t){this.disableNoData()}else{this.enableNoData()}return this};r.prototype._getMinRowCount=function(){var t=this.getMinRowCount();var e=this.getMaxRowCount();if(e>=0){return Math.min(t,e)}else{return t}};r.prototype.getMinRequestLength=function(){var t=this.getTable();var o=this.getConfiguredRowCount();if(this.isPropertyInitial("rowCount")||t&&!t._bContextsAvailable){var a=Math.ceil(i.resize.height/e.DefaultRowHeight.sapUiSizeCondensed);o=Math.max(o,a)}return o};r.prototype.getComputedRowCounts=function(){if(this.isPropertyInitial("rowCount")){return{count:0,scrollable:0,fixedTop:0,fixedBottom:0}}var t=this.getConfiguredRowCount();var e=this.getFixedTopRowCount();var o=this.getFixedBottomRowCount();if(this.getHideEmptyRows()){t=Math.min(t,this.getTotalRowCountOfTable())}return this.sanitizeRowCounts(t,e,o)};r.prototype.getTableStyles=function(){var t="0px";if(this.isPropertyInitial("rowCount")){t="auto"}else{var e=this.getConfiguredRowCount();if(e===0||e===this._getMinRowCount()){t="auto"}}return{height:t}};r.prototype.getTableBottomPlaceholderStyles=function(){if(!this.getHideEmptyRows()){return undefined}var t;if(this.isPropertyInitial("rowCount")){t=this._getMinRowCount()}else{t=this.getConfiguredRowCount()-this.getComputedRowCounts().count}return{height:t*this.getBaseRowHeightOfTable()+"px"}};r.prototype.getRowContainerStyles=function(){return{height:this.getComputedRowCounts().count*Math.max(this.getBaseRowHeightOfTable(),l(this))+"px"}};r.prototype.renderRowStyles=function(t){var e=this.getRowContentHeight();if(e>0){t.style("height",this.getBaseRowHeightOfTable()+"px")}};r.prototype.renderCellContentStyles=function(t){var e=this.getRowContentHeight();if(!this.bLegacy&&e<=0){e=this.getDefaultRowContentHeightOfTable()}if(e>0){t.style("max-height",e+"px")}};r.prototype.getBaseRowContentHeight=function(){return Math.max(0,this.getRowContentHeight())};r.prototype._onTableRefreshRows=function(){var t=this.getConfiguredRowCount();if(t>0){if(!this.isPropertyInitial("rowCount")){this.initTableRowsAfterDataRequested(t)}this.getRowContexts(t,true)}};r.prototype.getConfiguredRowCount=function(){var t=Math.max(0,this.getMinRowCount(),this.getRowCount());var e=this.getMaxRowCount();if(e>=0){t=Math.min(t,e)}return t};r.prototype.startAutoRowMode=function(){this.adjustRowCountToAvailableSpaceAsync(e.RowsUpdateReason.Render,true)};r.prototype.stopAutoRowMode=function(){this.deregisterResizeHandler();this.adjustRowCountToAvailableSpaceAsync.cancel();s(this).bRowCountAutoAdjustmentActive=false;h(this)};r.prototype.registerResizeHandler=function(t){var o=this.getTable();if(o){e.registerResizeHandler(o,"AutoRowMode",this.onResize.bind(this),null,t===true);e.registerResizeHandler(o,"AutoRowMode-BeforeTable",this.onResize.bind(this),"before");e.registerResizeHandler(o,"AutoRowMode-AfterTable",this.onResize.bind(this),"after")}};r.prototype.deregisterResizeHandler=function(){var t=this.getTable();if(t){e.deregisterResizeHandler(t,["AutoRowMode, AutoRowMode-BeforeTable, AutoRowMode-AfterTable"])}};r.prototype.onResize=function(t){var o=t.oldSize.height;var i=t.size.height;if(o!==i){u(this);this.adjustRowCountToAvailableSpaceAsync(e.RowsUpdateReason.Resize)}};r.prototype._onUpdateTableSizes=function(t){if(t===e.RowsUpdateReason.Resize||t===e.RowsUpdateReason.Render){return}if(s(this).bRowCountAutoAdjustmentActive){u(this);this.adjustRowCountToAvailableSpaceAsync(t)}};r.prototype.adjustRowCountToAvailableSpace=function(t,o){o=o===true;var i=this.getTable();var a=i?i.getDomRef():null;if(!i||i._bInvalid||!a||!sap.ui.getCore().isThemeApplied()){h(this);return}s(this).bTableIsFlexItem=window.getComputedStyle(a.parentNode).display==="flex";if(a.scrollHeight===0){if(o){this.registerResizeHandler(!s(this).bTableIsFlexItem);s(this).bRowCountAutoAdjustmentActive=true}h(this);return}var r=this.determineAvailableSpace();var n=this.getConfiguredRowCount();var u=Math.floor(r/l(this));var p=this.getComputedRowCounts().count;var g;if(this.bLegacy){i.setProperty("visibleRowCount",u,true)}this.setProperty("rowCount",u,true);g=this.getComputedRowCounts().count;if(this.bLegacy){i.setProperty("visibleRowCount",g,true)}if(p!==g){this.updateTable(t)}else{if(n!==u||t===e.RowsUpdateReason.Zoom){this.applyTableStyles();this.applyRowContainerStyles();this.applyTableBottomPlaceholderStyles()}if(!this._bFiredRowsUpdatedAfterRendering&&i.getRows().length>0){this.fireRowsUpdated(t)}}if(o){this.registerResizeHandler(!s(this).bTableIsFlexItem);s(this).bRowCountAutoAdjustmentActive=true}h(this)};r.prototype.determineAvailableSpace=function(){var t=this.getTable();var e=t?t.getDomRef():null;var o=t?t.getDomRef("tableCCnt"):null;var a=t?t.getDomRef("placeholder-bottom"):null;if(!e||!o||!e.parentNode){return 0}var r=0;var n=o.clientHeight;var l=a?a.clientHeight:0;if(s(this).bTableIsFlexItem){var u=e.childNodes;for(var h=0;h<u.length;h++){r+=u[h].offsetHeight}r-=n-l}else{r=e.scrollHeight-n-l}var p=t._getScrollExtension();if(!p.isHorizontalScrollbarVisible()){var g={};g[i.browser.BROWSER.CHROME]=16;g[i.browser.BROWSER.FIREFOX]=16;g[i.browser.BROWSER.INTERNET_EXPLORER]=18;g[i.browser.BROWSER.EDGE]=16;g[i.browser.BROWSER.SAFARI]=16;g[i.browser.BROWSER.ANDROID]=8;r+=g[i.browser.name]}var R=s(this).bTableIsFlexItem?e:e.parentNode;var d=Math.max(0,Math.floor(jQuery(R).height()-r));var f=Math.abs(d-s(this).iLastAvailableSpace);if(f>=5){s(this).iLastAvailableSpace=d}return s(this).iLastAvailableSpace};n.onBeforeRendering=function(t){var o=t&&t.isMarked("renderRows");if(!o){this.stopAutoRowMode();this.updateTable(e.RowsUpdateReason.Render)}};n.onAfterRendering=function(t){var e=t&&t.isMarked("renderRows");if(!e){this.startAutoRowMode()}};function u(t){s(t).iPendingStartTableUpdateSignals++;e.Hook.call(t.getTable(),e.Hook.Keys.Signal,"StartTableUpdate")}function h(t){for(var o=0;o<s(t).iPendingStartTableUpdateSignals;o++){e.Hook.call(t.getTable(),e.Hook.Keys.Signal,"EndTableUpdate")}s(t).iPendingStartTableUpdateSignals=0}return r});