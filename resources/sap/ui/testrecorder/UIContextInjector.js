/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Object","sap/base/util/restricted/_debounce","sap/ui/testrecorder/CommunicationBus","sap/ui/testrecorder/CommunicationChannels","sap/ui/testrecorder/Constants"],function(e,t,i,o,s,n){"use strict";var r=null;var d=false;var a=t.extend("sap.ui.testrecorder.UIContextInjector",{constructor:function(){if(!r){this._sIdentifier=_();Object.apply(this,arguments)}else{return r}}});a.prototype.injectFrame=function(e,t){window.communicationWindows=window.communicationWindows||{};this._generateTestRecorderUrl();this.fnOnClose=t;this._isInIframe=e.indexOf("window")===-1;this._onResizeHandleMouseover=c.bind(this);this._onResizeHandleMousedown=l.bind(this);this._onResizeHandleMouseleave=u.bind(this);this._onDocumentMouseup=h.bind(this);this._onDocumentMousemove=m.bind(this);if(this._isInIframe){this.dockFrameBottom()}else{this._openWindow()}window.communicationWindows.testRecorder.addEventListener("beforeunload",function(){if(!this._dockStarted&&!this._closeTriggered){this.close()}}.bind(this));o.subscribe(s.MINIMIZE_IFRAME,this.minimizeFrame.bind(this));o.subscribe(s.SHOW_IFRAME,this.unminimizeFrame.bind(this));o.subscribe(s.CLOSE_IFRAME,this.close.bind(this));o.subscribe(s.OPEN_NEW_WINDOW,this.openNewWindow.bind(this));o.subscribe(s.DOCK_IFRAME_BOTTOM,this.dockFrameBottom.bind(this));o.subscribe(s.DOCK_IFRAME_RIGHT,this.dockFrameRight.bind(this));o.subscribe(s.DOCK_IFRAME_LEFT,this.dockFrameLeft.bind(this))};a.prototype.minimizeFrame=function(){this._iframe.style.width=n.FRAME.MINIMIZED.width;this._iframe.style.height=n.FRAME.MINIMIZED.height;Object.values(this._resizeHandles).forEach(function(e){e.style.display="none"})};a.prototype.unminimizeFrame=function(){switch(this._sRememberedDockSide){case n.DOCK.RIGHT:this.dockFrameRight();break;case n.DOCK.LEFT:this.dockFrameLeft();break;case n.DOCK.BOTTOM:default:this.dockFrameBottom();break}};a.prototype.dockFrameBottom=function(){this._dockFrame(n.DOCK.BOTTOM)};a.prototype.dockFrameRight=function(){this._dockFrame(n.DOCK.RIGHT)};a.prototype.dockFrameLeft=function(){this._dockFrame(n.DOCK.LEFT)};a.prototype._dockFrame=function(e){if(!this._iframe){this._dockStarted=true;this.close();this._openFrame()}this._sRememberedDockSide=e;for(var t in n.FRAME[e]){this._iframe.style[t]=n.FRAME[e][t]}Object.values(this._resizeHandles).forEach(function(e){e.style.display="none"});this._resizeHandles[e].style.display="block";for(var i in n.RESIZE_HANDLE[e]){this._resizeHandles[e].style[i]=n.RESIZE_HANDLE[e][i]}};a.prototype.openNewWindow=function(){this._dockStarted=true;this.close();this._openWindow()};a.prototype._openWindow=function(){window.communicationWindows.testRecorder=window.open(this._sUrl,"sapUiTestRecorder","width=1024,height=700,status=no,toolbar=no,menubar=no,resizable=yes,location=no,directories=no,scrollbars=yes");window.communicationWindows.testRecorder.window.onload=function(){window.communicationWindows.testRecorder.document.title="Test Recorder"};this._isInIframe=false;this._dockStarted=false;this._closeTriggered=false};a.prototype._openFrame=function(){var t=document.createElement("IFRAME");var i=document.createElement("DIV");var o=this._createResizeHandle(e.extend(n.RESIZE_HANDLE.BOTTOM,{cursor:"n-resize",resize:function(e,t){e.style.top=t.y+"px";this._iframe.style.height="calc(100% - "+t.y+"px)"}.bind(this)}));var s=this._createResizeHandle(e.extend(n.RESIZE_HANDLE.RIGHT,{cursor:"e-resize",resize:function(e,t){e.style.left=t.x+"px";this._iframe.style.left=t.x+"px";this._iframe.style.width="calc(100% - "+t.x+"px)"}.bind(this)}));var r=this._createResizeHandle(e.extend(n.RESIZE_HANDLE.LEFT,{cursor:"w-resize",resize:function(e,t){e.style.left=t.x+"px";this._iframe.style.width=t.x+"px"}.bind(this)}));i.id=n.RESIZE_OVERLAY_ID;i.style.position="absolute";i.style.width="100%";i.style.height="100%";i.style.top="0";i.style.left="0";i.style["z-index"]=n.RESIZE_OVERLAY_ZINDEX;i.style.display="none";t.id=n.IFRAME_ID;t.src=this._sUrl;t.style.position="absolute";t.style.border="none";t.style.borderRadius="1px";t.style["z-index"]=n.IFRAME_ZINDEX;t.style.boxShadow="1px -10px 42px -4px #888";document.body.appendChild(o);document.body.appendChild(s);document.body.appendChild(r);document.body.appendChild(i);document.body.appendChild(t);window.communicationWindows.testRecorder=t.contentWindow;this._iframe=t;this._resizeOverlay=i;this._resizeHandles={BOTTOM:o,RIGHT:s,LEFT:r};this._dockStarted=false;this._isInIframe=true;this._closeTriggered=false};a.prototype.close=function(){if(this._closeTriggered){return}this._closeTriggered=true;if(this._isInIframe){var t=this._iframe&&this._iframe.contentWindow;if(t){t.onerror=e.noop;this._iframe.src="about:blank";t.document.write("");t.close();if(typeof CollectGarbage=="function"){CollectGarbage()}this._iframe.remove();this._resizeOverlay.remove();Object.values(this._resizeHandles).forEach(function(e){e.remove()});this._iframe=null;this._resizeOverlay=null;this._resizeHandles={}}}else if(window.communicationWindows.testRecorder){window.communicationWindows.testRecorder.close()}if(!this._dockStarted){window.communicationWindows={};this.fnOnClose()}};a.prototype.getCommunicationInfo=function(){return{origin:this._sOrigin,identifier:this._sIdentifier,url:this._sUrl}};a.prototype._generateTestRecorderUrl=function(){this._sUrl=sap.ui.require.toUrl("sap/ui/testrecorder/ui/overlay.html")+"?sap-ui-testrecorder-origin="+window.location.protocol+"//"+window.location.host+"&"+"sap-ui-testrecorder-frame-identifier="+this._sIdentifier;var e=new window.URI(this._sUrl);this._sOrigin=(e.protocol()||window.location.protocol.replace(":",""))+"://"+(e.host()||window.location.host)};a.prototype._createResizeHandle=function(e){var t=document.createElement("DIV");t.id=e.id;t.style.position="absolute";t.style.width=e.width;t.style.height=e.height;t.style.left=e.left;t.style.top=e.top;t.style["z-index"]=n.RESIZE_HANDLE_ZINDEX;t.style.cursor=e.cursor;t.style.display="none";t.onmouseover=this._onResizeHandleMouseover(t);t.onmousedown=this._onResizeHandleMousedown(t,e.resize);t.onmouseleave=this._onResizeHandleMouseleave(t);return t};function c(e){return function(){e.style.background="#0854a0"}}function l(e,t){return function(i){i.preventDefault();d=true;this._resizeOverlay.style.display="block";document.onmouseup=this._onDocumentMouseup;document.onmousemove=this._onDocumentMousemove(e,t)}.bind(this)}function u(e){return function(){if(!d){e.style.background="transparent"}}}function h(){d=false;this._resizeOverlay.style.display="none";document.onmouseup=null;document.onmousemove=null}function m(e,t){return i(function(i){i.preventDefault();var o=150;t(e,{x:Math.max(Math.min(i.clientX,window.innerWidth-o),o),y:Math.max(Math.min(i.clientY,window.innerHeight-o),o)})},50)}function _(){return""+Date.now()}r=new a;return r},true);