/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/util/Storage","sap/ui/core/mvc/Controller","sap/ui/testrecorder/ui/models/SharedModel","sap/ui/testrecorder/CommunicationBus","sap/ui/testrecorder/CommunicationChannels","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/model/Binding","sap/m/MessageToast","sap/m/Dialog","sap/m/CheckBox","sap/m/Button","sap/m/VBox","sap/ui/support/supportRules/ui/external/ElementTree","sap/ui/testrecorder/interaction/ContextMenu"],function(e,t,i,o,s,n,r,l,d,a,c,h,p,g,u,m,_){"use strict";return o.extend("sap.ui.testrecorder.ui.controllers.Main",{onInit:function(){this._hidden=false;this._frameHeight=1;this._treeSelectionId=null;this._localStorage=new i(i.Type.local,"sap-ui-test-recorder");e.sap.includeStyleSheet("sap/ui/testrecorder/ui/styles/overlay.css");this.elementTree=new m(null,{filter:{issues:false,search:true},onSelectionChanged:this._onTreeSelectionChanged.bind(this),onContextMenu:this._onTreeContextMenu.bind(this)});this._setupModels();this.toggleHeaderToolbars()},onBeforeRendering:function(){n.publish(r.REQUEST_ALL_CONTROLS_DATA)},onAfterRendering:function(){n.subscribe(r.RECEIVE_ALL_CONTROLS_DATA,this._onUpdateAllControls.bind(this));n.subscribe(r.RECEIVE_CONTROL_DATA,this._onReceiveControlDetails.bind(this));n.subscribe(r.RECEIVE_CODE_SNIPPET,this._onUpdateCodeSnippet.bind(this));n.subscribe(r.SELECT_CONTROL_IN_TREE,this._onUpdateSelection.bind(this));n.subscribe(r.DIALECT_CHANGED,this._changeDialect.bind(this))},toggleHeaderToolbars:function(){this.byId("ttMaximizeHeaderBar").setVisible(this._hidden)},toggleHide:function(){this._hidden=!this._hidden;this.toggleHeaderToolbars();if(this._hidden){n.publish(r.HIDE_IFRAME)}else{n.publish(r.SHOW_IFRAME)}},resizeDown:function(){this._frameHeight-=1;n.publish(r.RESIZE_IFRAME_DOWN)},resizeUp:function(){this._frameHeight+=1;n.publish(r.RESIZE_IFRAME_UP)},openWindow:function(){this._frameHeight=1;n.publish(r.OPEN_NEW_WINDOW)},close:function(){n.publish(r.CLOSE_IFRAME)},dockFrame:function(){this._frameHeight=1;n.publish(r.DOCK_IFRAME)},copyCodeSnippet:function(){var e=this.byId("codeEditor").getValue();var i=function(t){if(t.clipboardData){t.clipboardData.setData("text/plain",e)}else{t.originalEvent.clipboardData.setData("text/plain",e)}t.preventDefault()};if(t.browser.msie&&window.clipboardData){window.clipboardData.setData("text",e)}else{document.addEventListener("copy",i);document.execCommand("copy");document.removeEventListener("copy",i)}},clearCodeSnippet:function(){n.publish(r.CLEAR_SNIPPETS);this.byId("codeEditor").setValue("")},openSettingsDialog:function(){if(!this.settingsDialog){this.settingsDialog=new h({title:this.getView().getModel("i18n").getProperty("TestRecorder.SettingsDialog.Title"),content:[new u({items:[new p({text:this.getView().getModel("i18n").getProperty("TestRecorder.SettingsDialog.IDCheckBox.Text"),name:"preferViewId",selected:this.model.getProperty("/settings/preferViewId"),select:this._onSelectCheckBox.bind(this)}),new p({text:this.getView().getModel("i18n").getProperty("TestRecorder.SettingsDialog.POMethodCheckBox.Text"),name:"formatAsPOMethod",selected:this.model.getProperty("/settings/formatAsPOMethod"),select:this._onSelectCheckBox.bind(this)})]})],endButton:new g({text:this.getView().getModel("i18n").getProperty("TestRecorder.SettingsDialog.CloseButton.Text"),press:this.closeSettingsDialog.bind(this)})});this.getView().addDependent(this.settingsDialog)}this.settingsDialog.open()},closeSettingsDialog:function(){if(this.settingsDialog){this.settingsDialog.close()}},_setupModels:function(){this.model=s;this.getView().setModel(this.model);this.model.setProperty("/isInIframe",!window.opener);var e=this._localStorage.get("dialect");var t=this._localStorage.get("settings-preferViewId");var i=this._localStorage.get("settings-formatAsPOMethod");if(e){this.model.setProperty("/selectedDialect",e);n.publish(r.SET_DIALECT,e)}if(t!==null&&t!=="undefined"){this.model.setProperty("/settings/preferViewId",t)}if(i!==null&&i!=="undefined"){this.model.setProperty("/settings/formatAsPOMethod",i)}n.publish(r.UPDATE_SETTINGS,this.model.getProperty("/settings"));var o=new a(s,"/",s.getContext("/selectedDialect"));o.attachChange(function(){n.publish(r.SET_DIALECT,this.model.getProperty("/selectedDialect"))}.bind(this));var c=new d({bundleName:"sap.ui.core.messagebundle"});this.getView().setModel(c,"i18n");this.getView().setModel(new l({framework:{}}),"framework");this.getView().setModel(new l({controls:{bindings:{},properties:{},codeSnippet:"",renderedControls:[]}}),"controls")},_onUpdateAllControls:function(e){this.elementTree.setContainerId(this.byId("elementTreeContainer").getId());this._clearControlData();if(e.framework){this.getView().getModel("controls").setProperty("/framework",e.framework)}if(e.renderedControls){this.getView().getModel("controls").setProperty("/renderedControls",e.renderedControls);this.elementTree.setData({controls:e.renderedControls})}if(this._frameHeight>0&&!this._hidden){c.show(this.getView().getModel("i18n").getProperty("TestRecorder.ControlTree.MessageToast"),{duration:1e3})}},_onReceiveControlDetails:function(e){if(e.properties){this.getView().getModel("controls").setProperty("/properties",e.properties)}if(e.bindings){this.getView().getModel("controls").setProperty("/bindings",e.bindings)}},_onUpdateCodeSnippet:function(e){if(e.codeSnippet!==undefined){this.getView().getModel("controls").setProperty("/codeSnippet",e.codeSnippet)}else if(e.error){var t=this.getView().getModel("i18n").getResourceBundle().getText("TestRecorder.Inspect.Snippet.NotFound.Text","#"+e.domElementId);this.getView().getModel("controls").setProperty("/codeSnippet",t)}},_onUpdateSelection:function(e){this.elementTree.setSelectedElement(e.rootElementId,false);this._clearControlData();n.publish(r.REQUEST_CONTROL_DATA,{domElementId:e.rootElementId});n.publish(r.REQUEST_CODE_SNIPPET,{domElementId:e.interactionElementId,action:e.action});n.publish(r.HIGHLIGHT_CONTROL,{domElementId:e.rootElementId})},_onTreeSelectionChanged:function(e){this._clearControlData();n.publish(r.REQUEST_CONTROL_DATA,{domElementId:e});n.publish(r.REQUEST_CODE_SNIPPET,{domElementId:e});n.publish(r.HIGHLIGHT_CONTROL,{domElementId:e})},_onTreeContextMenu:function(e){e=e||{};e.withEvents=true;e.items={highlight:false};_.show(e)},_clearControlData:function(){this.getView().getModel("controls").setProperty("/properties",{});this.getView().getModel("controls").setProperty("/bindings",{});this.getView().getModel("controls").setProperty("/codeSnippet","")},_changeDialect:function(e){this._localStorage.put("dialect",e.dialect)},_onSelectCheckBox:function(e){var t=e.getParameter("selected");var i=e.getSource().getName();var o={};o[i]=t;this.model.setProperty("/settings/"+i,t);this._localStorage.put("settings-"+i,t);n.publish(r.UPDATE_SETTINGS,o)},_onChangeMultiple:function(e){var t=e.getParameter("state");n.publish(r.UPDATE_SETTINGS,{multipleSnippets:t})},_onCodeEditorChange:function(e){var t=this.byId("codeEditor");var i=t.getValue().split("\n").length;if(i){t._oEditor.scrollToLine(i)}}})});